var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a=e(""),n=clearInterval,s=t=>null==t,o=(t,e,a)=>s(t)?a?.():e(t),r=Object,i=t=>r.getPrototypeOf(t),c=r.keys,y=r.freeze,d=t=>(t=>!s(t)&&o(i(t),(t=>t==r.prototype||s(i(t))),(()=>!0)))(t)&&0==(t=>c(t).length)(t),l=JSON.parse,p=t=>new Map(t),u=(t,e)=>t?.get(e),g=(t,e,a)=>{return s(a)?(n=t,o=e,n?.delete(o),t):t?.set(e,a);var n,o},h=(t,e,a,n)=>{var s,o;return s=t,o=e,s?.has(o)?n?.(u(t,e)):g(t,e,a()),u(t,e)},f=p(),v=p(),w=t=>t.headers.get("ETag");t.createRemotePersister=(t,i,c,p=5,C)=>{let A;return((t,n,r,i,c,l,p,w={},C=[])=>{let A,b,S,T=0;h(f,C,(()=>0)),h(v,C,(()=>[]));const[m,L,M,O,x]=((t,e)=>!t||s(e.getMergeableContent)?[0,e.getContent,e.getTransactionChanges,([t,e])=>!d(t)||!d(e),e.setContent]:[1,e.getMergeableContent,e.getTransactionMergeableChanges,([,[[,t],[,e]]])=>!d(t)||!d(e),e.setDefaultContent])(p,t),P=async t=>(2!=T&&(T=1,await D.schedule((async()=>{await t(),T=0}))),D),j=n=>{var s;(m&&(s=n?.[0],e(s)==a)?1===n?.[1][2]?t.applyMergeableChanges:t.setMergeableContent:1===n?.[2]?t.applyChanges:t.setContent)(n)},D={load:async t=>await P((async()=>{try{j(await n())}catch(e){l?.(e),t&&x(t)}})),startAutoLoad:async t=>(await D.stopAutoLoad().load(t),b=i((async(t,e)=>{const a=e?.();await P((async()=>{try{j(a??t?.()??await n())}catch(t){l?.(t)}}))})),D),stopAutoLoad:()=>(b&&(c(b),b=void 0),D),isAutoLoading:()=>!s(b),save:async t=>(1!=T&&(T=2,await D.schedule((async()=>{try{await r(L,t)}catch(t){l?.(t)}T=0}))),D),startAutoSave:async()=>(await D.stopAutoSave().save(),S=t.addDidFinishTransactionListener((()=>{const t=M();O(t)&&D.save((()=>t))})),D),stopAutoSave:()=>(o(S,t.delListener),S=void 0,D),isAutoSaving:()=>!s(S),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(u(v,C),...t),await(async()=>{if(!u(f,C)){for(g(f,C,1);!s((t=u(v,C),A=t.shift()));)try{await A()}catch(t){l?.(t)}g(f,C,0)}var t})(),D),getStore:()=>t,destroy:()=>D.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...w};return y(D)})(t,(async()=>{const t=await fetch(i);return A=w(t),l(await t.text())}),(async t=>{return await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:(e=t(),JSON.stringify(e,((t,e)=>e instanceof Map?r.fromEntries([...e]):e)))});var e}),(t=>setInterval((async()=>{const e=await fetch(i,{method:"HEAD"}),a=w(e);s(A)||s(a)||a==A||(A=a,t())}),1e3*p)),(t=>n(t)),C,!1,{getUrls:()=>[i,c]})}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterRemote={});
