var t,e;t=this,e=function(t,e,a){"use strict";const s="utf8",n=JSON.parse,r=t=>null==t,i=Object.freeze;t.createFilePersister=(t,o)=>((t,n,c,u,f)=>{let d,y,l,p=0,v=0,w=0;const h=[],A=async t=>{2!=p&&(p=1,await t(),p=0)},S={load:async(e={},a={})=>(await A((async()=>{try{t.setContent(await n())}catch{t.setContent([e,a])}})),S),startAutoLoad:async(a={},s={})=>{return S.stopAutoLoad(),await S.load(a,s),w=1,r=async(e,a)=>{await A((async()=>{if(a)t.setTransactionChanges(a());else try{t.setContent(e?.()??await n())}catch{}}))},l=e.watch(o,(()=>r())),S;var r},stopAutoLoad:()=>{return w&&(t=l,t?.close(),l=void 0,w=0),S;var t},save:async e=>(await S.schedule((async()=>{if(1!=p){p=2;try{await(async t=>{return await a.writeFile(o,(e=t(),JSON.stringify(e,((t,e)=>{return e instanceof Map?(a=(t,[e,a])=>(t[e]=a,t),s={},[...e].reduce(a,s)):e;var a,s}))),s);var e})(t.getContent)}catch{}p=0}})),S),startAutoSave:async()=>(await S.stopAutoSave().save(),d=t.addDidFinishTransactionListener(((t,e)=>{const a=e();S.save((()=>a))})),S),stopAutoSave:()=>{var e,a;return e=d,a=t.delListener,r(e)||a(e),S},schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(h,...t),await(async()=>{if(!v){for(v=1;!r((t=h,y=t.shift()));)try{await y()}catch{}v=0}var t})(),S),getStore:()=>t,destroy:()=>S.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return i(S)})(t,(async()=>n(await a.readFile(o,s))))},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("fs"),require("fs/promises")):"function"==typeof define&&define.amd?define(["exports","fs","fs/promises"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterFile={},t.fs,t["fs/promises"]);
