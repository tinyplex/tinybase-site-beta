var t,e;t=this,e=function(t,e,s){"use strict";const a="utf8",o=t=>null==t,r=Object.freeze;t.createFilePersister=(t,n)=>((t,i,c,u,d)=>{let f,l,p=0,y=!1;const v={load:async(s,r)=>{if(2!=p){p=1;const i=await(async()=>{try{return await e.readFile(n,a)}catch{}})();o(i)||""==i?t.setContent([s,r]):t.setJson(i),p=0}return v},startAutoLoad:async(e,a)=>{return v.stopAutoLoad(),await v.load(e,a),y=!0,r=async e=>{o(e)?await v.load():2!=p&&(p=1,t.setContent(e),p=0)},l=s.watch(n,(()=>r())),v;var r},stopAutoLoad:()=>(y&&(l?.close(),l=void 0,y=!1),v),save:async()=>(1!=p&&(p=2,await(async t=>{try{await e.writeFile(n,(s=t(),JSON.stringify(s,((t,e)=>{return e instanceof Map?(s=(t,[e,s])=>(t[e]=s,t),a={},[...e].reduce(s,a)):e;var s,a}))),a)}catch{}var s})(t.getContent),p=0),v),startAutoSave:async()=>(await v.stopAutoSave().save(),f=t.addDidFinishTransactionListener(v.save),v),stopAutoSave:()=>{var e,s;return e=f,s=t.delListener,o(e)||s(e),v},getStore:()=>t,destroy:()=>v.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return r(v)})(t)},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("fs/promises"),require("fs")):"function"==typeof define&&define.amd?define(["exports","fs/promises","fs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterFile={},t["fs/promises"],t.fs);
