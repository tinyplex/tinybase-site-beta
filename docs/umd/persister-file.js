var t,e;t=this,e=function(t,e,a){"use strict";const s="utf8",n=(t,e)=>t instanceof e,o=t=>null==t,i=Object,r=i.keys,c=i.freeze,u=t=>(t=>n(t,i)&&t.constructor==i)(t)&&0==(t=>r(t).length)(t),f=JSON.parse,y=t=>new Map(t),d=(t,e)=>t?.get(e),l=(t,e,a)=>{return o(a)?(s=t,n=e,s?.delete(n),t):t?.set(e,a);var s,n},p=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||l(t,e,a()),d(t,e)},w=y(),h=y();t.createFilePersister=(t,r,y)=>((t,e,a,s,n,i,r=[])=>{let f,y,v,g=0,A=0;p(w,r,(()=>0)),p(h,r,(()=>[]));const S=async t=>(2!=g&&(g=1,await m.schedule((async()=>{await t(),g=0}))),m),m={load:async(a,s)=>await S((async()=>{try{t.setContent(await e())}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},n={})=>(m.stopAutoLoad(),await m.load(a,n),A=1,v=s((async(a,s)=>{if(s){const e=s();await S((async()=>t.setTransactionChanges(e)))}else await S((async()=>{try{t.setContent(a?.()??await e())}catch(t){i?.(t)}}))})),m),stopAutoLoad:()=>(A&&(n(v),v=void 0,A=0),m),save:async e=>(1!=g&&(g=2,await m.schedule((async()=>{try{await a(t.getContent,e)}catch(t){i?.(t)}g=0}))),m),startAutoSave:async()=>(await m.stopAutoSave().save(),f=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();u(a)&&u(s)||m.save((()=>[a,s]))})),m),stopAutoSave:()=>{var e,a;return e=f,a=t.delListener,o(e)||a(e),m},schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(d(h,r),...t),await(async()=>{if(!d(w,r)){for(l(w,r,1);!o((t=d(h,r),y=t.shift()));)try{await y()}catch(t){i?.(t)}l(w,r,0)}var t})(),m),getStore:()=>t,destroy:()=>m.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return c(m)})(t,(async()=>f(await a.readFile(r,s))),(async t=>{return await a.writeFile(r,(e=t(),JSON.stringify(e,((t,e)=>n(e,Map)?i.fromEntries([...e]):e))),s);var e}),(t=>e.watch(r,(()=>t()))),(t=>t?.close()),y)},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("fs"),require("fs/promises")):"function"==typeof define&&define.amd?define(["exports","fs","fs/promises"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterFile={},t.fs,t["fs/promises"]);
