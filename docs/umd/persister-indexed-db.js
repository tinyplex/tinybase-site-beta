var t,e;t=this,e=function(t){"use strict";const e=(t,e)=>t.map(e),a=(t,...e)=>t.push(...e),s=Promise,n=setInterval,o=clearInterval,r=t=>null==t,c=(t,e,a)=>r(t)?a?.():e(t),i=t=>new s(t),d=async t=>s.all(t),y=Object,l=y.keys,u=y.freeze,w=t=>(t=>t instanceof y&&t.constructor==y)(t)&&0==(t=>l(t).length)(t),h=t=>new Map(t),p=(t,e)=>t?.get(e),f=(t,e,a)=>{return r(a)?(s=t,n=e,s?.delete(n),t):t?.set(e,a);var s,n},v=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||f(t,e,a()),p(t,e)},g=h(),b=h(),A=globalThis.window,S=["t","v"],x={keyPath:"k"},j=async(t,s)=>{const n=((a,s)=>e(y.entries(a),(([e,a])=>L(t,"put",{k:e,v:a}))))(s);e(await L(t,"getAllKeys"),(e=>((t,e)=>!r(((t,e)=>c(t,(t=>t[e])))(t,e)))(s,e)?0:a(n,L(t,"delete",e)))),await d(n)},L=async(t,e,a)=>i(((s,n)=>{const o=t[e](a);o.onsuccess=()=>s(o.result),o.onerror=()=>n(`objectStore.${e} error`)}));t.createIndexedDbPersister=(t,s,l=1,h)=>{const T=async(t,a=[],n=0)=>i(((o,r)=>{const c=A.indexedDB.open(s,1);c.onupgradeneeded=()=>n&&e(S,(t=>c.result.createObjectStore(t,x))),c.onsuccess=async()=>{try{const s=c.result.transaction(S,"readwrite"),n=await d(e(S,(async(e,n)=>await t(s.objectStore(e),a[n]))));c.result.close(),o(n)}catch(t){r(t)}},c.onerror=()=>r("indexedDB.open error")}));return((t,e,s,n,o,i,d=[])=>{let y,l,h,A=0,S=0;v(g,d,(()=>0)),v(b,d,(()=>[]));const x=async t=>(2!=A&&(A=1,await j.schedule((async()=>{await t(),A=0}))),j),j={load:async(a,s)=>await x((async()=>{try{t.setContent(await e())}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},s={})=>(j.stopAutoLoad(),await j.load(a,s),S=1,h=n((async(a,s)=>{if(s){const e=s();await x((async()=>t.setTransactionChanges(e)))}else await x((async()=>{try{t.setContent(a?.()??await e())}catch(t){i?.(t)}}))})),j),stopAutoLoad:()=>(S&&(o(h),h=void 0,S=0),j),save:async e=>(1!=A&&(A=2,await j.schedule((async()=>{try{await s(t.getContent,e)}catch(t){i?.(t)}A=0}))),j),startAutoSave:async()=>(await j.stopAutoSave().save(),y=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();w(a)&&w(s)||j.save((()=>[a,s]))})),j),stopAutoSave:()=>(c(y,t.delListener),j),schedule:async(...t)=>(a(p(b,d),...t),await(async()=>{if(!p(g,d)){for(f(g,d,1);!r((t=p(b,d),l=t.shift()));)try{await l()}catch(t){i?.(t)}f(g,d,0)}var t})(),j),getStore:()=>t,destroy:()=>j.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return u(j)})(t,(async()=>await T((async t=>((t=[])=>y.fromEntries(t))(e(await L(t,"getAll"),(({k:t,v:e})=>[t,e])))))),(async t=>await T((async(t,e)=>await j(t,e)),t(),1)),(t=>n(t,1e3*l)),(t=>o(t)),h)},t.objectStoreMatch=j},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterIndexedDb={});
