var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n=t(""),s=t(!0),r=t(0),o=t(t),a="Listener",i="Result",l="Ids",d="Table",c="Row",u=c+l,f="Sorted"+c+l,h="Cell",g=h+l,v=(e,t)=>e.every(t),w=(e,t)=>e.forEach(t),y=e=>p(e,((e,t)=>e+t),0),L=e=>e.length,R=e=>0==L(e),p=(e,t,n)=>e.reduce(t,n),T=(e,...t)=>e.push(...t),b=Math.max,m=Math.min,C=isFinite,Q=e=>null==e,S=(e,t,n)=>Q(e)?n?.():t(e),x=e=>t(e)==o,I=e=>Array.isArray(e),E=()=>{},M=Object,j=M.freeze,D=e=>e.size,k=(e,t)=>e?.has(t)??!1,z=e=>Q(e)||0==D(e),A=e=>[...e?.values()??[]],F=e=>e.clear(),B=(e,t)=>e?.forEach(t),O=(e,t)=>e?.delete(t),W=e=>new Map(e),q=(e,t)=>e?.get(t),G=(e,t)=>B(e,((e,n)=>t(n,e))),H=(e,t,n)=>Q(n)?(O(e,t),e):e?.set(t,n),J=(e,t,n)=>(k(e,t)||H(e,t,n()),q(e,t)),K=(e,t,n,s,r=0)=>S((n?J:q)(e,t[r],r>L(t)-2?n:W),(o=>{if(r>L(t)-2)return s?.(o)&&H(e,t[r]),o;const a=K(o,t,n,s,r+1);return z(o)&&H(e,t[r]),a})),N=e=>new Set(I(e)||Q(e)?e:[e]),P=(e,t)=>e?.add(t),U=W([["avg",[(e,t)=>y(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,s)=>e+(t-n)/s]],["max",[e=>b(...e),(e,t)=>b(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:b(t,e)]],["min",[e=>m(...e),(e,t)=>m(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:m(t,e)]],["sum",[e=>y(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),V=(e=>{const o=new WeakMap;return e=>(o.has(e)||o.set(e,(e=>{const o=e.createStore,[l,y,p,b,m,,,V,,X,Y,Z,$]=((e,t,n)=>{const s=e.hasRow,r=W(),o=W(),a=W(),i=W(),l=W(),d=(t,n,...s)=>{const r=J(l,t,N);return w(s,(t=>P(r,t)&&n&&e.callListener(t))),s},c=(t,...n)=>S(q(l,t),(s=>{w(R(n)?A(s):n,(t=>{e.delListener(t),O(s,t)})),z(s)&&H(l,t)})),u=(e,t)=>{H(r,e,t),k(o,e)||(H(o,e,!0),H(a,e,W()),H(i,e,W()))},f=e=>{H(r,e),H(o,e),H(a,e),H(i,e),c(e)};return[()=>e,()=>{return e=r,[...e?.keys()??[]];var e},e=>G(o,e),e=>k(o,e),e=>q(r,e),e=>q(o,e),(e,t)=>H(o,e,t),u,(t,r,o,l,f)=>{u(t,r);const h=W(),g=W(),y=q(a,t),R=q(i,t),p=t=>{const o=n=>e.getCell(r,t,n),a=q(y,t),i=s(r,t)?n(l(o,t)):void 0;var d,c;if(a===i||I(a)&&I(i)&&(c=i,L(d=a)===L(c)&&v(d,((e,t)=>c[t]===e)))||H(h,t,[a,i]),!Q(f)){const e=q(R,t),n=s(r,t)?f(o,t):void 0;e!=n&&H(g,t,n)}},T=e=>{o((()=>{B(h,(([,e],t)=>H(y,t,e))),B(g,((e,t)=>H(R,t,e)))}),h,g,y,R,e),F(h),F(g)};G(y,p),e.hasTable(r)&&w(e.getRowIds(r),(e=>{k(y,e)||p(e)})),T(!0),c(t),d(t,0,e.addRowListener(r,null,((e,t,n)=>p(n))),e.addTableListener(r,(()=>T())))},f,()=>G(l,f),d,c]})(e,0,E),_=o(),ee=o(),te=W(),ne=(e,t,...n)=>w(n,(n=>P(J(J(te,t,W),e,N),n))),se=e=>{S(q(te,e),(e=>{G(e,((e,t)=>B(t,(t=>e.delListener(t))))),F(e)})),w([ee,_],(t=>t.delTable(e)))},re=(e,t,n)=>ne(t,e,t.addStartTransactionListener(n.startTransaction),t.addDidFinishTransactionListener((()=>n.finishTransaction()))),oe={setQueryDefinition:(o,a,i)=>{V(o,a),se(o);const l=[],d=[[null,[a,null,null,[],W()]]],c=[],u=[],f=[];i({select:(e,t)=>{const n=x(e)?[L(l)+"",e]:[Q(t)?e:t,n=>n(e,t)];return T(l,n),{as:e=>n[0]=e}},join:(e,t,n)=>{const s=Q(n)||x(t)?null:t,r=Q(s)?t:n,o=[e,[e,s,x(r)?r:e=>e(r),[],W()]];return T(d,o),{as:e=>o[0]=e}},where:(e,t,n)=>T(c,x(e)?e:Q(n)?n=>n(e)===t:s=>s(e,t)===n),group:(e,t,n,s,r)=>{const o=[e,[e,x(t)?[t,n,s,r]:q(U,t)??[(e,t)=>t]]];return T(u,o),{as:e=>o[0]=e}},having:(e,t)=>T(f,x(e)?e:n=>n(e)===t)});const h=W(l);if(z(h))return oe;const g=W(d);G(g,((e,[,t])=>S(q(g,t),(({3:t})=>Q(e)?0:T(t,e)))));const y=W(u);let p=_;if(z(y)&&R(f))p=ee;else{re(o,p,ee);const e=W();G(y,((t,[n,s])=>P(J(e,n,N),[t,s])));const a=N();G(h,(t=>k(e,t)?0:P(a,t)));const i=W(),l=(a,i,l,d)=>S(a,(([c,u,h,g])=>{G(i,((o,[a])=>{const i=J(c,o,W),u=q(i,l),f=d?void 0:a;if(u!==f){const a=N([[u,f]]),d=D(i);H(i,l,f),B(q(e,o),(([e,o])=>{const l=((e,t,n,s,r,o=!1)=>{if(z(n))return;const[a,i,l,d]=r;return o||=Q(e),B(s,(([n,s])=>{o||(e=Q(n)?i?.(e,s,t++):Q(s)?l?.(e,n,t--):d?.(e,s,n,t),o||=Q(e))})),o?a(A(n),D(n)):e})(g[e],d,i,a,o);g[e]=Q((e=>{const o=t(e);return(e=>e==n||e==s)(o)||o==r&&C(e)?o:void 0})(l))?null:l}))}})),z(u)||!v(f,(e=>e((e=>g[e]))))?ee.delRow(o,h):Q(h)?a[2]=ee.addRow(o,g):ee.setRow(o,h,g)}));ne(p,o,p.addRowListener(o,null,((t,n,s,r)=>{const d=[],c=[],u=W(),f=p.hasRow(o,s);let h=!f;B(a,(e=>{const[t,n,a]=r(o,s,e);T(d,n),T(c,a),h||=t})),G(e,(e=>{const[t,,n]=r(o,s,e);(h||t)&&H(u,e,[n])})),h&&l(K(i,d,void 0,(([,e])=>(O(e,s),z(e)))),u,s,1),f&&l(K(i,c,(()=>{const e={};return B(a,(t=>e[t]=p.getCell(o,s,t))),[W(),N(),void 0,e]}),(([,e])=>{P(e,s)})),u,s)})))}re(o,e,p);const b=(t,n,s,r)=>{const i=t=>e.getCell(n,s,t);w(r,(n=>{const[s,,r,a,l]=q(g,n),d=r?.(i,t),[c,u]=q(l,t)??[];d!=c&&(Q(u)||$(o,u),H(l,t,Q(d)?null:[d,...Z(o,1,e.addRowListener(s,d,(()=>b(t,s,d,a))))]))})),(t=>{const n=(n,s)=>e.getCell(...Q(s)?[a,t,n]:n===a?[a,t,s]:[q(g,n)?.[0],q(q(g,n)?.[4],t)?.[0],s]);p.transaction((()=>v(c,(e=>e(n)))?G(h,((e,s)=>((e,t,n,s,r)=>Q(r)?e.delCell(t,n,s,!0):e.setCell(t,n,s,r))(p,o,t,e,s(n,t)))):p.delRow(o,t)))})(t)},{3:m}=q(g,null);return p.transaction((()=>Z(o,1,e.addRowListener(a,null,((t,n,s)=>{e.hasRow(a,s)?b(s,a,s,m):(p.delRow(o,s),B(g,(({4:e})=>S(q(e,s),(([,t])=>{$(o,t),H(e,s)})))))}))))),oe},delQueryDefinition:e=>(se(e),X(e),oe),getStore:l,getQueryIds:y,forEachQuery:p,hasQuery:b,getTableId:m,delListener:e=>(ee.delListener(e),oe),destroy:Y,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:n,...s}=ee.getListenerStats();return s}};var ae,ie;return ae={[d]:[1,1],[d+g]:[0,1],[u]:[0,1],[f]:[0,5],[c]:[1,2],[g]:[0,2],[h]:[1,3]},ie=([e,t],n)=>{w(e?["get","has","forEach"]:["get"],(e=>oe[e+i+n]=(...t)=>ee[e+n](...t))),oe["add"+i+n+a]=(...e)=>{return ee["add"+n+a](...(s=e,0,r=t,s.slice(0,r)),((n,...s)=>e[t](oe,...s)));var s,r}},((e,t)=>{e.map(t)})(M.entries(ae),(([e,t])=>ie(t,e))),j(oe)})(e)),o.get(e))})();e.createQueries=V},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseQueries={});
