var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n=t(""),s=t(!0),r=t(0),o=t(t),i="Listener",l=(e,t)=>e.every(t),a=(e,t)=>e.forEach(t),d=e=>f(e,((e,t)=>e+t),0),c=e=>e.length,u=e=>0==c(e),f=(e,t,n)=>e.reduce(t,n),h=(e,...t)=>e.push(...t),g=Math.max,w=Math.min,v=isFinite,R=e=>null==e,y=(e,t,n)=>R(e)?n?.():t(e),L=e=>t(e)==o,p=e=>Array.isArray(e),T=()=>{},b=e=>e.size,m=(e,t)=>e?.has(t)??!1,C=e=>R(e)||0==b(e),I=e=>[...e?.values()??[]],Q=e=>e.clear(),S=(e,t)=>e?.forEach(t),x=(e,t)=>e?.delete(t),E=e=>new Map(e),M=(e,t)=>e?.get(t),j=(e,t)=>S(e,((e,n)=>t(n,e))),D=(e,t,n)=>R(n)?(x(e,t),e):e?.set(t,n),F=(e,t,n)=>(m(e,t)||D(e,t,n()),M(e,t)),k=(e,t,n,s,r=0)=>y((n?F:M)(e,t[r],r>c(t)-2?n:E),(o=>{if(r>c(t)-2)return s?.(o)&&D(e,t[r]),o;const i=k(o,t,n,s,r+1);return C(o)&&D(e,t[r]),i})),z=e=>new Set(p(e)||R(e)?e:[e]),A=(e,t)=>e?.add(t),W=E([["avg",[(e,t)=>d(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,s)=>e+(t-n)/s]],["max",[e=>g(...e),(e,t)=>g(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:g(t,e)]],["min",[e=>w(...e),(e,t)=>w(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:w(t,e)]],["sum",[e=>d(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),B=Object,O=B.freeze,q=(e=>{const o=new WeakMap;return e=>(o.has(e)||o.set(e,(e=>{const o=e.createStore,[d,f,g,w,q,,,G,,H,J,K,N]=((e,t,n)=>{const s=e.hasRow,r=E(),o=E(),i=E(),d=E(),f=E(),h=(t,n,...s)=>{const r=F(f,t,z);return a(s,(t=>A(r,t)&&n&&e.callListener(t))),s},g=(t,...n)=>y(M(f,t),(s=>{a(u(n)?I(s):n,(t=>{e.delListener(t),x(s,t)})),C(s)&&D(f,t)})),w=(e,t)=>{D(r,e,t),m(o,e)||(D(o,e,!0),D(i,e,E()),D(d,e,E()))},v=e=>{D(r,e),D(o,e),D(i,e),D(d,e),g(e)};return[()=>e,()=>[...r?.keys()??[]],e=>j(o,e),e=>m(o,e),e=>M(r,e),e=>M(o,e),(e,t)=>D(o,e,t),w,(t,r,o,u,f)=>{w(t,r);const v=E(),y=E(),L=M(i,t),T=M(d,t),b=t=>{const o=n=>e.getCell(r,t,n),i=M(L,t),a=s(r,t)?n(u(o,t)):void 0;var d,h;if(i===a||p(i)&&p(a)&&(h=a,c(d=i)===c(h)&&l(d,((e,t)=>h[t]===e)))||D(v,t,[i,a]),!R(f)){const e=M(T,t),n=s(r,t)?f(o,t):void 0;e!=n&&D(y,t,n)}},C=e=>{o((()=>{S(v,(([,e],t)=>D(L,t,e))),S(y,((e,t)=>D(T,t,e)))}),v,y,L,T,e),Q(v),Q(y)};j(L,b),e.hasTable(r)&&a(e.getRowIds(r),(e=>{m(L,e)||b(e)})),C(!0),g(t),h(t,0,e.addRowListener(r,null,((e,t,n)=>b(n))),e.addTableListener(r,(()=>C())))},v,()=>j(f,v),h,g]})(e,0,T),P=o(),U=o(),V=E(),X=(e,t,...n)=>a(n,(n=>A(F(F(V,t,E),e,z),n))),Y=e=>{y(M(V,e),(e=>{j(e,((e,t)=>S(t,(t=>e.delListener(t))))),Q(e)})),a([U,P],(t=>t.delTable(e)))},Z=(e,t,n)=>X(t,e,t.addWillFinishTransactionListener(n.startTransaction),t.addDidFinishTransactionListener((()=>n.finishTransaction()))),$={setQueryDefinition:(o,i,d)=>{G(o,i),Y(o);const f=[],g=[[null,[i,null,null,[],E()]]],w=[],p=[],T=[];d({select:(e,t)=>{const n=L(e)?[c(f)+"",e]:[R(t)?e:t,n=>n(e,t)];return h(f,n),{as:e=>n[0]=e}},join:(e,t,n)=>{const s=R(n)||L(t)?null:t,r=R(s)?t:n,o=[e,[e,s,L(r)?r:e=>e(r),[],E()]];return h(g,o),{as:e=>o[0]=e}},where:(e,t,n)=>h(w,L(e)?e:R(n)?n=>n(e)===t:s=>s(e,t)===n),group:(e,t,n,s,r)=>{const o=[e,[e,L(t)?[t,n,s,r]:M(W,t)??[(e,t)=>t]]];return h(p,o),{as:e=>o[0]=e}},having:(e,t)=>h(T,L(e)?e:n=>n(e)===t)});const Q=E(f);if(C(Q))return $;const B=E(g);j(B,((e,[,t])=>y(M(B,t),(({3:t})=>R(e)?0:h(t,e)))));const O=E(p);let q=P;if(C(O)&&u(T))q=U;else{Z(o,q,U);const e=E();j(O,((t,[n,s])=>A(F(e,n,z),[t,s])));const i=z();j(Q,(t=>m(e,t)?0:A(i,t)));const a=E(),d=(i,a,d,c)=>y(i,(([u,f,h,g])=>{j(a,((o,[i])=>{const l=F(u,o,E),a=M(l,d),f=c?void 0:i;if(a!==f){const i=z([[a,f]]),c=b(l);D(l,d,f),S(M(e,o),(([e,o])=>{const a=((e,t,n,s,r,o=!1)=>{if(C(n))return;const[i,l,a,d]=r;return o||=R(e),S(s,(([n,s])=>{o||(e=R(n)?l?.(e,s,t++):R(s)?a?.(e,n,t--):d?.(e,s,n,t),o||=R(e))})),o?i(I(n),b(n)):e})(g[e],c,l,i,o);g[e]=R((e=>{const o=t(e);return(e=>e==n||e==s)(o)||o==r&&v(e)?o:void 0})(a))?null:a}))}})),C(f)||!l(T,(e=>e((e=>g[e]))))?U.delRow(o,h):R(h)?i[2]=U.addRow(o,g):U.setRow(o,h,g)}));X(q,o,q.addRowListener(o,null,((t,n,s,r)=>{const l=[],c=[],u=E(),f=q.hasRow(o,s);let g=!f;S(i,(e=>{const[t,n,i]=r(o,s,e);h(l,n),h(c,i),g||=t})),j(e,(e=>{const[t,,n]=r(o,s,e);(g||t)&&D(u,e,[n])})),g&&d(k(a,l,void 0,(([,e])=>(x(e,s),C(e)))),u,s,1),f&&d(k(a,c,(()=>{const e={};return S(i,(t=>e[t]=q.getCell(o,s,t))),[E(),z(),void 0,e]}),(([,e])=>{A(e,s)})),u,s)})))}Z(o,e,q);const H=(t,n,s,r)=>{const d=t=>e.getCell(n,s,t);a(r,(n=>{const[s,,r,i,l]=M(B,n),a=r?.(d,t),[c,u]=M(l,t)??[];a!=c&&(R(u)||N(o,u),D(l,t,R(a)?null:[a,...K(o,1,e.addRowListener(s,a,(()=>H(t,s,a,i))))]))})),(t=>{const n=(n,s)=>e.getCell(...R(s)?[i,t,n]:n===i?[i,t,s]:[M(B,n)?.[0],M(M(B,n)?.[4],t)?.[0],s]);q.transaction((()=>l(w,(e=>e(n)))?j(Q,((e,s)=>((e,t,n,s,r)=>R(r)?e.delCell(t,n,s,!0):e.setCell(t,n,s,r))(q,o,t,e,s(n,t)))):q.delRow(o,t)))})(t)},{3:J}=M(B,null);return q.transaction((()=>K(o,1,e.addRowListener(i,null,((t,n,s)=>{e.hasRow(i,s)?H(s,i,s,J):(q.delRow(o,s),S(B,(({4:e})=>y(M(e,s),(([,t])=>{N(o,t),D(e,s)})))))}))))),$},delQueryDefinition:e=>(Y(e),H(e),$),getStore:d,getQueryIds:f,forEachQuery:g,hasQuery:w,getTableId:q,delListener:e=>(U.delListener(e),$),destroy:J,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:n,...s}=U.getListenerStats();return s}};var _,ee;return _={Table:[1,1],RowIds:[0,1],SortedRowIds:[0,5],Row:[1,2],CellIds:[0,2],Cell:[1,3]},ee=([e,t],n)=>{a(e?["get","has","forEach"]:["get"],(e=>$[e+"Result"+n]=(...t)=>U[e+n](...t))),$["addResult"+n+i]=(...e)=>{return U["add"+n+i](...(s=e,0,r=t,s.slice(0,r)),((n,...s)=>e[t]($,...s)));var s,r}},((e,t)=>{e.map(t)})(B.entries(_),(([e,t])=>ee(t,e))),O($)})(e)),o.get(e))})();e.createQueries=q},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseQueries={});
