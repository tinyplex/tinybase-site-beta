var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n=t(""),s=t(!0),r=t(0),o=t(t),i="Listener",l="Result",a=(e,t)=>e.every(t),d=(e,t)=>e.forEach(t),c=e=>h(e,((e,t)=>e+t),0),u=e=>e.length,f=e=>0==u(e),h=(e,t,n)=>e.reduce(t,n),g=(e,...t)=>e.push(...t),w=Math.max,v=Math.min,R=isFinite,y=e=>null==e,L=(e,t,n)=>y(e)?n?.():t(e),p=e=>t(e)==o,T=e=>Array.isArray(e),b=()=>{},C=e=>e.size,m=(e,t)=>e?.has(t)??!1,I=e=>y(e)||0==C(e),Q=e=>[...e?.values()??[]],S=e=>e.clear(),x=(e,t)=>e?.forEach(t),E=(e,t)=>e?.delete(t),M=e=>new Map(e),j=(e,t)=>e?.get(t),D=(e,t)=>x(e,((e,n)=>t(n,e))),F=(e,t,n)=>y(n)?(E(e,t),e):e?.set(t,n),k=(e,t,n)=>(m(e,t)||F(e,t,n()),j(e,t)),z=(e,t,n,s,r=0)=>L((n?k:j)(e,t[r],r>u(t)-2?n:M),(o=>{if(r>u(t)-2)return s?.(o)&&F(e,t[r]),o;const i=z(o,t,n,s,r+1);return I(o)&&F(e,t[r]),i})),A=e=>new Set(T(e)||y(e)?e:[e]),W=(e,t)=>e?.add(t),B=M([["avg",[(e,t)=>c(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,s)=>e+(t-n)/s]],["max",[e=>w(...e),(e,t)=>w(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:w(t,e)]],["min",[e=>v(...e),(e,t)=>v(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:v(t,e)]],["sum",[e=>c(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),O=e=>{const o=t(e);return(e=>e==n||e==s)(o)||o==r&&R(e)?o:void 0},q=(e,t,n)=>{const s=e.hasRow,r=M(),o=M(),i=M(),l=M(),c=M(),h=(t,n,...s)=>{const r=k(c,t,A);return d(s,(t=>W(r,t)&&n&&e.callListener(t))),s},g=(t,...n)=>L(j(c,t),(s=>{d(f(n)?Q(s):n,(t=>{e.delListener(t),E(s,t)})),I(s)&&F(c,t)})),w=(e,n)=>{F(r,e,n),m(o,e)||(F(o,e,t()),F(i,e,M()),F(l,e,M()))},v=e=>{F(r,e),F(o,e),F(i,e),F(l,e),g(e)};return[()=>e,()=>[...r?.keys()??[]],e=>D(o,e),e=>m(o,e),e=>j(r,e),e=>j(o,e),(e,t)=>F(o,e,t),w,(t,r,o,c,f)=>{w(t,r);const v=M(),R=M(),L=j(i,t),p=j(l,t),b=t=>{const o=n=>e.getCell(r,t,n),i=j(L,t),l=s(r,t)?n(c(o,t)):void 0;var d,h;if(i===l||T(i)&&T(l)&&(h=l,u(d=i)===u(h)&&a(d,((e,t)=>h[t]===e)))||F(v,t,[i,l]),!y(f)){const e=j(p,t),n=s(r,t)?f(o,t):void 0;e!=n&&F(R,t,n)}},C=e=>{o((()=>{x(v,(([,e],t)=>F(L,t,e))),x(R,((e,t)=>F(p,t,e)))}),v,R,L,p,e),S(v),S(R)};D(L,b),e.hasTable(r)&&d(e.getRowIds(r),(e=>{m(L,e)||b(e)})),C(!0),g(t),h(t,0,e.addRowListener(r,null,((e,t,n)=>b(n))),e.addTableListener(r,(()=>C())))},v,()=>D(c,v),h,g]},G=Object,H=G.freeze,J=(e=>{const t=new WeakMap;return n=>(t.has(n)||t.set(n,e(n)),t.get(n))})((e=>{const t=e.createStore,[n,s,r,o,c,,,h,,w,v,R,T]=q(e,(()=>!0),b),J=t(),K=t(),N=M(),P=(e,t,...n)=>d(n,(n=>W(k(k(N,t,M),e,A),n))),U=e=>{L(j(N,e),(e=>{D(e,((e,t)=>x(t,(t=>e.delListener(t))))),S(e)})),d([K,J],(t=>t.delTable(e)))},V=(e,t,n)=>P(t,e,t.addWillFinishTransactionListener(n.startTransaction),t.addDidFinishTransactionListener((()=>n.finishTransaction()))),X={setQueryDefinition:(t,n,s)=>{h(t,n),U(t);const r=[],o=[[null,[n,null,null,[],M()]]],i=[],l=[],c=[];s({select:(e,t)=>{const n=p(e)?[u(r)+"",e]:[y(t)?e:t,n=>n(e,t)];return g(r,n),{as:e=>n[0]=e}},join:(e,t,n)=>{const s=y(n)||p(t)?null:t,r=y(s)?t:n,i=[e,[e,s,p(r)?r:e=>e(r),[],M()]];return g(o,i),{as:e=>i[0]=e}},where:(e,t,n)=>g(i,p(e)?e:y(n)?n=>n(e)===t:s=>s(e,t)===n),group:(e,t,n,s,r)=>{const o=[e,[e,p(t)?[t,n,s,r]:j(B,t)??[(e,t)=>t]]];return g(l,o),{as:e=>o[0]=e}},having:(e,t)=>g(c,p(e)?e:n=>n(e)===t)});const w=M(r);if(I(w))return X;const v=M(o);D(v,((e,[,t])=>L(j(v,t),(({3:t})=>y(e)?0:g(t,e)))));const b=M(l);let S=J;if(I(b)&&f(c))S=K;else{V(t,S,K);const e=M();D(b,((t,[n,s])=>W(k(e,n,A),[t,s])));const n=A();D(w,(t=>m(e,t)?0:W(n,t)));const s=M(),r=(n,s,r,o)=>L(n,(([i,l,d,u])=>{D(s,((t,[n])=>{const s=k(i,t,M),l=j(s,r),a=o?void 0:n;if(l!==a){const n=A([[l,a]]),o=C(s);F(s,r,a),x(j(e,t),(([e,t])=>{const r=((e,t,n,s,r,o=!1)=>{if(I(n))return;const[i,l,a,d]=r;return o||=y(e),x(s,(([n,s])=>{o||(e=y(n)?l?.(e,s,t++):y(s)?a?.(e,n,t--):d?.(e,s,n,t),o||=y(e))})),o?i(Q(n),C(n)):e})(u[e],o,s,n,t);u[e]=y(O(r))?null:r}))}})),I(l)||!a(c,(e=>e((e=>u[e]))))?K.delRow(t,d):y(d)?n[2]=K.addRow(t,u):K.setRow(t,d,u)}));P(S,t,S.addRowListener(t,null,((o,i,l,a)=>{const d=[],c=[],u=M(),f=S.hasRow(t,l);let h=!f;x(n,(e=>{const[n,s,r]=a(t,l,e);g(d,s),g(c,r),h||=n})),D(e,(e=>{const[n,,s]=a(t,l,e);(h||n)&&F(u,e,[s])})),h&&r(z(s,d,void 0,(([,e])=>(E(e,l),I(e)))),u,l,1),f&&r(z(s,c,(()=>{const e={};return x(n,(n=>e[n]=S.getCell(t,l,n))),[M(),A(),void 0,e]}),(([,e])=>{W(e,l)})),u,l)})))}V(t,e,S);const q=s=>{const r=(t,r)=>e.getCell(...y(r)?[n,s,t]:t===n?[n,s,r]:[j(v,t)?.[0],j(j(v,t)?.[4],s)?.[0],r]);S.transaction((()=>a(i,(e=>e(r)))?D(w,((e,n)=>((e,t,n,s,r)=>y(r)?e.delCell(t,n,s,!0):e.setCell(t,n,s,r))(S,t,s,e,n(r,s)))):S.delRow(t,s)))},G=(n,s,r,o)=>{const i=t=>e.getCell(s,r,t);d(o,(s=>{const[r,,o,l,a]=j(v,s),d=o?.(i,n),[c,u]=j(a,n)??[];d!=c&&(y(u)||T(t,u),F(a,n,y(d)?null:[d,...R(t,1,e.addRowListener(r,d,(()=>G(n,r,d,l))))]))})),q(n)},{3:H}=j(v,null);return S.transaction((()=>R(t,1,e.addRowListener(n,null,((s,r,o)=>{e.hasRow(n,o)?G(o,n,o,H):(S.delRow(t,o),x(v,(({4:e})=>L(j(e,o),(([,n])=>{T(t,n),F(e,o)})))))}))))),X},delQueryDefinition:e=>(U(e),w(e),X),getStore:n,getQueryIds:s,forEachQuery:r,hasQuery:o,getTableId:c,delListener:e=>(K.delListener(e),X),destroy:v,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:n,...s}=K.getListenerStats();return s}};var Y,Z;return Y={Table:[1,1],RowIds:[0,1],SortedRowIds:[0,5],Row:[1,2],CellIds:[0,2],Cell:[1,3]},Z=([e,t],n)=>{d(e?["get","has","forEach"]:["get"],(e=>X[e+l+n]=(...t)=>K[e+n](...t))),X["addResult"+n+i]=(...e)=>{return K["add"+n+i](...(s=e,r=0,o=t,s.slice(r,o)),((n,...s)=>e[t](X,...s)));var s,r,o}},d(G.entries(Y),(([e,t])=>Z(t,e))),H(X)}));e.createQueries=J},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseQueries={});
