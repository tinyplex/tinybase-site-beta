var t,e;t=this,e=function(t,e){"use strict";const s=t=>t.length,a=t=>t.shift(),n=t=>null==t,o=(t,e,s)=>n(t)?s?.():e(t),i=Object,r=i.freeze,c=(t=[])=>i.fromEntries(t),d=(t,e)=>!n(((t,e)=>o(t,(t=>t[e])))(t,e)),l=(t,e)=>((t,e)=>t.map(e))(i.entries(t),(([t,s])=>e(s,t))),u=(t,e,s)=>(d(t,e)||(t[e]=s()),t[e]),y=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,s)=>e(s,t))),g="t",f="delete",p=t=>[t.get(g),t.get("v")],v=(t,s,a,o)=>{const i=n(s)?t:t.get(s)??t.set(s,new e.Map);let r;return l(a,((t,e)=>{o(i,e,t)&&(r=1)})),i.forEach(((t,e)=>{d(a,e)||(i.delete(e),r=1)})),n(s)||i.size||t.delete(s),r};t.createYjsPersister=(t,i,d="tinybase")=>{const h=i.getMap(d);return((t,d,w,S,A)=>{let b,j,O,J=0,L=0,N=0;const C=[],T=async t=>{2!=J&&(J=1,await t(),J=0)},m={load:async(e={},s={})=>(await T((async()=>{try{t.setContent(await d())}catch{t.setContent([e,s])}})),m),startAutoLoad:async(e={},n={})=>(m.stopAutoLoad(),await m.load(e,n),N=1,O=(t=>{const e=e=>t(void 0,(()=>((t,e)=>{if(1==s(e)&&(n=e[0].path,0==s(n)))return[t.get("t").toJSON(),t.get("v").toJSON()];var n;const[i,r]=p(t),d={},l={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>a(t)==g?o(a(t),(s=>{const n=u(d,s,c),r=i.get(s);o(a(t),(t=>{const s=u(n,t,c),a=r.get(t);y(e,((t,{action:e})=>s[t]=e==f?null:a.get(t)))}),(()=>y(e,((t,{action:e})=>n[t]=e==f?null:r.get(t)?.toJSON()))))}),(()=>y(e,((t,{action:e})=>d[t]=e==f?null:i.get(t)?.toJSON())))):y(e,((t,{action:e})=>l[t]=e==f?null:r.get(t)))))})(e),[d,l]})(h,e)));return h.observeDeep(e),e})((async(e,s)=>{await T((async()=>{if(s)t.setTransactionChanges(s());else try{t.setContent(e?.()??await d())}catch{}}))})),m),stopAutoLoad:()=>{return N&&(t=O,h.unobserveDeep(t),O=void 0,N=0),m;var t},save:async s=>(await m.schedule((async()=>{if(1!=J){J=2;try{await(async(t,s)=>i.transact((()=>((t,s,a)=>{(t=>{t.size||(t.set(g,new e.Map),t.set("v",new e.Map))})(t);const[i,r]=p(t),c=()=>{d=1};let d=1;if(o(a?.(),(([t,e])=>{d=0,l(t,((t,e)=>d?0:n(t)?i.delete(e):o(i.get(e),(e=>l(t,((t,s)=>d?0:n(t)?e.delete(s):o(e.get(s),(e=>l(t,((t,s)=>n(t)?e.delete(s):e.set(s,t)))),c)))),c))),l(e,((t,e)=>d?0:n(t)?r.delete(e):r.set(e,t)))})),d){const[t,e]=s();v(i,void 0,t,((t,e,s)=>v(i,e,s,((t,e,s)=>v(t,e,s,((t,e,s)=>{if(t.get(e)!==s)return t.set(e,s),1})))))),v(r,void 0,e,((t,e,s)=>{r.get(e)!==s&&r.set(e,s)}))}})(h,t,s))))(t.getContent,s)}catch{}J=0}})),m),startAutoSave:async()=>(await m.stopAutoSave().save(),b=t.addDidFinishTransactionListener(((t,e)=>{const s=e();m.save((()=>s))})),m),stopAutoSave:()=>(o(b,t.delListener),m),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(C,...t),await(async()=>{if(!L){for(L=1;!n(j=a(C));)try{await j()}catch{}L=0}})(),m),getStore:()=>t,destroy:()=>m.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return r(m)})(t,(async()=>h.size?[h.get(g).toJSON(),h.get("v").toJSON()]:void 0))}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
