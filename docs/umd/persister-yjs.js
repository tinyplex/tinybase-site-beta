var t,e;t=this,e=function(t,e){"use strict";const s=t=>t.length,a=t=>t.shift(),n=t=>null==t,o=(t,e,s)=>n(t)?s?.():e(t),i=Object,r=i.freeze,c=()=>({}),d=(t,e)=>!n(((t,e)=>o(t,(t=>t[e])))(t,e)),l=(t,e)=>((t,e)=>t.map(e))(i.entries(t),(([t,s])=>e(s,t))),u=(t,e,s)=>(d(t,e)||(t[e]=s()),t[e]),g=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,s)=>e(s,t))),y="t",p="delete",f=t=>[t.get(y),t.get("v")],v=(t,s,a,o)=>{const i=n(s)?t:t.get(s)??t.set(s,new e.Map);let r;return l(a,((t,e)=>{o(i,e,t)&&(r=1)})),i.forEach(((t,e)=>{d(a,e)||(i.delete(e),r=1)})),n(s)||i.size||t.delete(s),r};t.createYjsPersister=(t,i,d="tinybase")=>{const h=i.getMap(d);return((t,d,S,w,A)=>{let b,j,O=0,J=!1;const L=async t=>{2!=O&&(O=1,await t(),O=0)},N={load:async(e={},s={})=>(await L((async()=>{let a;try{a=await d()}catch{}t.setContent(a??[e,s])})),N),startAutoLoad:async(e={},n={})=>(N.stopAutoLoad(),await N.load(e,n),J=!0,j=(e=>{const n=e=>(async(e,s)=>{await L((async()=>{if(s)t.setTransactionChanges(s());else try{t.setContent(e?.()??await d())}catch{}}))})(void 0,(()=>((t,e)=>{if(1==s(e)&&(n=e[0].path,0==s(n)))return[t.get("t").toJSON(),t.get("v").toJSON()];var n;const[i,r]=f(t),d={},l={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>a(t)==y?o(a(t),(s=>{const n=u(d,s,c),r=i.get(s);o(a(t),(t=>{const s=u(n,t,c),a=r.get(t);g(e,((t,{action:e})=>s[t]=e==p?null:a.get(t)))}),(()=>g(e,((t,{action:e})=>n[t]=e==p?null:r.get(t)?.toJSON()))))}),(()=>g(e,((t,{action:e})=>d[t]=e==p?null:i.get(t)?.toJSON())))):g(e,((t,{action:e})=>l[t]=e==p?null:r.get(t)))))})(e),[d,l]})(h,e)));return h.observeDeep(n),n})(),N),stopAutoLoad:()=>{return J&&(t=j,h.unobserveDeep(t),j=void 0,J=!1),N;var t},save:async s=>(1!=O&&(O=2,await(async(t,s)=>i.transact((()=>((t,s,a)=>{(t=>{t.size||(t.set(y,new e.Map),t.set("v",new e.Map))})(t);const[i,r]=f(t),c=()=>{d=1};let d=1;if(o(a?.(),(([t,e])=>{d=0,l(t,((t,e)=>d?0:n(t)?i.delete(e):o(i.get(e),(e=>l(t,((t,s)=>d?0:n(t)?e.delete(s):o(e.get(s),(e=>l(t,((t,s)=>n(t)?e.delete(s):e.set(s,t)))),c)))),c))),l(e,((t,e)=>d?0:n(t)?r.delete(e):r.set(e,t)))})),d){const[t,e]=s();v(i,void 0,t,((t,e,s)=>v(i,e,s,((t,e,s)=>v(t,e,s,((t,e,s)=>{if(t.get(e)!==s)return t.set(e,s),1})))))),v(r,void 0,e,((t,e,s)=>{r.get(e)!==s&&r.set(e,s)}))}})(h,t,s))))(t.getContent,s),O=0),N),startAutoSave:async()=>(await N.stopAutoSave().save(),b=t.addDidFinishTransactionListener(((t,e)=>N.save(e))),N),stopAutoSave:()=>(o(b,t.delListener),N),getStore:()=>t,destroy:()=>N.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return r(N)})(t,(async()=>h.size?[h.get(y).toJSON(),h.get("v").toJSON()]:void 0))}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
