var t,e;t=this,e=function(t,e){"use strict";const s=t=>t.length,a=t=>t.shift(),n=t=>null==t,o=(t,e,s)=>n(t)?s?.():e(t),c=Object,r=c.keys,i=c.freeze,d=(t=[])=>c.fromEntries(t),l=(t,e)=>!n(((t,e)=>o(t,(t=>t[e])))(t,e)),u=(t,e)=>((t,e)=>t.map(e))(c.entries(t),(([t,s])=>e(s,t))),y=t=>(t=>t instanceof c&&t.constructor==c)(t)&&0==(t=>s(r(t)))(t),g=(t,e,s)=>(l(t,e)||(t[e]=s()),t[e]),f=t=>new Map(t),p=(t,e)=>t?.get(e),h=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,s)=>e(s,t))),v=(t,e,s)=>{return n(s)?(a=t,o=e,a?.delete(o),t):t?.set(e,s);var a,o},w=(t,e,s)=>{var a,n;return a=t,n=e,a?.has(n)||v(t,e,s()),p(t,e)},S=f(),A=f(),b="t",j="delete",O=t=>[t.get(b),t.get("v")],J=(t,s,a,o)=>{const c=n(s)?t:t.get(s)??t.set(s,new e.Map);let r;return u(a,((t,e)=>{o(c,e,t)&&(r=1)})),c.forEach(((t,e)=>{l(a,e)||(c.delete(e),r=1)})),n(s)||c.size||t.delete(s),r};t.createYjsPersister=(t,c,r="tinybase",l)=>{const f=c.getMap(r);return((t,e,s,c,r,d,l=[])=>{let u,g,f,h=0,b=0;w(S,l,(()=>0)),w(A,l,(()=>[]));const j=async t=>(2!=h&&(h=1,await O.schedule((async()=>{await t(),h=0}))),O),O={load:async(s,a)=>await j((async()=>{try{t.setContent(await e())}catch{t.setContent([s,a])}})),startAutoLoad:async(s={},a={})=>(O.stopAutoLoad(),await O.load(s,a),b=1,f=c((async(s,a)=>{if(a){const e=a();await j((async()=>t.setTransactionChanges(e)))}else await j((async()=>{try{t.setContent(s?.()??await e())}catch(t){d?.(t)}}))})),O),stopAutoLoad:()=>(b&&(r(f),f=void 0,b=0),O),save:async e=>(1!=h&&(h=2,await O.schedule((async()=>{try{await s(t.getContent,e)}catch(t){d?.(t)}h=0}))),O),startAutoSave:async()=>(await O.stopAutoSave().save(),u=t.addDidFinishTransactionListener(((t,e)=>{const[s,a]=e();y(s)&&y(a)||O.save((()=>[s,a]))})),O),stopAutoSave:()=>(o(u,t.delListener),O),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(p(A,l),...t),await(async()=>{if(!p(S,l)){for(v(S,l,1);!n(g=a(p(A,l)));)try{await g()}catch(t){d?.(t)}v(S,l,0)}})(),O),getStore:()=>t,destroy:()=>O.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return i(O)})(t,(async()=>f.size?[f.get(b).toJSON(),f.get("v").toJSON()]:void 0),(async(t,s)=>c.transact((()=>((t,s,a)=>{(t=>{t.size||(t.set(b,new e.Map),t.set("v",new e.Map))})(t);const[c,r]=O(t),i=()=>{d=1};let d=1;if(o(a?.(),(([t,e])=>{d=0,u(t,((t,e)=>d?0:n(t)?c.delete(e):o(c.get(e),(e=>u(t,((t,s)=>d?0:n(t)?e.delete(s):o(e.get(s),(e=>u(t,((t,s)=>n(t)?e.delete(s):e.set(s,t)))),i)))),i))),u(e,((t,e)=>d?0:n(t)?r.delete(e):r.set(e,t)))})),d){const[t,e]=s();J(c,void 0,t,((t,e,s)=>J(c,e,s,((t,e,s)=>J(t,e,s,((t,e,s)=>{if(t.get(e)!==s)return t.set(e,s),1})))))),J(r,void 0,e,((t,e,s)=>{r.get(e)!==s&&r.set(e,s)}))}})(f,t,s)))),(t=>{const e=e=>t(void 0,(()=>((t,e)=>{if(1==s(e)&&(n=e[0].path,0==s(n)))return[t.get("t").toJSON(),t.get("v").toJSON()];var n;const[c,r]=O(t),i={},l={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>a(t)==b?o(a(t),(s=>{const n=g(i,s,d),r=c.get(s);o(a(t),(t=>{const s=g(n,t,d),a=r.get(t);h(e,((t,{action:e})=>s[t]=e==j?null:a.get(t)))}),(()=>h(e,((t,{action:e})=>n[t]=e==j?null:r.get(t)?.toJSON()))))}),(()=>h(e,((t,{action:e})=>i[t]=e==j?null:c.get(t)?.toJSON())))):h(e,((t,{action:e})=>l[t]=e==j?null:r.get(t)))))})(e),[i,l]})(f,e)));return f.observeDeep(e),e}),(t=>{f.unobserveDeep(t)}),l)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
