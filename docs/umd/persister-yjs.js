var e,t;e=this,t=function(e,t){"use strict";const a=e=>typeof e,s=a(""),n="t",o="v",r=e=>null==e,i=(e,t,a)=>r(e)?a?.():t(e),c=e=>e.length,g=e=>e.shift(),l=Object,d=e=>l.getPrototypeOf(e),u=l.entries,y=l.keys,p=l.freeze,f=(e=[])=>l.fromEntries(e),h=(e,t)=>t in e,v=(e,t)=>((e,t)=>e.map(t))(u(e),(([e,a])=>t(a,e))),w=e=>(e=>!r(e)&&i(d(e),(e=>e==l.prototype||r(d(e))),(()=>!0)))(e)&&0==(e=>c(y(e)))(e),S=(e,t,a)=>(h(e,t)||(e[t]=a()),e[t]),b=e=>new Map(e),A=(e,t)=>e?.get(t),C=(e,t)=>((e,t)=>e?.forEach(t))(e,((e,a)=>t(a,e))),M=(e,t,a)=>{return r(a)?(s=e,n=t,s?.delete(n),e):e?.set(t,a);var s,n},O=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)?s?.(A(e,t)):M(e,t,a()),A(e,t)},j=b(),L=b(),J="delete",N=e=>[e.get(n),e.get(o)],T=(e,a,s,n)=>{const o=r(a)?e:e.get(a)??e.set(a,new t.Map);let i;return v(s,((e,t)=>{n(o,t,e)&&(i=1)})),o.forEach(((e,t)=>{h(s,t)||(o.delete(t),i=1)})),r(a)||o.size||e.delete(a),i};e.createYjsPersister=(e,l,d="tinybase",u)=>{const y=l.getMap(d);return((e,t,n,o,c,l,d,u={},y=[])=>{let f,h,v,S=0;O(j,y,(()=>0)),O(L,y,(()=>[]));const[b,C,J,N]=((e,t)=>!e||r(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!w(e)||!w(t)]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!w(e)||!w(t)])(d,e),T=async e=>(2!=S&&(S=1,await z.schedule((async()=>{await e(),S=0}))),z),m=t=>{var n;(b&&(n=t?.[0],a(n)==s)?1===t?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},z={load:async(a,s)=>await T((async()=>{try{m(await t())}catch(t){l?.(t),e.setContent([a,s])}})),startAutoLoad:async(e={},a={})=>(await z.stopAutoLoad().load(e,a),h=o((async(e,a)=>{const s=a?.();await T((async()=>{try{m(s??e?.()??await t())}catch(e){l?.(e)}}))})),z),stopAutoLoad:()=>(h&&(c(h),h=void 0),z),isAutoLoading:()=>!r(h),save:async e=>(1!=S&&(S=2,await z.schedule((async()=>{try{await n(C,e)}catch(e){l?.(e)}S=0}))),z),startAutoSave:async()=>(await z.stopAutoSave().save(),v=e.addDidFinishTransactionListener((()=>{const e=J();N(e)&&z.save((()=>e))})),z),stopAutoSave:()=>(i(v,e.delListener),v=void 0,z),isAutoSaving:()=>!r(v),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(A(L,y),...e),await(async()=>{if(!A(j,y)){for(M(j,y,1);!r(f=g(A(L,y)));)try{await f()}catch(e){l?.(e)}M(j,y,0)}})(),z),getStore:()=>e,destroy:()=>z.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...u};return p(z)})(e,(async()=>y.size?[y.get(n).toJSON(),y.get(o).toJSON()]:void 0),(async(e,a)=>l.transact((()=>((e,a,s)=>{e.size||(e.set(n,new t.Map),e.set(o,new t.Map));const[c,g]=N(e),l=()=>{d=1};let d=1;if(i(s?.(),(([e,t])=>{d=0,v(e,((e,t)=>d?0:r(e)?c.delete(t):i(c.get(t),(t=>v(e,((e,a)=>d?0:r(e)?t.delete(a):i(t.get(a),(t=>v(e,((e,a)=>r(e)?t.delete(a):t.set(a,e)))),l)))),l))),v(t,((e,t)=>d?0:r(e)?g.delete(t):g.set(t,e)))})),d){const[e,t]=a();T(c,void 0,e,((e,t,a)=>T(c,t,a,((e,t,a)=>T(e,t,a,((e,t,a)=>{if(e.get(t)!==a)return e.set(t,a),1})))))),T(g,void 0,t,((e,t,a)=>{g.get(t)!==a&&g.set(t,a)}))}})(y,e,a)))),(e=>{const t=t=>e(void 0,(()=>((e,t)=>{if(1==c(t)&&(a=t[0].path,0==c(a)))return[e.get(n).toJSON(),e.get(o).toJSON(),1];var a;const[s,r]=N(e),l={},d={};return((e,t)=>{e.forEach((({path:e,changes:{keys:t}})=>g(e)==n?i(g(e),(a=>{const n=S(l,a,f),o=s.get(a);i(g(e),(e=>{const a=S(n,e,f),s=o.get(e);C(t,((e,{action:t})=>a[e]=t==J?null:s.get(e)))}),(()=>C(t,((e,{action:t})=>n[e]=t==J?null:o.get(e)?.toJSON()))))}),(()=>C(t,((e,{action:t})=>l[e]=t==J?null:s.get(e)?.toJSON())))):C(t,((e,{action:t})=>d[e]=t==J?null:r.get(e)))))})(t),[l,d,1]})(y,t)));return y.observeDeep(t),t}),(e=>{y.unobserveDeep(e)}),u,!1,{getYDoc:()=>l})}},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterYjs={},e.yjs);
