var e,t;e=this,t=function(e,t){"use strict";const a=e=>typeof e,s=a(""),n="t",o="v",r=e=>null==e,c=(e,t,a)=>r(e)?a?.():t(e),i=e=>e.length,l=e=>e.shift(),g=Object,d=e=>g.getPrototypeOf(e),y=g.entries,u=g.keys,p=g.freeze,f=(e=[])=>g.fromEntries(e),h=(e,t)=>t in e,v=(e,t)=>((e,t)=>e.map(t))(y(e),(([e,a])=>t(a,e))),w=e=>(e=>!r(e)&&c(d(e),(e=>e==g.prototype||r(d(e))),(()=>!0)))(e)&&0==(e=>i(u(e)))(e),b=(e,t,a)=>(h(e,t)||(e[t]=a()),e[t]),C=e=>new Map(e),S=(e,t)=>e?.get(t),M=(e,t)=>((e,t)=>e?.forEach(t))(e,((e,a)=>t(a,e))),A=(e,t,a)=>{return r(a)?(s=e,n=t,s?.delete(n),e):e?.set(t,a);var s,n},O=(e,t,a)=>{var s,n;return s=e,n=t,s?.has(n)||A(e,t,a()),S(e,t)},j=C(),J=C(),L=e=>{return t=e?.[0],a(t)==s;var t},N="delete",T=e=>[e.get(n),e.get(o)],m=(e,a,s,n)=>{const o=r(a)?e:e.get(a)??e.set(a,new t.Map);let c;return v(s,((e,t)=>{n(o,t,e)&&(c=1)})),o.forEach(((e,t)=>{h(s,t)||(o.delete(t),c=1)})),r(a)||o.size||e.delete(a),c};e.createYjsPersister=(e,a,s="tinybase",g)=>{const d=a.getMap(s);return((e,t,a,s,n,o,i,[g,d]=[],y=[])=>{let u,f,h,v=0,b=0;O(j,y,(()=>0)),O(J,y,(()=>[]));const[C,M,N,T]=((e,t)=>!e||r(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!w(e)||!w(t)]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!w(e)||!w(t)])(i,e),m=async e=>(2!=v&&(v=1,await z.schedule((async()=>{await e(),v=0}))),z),z={load:async(a,s)=>await m((async()=>{try{const a=await t();(C&&L(a)?e.setMergeableContent:e.setContent)(a)}catch{e.setContent([a,s])}})),startAutoLoad:async(a={},n={})=>(z.stopAutoLoad(),await z.load(a,n),b=1,h=s((async(a,s)=>{if(s){const t=s();await m((async()=>(C&&L(t)?e.applyMergeableChanges:e.applyChanges)(t)))}else await m((async()=>{try{const s=a?.()??await t();(C&&L(s)?e.setMergeableContent:e.setContent)(s)}catch(e){o?.(e)}}))})),z),stopAutoLoad:()=>(b&&(n(h),h=void 0,b=0),z),save:async e=>(1!=v&&(v=2,await z.schedule((async()=>{try{await a(M,e)}catch(e){o?.(e)}v=0}))),z),startAutoSave:async()=>(await z.stopAutoSave().save(),u=e.addDidFinishTransactionListener((()=>{const e=N();T(e)&&z.save((()=>e))})),z),stopAutoSave:()=>(c(u,e.delListener),u=void 0,z),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(S(J,y),...e),await(async()=>{if(!S(j,y)){for(A(j,y,1);!r(f=l(S(J,y)));)try{await f()}catch(e){o?.(e)}A(j,y,0)}})(),z),getStore:()=>e,destroy:()=>z.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return g&&(z[g]=()=>d),p(z)})(e,(async()=>d.size?[d.get(n).toJSON(),d.get(o).toJSON()]:void 0),(async(e,s)=>a.transact((()=>((e,a,s)=>{e.size||(e.set(n,new t.Map),e.set(o,new t.Map));const[i,l]=T(e),g=()=>{d=1};let d=1;if(c(s?.(),(([e,t])=>{d=0,v(e,((e,t)=>d?0:r(e)?i.delete(t):c(i.get(t),(t=>v(e,((e,a)=>d?0:r(e)?t.delete(a):c(t.get(a),(t=>v(e,((e,a)=>r(e)?t.delete(a):t.set(a,e)))),g)))),g))),v(t,((e,t)=>d?0:r(e)?l.delete(t):l.set(t,e)))})),d){const[e,t]=a();m(i,void 0,e,((e,t,a)=>m(i,t,a,((e,t,a)=>m(e,t,a,((e,t,a)=>{if(e.get(t)!==a)return e.set(t,a),1})))))),m(l,void 0,t,((e,t,a)=>{l.get(t)!==a&&l.set(t,a)}))}})(d,e,s)))),(e=>{const t=t=>e(void 0,(()=>((e,t)=>{if(1==i(t)&&(a=t[0].path,0==i(a)))return[e.get(n).toJSON(),e.get(o).toJSON()];var a;const[s,r]=T(e),g={},d={};return((e,t)=>{e.forEach((({path:e,changes:{keys:t}})=>l(e)==n?c(l(e),(a=>{const n=b(g,a,f),o=s.get(a);c(l(e),(e=>{const a=b(n,e,f),s=o.get(e);M(t,((e,{action:t})=>a[e]=t==N?null:s.get(e)))}),(()=>M(t,((e,{action:t})=>n[e]=t==N?null:o.get(e)?.toJSON()))))}),(()=>M(t,((e,{action:t})=>g[e]=t==N?null:s.get(e)?.toJSON())))):M(t,((e,{action:t})=>d[e]=t==N?null:r.get(e)))))})(t),[g,d]})(d,t)));return d.observeDeep(t),t}),(e=>{d.unobserveDeep(e)}),g,!1,["getYDoc",a])}},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterYjs={},e.yjs);
