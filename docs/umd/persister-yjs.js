var t,e;t=this,e=function(t,e){"use strict";const s=t=>t.length,a=t=>t.shift(),n=t=>null==t,o=(t,e,s)=>n(t)?s?.():e(t),i=Object,r=i.freeze,c=()=>({}),d=(t,e)=>!n(((t,e)=>o(t,(t=>t[e])))(t,e)),l=(t,e)=>((t,e)=>t.map(e))(i.entries(t),(([t,s])=>e(s,t))),u=(t,e,s)=>(d(t,e)||(t[e]=s()),t[e]),g=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,s)=>e(s,t))),y="delete",p=t=>[t.get("t"),t.get("v")],f=(t,s,a,o)=>{const i=n(s)?t:t.get(s)??t.set(s,new e.Map);let r;return l(a,((t,e)=>{o(i,e,t)&&(r=1)})),i.forEach(((t,e)=>{d(a,e)||(i.delete(e),r=1)})),n(s)||i.size||t.delete(s),r};t.createYjsPersister=(t,i,d="tinybase")=>{const v=i.getMap(d);return((t,d,h,S,w)=>{let A,b,j=0,O=!1;const J=async t=>{2!=j&&(j=1,await t(),j=0)},L={load:async(e,s)=>(await J((async()=>{let a;try{a=await d()}catch{}t.setContent(a??[e,s])})),L),startAutoLoad:async(e,n)=>(L.stopAutoLoad(),await L.load(e,n),O=!0,b=(e=>{const n=e=>(async(e,s)=>{await J((async()=>{if(s)t.setTransactionChanges(s());else try{t.setContent(e?.()??await d())}catch{}}))})(void 0,(()=>((t,e)=>{if(1==s(e)&&(n=e[0].path,0==s(n)))return[t.get("t").toJSON(),t.get("v").toJSON()];var n;const[i,r]=p(t),d={},l={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>"t"==a(t)?o(a(t),(s=>{const n=u(d,s,c),r=i.get(s);o(a(t),(t=>{const s=u(n,t,c),a=r.get(t);g(e,((t,{action:e})=>s[t]=e==y?null:a.get(t)))}),(()=>g(e,((t,{action:e})=>n[t]=e==y?null:r.get(t)?.toJSON()))))}),(()=>g(e,((t,{action:e})=>d[t]=e==y?null:i.get(t)?.toJSON())))):g(e,((t,{action:e})=>l[t]=e==y?null:r.get(t)))))})(e),[d,l]})(v,e)));return v.observeDeep(n),n})(),L),stopAutoLoad:()=>{return O&&(t=b,v.unobserveDeep(t),b=void 0,O=!1),L;var t},save:async s=>(1!=j&&(j=2,await(async(t,s)=>i.transact((()=>((t,s,a)=>{(t=>{t.size||(t.set("t",new e.Map),t.set("v",new e.Map))})(t);const[i,r]=p(t),c=()=>{d=1};let d=1;if(o(a?.(),(([t,e])=>{d=0,l(t,((t,e)=>d?0:n(t)?i.delete(e):o(i.get(e),(e=>l(t,((t,s)=>d?0:n(t)?e.delete(s):o(e.get(s),(e=>l(t,((t,s)=>n(t)?e.delete(s):e.set(s,t)))),c)))),c))),l(e,((t,e)=>d?0:n(t)?r.delete(e):r.set(e,t)))})),d){const[t,e]=s();f(i,void 0,t,((t,e,s)=>f(i,e,s,((t,e,s)=>f(t,e,s,((t,e,s)=>{if(t.get(e)!==s)return t.set(e,s),1})))))),f(r,void 0,e,((t,e,s)=>{r.get(e)!==s&&r.set(e,s)}))}})(v,t,s))))(t.getContent,s),j=0),L),startAutoSave:async()=>(await L.stopAutoSave().save(),A=t.addDidFinishTransactionListener(((t,e)=>L.save(e))),L),stopAutoSave:()=>(o(A,t.delListener),L),getStore:()=>t,destroy:()=>L.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return r(L)})(t,(async()=>v.size?[v.get("t").toJSON(),v.get("v").toJSON()]:void 0))}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
