var e,t;e=this,t=function(e,t){"use strict";const a="t",s="v",n=e=>null==e,o=(e,t,a)=>n(e)?a?.():t(e),r=e=>e.length,i=e=>e.shift(),c=Object,g=e=>c.getPrototypeOf(e),l=c.entries,d=c.keys,u=c.freeze,y=(e=[])=>c.fromEntries(e),p=(e,t)=>t in e,f=(e,t)=>((e,t)=>e.map(t))(l(e),(([e,a])=>t(a,e))),h=e=>(e=>!n(e)&&o(g(e),(e=>e==c.prototype||n(g(e))),(()=>!0)))(e)&&0==(e=>r(d(e)))(e),v=(e,t,a)=>(p(e,t)||(e[t]=a()),e[t]),w=e=>new Map(e),S=(e,t)=>e?.get(t),b=(e,t)=>((e,t)=>e?.forEach(t))(e,((e,a)=>t(a,e))),A=(e,t,a)=>{return n(a)?(s=e,o=t,s?.delete(o),e):e?.set(t,a);var s,o},C=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)?s?.(S(e,t)):A(e,t,a()),S(e,t)},M=w(),O=w(),j="delete",L=e=>[e.get(a),e.get(s)],J=(e,a,s,o)=>{const r=n(a)?e:e.get(a)??e.set(a,new t.Map);let i;return f(s,((e,t)=>{o(r,t,e)&&(i=1)})),r.forEach(((e,t)=>{p(s,t)||(r.delete(t),i=1)})),n(a)||r.size||e.delete(a),i};e.createYjsPersister=(e,c,g="tinybase",l)=>{const d=c.getMap(g);return((e,t,a,s,r,c,g,l={},d=[])=>{let y,p,f,v=0;C(M,d,(()=>0)),C(O,d,(()=>[]));const[w,b,j,L,J]=((e,t)=>!e||n(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!h(e)||!h(t),t.setContent]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([[e],[t]])=>!h(e)||!h(t),t.setDefaultContent])(g,e),N=async e=>(2!=v&&(v=1,await D.schedule((async()=>{await e(),v=0}))),D),T=t=>{var a;(w&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},D={load:async e=>await N((async()=>{try{T(await t())}catch(t){c?.(t),e&&J(e)}})),startAutoLoad:async e=>(await D.stopAutoLoad().load(e),p=s((async(e,a)=>{const s=a?.();await N((async()=>{try{T(s??e?.()??await t())}catch(e){c?.(e)}}))})),D),stopAutoLoad:()=>(p&&(r(p),p=void 0),D),isAutoLoading:()=>!n(p),save:async e=>(1!=v&&(v=2,await D.schedule((async()=>{try{await a(b,e)}catch(e){c?.(e)}v=0}))),D),startAutoSave:async()=>(await D.stopAutoSave().save(),f=e.addDidFinishTransactionListener((()=>{const e=j();L(e)&&D.save((()=>e))})),D),stopAutoSave:()=>(o(f,e.delListener),f=void 0,D),isAutoSaving:()=>!n(f),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(S(O,d),...e),await(async()=>{if(!S(M,d)){for(A(M,d,1);!n(y=i(S(O,d)));)try{await y()}catch(e){c?.(e)}A(M,d,0)}})(),D),getStore:()=>e,destroy:()=>D.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...l};return u(D)})(e,(async()=>d.size?[d.get(a).toJSON(),d.get(s).toJSON()]:void 0),(async(e,r)=>c.transact((()=>((e,r,i)=>{e.size||(e.set(a,new t.Map),e.set(s,new t.Map));const[c,g]=L(e),l=()=>{d=1};let d=1;if(o(i?.(),(([e,t])=>{d=0,f(e,((e,t)=>d?0:n(e)?c.delete(t):o(c.get(t),(t=>f(e,((e,a)=>d?0:n(e)?t.delete(a):o(t.get(a),(t=>f(e,((e,a)=>n(e)?t.delete(a):t.set(a,e)))),l)))),l))),f(t,((e,t)=>d?0:n(e)?g.delete(t):g.set(t,e)))})),d){const[e,t]=r();J(c,void 0,e,((e,t,a)=>J(c,t,a,((e,t,a)=>J(e,t,a,((e,t,a)=>{if(e.get(t)!==a)return e.set(t,a),1})))))),J(g,void 0,t,((e,t,a)=>{g.get(t)!==a&&g.set(t,a)}))}})(d,e,r)))),(e=>{const t=t=>e(void 0,(()=>((e,t)=>{if(1==r(t)&&(n=t[0].path,0==r(n)))return[e.get(a).toJSON(),e.get(s).toJSON(),1];var n;const[c,g]=L(e),l={},d={};return((e,t)=>{e.forEach((({path:e,changes:{keys:t}})=>i(e)==a?o(i(e),(a=>{const s=v(l,a,y),n=c.get(a);o(i(e),(e=>{const a=v(s,e,y),o=n.get(e);b(t,((e,{action:t})=>a[e]=t==j?null:o.get(e)))}),(()=>b(t,((e,{action:t})=>s[e]=t==j?null:n.get(e)?.toJSON()))))}),(()=>b(t,((e,{action:t})=>l[e]=t==j?null:c.get(e)?.toJSON())))):b(t,((e,{action:t})=>d[e]=t==j?null:g.get(e)))))})(t),[l,d,1]})(d,t)));return d.observeDeep(t),t}),(e=>{d.unobserveDeep(e)}),l,!1,{getYDoc:()=>c})}},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterYjs={},e.yjs);
