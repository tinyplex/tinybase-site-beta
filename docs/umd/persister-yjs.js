var t,e;t=this,e=function(t,e){"use strict";const s=t=>t.length,a=t=>t.shift(),n=t=>null==t,o=(t,e,s)=>n(t)?s?.():e(t),c=Object,i=c.keys,r=c.freeze,d=(t=[])=>c.fromEntries(t),l=(t,e)=>!n(((t,e)=>o(t,(t=>t[e])))(t,e)),u=(t,e)=>((t,e)=>t.map(e))(c.entries(t),(([t,s])=>e(s,t))),y=t=>(t=>t instanceof c&&t.constructor==c)(t)&&0==(t=>s(i(t)))(t),g=(t,e,s)=>(l(t,e)||(t[e]=s()),t[e]),f=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,s)=>e(s,t))),p="t",h="delete",v=t=>[t.get(p),t.get("v")],w=(t,s,a,o)=>{const c=n(s)?t:t.get(s)??t.set(s,new e.Map);let i;return u(a,((t,e)=>{o(c,e,t)&&(i=1)})),c.forEach(((t,e)=>{l(a,e)||(c.delete(e),i=1)})),n(s)||c.size||t.delete(s),i};t.createYjsPersister=(t,c,i="tinybase")=>{const l=c.getMap(i);return((t,i,S,A,b)=>{let j,O,J,L=0,N=0,C=0;const T=[],m=async t=>(2!=L&&(L=1,await z.schedule((async()=>{await t(),L=0}))),z),z={load:async(e,s)=>await m((async()=>{try{t.setContent(await i())}catch{t.setContent([e,s])}})),startAutoLoad:async(e={},n={})=>(z.stopAutoLoad(),await z.load(e,n),C=1,J=(t=>{const e=e=>t(void 0,(()=>((t,e)=>{if(1==s(e)&&(n=e[0].path,0==s(n)))return[t.get("t").toJSON(),t.get("v").toJSON()];var n;const[c,i]=v(t),r={},l={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>a(t)==p?o(a(t),(s=>{const n=g(r,s,d),i=c.get(s);o(a(t),(t=>{const s=g(n,t,d),a=i.get(t);f(e,((t,{action:e})=>s[t]=e==h?null:a.get(t)))}),(()=>f(e,((t,{action:e})=>n[t]=e==h?null:i.get(t)?.toJSON()))))}),(()=>f(e,((t,{action:e})=>r[t]=e==h?null:c.get(t)?.toJSON())))):f(e,((t,{action:e})=>l[t]=e==h?null:i.get(t)))))})(e),[r,l]})(l,e)));return l.observeDeep(e),e})((async(e,s)=>await m((async()=>{if(s)t.setTransactionChanges(s());else try{t.setContent(e?.()??await i())}catch{}})))),z),stopAutoLoad:()=>{return C&&(t=J,l.unobserveDeep(t),J=void 0,C=0),z;var t},save:async s=>(1!=L&&(L=2,await z.schedule((async()=>{try{await(async(t,s)=>c.transact((()=>((t,s,a)=>{(t=>{t.size||(t.set(p,new e.Map),t.set("v",new e.Map))})(t);const[c,i]=v(t),r=()=>{d=1};let d=1;if(o(a?.(),(([t,e])=>{d=0,u(t,((t,e)=>d?0:n(t)?c.delete(e):o(c.get(e),(e=>u(t,((t,s)=>d?0:n(t)?e.delete(s):o(e.get(s),(e=>u(t,((t,s)=>n(t)?e.delete(s):e.set(s,t)))),r)))),r))),u(e,((t,e)=>d?0:n(t)?i.delete(e):i.set(e,t)))})),d){const[t,e]=s();w(c,void 0,t,((t,e,s)=>w(c,e,s,((t,e,s)=>w(t,e,s,((t,e,s)=>{if(t.get(e)!==s)return t.set(e,s),1})))))),w(i,void 0,e,((t,e,s)=>{i.get(e)!==s&&i.set(e,s)}))}})(l,t,s))))(t.getContent,s)}catch{}L=0}))),z),startAutoSave:async()=>(await z.stopAutoSave().save(),j=t.addDidFinishTransactionListener(((t,e)=>{const[s,a]=e();y(s)&&y(a)||z.save((()=>[s,a]))})),z),stopAutoSave:()=>(o(j,t.delListener),z),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(T,...t),await(async()=>{if(!N){for(N=1;!n(O=a(T));)try{await O()}catch{}N=0}})(),z),getStore:()=>t,destroy:()=>z.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return r(z)})(t,(async()=>l.size?[l.get(p).toJSON(),l.get("v").toJSON()]:void 0))}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
