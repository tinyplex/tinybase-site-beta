var e,t;e=this,t=function(e,t){"use strict";const a=e=>typeof e,s=a(""),n="t",o="v",r=e=>null==e,i=(e,t,a)=>r(e)?a?.():t(e),c=e=>e.length,l=e=>e.shift(),d=Object,y=e=>d.getPrototypeOf(e),g=d.entries,u=d.keys,p=d.freeze,f=(e=[])=>d.fromEntries(e),h=(e,t)=>t in e,v=(e,t)=>((e,t)=>e.map(t))(g(e),(([e,a])=>t(a,e))),w=e=>(e=>!r(e)&&i(y(e),(e=>e==d.prototype||r(y(e))),(()=>!0)))(e)&&0==(e=>c(u(e)))(e),S=(e,t,a)=>(h(e,t)||(e[t]=a()),e[t]),b=e=>new Map(e),A=(e,t)=>e?.get(t),C=(e,t)=>((e,t)=>e?.forEach(t))(e,((e,a)=>t(a,e))),O=(e,t,a)=>{return r(a)?(s=e,n=t,s?.delete(n),e):e?.set(t,a);var s,n},j=(e,t,a)=>{var s,n;return s=e,n=t,s?.has(n)||O(e,t,a()),A(e,t)},M=b(),J=b(),L="delete",N=e=>[e.get(n),e.get(o)],T=(e,a,s,n)=>{const o=r(a)?e:e.get(a)??e.set(a,new t.Map);let i;return v(s,((e,t)=>{n(o,t,e)&&(i=1)})),o.forEach(((e,t)=>{h(s,t)||(o.delete(t),i=1)})),r(a)||o.size||e.delete(a),i};e.createYjsPersister=(e,d,y="tinybase",g)=>{const u=d.getMap(y);return((e,t,n,o,c,d,y,[g,u]=[],f=[])=>{let h,v,S,b=0,C=0;j(M,f,(()=>0)),j(J,f,(()=>[]));const L=(y?e.getMergeableContent:null)??e.getContent,N=e.getTransactionChanges,T=async e=>(2!=b&&(b=1,await m.schedule((async()=>{await e(),b=0}))),m),m={load:async(n,o)=>await T((async()=>{try{const n=await t();(y&&(e=>a(e)==s)(n[0])?e.applyMergeableChanges:e.setContent)(n)}catch{e.setContent([n,o])}})),startAutoLoad:async(a={},s={})=>(m.stopAutoLoad(),await m.load(a,s),C=1,S=o((async(a,s)=>{if(s){const t=s();await T((async()=>e.applyChanges(t)))}else await T((async()=>{try{e.setContent(a?.()??await t())}catch(e){d?.(e)}}))})),m),stopAutoLoad:()=>(C&&(c(S),S=void 0,C=0),m),save:async e=>(1!=b&&(b=2,await m.schedule((async()=>{try{await n(L,e)}catch(e){d?.(e)}b=0}))),m),startAutoSave:async()=>(await m.stopAutoSave().save(),h=e.addDidFinishTransactionListener((()=>{const[e,t]=N();w(e)&&w(t)||m.save((()=>[e,t]))})),m),stopAutoSave:()=>(i(h,e.delListener),h=void 0,m),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(A(J,f),...e),await(async()=>{if(!A(M,f)){for(O(M,f,1);!r(v=l(A(J,f)));)try{await v()}catch(e){d?.(e)}O(M,f,0)}})(),m),getStore:()=>e,destroy:()=>m.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return g&&(m[g]=()=>u),p(m)})(e,(async()=>u.size?[u.get(n).toJSON(),u.get(o).toJSON()]:void 0),(async(e,a)=>d.transact((()=>((e,a,s)=>{e.size||(e.set(n,new t.Map),e.set(o,new t.Map));const[c,l]=N(e),d=()=>{y=1};let y=1;if(i(s?.(),(([e,t])=>{y=0,v(e,((e,t)=>y?0:r(e)?c.delete(t):i(c.get(t),(t=>v(e,((e,a)=>y?0:r(e)?t.delete(a):i(t.get(a),(t=>v(e,((e,a)=>r(e)?t.delete(a):t.set(a,e)))),d)))),d))),v(t,((e,t)=>y?0:r(e)?l.delete(t):l.set(t,e)))})),y){const[e,t]=a();T(c,void 0,e,((e,t,a)=>T(c,t,a,((e,t,a)=>T(e,t,a,((e,t,a)=>{if(e.get(t)!==a)return e.set(t,a),1})))))),T(l,void 0,t,((e,t,a)=>{l.get(t)!==a&&l.set(t,a)}))}})(u,e,a)))),(e=>{const t=t=>e(void 0,(()=>((e,t)=>{if(1==c(t)&&(a=t[0].path,0==c(a)))return[e.get(n).toJSON(),e.get(o).toJSON()];var a;const[s,r]=N(e),d={},y={};return((e,t)=>{e.forEach((({path:e,changes:{keys:t}})=>l(e)==n?i(l(e),(a=>{const n=S(d,a,f),o=s.get(a);i(l(e),(e=>{const a=S(n,e,f),s=o.get(e);C(t,((e,{action:t})=>a[e]=t==L?null:s.get(e)))}),(()=>C(t,((e,{action:t})=>n[e]=t==L?null:o.get(e)?.toJSON()))))}),(()=>C(t,((e,{action:t})=>d[e]=t==L?null:s.get(e)?.toJSON())))):C(t,((e,{action:t})=>y[e]=t==L?null:r.get(e)))))})(t),[d,y]})(u,t)));return u.observeDeep(t),t}),(e=>{u.unobserveDeep(e)}),g,!1,["getYDoc",d])}},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterYjs={},e.yjs);
