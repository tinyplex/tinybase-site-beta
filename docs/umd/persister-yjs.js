var t,e;t=this,e=function(t,e){"use strict";const a="t",s="v",n=t=>null==t,o=(t,e,a)=>n(t)?a?.():e(t),r=t=>t.length,i=t=>t.shift(),c=Object,d=t=>c.getPrototypeOf(t),l=c.keys,u=c.freeze,y=(t=[])=>c.fromEntries(t),g=(t,e)=>!n(((t,e)=>o(t,(t=>t[e])))(t,e)),p=(t,e)=>((t,e)=>t.map(e))(c.entries(t),(([t,a])=>e(a,t))),f=t=>(t=>!n(t)&&o(d(t),(t=>t==c.prototype||n(d(t))),(()=>!0)))(t)&&0==(t=>r(l(t)))(t),h=(t,e,a)=>(g(t,e)||(t[e]=a()),t[e]),v=t=>new Map(t),w=(t,e)=>t?.get(e),S=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,a)=>e(a,t))),A=(t,e,a)=>{return n(a)?(s=t,o=e,s?.delete(o),t):t?.set(e,a);var s,o},O=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||A(t,e,a()),w(t,e)},b=v(),j=v(),J="delete",L=t=>[t.get(a),t.get(s)],N=(t,a,s,o)=>{const r=n(a)?t:t.get(a)??t.set(a,new e.Map);let i;return p(s,((t,e)=>{o(r,e,t)&&(i=1)})),r.forEach(((t,e)=>{g(s,e)||(r.delete(e),i=1)})),n(a)||r.size||t.delete(a),i};t.createYjsPersister=(t,c,d="tinybase",l)=>{const g=c.getMap(d);return((t,e,a,s,r,c,[d,l]=[],y=[])=>{let g,p,h,v=0,S=0;O(b,y,(()=>0)),O(j,y,(()=>[]));const J=async t=>(2!=v&&(v=1,await L.schedule((async()=>{await t(),v=0}))),L),L={load:async(a,s)=>await J((async()=>{try{t.setContent(await e())}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},n={})=>(L.stopAutoLoad(),await L.load(a,n),S=1,h=s((async(a,s)=>{if(s){const e=s();await J((async()=>t.setTransactionChanges(e)))}else await J((async()=>{try{t.setContent(a?.()??await e())}catch(t){c?.(t)}}))})),L),stopAutoLoad:()=>(S&&(r(h),h=void 0,S=0),L),save:async e=>(1!=v&&(v=2,await L.schedule((async()=>{try{await a(t.getContent,e)}catch(t){c?.(t)}v=0}))),L),startAutoSave:async()=>(await L.stopAutoSave().save(),g=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();f(a)&&f(s)||L.save((()=>[a,s]))})),L),stopAutoSave:()=>(o(g,t.delListener),g=void 0,L),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(w(j,y),...t),await(async()=>{if(!w(b,y)){for(A(b,y,1);!n(p=i(w(j,y)));)try{await p()}catch(t){c?.(t)}A(b,y,0)}})(),L),getStore:()=>t,destroy:()=>L.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return d&&(L[d]=()=>l),u(L)})(t,(async()=>g.size?[g.get(a).toJSON(),g.get(s).toJSON()]:void 0),(async(t,r)=>c.transact((()=>((t,r,i)=>{t.size||(t.set(a,new e.Map),t.set(s,new e.Map));const[c,d]=L(t),l=()=>{u=1};let u=1;if(o(i?.(),(([t,e])=>{u=0,p(t,((t,e)=>u?0:n(t)?c.delete(e):o(c.get(e),(e=>p(t,((t,a)=>u?0:n(t)?e.delete(a):o(e.get(a),(e=>p(t,((t,a)=>n(t)?e.delete(a):e.set(a,t)))),l)))),l))),p(e,((t,e)=>u?0:n(t)?d.delete(e):d.set(e,t)))})),u){const[t,e]=r();N(c,void 0,t,((t,e,a)=>N(c,e,a,((t,e,a)=>N(t,e,a,((t,e,a)=>{if(t.get(e)!==a)return t.set(e,a),1})))))),N(d,void 0,e,((t,e,a)=>{d.get(e)!==a&&d.set(e,a)}))}})(g,t,r)))),(t=>{const e=e=>t(void 0,(()=>((t,e)=>{if(1==r(e)&&(n=e[0].path,0==r(n)))return[t.get(a).toJSON(),t.get(s).toJSON()];var n;const[c,d]=L(t),l={},u={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>i(t)==a?o(i(t),(a=>{const s=h(l,a,y),n=c.get(a);o(i(t),(t=>{const a=h(s,t,y),o=n.get(t);S(e,((t,{action:e})=>a[t]=e==J?null:o.get(t)))}),(()=>S(e,((t,{action:e})=>s[t]=e==J?null:n.get(t)?.toJSON()))))}),(()=>S(e,((t,{action:e})=>l[t]=e==J?null:c.get(t)?.toJSON())))):S(e,((t,{action:e})=>u[t]=e==J?null:d.get(t)))))})(e),[l,u]})(g,e)));return g.observeDeep(e),e}),(t=>{g.unobserveDeep(t)}),l,["getYDoc",c])}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
