var t,e;t=this,e=function(t,e){"use strict";const s="t",a="v",n=t=>t.length,o=t=>t.shift(),c=t=>null==t,r=(t,e,s)=>c(t)?s?.():e(t),i=Object,d=i.keys,l=i.freeze,u=(t=[])=>i.fromEntries(t),y=(t,e)=>!c(((t,e)=>r(t,(t=>t[e])))(t,e)),g=(t,e)=>((t,e)=>t.map(e))(i.entries(t),(([t,s])=>e(s,t))),f=t=>(t=>t instanceof i&&t.constructor==i)(t)&&0==(t=>n(d(t)))(t),p=(t,e,s)=>(y(t,e)||(t[e]=s()),t[e]),h=t=>new Map(t),v=(t,e)=>t?.get(e),w=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,s)=>e(s,t))),S=(t,e,s)=>{return c(s)?(a=t,n=e,a?.delete(n),t):t?.set(e,s);var a,n},A=(t,e,s)=>{var a,n;return a=t,n=e,a?.has(n)||S(t,e,s()),v(t,e)},b=h(),j=h(),O="delete",J=t=>[t.get(s),t.get(a)],L=(t,s,a,n)=>{const o=c(s)?t:t.get(s)??t.set(s,new e.Map);let r;return g(a,((t,e)=>{n(o,e,t)&&(r=1)})),o.forEach(((t,e)=>{y(a,e)||(o.delete(e),r=1)})),c(s)||o.size||t.delete(s),r};t.createYjsPersister=(t,i,d="tinybase",y)=>{const h=i.getMap(d);return((t,e,s,a,n,i,d=[])=>{let u,y,g,p=0,h=0;A(b,d,(()=>0)),A(j,d,(()=>[]));const w=async t=>(2!=p&&(p=1,await O.schedule((async()=>{await t(),p=0}))),O),O={load:async(s,a)=>await w((async()=>{try{t.setContent(await e())}catch{t.setContent([s,a])}})),startAutoLoad:async(s={},n={})=>(O.stopAutoLoad(),await O.load(s,n),h=1,g=a((async(s,a)=>{if(a){const e=a();await w((async()=>t.setTransactionChanges(e)))}else await w((async()=>{try{t.setContent(s?.()??await e())}catch(t){i?.(t)}}))})),O),stopAutoLoad:()=>(h&&(n(g),g=void 0,h=0),O),save:async e=>(1!=p&&(p=2,await O.schedule((async()=>{try{await s(t.getContent,e)}catch(t){i?.(t)}p=0}))),O),startAutoSave:async()=>(await O.stopAutoSave().save(),u=t.addDidFinishTransactionListener(((t,e)=>{const[s,a]=e();f(s)&&f(a)||O.save((()=>[s,a]))})),O),stopAutoSave:()=>(r(u,t.delListener),O),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(v(j,d),...t),await(async()=>{if(!v(b,d)){for(S(b,d,1);!c(y=o(v(j,d)));)try{await y()}catch(t){i?.(t)}S(b,d,0)}})(),O),getStore:()=>t,destroy:()=>O.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return l(O)})(t,(async()=>h.size?[h.get(s).toJSON(),h.get(a).toJSON()]:void 0),(async(t,n)=>i.transact((()=>((t,n,o)=>{t.size||(t.set(s,new e.Map),t.set(a,new e.Map));const[i,d]=J(t),l=()=>{u=1};let u=1;if(r(o?.(),(([t,e])=>{u=0,g(t,((t,e)=>u?0:c(t)?i.delete(e):r(i.get(e),(e=>g(t,((t,s)=>u?0:c(t)?e.delete(s):r(e.get(s),(e=>g(t,((t,s)=>c(t)?e.delete(s):e.set(s,t)))),l)))),l))),g(e,((t,e)=>u?0:c(t)?d.delete(e):d.set(e,t)))})),u){const[t,e]=n();L(i,void 0,t,((t,e,s)=>L(i,e,s,((t,e,s)=>L(t,e,s,((t,e,s)=>{if(t.get(e)!==s)return t.set(e,s),1})))))),L(d,void 0,e,((t,e,s)=>{d.get(e)!==s&&d.set(e,s)}))}})(h,t,n)))),(t=>{const e=e=>t(void 0,(()=>((t,e)=>{if(1==n(e)&&(c=e[0].path,0==n(c)))return[t.get(s).toJSON(),t.get(a).toJSON()];var c;const[i,d]=J(t),l={},y={};return((t,e)=>{t.forEach((({path:t,changes:{keys:e}})=>o(t)==s?r(o(t),(s=>{const a=p(l,s,u),n=i.get(s);r(o(t),(t=>{const s=p(a,t,u),o=n.get(t);w(e,((t,{action:e})=>s[t]=e==O?null:o.get(t)))}),(()=>w(e,((t,{action:e})=>a[t]=e==O?null:n.get(t)?.toJSON()))))}),(()=>w(e,((t,{action:e})=>l[t]=e==O?null:i.get(t)?.toJSON())))):w(e,((t,{action:e})=>y[t]=e==O?null:d.get(t)))))})(e),[l,y]})(h,e)));return h.observeDeep(e),e}),(t=>{h.unobserveDeep(t)}),y)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterYjs={},t.yjs);
