var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a=e(""),s=(t,e)=>t instanceof e,n=t=>null==t,o=Object,r=o.keys,i=o.freeze,c=t=>(t=>s(t,o)&&t.constructor==o)(t)&&0==(t=>r(t).length)(t),d=t=>JSON.stringify(t,((t,e)=>s(e,Map)?o.fromEntries([...e]):e)),y=JSON.parse,u=t=>new Map(t),f=(t,e)=>t?.get(e),p=(t,e,a)=>{return n(a)?(s=t,o=e,s?.delete(o),t):t?.set(e,a);var s,o},h=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||p(t,e,a()),f(t,e)},l=u(),v=u(),w="message";t.createPartyKitPersister=(t,s,o="https",r)=>{const{host:u,room:g}=s.partySocketOptions,m=o+"://"+u+"/parties/"+(s.name??"main")+"/"+g+"/store",S=async t=>await(await fetch(m,{...t?{method:"PUT",body:d(t)}:{},mode:"cors",cache:"no-store"})).json();return((t,e,a,s,o,r,d=[])=>{let y,u,w,g=0,m=0;h(l,d,(()=>0)),h(v,d,(()=>[]));const S=async t=>(2!=g&&(g=1,await A.schedule((async()=>{await t(),g=0}))),A),A={load:async(a,s)=>await S((async()=>{try{t.setContent(await e())}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},n={})=>(A.stopAutoLoad(),await A.load(a,n),m=1,w=s((async(a,s)=>{if(s){const e=s();await S((async()=>t.setTransactionChanges(e)))}else await S((async()=>{try{t.setContent(a?.()??await e())}catch(t){r?.(t)}}))})),A),stopAutoLoad:()=>(m&&(o(w),w=void 0,m=0),A),save:async e=>(1!=g&&(g=2,await A.schedule((async()=>{try{await a(t.getContent,e)}catch(t){r?.(t)}g=0}))),A),startAutoSave:async()=>(await A.stopAutoSave().save(),y=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();c(a)&&c(s)||A.save((()=>[a,s]))})),A),stopAutoSave:()=>{var e,a;return e=y,a=t.delListener,n(e)||a(e),A},schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(f(v,d),...t),await(async()=>{if(!f(l,d)){for(p(l,d,1);!n((t=f(v,d),u=t.shift()));)try{await u()}catch(t){r?.(t)}p(l,d,0)}var t})(),A),getStore:()=>t,destroy:()=>A.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return i(A)})(t,(async()=>await S()),(async(t,n)=>{var o;n?s.send(("s",o=n(),"s"+(e(o)==a?o:d(o)))):await S(t())}),(t=>{const e=e=>{const[a,s]=[(i=e.data)[0],y((n=i,o=1,n.slice(o,r)))];var n,o,r,i;"s"==a&&t(void 0,(()=>s))};return s.addEventListener(w,e),e}),(t=>{s.removeEventListener(w,t)}),r)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPartyKitClient={});
