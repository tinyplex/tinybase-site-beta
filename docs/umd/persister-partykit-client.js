var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a="",s=e(a),o=t=>null==t,n=(t,e,a)=>o(t)?a?.():e(t),r=t=>e(t)==s,i=t=>t.length,c=Object,y=t=>c.getPrototypeOf(t),d=c.keys,l=c.freeze,p=t=>(t=>!o(t)&&n(y(t),(t=>t==c.prototype||o(y(t))),(()=>!0)))(t)&&0==(t=>i(d(t)))(t),g=t=>JSON.stringify(t,((t,e)=>e instanceof Map?c.fromEntries([...e]):e)),h=JSON.parse,u="/store",f=t=>new Map(t),v=(t,e)=>t?.get(e),w=(t,e,a)=>{return o(a)?(s=t,n=e,s?.delete(n),t):t?.set(e,a);var s,n},C=(t,e,a,s)=>{var o,n;return o=t,n=e,o?.has(n)?s?.(v(t,e)):w(t,e,a()),v(t,e)},b=f(),m=f(),P=t=>r(t?.[0]),S="message";t.createPartyKitPersister=(t,e,s,c)=>{const{host:y,room:d}=e.partySocketOptions,{storeProtocol:f="https",storePath:A=u,messagePrefix:L=a}={...r(s)?{storeProtocol:s}:s},M=f+"://"+y+"/parties/"+e.name+"/"+d+A,T=async t=>await(await fetch(M,{...t?{method:"PUT",body:g(t)}:{},mode:"cors",cache:"no-store"})).json();return((t,e,a,s,r,i,c,[y,d]=[],g=[])=>{let h,u,f,S=0,A=0;C(b,g,(()=>0)),C(m,g,(()=>[]));const[L,M,T,O]=((t,e)=>!t||o(e.getMergeableContent)?[0,e.getContent,e.getTransactionChanges,([t,e])=>!p(t)||!p(e)]:[1,e.getMergeableContent,e.getTransactionMergeableChanges,([,[[,t],[,e]]])=>!p(t)||!p(e)])(c,t),x=async t=>(2!=S&&(S=1,await j.schedule((async()=>{await t(),S=0}))),j),j={load:async(a,s)=>await x((async()=>{try{const a=await e();(L&&P(a)?t.setMergeableContent:t.setContent)(a)}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},o={})=>(j.stopAutoLoad(),await j.load(a,o),A=1,f=s((async(a,s)=>{if(s){const e=s();await x((async()=>(L&&P(e)?t.applyMergeableChanges:t.applyChanges)(e)))}else await x((async()=>{try{const s=a?.()??await e();(L&&P(s)?t.setMergeableContent:t.setContent)(s)}catch(t){i?.(t)}}))})),j),stopAutoLoad:()=>(A&&(r(f),f=void 0,A=0),j),save:async t=>(1!=S&&(S=2,await j.schedule((async()=>{try{await a(M,t)}catch(t){i?.(t)}S=0}))),j),startAutoSave:async()=>(await j.stopAutoSave().save(),h=t.addDidFinishTransactionListener((()=>{const t=T();O(t)&&j.save((()=>t))})),j),stopAutoSave:()=>(n(h,t.delListener),h=void 0,j),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(v(m,g),...t),await(async()=>{if(!v(b,g)){for(w(b,g,1);!o((t=v(m,g),u=t.shift()));)try{await u()}catch(t){i?.(t)}w(b,g,0)}var t})(),j),getStore:()=>t,destroy:()=>j.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return y&&(j[y]=()=>d),l(j)})(t,(async()=>await T()),(async(t,a)=>{var s,o;a?e.send((s=L,o=a(),s+"s"+(r(o)?o:g(o)))):await T(t())}),(t=>{const a=e=>n(((t,e,a)=>{const s=i(t);return((t,e)=>t.startsWith(e))(e,t)?[e[s],h((o=e,n=s+1,o.slice(n,void 0)))]:void 0;var o,n})(L,e.data),(([e,a])=>{"s"==e&&t(void 0,(()=>a))}));return e.addEventListener(S,a),a}),(t=>{e.removeEventListener(S,t)}),c,!1,["getConnection",e])}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPartyKitClient={});
