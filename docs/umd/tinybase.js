var e,t;e=this,t=function(e,t){"use strict";const s=e=>typeof e,n="",o=s(n),r=s(!0),a=s(0),i=s(s),l="type",c="default",d="utf8",u="Listener",f="Result",h="add",g="Table",w="RowIds",L="CellIds",p="Cell",R=e=>n+e,v=(e,t)=>e.includes(t),y=(e,t)=>e.every(t),I=(e,t)=>E(e)===E(t)&&y(e,((e,s)=>t[s]===e)),S=(e,t)=>y(e,((s,n)=>0==n||t(e[n-1],s)<=0)),T=(e,t)=>e.sort(t),b=(e,t)=>e.forEach(t),C=(e,t)=>e.map(t),m=e=>M(e,((e,t)=>e+t),0),E=e=>e.length,k=e=>0==E(e),M=(e,t,s)=>e.reduce(t,s),x=(e,t,s)=>e.slice(t,s),A=(e,...t)=>e.push(...t),D=e=>e.pop(),F=e=>e.shift(),J=e=>JSON.stringify(e,((e,t)=>N(t,Map)?M([...t],((e,[t,s])=>(e[t]=s,e)),{}):t)),P=JSON.parse,Q=Math.max,j=Math.min,z=isFinite,N=(e,t)=>e instanceof t,O=e=>null==e,W=(e,t,s)=>O(e)?s?.():t(e),B=e=>e==o||e==r,q=e=>s(e)==i,H=e=>Array.isArray(e),$=()=>{},G=e=>e.size,K=(e,t)=>e?.has(t)??!1,U=e=>O(e)||0==G(e),V=e=>[...e?.values()??[]],X=e=>e.clear(),Y=(e,t)=>e?.forEach(t),Z=(e,t)=>e?.delete(t),_=e=>new Map(e),ee=e=>[...e?.keys()??[]],te=(e,t)=>e?.get(t),se=(e,t)=>Y(e,((e,s)=>t(s,e))),ne=(e,t,s)=>O(s)?(Z(e,t),e):e?.set(t,s),oe=(e,t,s)=>(K(e,t)||ne(e,t,s()),te(e,t)),re=(e,t,s)=>{const n={},o=t??(e=>e);return Y(e,((e,t)=>W(o(e),(e=>s?.(e)?0:n[t]=e)))),n},ae=(e,t)=>{const s=_(),n=t??(e=>e);return Y(e,((e,t)=>s.set(t,n(e)))),s},ie=e=>ae(e,ae),le=(e,t,s,n,o=0)=>W((s?oe:te)(e,t[o],o>E(t)-2?s:_),(r=>{if(o>E(t)-2)return n?.(r)&&ne(e,t[o]),r;const a=le(r,t,s,n,o+1);return U(r)&&ne(e,t[o]),a})),ce=e=>new Set(H(e)||O(e)?e:[e]),de=(e,t)=>e?.add(t),ue=(e,t,s)=>{const n=e.hasRow,o=_(),r=_(),a=_(),i=_(),l=_(),c=(t,s,...n)=>{const o=oe(l,t,ce);return b(n,(t=>de(o,t)&&s&&e.callListener(t))),n},d=(t,...s)=>W(te(l,t),(n=>{b(k(s)?V(n):s,(t=>{e.delListener(t),Z(n,t)})),U(n)&&ne(l,t)})),u=(e,s)=>{ne(o,e,s),K(r,e)||(ne(r,e,t()),ne(a,e,_()),ne(i,e,_()))},f=e=>{ne(o,e),ne(r,e),ne(a,e),ne(i,e),d(e)};return[()=>e,()=>ee(o),e=>se(r,e),e=>K(r,e),e=>te(o,e),e=>te(r,e),(e,t)=>ne(r,e,t),u,(t,o,r,l,f)=>{u(t,o);const h=_(),g=_(),w=te(a,t),L=te(i,t),p=t=>{const r=s=>e.getCell(o,t,s),a=te(w,t),i=n(o,t)?s(l(r,t)):void 0;if(a===i||H(a)&&H(i)&&I(a,i)||ne(h,t,[a,i]),!O(f)){const e=te(L,t),s=n(o,t)?f(r,t):void 0;e!=s&&ne(g,t,s)}},R=e=>{r((()=>{Y(h,(([,e],t)=>ne(w,t,e))),Y(g,((e,t)=>ne(L,t,e)))}),h,g,w,L,e),X(h),X(g)};se(w,p),e.hasTable(o)&&b(e.getRowIds(o),(e=>{K(w,e)||p(e)})),R(!0),d(t),c(t,0,e.addRowListener(o,null,((e,t,s)=>p(s))),e.addTableListener(o,(()=>R())))},f,()=>se(l,f),c,d]},fe=(e,t)=>s(e)==o?t=>t(e):e??(()=>t??n),he=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},ge=/^\d+$/,we=()=>{const e=[];let t=0;return[()=>F(e)??n+t++,t=>{ge.test(t)&&E(e)<1e3&&A(e,t)}]},Le=e=>{let t;const[s,o]=we(),r=_();return[(o,a,i)=>{t??=e();const l=s();return ne(r,l,[o,a,i]),de(le(a,i??[n],ce),l),l},(e,s,...o)=>b(((e,t=[n])=>{const s=[],o=(e,n)=>n==E(t)?A(s,e):null===t[n]?Y(e,(e=>o(e,n+1))):b([t[n],null],(t=>o(te(e,t),n+1)));return o(e,0),s})(e,s),(e=>Y(e,(e=>te(r,e)[0](t,...s??[],...o))))),e=>W(te(r,e),(([,t,s])=>(le(t,s??[n],void 0,(t=>(Z(t,e),U(t)?1:0))),ne(r,e),o(e),s))),(e,s,n)=>W(te(r,e),(([e,,o=[]])=>{const r=(...a)=>{const i=E(a);i==E(o)?e(t,...a,...n(a)):O(o[i])?b(s[i](...a),(e=>r(...a,e))):r(...a,o[i])};r()}))]},pe=Object,Re=pe.keys,ve=pe.isFrozen,ye=pe.freeze,Ie=(e,t)=>!O(((e,t)=>W(e,(e=>e[t])))(e,t)),Se=(e,t)=>delete e[t],Te=(e,t)=>b(pe.entries(e),(([e,s])=>t(s,e))),be=e=>k(Re(e)),Ce=e=>{const t=s(e);return B(t)||t==a&&z(e)?t:void 0},me=(e,t,s,n,o)=>O(o)?e.delCell(t,s,n,!0):e.setCell(t,s,n,o),Ee=he((e=>{let t,s,o,r=100,a=_(),i=1;const l=_(),c=_(),[d,u,f]=Le((()=>Q)),h=_(),g=_(),w=[],L=[],p=(t,s)=>{i=0,e.transaction((()=>Y(te(h,s),((s,n)=>Y(s,((s,o)=>Y(s,((s,r)=>me(e,n,o,r,s[t]))))))))),i=1},R=e=>{ne(h,e),ne(g,e),u(c,[e])},y=(e,t)=>b(((e,t)=>e.splice(0,t))(e,t??E(e)),R),I=()=>y(w,E(w)-r),S=e.addCellListener(null,null,null,((e,s,n,r,l,c)=>{if(i){W(t,(()=>{A(w,t),I(),y(L),t=void 0,o=1}));const e=oe(a,s,_),i=oe(e,n,_),d=oe(i,r,(()=>[c,void 0]));d[1]=l,d[0]===l&&U(ne(i,r))&&U(ne(e,n))&&U(ne(a,s))&&(t=D(w),o=1),M()}})),T=(e="")=>(O(t)&&(t=n+s++,ne(h,t,a),J(t,e),a=_(),o=1),t),C=()=>{k(w)||(((e,...t)=>{e.unshift(...t)})(L,T()),p(0,t),t=D(w),o=1)},m=()=>{k(L)||(A(w,t),t=F(L),p(1,t),o=1)},M=()=>{o&&(u(l),o=0)},x=e=>{const t=T(e);return M(),t},J=(e,t)=>(P(e)&&te(g,e)!==t&&(ne(g,e,t),u(c,[e])),Q),P=e=>K(h,e),Q={setSize:e=>(r=e,I(),Q),addCheckpoint:x,setCheckpoint:J,getStore:()=>e,getCheckpointIds:()=>[[...w],t,[...L]],forEachCheckpoint:e=>se(g,e),hasCheckpoint:P,getCheckpoint:e=>te(g,e),goBackward:()=>(C(),M(),Q),goForward:()=>(m(),M(),Q),goTo:e=>{const s=v(w,e)?C:v(L,e)?m:null;for(;!O(s)&&e!=t;)s();return M(),Q},addCheckpointIdsListener:e=>d(e,l),addCheckpointListener:(e,t)=>d(t,c,[e]),delListener:e=>(f(e),Q),clear:()=>(y(w),y(L),O(t)||R(t),t=void 0,s=0,x(),Q),destroy:()=>{e.delListener(S)},getListenerStats:()=>({})};return ye(Q.clear())})),ke=(e,t)=>e<t?-1:1,Me=he((e=>{const t=_(),s=_(),[o,r,a,i,l,c,d,,u,f,h]=ue(e,_,(e=>O(e)?n:H(e)?C(e,R):R(e))),[g,w,L]=Le((()=>v)),p=(t,s,n)=>{const o=l(t);Y(n,((t,n)=>s(n,(s=>Y(t,(t=>s(t,(s=>e.forEachCell(o,t,s)))))))))},v={setIndexDefinition:(e,n,o,r,a,i=ke)=>{const l=O(a)?void 0:([e],[t])=>a(e,t);return u(e,n,((n,o,a,u,f,h)=>{let g=0;const L=ce(),p=ce(),R=c(e);if(Y(o,(([e,t],s)=>{const n=ce(e),o=ce(t);Y(n,(e=>Z(o,e)?Z(n,e):0)),Y(n,(e=>{de(L,e),W(te(R,e),(t=>{Z(t,s),U(t)&&(ne(R,e),g=1)}))})),Y(o,(e=>{de(L,e),K(R,e)||(ne(R,e,ce()),g=1),de(te(R,e),s),O(r)||de(p,e)}))})),n(),U(f)||(h?se(R,(e=>de(p,e))):se(a,(e=>W(te(u,e),(e=>de(p,e))))),Y(p,(e=>{const t=(t,s)=>i(te(f,t),te(f,s),e),s=[...te(R,e)];S(s,t)||(ne(R,e,ce(T(s,t))),de(L,e))}))),(g||h)&&!O(l)){const t=[...R];S(t,l)||(d(e,_(T(t,l))),g=1)}g&&w(t,[e]),Y(L,(t=>w(s,[e,t])))}),fe(o),W(r,fe)),v},delIndexDefinition:e=>(f(e),v),getStore:o,getIndexIds:r,forEachIndex:e=>a(((t,s)=>e(t,(e=>p(t,e,s))))),forEachSlice:(e,t)=>p(e,t,c(e)),hasIndex:i,hasSlice:(e,t)=>K(c(e),t),getTableId:l,getSliceIds:e=>ee(c(e)),getSliceRowIds:(e,t)=>V(te(c(e),t)),addSliceIdsListener:(e,s)=>g(s,t,[e]),addSliceRowIdsListener:(e,t,n)=>g(n,s,[e,t]),delListener:e=>(L(e),v),destroy:h,getListenerStats:()=>({})};return ye(v)})),xe=_([["avg",[(e,t)=>m(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>Q(...e),(e,t)=>Q(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:Q(t,e)]],["min",[e=>j(...e),(e,t)=>j(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:j(t,e)]],["sum",[e=>m(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),Ae=(e,t,s,n,o,r=!1)=>{if(U(s))return;const[a,i,l,c]=o;return r||=O(e),Y(n,(([s,n])=>{r||(e=O(s)?i?.(e,n,t++):O(n)?l?.(e,s,t--):c?.(e,n,s,t),r||=O(e))})),r?a(V(s),G(s)):e},De=he((e=>{const t=_(),[s,o,r,a,i,l,c,,d,u,f]=ue(e,$,(e=>isNaN(e)||O(e)||!0===e||!1===e||e===n?void 0:1*e)),[h,g,w]=Le((()=>L)),L={setMetricDefinition:(e,s,n,o,r,a,i)=>{const u=q(n)?[n,r,a,i]:te(xe,n)??te(xe,"sum");return d(e,s,((s,n,o,r,a,i)=>{const d=l(e),f=G(r);i||=O(d),s();let h=Ae(d,f,r,n,u,i);z(h)||(h=void 0),h!=d&&(c(e,h),g(t,[e],h,d))}),fe(o,1)),L},delMetricDefinition:e=>(u(e),L),getStore:s,getMetricIds:o,forEachMetric:r,hasMetric:a,getTableId:i,getMetric:l,addMetricListener:(e,s)=>h(s,t,[e]),delListener:e=>(w(e),L),destroy:f,getListenerStats:()=>({})};return ye(L)})),Fe=(e,t,s,o,r)=>{let a,i=0;const l={load:async s=>{if(2!=i){i=1;const o=await t();O(o)||o==n?e.setTables(s):e.setJson(o),i=0}return l},startAutoLoad:async e=>(l.stopAutoLoad(),await l.load(e),o(l.load),l),stopAutoLoad:()=>(r(),l),save:async()=>(1!=i&&(i=2,await s(e.getJson()),i=0),l),startAutoSave:async()=>(await l.stopAutoSave().save(),a=e.addTablesListener((()=>l.save())),l),stopAutoSave:()=>(W(a,e.delListener),l),getStore:()=>e,destroy:()=>l.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return ye(l)},Je="storage",Pe=globalThis.window,Qe=(e,t,s)=>{let n;return Fe(e,(async()=>s.getItem(t)),(async e=>s.setItem(t,e)),(e=>{n=n=>{n.storageArea===s&&n.key===t&&e()},Pe.addEventListener(Je,n)}),(()=>{Pe.removeEventListener(Je,n),n=void 0}))},je=e=>e.headers.get("ETag"),ze=he((e=>{const t=e.createStore,[s,o,r,a,i,,,l,,c,d,R,v]=ue(e,(()=>!0),$),I=t(),S=t(),T=_(),C=(e,t,...s)=>b(s,(s=>de(oe(oe(T,t,_),e,ce),s))),m=e=>{W(te(T,e),(e=>{se(e,((e,t)=>Y(t,(t=>e.delListener(t))))),X(e)})),b([S,I],(t=>t.delTable(e)))},M=(e,t,s)=>C(t,e,t.addWillFinishTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),D={setQueryDefinition:(t,s,o)=>{l(t,s),m(t);const r=[],a=[[null,[s,null,null,[],_()]]],i=[],c=[],d=[];o({select:(e,t)=>{const s=q(e)?[E(r)+n,e]:[O(t)?e:t,s=>s(e,t)];return A(r,s),{as:e=>s[0]=e}},join:(e,t,s)=>{const n=O(s)||q(t)?null:t,o=O(n)?t:s,r=[e,[e,n,q(o)?o:e=>e(o),[],_()]];return A(a,r),{as:e=>r[0]=e}},where:(e,t,s)=>A(i,q(e)?e:O(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,o)=>{const r=[e,[e,q(t)?[t,s,n,o]:te(xe,t)??[(e,t)=>t]]];return A(c,r),{as:e=>r[0]=e}},having:(e,t)=>A(d,q(e)?e:s=>s(e)===t)});const u=_(r);if(U(u))return D;const f=_(a);se(f,((e,[,t])=>W(te(f,t),(({3:t})=>O(e)?0:A(t,e)))));const h=_(c);let g=I;if(U(h)&&k(d))g=S;else{M(t,g,S);const e=_();se(h,((t,[s,n])=>de(oe(e,s,ce),[t,n])));const s=ce();se(u,(t=>K(e,t)?0:de(s,t)));const n=_(),o=(s,n,o,r)=>W(s,(([a,i,l,c])=>{se(n,((t,[s])=>{const n=oe(a,t,_),i=te(n,o),l=r?void 0:s;if(i!==l){const s=ce([[i,l]]),r=G(n);ne(n,o,l),Y(te(e,t),(([e,t])=>{const o=Ae(c[e],r,n,s,t);c[e]=O(Ce(o))?null:o}))}})),U(i)||!y(d,(e=>e((e=>c[e]))))?S.delRow(t,l):O(l)?s[2]=S.addRow(t,c):S.setRow(t,l,c)}));C(g,t,g.addRowListener(t,null,((r,a,i,l)=>{const c=[],d=[],u=_(),f=g.hasRow(t,i);let h=!f;Y(s,(e=>{const[s,n,o]=l(t,i,e);A(c,n),A(d,o),h||=s})),se(e,(e=>{const[s,,n]=l(t,i,e);(h||s)&&ne(u,e,[n])})),h&&o(le(n,c,void 0,(([,e])=>(Z(e,i),U(e)))),u,i,1),f&&o(le(n,d,(()=>{const e={};return Y(s,(s=>e[s]=g.getCell(t,i,s))),[_(),ce(),void 0,e]}),(([,e])=>{de(e,i)})),u,i)})))}M(t,e,g);const w=(n,o,r,a)=>{const l=t=>e.getCell(o,r,t);b(a,(s=>{const[o,,r,a,i]=te(f,s),c=r?.(l,n),[d,u]=te(i,n)??[];c!=d&&(O(u)||v(t,u),ne(i,n,O(c)?null:[c,...R(t,1,e.addRowListener(o,c,(()=>w(n,o,c,a))))]))})),(n=>{const o=(t,o)=>e.getCell(...O(o)?[s,n,t]:t===s?[s,n,o]:[te(f,t)?.[0],te(te(f,t)?.[4],n)?.[0],o]);g.transaction((()=>y(i,(e=>e(o)))?se(u,((e,s)=>me(g,t,n,e,s(o,n)))):g.delRow(t,n)))})(n)},{3:L}=te(f,null);return g.transaction((()=>R(t,1,e.addRowListener(s,null,((n,o,r)=>{e.hasRow(s,r)?w(r,s,r,L):(g.delRow(t,r),Y(f,(({4:e})=>W(te(e,r),(([,s])=>{v(t,s),ne(e,r)})))))}))))),D},delQueryDefinition:e=>(m(e),c(e),D),getStore:s,getQueryIds:o,forEachQuery:r,hasQuery:a,getTableId:i,delListener:e=>(S.delListener(e),D),destroy:d,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=S.getListenerStats();return n}};return Te({[g]:[1,1],[w]:[0,1],SortedRowIds:[0,5],Row:[1,2],[L]:[0,2],[p]:[1,3]},(([e,t],s)=>{b(e?["get","has","forEach"]:["get"],(e=>D[e+f+s]=(...t)=>S[e+s](...t))),D[h+f+s+u]=(...e)=>S[h+s+u](...x(e,0,t),((s,...n)=>e[t](D,...n)))})),ye(D)})),Ne=he((e=>{const t=_(),s=_(),o=_(),r=_(),[a,i,l,c,d,u,,,f,h,g]=ue(e,(()=>[_(),_(),_(),_()]),(e=>O(e)?void 0:e+n)),[w,L,p]=Le((()=>I)),R=(e,t,s)=>W(u(e),(([n,,o])=>{if(!K(o,t)){const r=ce();if(d(e)!=y(e))de(r,t);else{let e=t;for(;!O(e)&&!K(r,e);)de(r,e),e=te(n,e)}if(s)return r;ne(o,t,r)}return te(o,t)})),v=(e,t)=>W(u(e),(([,,e])=>ne(e,t))),y=e=>te(t,e),I={setRelationshipDefinition:(e,n,a,i)=>(ne(t,e,a),f(e,n,((t,n)=>{const a=ce(),i=ce(),l=ce(),[c,d]=u(e);Y(n,(([t,s],n)=>{O(t)||(de(i,t),W(te(d,t),(e=>{Z(e,n),U(e)&&ne(d,t)}))),O(s)||(de(i,s),K(d,s)||ne(d,s,ce()),de(te(d,s),n)),de(a,n),ne(c,n,s),se(te(r,e),(t=>{K(R(e,t),n)&&de(l,t)}))})),t(),Y(a,(t=>L(s,[e,t]))),Y(i,(t=>L(o,[e,t]))),Y(l,(t=>{v(e,t),L(r,[e,t])}))}),fe(i)),I),delRelationshipDefinition:e=>(ne(t,e),h(e),I),getStore:a,getRelationshipIds:i,forEachRelationship:t=>l((s=>t(s,(t=>e.forEachRow(d(s),t))))),hasRelationship:c,getLocalTableId:d,getRemoteTableId:y,getRemoteRowId:(e,t)=>te(u(e)?.[0],t),getLocalRowIds:(e,t)=>V(te(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>O(u(e))?[t]:V(R(e,t,!0)),addRemoteRowIdListener:(e,t,n)=>w(n,s,[e,t]),addLocalRowIdsListener:(e,t,s)=>w(s,o,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(R(e,t),w(s,r,[e,t])),delListener:e=>(v(...p(e)),I),destroy:g,getListenerStats:()=>({})};return ye(I)})),Oe=e=>[e,e],We=()=>[_(),_()],Be=(e,t,s,n=ne)=>{const o=(r=ee(e),a=e=>!Ie(t,e),r.filter(a));var r,a;return b(Re(t),(n=>s(e,n,t[n]))),b(o,(t=>n(e,t))),e},qe=(e,t,s)=>O(e)||!(e=>N(e,pe)&&e.constructor==pe)(e)||be(e)||ve(e)?(s?.(),!1):(Te(e,((s,n)=>{t(s,n)||Se(e,n)})),!be(e)),He=(e,t,s)=>ne(e,t,te(e,t)==-s?void 0:s),$e=()=>{let e,t,s=0;const n=_(),o=_(),r=_(),i=_(),d=_(),f=_(),y=_(),S=_(),m=_(),E=We(),k=We(),M=We(),D=We(),F=We(),Q=We(),j=We(),z=We(),N=We(),H=We(),[$,G,V,le]=Le((()=>ct)),ue=(t,s)=>(!e||K(f,s)||Ge(s))&&qe(t,((e,t)=>fe(s,t,e)),(()=>Ge(s))),fe=(e,t,s,n)=>qe(n?s:ge(s,e,t),((n,o)=>W(he(e,t,o,n),(e=>(s[o]=e,!0)),(()=>!1))),(()=>Ge(e,t))),he=(t,s,n,o)=>e?W(te(te(f,t),n),(e=>Ce(o)!=e.type?Ge(t,s,n,o,e.default):o),(()=>Ge(t,s,n,o))):O(Ce(o))?Ge(t,s,n,o):o,ge=(e,t,s)=>(W(te(y,t),(([n,o])=>{Y(n,((t,s)=>{Ie(e,s)||(e[s]=t)})),Y(o,(n=>{Ie(e,n)||Ge(t,s,n)}))})),e),pe=e=>Be(f,e,((e,t,s)=>{const n=_(),o=ce();Be(oe(f,t,_),s,((e,t,s)=>{ne(e,t,s),W(s.default,(e=>ne(n,t,e)),(()=>de(o,t)))})),ne(y,t,[n,o])}),((e,t)=>{ne(f,t),ne(y,t)})),Re=e=>Be(m,e,((e,t,s)=>ve(t,s)),((e,t)=>Fe(t))),ve=(e,t)=>Be(oe(m,e,(()=>(Qe(e,1),_()))),t,((t,s,n)=>Ee(e,t,s,n)),((t,s)=>Je(e,t,s))),Ee=(e,t,s,n,o)=>Be(oe(t,s,(()=>(je(e,s,1),_()))),n,((t,n,o)=>Me(e,s,t,n,o)),((n,r)=>Pe(e,t,s,n,r,o))),Me=(e,t,s,n,o)=>{K(s,n)||ze(e,t,n,1);const r=te(s,n);o!==r&&(Ne(e,t,n,r,o),ne(s,n,o))},xe=(e,t,s,n,o)=>W(te(t,s),(t=>Me(e,s,t,n,o)),(()=>Ee(e,t,s,ge({[n]:o},e,s)))),Ae=e=>{const[t]=oe(S,e,we),s=t();return K(te(m,e),s)?Ae(e):s},De=e=>te(m,e)??ve(e,{}),Fe=e=>ve(e,{}),Je=(e,t,s)=>{const[,n]=oe(S,e,we);n(s),Ee(e,t,s,{},!0)},Pe=(e,t,s,n,o,r)=>{const a=te(te(y,e)?.[0],o);if(!O(a)&&!r)return Me(e,s,n,o,a);const i=t=>{Ne(e,s,t,te(n,t)),ze(e,s,t,-1),ne(n,t)};O(a)?i(o):se(n,i),U(n)&&(je(e,s,-1),U(ne(t,s))&&(Qe(e,-1),ne(m,e),ne(S,e)))},Qe=(e,t)=>He(n,e,t),je=(e,t,s)=>He(oe(o,e,_),t,s),ze=(e,t,s,n)=>He(oe(oe(r,e,_),t,_),s,n),Ne=(e,t,s,n,o)=>oe(oe(oe(i,e,_),t,_),s,(()=>[n,0]))[1]=o,Ge=(e,t,s,n,o)=>(A(oe(oe(oe(d,e,_),t,_),s,(()=>[])),n),o),Ke=(e,t,s)=>W(te(te(te(i,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...Oe(nt(e,t,s))])),Ue=e=>U(d)||U(N[e])?0:Y(e?ae(d,ie):d,((t,s)=>Y(t,((t,n)=>Y(t,((t,o)=>G(N[e],[s,n,o],t))))))),Ve=(e,t,s)=>{if(!U(t))return G(e,s),1},Xe=e=>{const t=U(F[e]),s=U(j[e])&&U(D[e])&&t&&U(k[e]),a=U(z[e])&&U(Q[e])&&U(M[e])&&U(E[e]);if(!s||!a){const l=e?[ae(n),ie(o),ae(r,ie),ae(i,ie)]:[n,o,r,i];if(!s){Y(l[2],((t,s)=>Y(t,((t,n)=>Ve(j[e],t,[s,n])))));const s=ce();Y(l[1],((n,o)=>{Ve(D[e],n,[o])&&!t&&(G(F[e],[o,null]),de(s,o))})),t||Y(l[3],((t,n)=>{if(!K(s,n)){const s=ce();Y(t,(e=>Y(e,(([t,n],o)=>n!==t?de(s,o):Z(e,o))))),Y(s,(t=>G(F[e],[n,t])))}})),Ve(k[e],l[0])}if(!a){let t;Y(l[3],((s,n)=>{let o;Y(s,((s,r)=>{let a;Y(s,(([s,i],l)=>{i!==s&&(G(z[e],[n,r,l],i,s,Ke),t=o=a=1)})),a&&G(Q[e],[n,r],Ke)})),o&&G(M[e],[n],Ke)})),t&&G(E[e],void 0,Ke)}}},Ye=(e,...t)=>(at((()=>e(...C(t,R)))),ct),Ze=()=>re(m,(e=>re(e,re))),_e=()=>ee(m),et=e=>ee(te(m,R(e))),tt=(e,t,s,n=0,o)=>{return C(x(T((r=te(m,R(e)),a=(e,s)=>[O(t)?s:te(e,R(t)),s],C([...r?.entries()??[]],(([e,t])=>a(t,e)))),(([e],[t])=>ke(e,t)*(s?-1:1))),n,O(o)?o:n+o),(([,e])=>e));var r,a},st=(e,t)=>ee(te(te(m,R(e)),R(t))),nt=(e,t,s)=>te(te(te(m,R(e)),R(t)),R(s)),ot=e=>Ye((()=>(e=>qe(e,ue,Ge))(e)?Re(e):0)),rt=()=>Ye((()=>Re({}))),at=(e,t)=>{if(-1==s)return;it();const n=e();return lt(t),n},it=()=>(s++,ct),lt=e=>(s>0&&(s--,0==s&&(t=!U(i),s=1,Ue(1),t&&Xe(1),s=-1,e?.(re(i,(e=>re(e,(e=>re(e,(e=>[...e]),(([e,t])=>e===t))),be)),be),re(d,(e=>re(e,re))))&&(s=1,Y(i,((e,t)=>Y(e,((e,s)=>Y(e,(([e],n)=>me(ct,t,s,n,e))))))),s=-1,t=!1),G(H[0],void 0,t),Ue(0),t&&Xe(0),G(H[1],void 0,t),s=0,b([i,d,n,o,r],X))),ct),ct={getTables:Ze,getTableIds:_e,getTable:e=>re(te(m,R(e)),re),getRowIds:et,getSortedRowIds:tt,getRow:(e,t)=>re(te(te(m,R(e)),R(t))),getCellIds:st,getCell:nt,hasTables:()=>!U(m),hasTable:e=>K(m,R(e)),hasRow:(e,t)=>K(te(m,R(e)),R(t)),hasCell:(e,t,s)=>K(te(te(m,R(e)),R(t)),R(s)),getJson:()=>J(m),getSchemaJson:()=>J(f),setTables:ot,setTable:(e,t)=>Ye((e=>ue(t,e)?ve(e,t):0),e),setRow:(e,t,s)=>Ye(((e,t)=>fe(R(e),R(t),s)?Ee(R(e),De(R(e)),R(t),s):0),e,t),addRow:(e,t)=>at((()=>{let s;return fe(e,s,t)&&(e=R(e),Ee(e,De(e),s=Ae(e),t)),s})),setPartialRow:(e,t,s)=>Ye(((e,t)=>{if(fe(e,t,s,1)){const n=De(e);Te(s,((s,o)=>xe(e,n,t,o,s)))}}),e,t),setCell:(e,t,s,n)=>Ye(((e,t,s)=>W(he(e,t,s,q(n)?n(nt(e,t,s)):n),(n=>xe(e,De(e),t,s,n)))),e,t,s),setJson:e=>{try{"{}"===e?rt():ot(P(e))}catch{}return ct},setSchema:t=>Ye((()=>{if((e=(e=>qe(e,(e=>qe(e,(e=>{if(!qe(e,((e,t)=>v([l,c],t))))return!1;const t=e.type;return!(!B(t)&&t!=a||(Ce(e.default)!=t&&Se(e,c),0))})))))(t))&&(pe(t),!U(m))){const e=Ze();rt(),ot(e)}})),delTables:rt,delTable:e=>Ye((e=>K(m,e)?Fe(e):0),e),delRow:(e,t)=>Ye(((e,t)=>W(te(m,e),(s=>K(s,t)?Je(e,s,t):0))),e,t),delCell:(e,t,s,n)=>Ye(((e,t,s)=>W(te(m,e),(o=>W(te(o,t),(r=>K(r,s)?Pe(e,o,t,r,s,n):0))))),e,t,s),delSchema:()=>Ye((()=>{pe({}),e=!1})),transaction:at,startTransaction:it,finishTransaction:lt,forEachTable:e=>Y(m,((t,s)=>e(s,(e=>Y(t,((t,s)=>e(s,(e=>se(t,e))))))))),forEachRow:(e,t)=>Y(te(m,R(e)),((e,s)=>t(s,(t=>se(e,t))))),forEachCell:(e,t,s)=>se(te(te(m,R(e)),R(t)),s),addSortedRowIdsListener:(e,t,s,n,o,r,a)=>{let i=tt(e,t,s,n,o);return $((()=>{const a=tt(e,t,s,n,o);I(a,i)||(i=a,r(ct,e,t,s,n,o,i))}),F[a?1:0],[e,t])},addWillFinishTransactionListener:e=>$(e,H[0]),addDidFinishTransactionListener:e=>$(e,H[1]),callListener:e=>(le(e,[_e,et,st],(e=>O(e[2])?[]:Oe(nt(...e)))),ct),delListener:e=>(V(e),ct),getListenerStats:()=>({}),createStore:$e};return Te({Tables:[0,E],TableIds:[0,k],[g]:[1,M],[w]:[1,D],Row:[2,Q],[L]:[2,j],[p]:[3,z],InvalidCell:[3,N]},(([e,t],s)=>{ct[h+s+u]=(...s)=>$(s[e],t[s[e+1]?1:0],e>0?x(s,0,e):void 0)})),ye(ct)};e.createCheckpoints=Ee,e.createCustomPersister=Fe,e.createFilePersister=(e,s)=>{let n;return Fe(e,(async()=>{try{return await t.promises.readFile(s,d)}catch{}}),(async e=>{try{await t.promises.writeFile(s,e,d)}catch{}}),(e=>{n=t.watch(s,e)}),(()=>{n?.close(),n=void 0}))},e.createIndexes=Me,e.createLocalPersister=(e,t)=>Qe(e,t,localStorage),e.createMetrics=De,e.createQueries=ze,e.createRelationships=Ne,e.createRemotePersister=(e,t,s,n)=>{let o,r;return Fe(e,(async()=>{const e=await fetch(t);return r=je(e),e.text()}),(async e=>await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:e})),(e=>{o=setInterval((async()=>{const s=await fetch(t,{method:"HEAD"}),n=je(s);O(r)||O(n)||n==r||(r=n,e())}),1e3*n)}),(()=>{W(o,clearInterval),o=void 0}))},e.createSessionPersister=(e,t)=>Qe(e,t,sessionStorage),e.createStore=$e,e.defaultSorter=ke},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs")):"function"==typeof define&&define.amd?define(["exports","fs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={},e.fs);
