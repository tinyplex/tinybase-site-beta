var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",n=t(s),o=t(!0),a=t(0),r=t(t),i="type",l="default",c="Listener",d="Result",u="add",h="Ids",g="Table",f=g+"s",L=g+h,w="Row",v=w+h,R="Sorted"+w+h,S="Cell",I=S+h,T="Value",p=T+"s",y=T+h,C=e=>s+e,b=(e,t)=>e.includes(t),V=(e,t)=>e.every(t),m=(e,t)=>J(e)===J(t)&&V(e,((e,s)=>t[s]===e)),k=(e,t)=>V(e,((s,n)=>0==n||t(e[n-1],s)<=0)),E=(e,t)=>e.sort(t),M=(e,t)=>e.forEach(t),x=(e,t)=>e.map(t),D=e=>F(e,((e,t)=>e+t),0),J=e=>e.length,A=e=>0==J(e),F=(e,t,s)=>e.reduce(t,s),Q=(e,t,s)=>e.slice(t,s),z=(e,...t)=>e.push(...t),N=e=>e.pop(),j=e=>e.shift(),O=e=>JSON.stringify(e,((e,t)=>q(t,Map)?F([...t],((e,[t,s])=>(e[t]=s,e)),{}):t)),P=JSON.parse,W=Math.max,B=Math.min,$=isFinite,q=(e,t)=>e instanceof t,G=e=>null==e,H=(e,t,s)=>G(e)?s?.():t(e),K=e=>e==n||e==o,U=e=>t(e)==r,X=e=>Array.isArray(e),Y=()=>{},Z=Object,_=Z.keys,ee=Z.isFrozen,te=Z.freeze,se=e=>q(e,Z)&&e.constructor==Z,ne=(e,t)=>!G(((e,t)=>H(e,(e=>e[t])))(e,t)),oe=(e,t)=>delete e[t],ae=(e,t)=>x(Z.entries(e),(([e,s])=>t(s,e))),re=e=>se(e)&&A(_(e)),ie=e=>e.size,le=(e,t)=>e?.has(t)??!1,ce=e=>G(e)||0==ie(e),de=e=>[...e?.values()??[]],ue=e=>e.clear(),he=(e,t)=>e?.forEach(t),ge=(e,t)=>e?.delete(t),fe=e=>new Map(e),Le=e=>[...e?.keys()??[]],we=(e,t)=>e?.get(t),ve=(e,t)=>he(e,((e,s)=>t(s,e))),Re=(e,t,s)=>G(s)?(ge(e,t),e):e?.set(t,s),Se=(e,t,s)=>(le(e,t)||Re(e,t,s()),we(e,t)),Ie=(e,t,s)=>{const n={};return he(e,((e,o)=>{const a=t?t(e,o):e;!s?.(a,e)&&(n[o]=a)})),n},Te=(e,t,s)=>Ie(e,(e=>Ie(e,t,s)),re),pe=(e,t,s)=>Ie(e,(e=>Te(e,t,s)),re),ye=(e,t)=>{const s=fe();return he(e,((e,n)=>s.set(n,t?.(e)??e))),s},Ce=e=>ye(e,ye),be=e=>ye(e,Ce),Ve=(e,t,s,n,o=0)=>H((s?Se:we)(e,t[o],o>J(t)-2?s:fe),(a=>{if(o>J(t)-2)return n?.(a)&&Re(e,t[o]),a;const r=Ve(a,t,s,n,o+1);return ce(a)&&Re(e,t[o]),r})),me=e=>{const s=t(e);return K(s)||s==a&&$(e)?s:void 0},ke=(e,t,s,n,o)=>G(o)?e.delCell(t,s,n,!0):e.setCell(t,s,n,o),Ee=(e,t,s)=>G(s)?e.delValue(t):e.setValue(t,s),Me=e=>new Set(X(e)||G(e)?e:[e]),xe=(e,t)=>e?.add(t),De=(e,t,s)=>{const n=e.hasRow,o=fe(),a=fe(),r=fe(),i=fe(),l=fe(),c=(t,s,...n)=>{const o=Se(l,t,Me);return M(n,(t=>xe(o,t)&&s&&e.callListener(t))),n},d=(t,...s)=>H(we(l,t),(n=>{M(A(s)?de(n):s,(t=>{e.delListener(t),ge(n,t)})),ce(n)&&Re(l,t)})),u=(e,s)=>{Re(o,e,s),le(a,e)||(Re(a,e,t()),Re(r,e,fe()),Re(i,e,fe()))},h=e=>{Re(o,e),Re(a,e),Re(r,e),Re(i,e),d(e)};return[()=>e,()=>Le(o),e=>ve(a,e),e=>le(a,e),e=>we(o,e),e=>we(a,e),(e,t)=>Re(a,e,t),u,(t,o,a,l,h)=>{u(t,o);const g=fe(),f=fe(),L=we(r,t),w=we(i,t),v=t=>{const a=s=>e.getCell(o,t,s),r=we(L,t),i=n(o,t)?s(l(a,t)):void 0;if(r===i||X(r)&&X(i)&&m(r,i)||Re(g,t,[r,i]),!G(h)){const e=we(w,t),s=n(o,t)?h(a,t):void 0;e!=s&&Re(f,t,s)}},R=e=>{a((()=>{he(g,(([,e],t)=>Re(L,t,e))),he(f,((e,t)=>Re(w,t,e)))}),g,f,L,w,e),ue(g),ue(f)};ve(L,v),e.hasTable(o)&&M(e.getRowIds(o),(e=>{le(L,e)||v(e)})),R(!0),d(t),c(t,0,e.addRowListener(o,null,((e,t,s)=>v(s))),e.addTableListener(o,(()=>R())))},h,()=>ve(l,h),c,d]},Je=(e,o)=>t(e)==n?t=>t(e):e??(()=>o??s),Ae=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},Fe=/^\d+$/,Qe=()=>{const e=[];let t=0;return[n=>(n?j(e):null)??s+t++,t=>{Fe.test(t)&&J(e)<1e3&&z(e,t)}]},ze=e=>{let t;const[n,o]=Qe(),a=fe();return[(o,r,i,l=[],c=(()=>[]))=>{t??=e();const d=n(1);return Re(a,d,[o,r,i,l,c]),xe(Ve(r,i??[s],Me),d),d},(e,n,...o)=>M(((e,t=[s])=>{const n=[],o=(e,s)=>s==J(t)?z(n,e):null===t[s]?he(e,(e=>o(e,s+1))):M([t[s],null],(t=>o(we(e,t),s+1)));return o(e,0),n})(e,n),(e=>he(e,(e=>we(a,e)[0](t,...n??[],...o))))),e=>H(we(a,e),(([,t,n])=>(Ve(t,n??[s],void 0,(t=>(ge(t,e),ce(t)?1:0))),Re(a,e),o(e),n))),e=>H(we(a,e),(([e,,s=[],n,o])=>{const a=(...r)=>{const i=J(r);i==J(s)?e(t,...r,...o(r)):G(s[i])?M(n[i]?.(...r)??[],(e=>a(...r,e))):a(...r,s[i])};a()}))]},Ne=Ae((e=>{let t,n,o,a=100,r=fe(),i=fe(),l=1;const c=fe(),d=fe(),[u,h,g]=ze((()=>O)),f=fe(),L=fe(),w=[],v=[],R=(t,s)=>{l=0,e.transaction((()=>{const[n,o]=we(f,s);he(n,((s,n)=>he(s,((s,o)=>he(s,((s,a)=>ke(e,n,o,a,s[t]))))))),he(o,((s,n)=>Ee(e,n,s[t])))})),l=1},S=e=>{Re(f,e),Re(L,e),h(d,[e])},I=(e,t)=>M(((e,t)=>e.splice(0,t))(e,t??J(e)),S),T=()=>I(w,J(w)-a),p=()=>H(t,(()=>{z(w,t),T(),I(v),t=void 0,o=1})),y=()=>{t=N(w),o=1},C=e.addCellListener(null,null,null,((e,t,s,n,o,a)=>{if(l){p();const e=Se(r,t,fe),i=Se(e,s,fe),l=Se(i,n,(()=>[a,void 0]));l[1]=o,l[0]===o&&ce(Re(i,n))&&ce(Re(e,s))&&ce(Re(r,t))&&y(),x()}})),V=e.addValueListener(null,((e,t,s,n)=>{if(l){p();const e=Se(i,t,(()=>[n,void 0]));e[1]=s,e[0]===s&&ce(Re(i,t))&&y(),x()}})),m=(e="")=>(G(t)&&(t=s+n++,Re(f,t,[r,i]),F(t,e),r=fe(),i=fe(),o=1),t),k=()=>{A(w)||(((e,...t)=>{e.unshift(...t)})(v,m()),R(0,t),t=N(w),o=1)},E=()=>{A(v)||(z(w,t),t=j(v),R(1,t),o=1)},x=()=>{o&&(h(c),o=0)},D=e=>{const t=m(e);return x(),t},F=(e,t)=>(Q(e)&&we(L,e)!==t&&(Re(L,e,t),h(d,[e])),O),Q=e=>le(f,e),O={setSize:e=>(a=e,T(),O),addCheckpoint:D,setCheckpoint:F,getStore:()=>e,getCheckpointIds:()=>[[...w],t,[...v]],forEachCheckpoint:e=>ve(L,e),hasCheckpoint:Q,getCheckpoint:e=>we(L,e),goBackward:()=>(k(),x(),O),goForward:()=>(E(),x(),O),goTo:e=>{const s=b(w,e)?k:b(v,e)?E:null;for(;!G(s)&&e!=t;)s();return x(),O},addCheckpointIdsListener:e=>u(e,c),addCheckpointListener:(e,t)=>u(t,d,[e]),delListener:e=>(g(e),O),clear:()=>(I(w),I(v),G(t)||S(t),t=void 0,n=0,D(),O),destroy:()=>{e.delListener(C),e.delListener(V)},getListenerStats:()=>({})};return te(O.clear())})),je=(e,t)=>e<t?-1:1,Oe=Ae((e=>{const t=fe(),n=fe(),[o,a,r,i,l,c,d,,u,h,g]=De(e,fe,(e=>G(e)?s:X(e)?x(e,C):C(e))),[f,L,w]=ze((()=>R)),v=(t,s,n)=>{const o=l(t);he(n,((t,n)=>s(n,(s=>he(t,(t=>s(t,(s=>e.forEachCell(o,t,s)))))))))},R={setIndexDefinition:(e,s,o,a,r,i=je)=>{const l=G(r)?void 0:([e],[t])=>r(e,t);return u(e,s,((s,o,r,u,h,g)=>{let f=0;const w=Me(),v=Me(),R=c(e);if(he(o,(([e,t],s)=>{const n=Me(e),o=Me(t);he(n,(e=>ge(o,e)?ge(n,e):0)),he(n,(e=>{xe(w,e),H(we(R,e),(t=>{ge(t,s),ce(t)&&(Re(R,e),f=1)}))})),he(o,(e=>{xe(w,e),le(R,e)||(Re(R,e,Me()),f=1),xe(we(R,e),s),G(a)||xe(v,e)}))})),s(),ce(h)||(g?ve(R,(e=>xe(v,e))):ve(r,(e=>H(we(u,e),(e=>xe(v,e))))),he(v,(e=>{const t=(t,s)=>i(we(h,t),we(h,s),e),s=[...we(R,e)];k(s,t)||(Re(R,e,Me(E(s,t))),xe(w,e))}))),(f||g)&&!G(l)){const t=[...R];k(t,l)||(d(e,fe(E(t,l))),f=1)}f&&L(t,[e]),he(w,(t=>L(n,[e,t])))}),Je(o),H(a,Je)),R},delIndexDefinition:e=>(h(e),R),getStore:o,getIndexIds:a,forEachIndex:e=>r(((t,s)=>e(t,(e=>v(t,e,s))))),forEachSlice:(e,t)=>v(e,t,c(e)),hasIndex:i,hasSlice:(e,t)=>le(c(e),t),getTableId:l,getSliceIds:e=>Le(c(e)),getSliceRowIds:(e,t)=>de(we(c(e),t)),addSliceIdsListener:(e,s)=>f(s,t,[e]),addSliceRowIdsListener:(e,t,s)=>f(s,n,[e,t]),delListener:e=>(w(e),R),destroy:g,getListenerStats:()=>({})};return te(R)})),Pe=fe([["avg",[(e,t)=>D(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>W(...e),(e,t)=>W(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:W(t,e)]],["min",[e=>B(...e),(e,t)=>B(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:B(t,e)]],["sum",[e=>D(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),We=(e,t,s,n,o,a=!1)=>{if(ce(s))return;const[r,i,l,c]=o;return a||=G(e),he(n,(([s,n])=>{a||(e=G(s)?i?.(e,n,t++):G(n)?l?.(e,s,t--):c?.(e,n,s,t),a||=G(e))})),a?r(de(s),ie(s)):e},Be=Ae((e=>{const t=fe(),[n,o,a,r,i,l,c,,d,u,h]=De(e,Y,(e=>isNaN(e)||G(e)||!0===e||!1===e||e===s?void 0:1*e)),[g,f,L]=ze((()=>w)),w={setMetricDefinition:(e,s,n,o,a,r,i)=>{const u=U(n)?[n,a,r,i]:we(Pe,n)??we(Pe,"sum");return d(e,s,((s,n,o,a,r,i)=>{const d=l(e),h=ie(a);i||=G(d),s();let g=We(d,h,a,n,u,i);$(g)||(g=void 0),g!=d&&(c(e,g),f(t,[e],g,d))}),Je(o,1)),w},delMetricDefinition:e=>(u(e),w),getStore:n,getMetricIds:o,forEachMetric:a,hasMetric:r,getTableId:i,getMetric:l,addMetricListener:(e,s)=>g(s,t,[e]),delListener:e=>(L(e),w),destroy:h,getListenerStats:()=>({})};return te(w)})),$e=Ae((e=>{const t=e.createStore,[n,o,a,r,i,,,l,,h,f,L,T]=De(e,(()=>!0),Y),p=t(),y=t(),C=fe(),b=(e,t,...s)=>M(s,(s=>xe(Se(Se(C,t,fe),e,Me),s))),m=e=>{H(we(C,e),(e=>{ve(e,((e,t)=>he(t,(t=>e.delListener(t))))),ue(e)})),M([y,p],(t=>t.delTable(e)))},k=(e,t,s)=>b(t,e,t.addWillFinishTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),E={setQueryDefinition:(t,n,o)=>{l(t,n),m(t);const a=[],r=[[null,[n,null,null,[],fe()]]],i=[],c=[],d=[];o({select:(e,t)=>{const n=U(e)?[J(a)+s,e]:[G(t)?e:t,s=>s(e,t)];return z(a,n),{as:e=>n[0]=e}},join:(e,t,s)=>{const n=G(s)||U(t)?null:t,o=G(n)?t:s,a=[e,[e,n,U(o)?o:e=>e(o),[],fe()]];return z(r,a),{as:e=>a[0]=e}},where:(e,t,s)=>z(i,U(e)?e:G(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,o)=>{const a=[e,[e,U(t)?[t,s,n,o]:we(Pe,t)??[(e,t)=>t]]];return z(c,a),{as:e=>a[0]=e}},having:(e,t)=>z(d,U(e)?e:s=>s(e)===t)});const u=fe(a);if(ce(u))return E;const h=fe(r);ve(h,((e,[,t])=>H(we(h,t),(({3:t})=>G(e)?0:z(t,e)))));const g=fe(c);let f=p;if(ce(g)&&A(d))f=y;else{k(t,f,y);const e=fe();ve(g,((t,[s,n])=>xe(Se(e,s,Me),[t,n])));const s=Me();ve(u,(t=>le(e,t)?0:xe(s,t)));const n=fe(),o=(s,n,o,a)=>H(s,(([r,i,l,c])=>{ve(n,((t,[s])=>{const n=Se(r,t,fe),i=we(n,o),l=a?void 0:s;if(i!==l){const s=Me([[i,l]]),a=ie(n);Re(n,o,l),he(we(e,t),(([e,t])=>{const o=We(c[e],a,n,s,t);c[e]=G(me(o))?null:o}))}})),ce(i)||!V(d,(e=>e((e=>c[e]))))?y.delRow(t,l):G(l)?s[2]=y.addRow(t,c):y.setRow(t,l,c)}));b(f,t,f.addRowListener(t,null,((a,r,i,l)=>{const c=[],d=[],u=fe(),h=f.hasRow(t,i);let g=!h;he(s,(e=>{const[s,n,o]=l(t,i,e);z(c,n),z(d,o),g||=s})),ve(e,(e=>{const[s,,n]=l(t,i,e);(g||s)&&Re(u,e,[n])})),g&&o(Ve(n,c,void 0,(([,e])=>(ge(e,i),ce(e)))),u,i,1),h&&o(Ve(n,d,(()=>{const e={};return he(s,(s=>e[s]=f.getCell(t,i,s))),[fe(),Me(),void 0,e]}),(([,e])=>{xe(e,i)})),u,i)})))}k(t,e,f);const w=(s,o,a,r)=>{const l=t=>e.getCell(o,a,t);M(r,(n=>{const[o,,a,r,i]=we(h,n),c=a?.(l,s),[d,u]=we(i,s)??[];c!=d&&(G(u)||T(t,u),Re(i,s,G(c)?null:[c,...L(t,1,e.addRowListener(o,c,(()=>w(s,o,c,r))))]))})),(s=>{const o=(t,o)=>e.getCell(...G(o)?[n,s,t]:t===n?[n,s,o]:[we(h,t)?.[0],we(we(h,t)?.[4],s)?.[0],o]);f.transaction((()=>V(i,(e=>e(o)))?ve(u,((e,n)=>ke(f,t,s,e,n(o,s)))):f.delRow(t,s)))})(s)},{3:v}=we(h,null);return f.transaction((()=>L(t,1,e.addRowListener(n,null,((s,o,a)=>{e.hasRow(n,a)?w(a,n,a,v):(f.delRow(t,a),he(h,(({4:e})=>H(we(e,a),(([,s])=>{T(t,s),Re(e,a)})))))}))))),E},delQueryDefinition:e=>(m(e),h(e),E),getStore:n,getQueryIds:o,forEachQuery:a,hasQuery:r,getTableId:i,delListener:e=>(y.delListener(e),E),destroy:f,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=y.getListenerStats();return n}};return ae({[g]:[1,1],[v]:[0,1],[R]:[0,5],[w]:[1,2],[I]:[0,2],[S]:[1,3]},(([e,t],s)=>{M(e?["get","has","forEach"]:["get"],(e=>E[e+d+s]=(...t)=>y[e+s](...t))),E[u+d+s+c]=(...e)=>y[u+s+c](...Q(e,0,t),((s,...n)=>e[t](E,...n)))})),te(E)})),qe=Ae((e=>{const t=fe(),n=fe(),o=fe(),a=fe(),[r,i,l,c,d,u,,,h,g,f]=De(e,(()=>[fe(),fe(),fe(),fe()]),(e=>G(e)?void 0:e+s)),[L,w,v]=ze((()=>T)),R=(e,t,s)=>H(u(e),(([n,,o])=>{if(!le(o,t)){const a=Me();if(d(e)!=I(e))xe(a,t);else{let e=t;for(;!G(e)&&!le(a,e);)xe(a,e),e=we(n,e)}if(s)return a;Re(o,t,a)}return we(o,t)})),S=(e,t)=>H(u(e),(([,,e])=>Re(e,t))),I=e=>we(t,e),T={setRelationshipDefinition:(e,s,r,i)=>(Re(t,e,r),h(e,s,((t,s)=>{const r=Me(),i=Me(),l=Me(),[c,d]=u(e);he(s,(([t,s],n)=>{G(t)||(xe(i,t),H(we(d,t),(e=>{ge(e,n),ce(e)&&Re(d,t)}))),G(s)||(xe(i,s),le(d,s)||Re(d,s,Me()),xe(we(d,s),n)),xe(r,n),Re(c,n,s),ve(we(a,e),(t=>{le(R(e,t),n)&&xe(l,t)}))})),t(),he(r,(t=>w(n,[e,t]))),he(i,(t=>w(o,[e,t]))),he(l,(t=>{S(e,t),w(a,[e,t])}))}),Je(i)),T),delRelationshipDefinition:e=>(Re(t,e),g(e),T),getStore:r,getRelationshipIds:i,forEachRelationship:t=>l((s=>t(s,(t=>e.forEachRow(d(s),t))))),hasRelationship:c,getLocalTableId:d,getRemoteTableId:I,getRemoteRowId:(e,t)=>we(u(e)?.[0],t),getLocalRowIds:(e,t)=>de(we(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>G(u(e))?[t]:de(R(e,t,!0)),addRemoteRowIdListener:(e,t,s)=>L(s,n,[e,t]),addLocalRowIdsListener:(e,t,s)=>L(s,o,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(R(e,t),L(s,a,[e,t])),delListener:e=>(S(...v(e)),T),destroy:f,getListenerStats:()=>({})};return te(T)})),Ge=e=>[e,e],He=()=>[fe(),fe()],Ke=e=>[...e],Ue=([e,t])=>e===t,Xe=(e,t,s,n=Re)=>(ae(t,((t,n)=>s(e,n,t))),ve(e,(s=>ne(t,s)?0:n(e,s))),e),Ye=(e,t,s)=>G(e)||!se(e)||re(e)||ee(e)?(s?.(),!1):(ae(e,((s,n)=>{t(s,n)||oe(e,n)})),!re(e)),Ze=(e,t,s)=>Re(e,t,we(e,t)==-s?void 0:s),_e=()=>{let e,t,s,n,o=0;const r=fe(),d=fe(),h=fe(),R=fe(),V=fe(),k=fe(),D=fe(),J=fe(),A=fe(),F=fe(),N=fe(),j=fe(),W=Me(),B=fe(),$=fe(),q=fe(),X=He(),Y=He(),Z=He(),_=He(),ee=He(),se=He(),ie=He(),de=He(),Ve=He(),De=He(),Je=He(),Ae=He(),Fe=He(),Ne=He(),[Oe,Pe,We,Be]=ze((()=>ds)),$e=e=>{if(!Ye(e,((e,t)=>b([i,l],t))))return!1;const t=e[i];return!(!K(t)&&t!=a||(me(e[l])!=t&&oe(e,l),0))},qe=(t,s)=>(!e||le(A,s)||Et(s))&&Ye(t,((e,t)=>et(s,t,e)),(()=>Et(s))),et=(e,t,s,n)=>Ye(n?s:ot(s,e,t),((n,o)=>H(tt(e,t,o,n),(e=>(s[o]=e,!0)),(()=>!1))),(()=>Et(e,t))),tt=(t,s,n,o)=>e?H(we(we(A,t),n),(e=>me(o)!=e[i]?Et(t,s,n,o,e[l]):o),(()=>Et(t,s,n,o))):G(me(o))?Et(t,s,n,o):o,st=(e,t)=>Ye(t?e:at(e),((t,s)=>H(nt(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>Mt())),nt=(e,s)=>t?H(we(N,e),(t=>me(s)!=t[i]?Mt(e,s,t[l]):s),(()=>Mt(e,s))):G(me(s))?Mt(e,s):s,ot=(e,t,s)=>(H(we(F,t),(([n,o])=>{he(n,((t,s)=>{ne(e,s)||(e[s]=t)})),he(o,(n=>{ne(e,n)||Et(t,s,n)}))})),e),at=e=>(t&&(he(j,((t,s)=>{ne(e,s)||(e[s]=t)})),he(W,(t=>{ne(e,t)||Mt(t)}))),e),rt=e=>Xe(A,e,((e,t,s)=>{const n=fe(),o=Me();Xe(Se(A,t,fe),s,((e,t,s)=>{Re(e,t,s),H(s[l],(e=>Re(n,t,e)),(()=>xe(o,t)))})),Re(F,t,[n,o])}),((e,t)=>{Re(A,t),Re(F,t)})),it=e=>Xe(N,e,((e,t,s)=>{Re(N,t,s),H(s[l],(e=>Re(j,t,e)),(()=>xe(W,t)))}),((e,t)=>{Re(N,t),Re(j,t),ge(W,t)})),lt=e=>re(e)?ts():Xt(e),ct=e=>Xe($,e,((e,t,s)=>dt(t,s)),((e,t)=>St(t))),dt=(e,t)=>Xe(Se($,e,(()=>(yt(e,1),fe()))),t,((t,s,n)=>ut(e,t,s,n)),((t,s)=>It(e,t,s))),ut=(e,t,s,n,o)=>Xe(Se(t,s,(()=>(Ct(e,s,1),fe()))),n,((t,n,o)=>ht(e,s,t,n,o)),((n,a)=>Tt(e,t,s,n,a,o))),ht=(e,t,s,n,o)=>{le(s,n)||bt(e,t,n,1);const a=we(s,n);o!==a&&(Vt(e,t,n,a,o),Re(s,n,o))},gt=(e,t,s,n,o)=>H(we(t,s),(t=>ht(e,s,t,n,o)),(()=>ut(e,t,s,ot({[n]:o},e,s)))),ft=e=>re(e)?os():Yt(e),Lt=e=>Xe(q,e,((e,t,s)=>wt(t,s)),((e,t)=>pt(t))),wt=(e,t)=>{le(q,e)||mt(e,1);const s=we(q,e);t!==s&&(kt(e,s,t),Re(q,e,t))},vt=(e,t)=>{const[s]=Se(B,e,Qe),n=s(t);return le(we($,e),n)?vt(e,t):n},Rt=e=>we($,e)??dt(e,{}),St=e=>dt(e,{}),It=(e,t,s)=>{const[,n]=Se(B,e,Qe);n(s),ut(e,t,s,{},!0)},Tt=(e,t,s,n,o,a)=>{const r=we(we(F,e)?.[0],o);if(!G(r)&&!a)return ht(e,s,n,o,r);const i=t=>{Vt(e,s,t,we(n,t)),bt(e,s,t,-1),Re(n,t)};G(r)?i(o):ve(n,i),ce(n)&&(Ct(e,s,-1),ce(Re(t,s))&&(yt(e,-1),Re($,e),Re(B,e)))},pt=e=>{const t=we(j,e);if(!G(t))return wt(e,t);kt(e,we(q,e)),mt(e,-1),Re(q,e)},yt=(e,t)=>Ze(r,e,t),Ct=(e,t,s)=>Ze(Se(d,e,fe),t,s),bt=(e,t,s,n)=>Ze(Se(Se(h,e,fe),t,fe),s,n),Vt=(e,t,s,n,o)=>Se(Se(Se(R,e,fe),t,fe),s,(()=>[n,0]))[1]=o,mt=(e,t)=>Ze(V,e,t),kt=(e,t,s)=>Se(k,e,(()=>[t,0]))[1]=s,Et=(e,t,s,n,o)=>(z(Se(Se(Se(D,e,fe),t,fe),s,(()=>[])),n),o),Mt=(e,t,s)=>(z(Se(J,e,(()=>[])),t),s),xt=(e,t,s)=>H(we(we(we(R,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...Ge(Gt(e,t,s))])),Dt=e=>H(we(k,e),(([e,t])=>[!0,e,t]),(()=>[!1,...Ge(Ut(e))])),Jt=e=>ce(D)||ce(Ve[e])?0:he(e?be(D):D,((t,s)=>he(t,((t,n)=>he(t,((t,o)=>Pe(Ve[e],[s,n,o],t))))))),At=e=>ce(J)||ce(De[e])?0:he(e?ye(J):J,((t,s)=>Pe(De[e],[s],t))),Ft=(e,t,s)=>{if(!ce(t))return Pe(e,s),1},Qt=e=>{const t=ce(ee[e]),s=ce(ie[e])&&ce(_[e])&&t&&ce(Y[e]),n=ce(de[e])&&ce(se[e])&&ce(Z[e])&&ce(X[e]);if(!s||!n){const o=e?[ye(r),Ce(d),be(h),be(R)]:[r,d,h,R];if(!s){he(o[2],((t,s)=>he(t,((t,n)=>Ft(ie[e],t,[s,n])))));const s=Me();he(o[1],((n,o)=>{Ft(_[e],n,[o])&&!t&&(Pe(ee[e],[o,null]),xe(s,o))})),t||he(o[3],((t,n)=>{if(!le(s,n)){const s=Me();he(t,(e=>he(e,(([t,n],o)=>n!==t?xe(s,o):ge(e,o))))),he(s,(t=>Pe(ee[e],[n,t])))}})),Ft(Y[e],o[0])}if(!n){let t;he(o[3],((s,n)=>{let o;he(s,((s,a)=>{let r;he(s,(([s,i],l)=>{i!==s&&(Pe(de[e],[n,a,l],i,s,xt),t=o=r=1)})),r&&Pe(se[e],[n,a],xt)})),o&&Pe(Z[e],[n],xt)})),t&&Pe(X[e],void 0,xt)}}},zt=e=>{const t=ce(Ae[e]),s=ce(Fe[e])&&ce(Je[e]);if(!t||!s){const n=e?[ye(V),ye(k)]:[V,k];if(t||Ft(Ae[e],n[0]),!s){let t;he(n[1],(([s,n],o)=>{n!==s&&(Pe(Fe[e],[o],n,s,Dt),t=1)})),t&&Pe(Je[e],void 0,Dt)}}},Nt=(e,...t)=>(is((()=>e(...x(t,C)))),ds),jt=()=>[Ie(R,((e,t)=>-1===we(r,t)?null:Ie(e,((e,s)=>-1===we(we(d,t),s)?null:Ie(e,(([,e])=>e??null),((e,t)=>Ue(t)))),re)),re),Ie(k,(([,e])=>e??null),((e,t)=>Ue(t)))],Ot=()=>({cellsTouched:s,valuesTouched:n,changedCells:pe(R,Ke,Ue),invalidCells:pe(D),changedValues:Ie(k,Ke,Ue),invalidValues:Ie(J),changedTableIds:Ie(r),changedRowIds:Te(d),changedCellIds:pe(h),changedValueIds:Ie(V)}),Pt=()=>pe($),Wt=()=>Le($),Bt=e=>Le(we($,C(e))),$t=(e,t,s,n=0,o)=>{return x(Q(E((a=we($,C(e)),r=(e,s)=>[G(t)?s:we(e,C(t)),s],x([...a?.entries()??[]],(([e,t])=>r(t,e)))),(([e],[t])=>je(e,t)*(s?-1:1))),n,G(o)?o:n+o),(([,e])=>e));var a,r},qt=(e,t)=>Le(we(we($,C(e)),C(t))),Gt=(e,t,s)=>we(we(we($,C(e)),C(t)),C(s)),Ht=()=>Ie(q),Kt=()=>Le(q),Ut=e=>we(q,C(e)),Xt=e=>Nt((()=>(e=>Ye(e,qe,Et))(e)?ct(e):0)),Yt=e=>Nt((()=>st(e)?Lt(e):0)),Zt=e=>{try{lt(P(e))}catch{}return ds},_t=t=>Nt((()=>{if((e=Ye(t,(e=>Ye(e,$e))))&&(rt(t),!ce($))){const e=Pt();ts(),Xt(e)}})),es=e=>Nt((()=>{if(t=(e=>Ye(e,$e))(e)){const s=Ht();rs(),os(),t=!0,it(e),Yt(s)}})),ts=()=>Nt((()=>ct({}))),ss=e=>Nt((e=>le($,e)?St(e):0),e),ns=(e,t)=>Nt(((e,t)=>H(we($,e),(s=>le(s,t)?It(e,s,t):0))),e,t),os=()=>Nt((()=>Lt({}))),as=()=>Nt((()=>{rt({}),e=!1})),rs=()=>Nt((()=>{it({}),t=!1})),is=(e,t)=>{if(-1==o)return;ls();const s=e();return cs(t),s},ls=()=>(o++,ds),cs=e=>(o>0&&(o--,0==o&&(s=!ce(R),n=!ce(k),o=1,Jt(1),s&&Qt(1),At(1),n&&zt(1),o=-1,e?.(jt,Ot)&&(o=1,he(R,((e,t)=>he(e,((e,s)=>he(e,(([e],n)=>ke(ds,t,s,n,e))))))),he(k,(([e],t)=>Ee(ds,t,e))),o=-1,s=n=!1),Pe(Ne[0],void 0,jt,Ot),Jt(0),s&&Qt(0),At(0),n&&zt(0),Pe(Ne[1],void 0,jt,Ot),o=0,M([r,d,h,R,D,V,k,J],ue))),ds),ds={getContent:()=>[Pt(),Ht()],getTables:Pt,getTableIds:Wt,getTable:e=>Te(we($,C(e))),getRowIds:Bt,getSortedRowIds:$t,getRow:(e,t)=>Ie(we(we($,C(e)),C(t))),getCellIds:qt,getCell:Gt,getValues:Ht,getValueIds:Kt,getValue:Ut,hasTables:()=>!ce($),hasTable:e=>le($,C(e)),hasRow:(e,t)=>le(we($,C(e)),C(t)),hasCell:(e,t,s)=>le(we(we($,C(e)),C(t)),C(s)),hasValues:()=>!ce(q),hasValue:e=>le(q,C(e)),getTablesJson:()=>O($),getValuesJson:()=>O(q),getJson:()=>O([$,q]),getTablesSchemaJson:()=>O(A),getValuesSchemaJson:()=>O(N),getSchemaJson:()=>O([A,N]),setContent:([e,t])=>Nt((()=>{Xt(e),Yt(t)})),setTables:Xt,setTable:(e,t)=>Nt((e=>qe(t,e)?dt(e,t):0),e),setRow:(e,t,s)=>Nt(((e,t)=>et(e,t,s)?ut(e,Rt(e),t,s):0),e,t),addRow:(e,t,s=!0)=>is((()=>{let n;return et(e,n,t)&&(e=C(e),ut(e,Rt(e),n=vt(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>Nt(((e,t)=>{if(et(e,t,s,1)){const n=Rt(e);ae(s,((s,o)=>gt(e,n,t,o,s)))}}),e,t),setCell:(e,t,s,n)=>Nt(((e,t,s)=>H(tt(e,t,s,U(n)?n(Gt(e,t,s)):n),(n=>gt(e,Rt(e),t,s,n)))),e,t,s),setValues:Yt,setPartialValues:e=>Nt((()=>st(e,1)?ae(e,((e,t)=>wt(t,e))):0)),setValue:(e,t)=>Nt((e=>H(nt(e,U(t)?t(Ut(e)):t),(t=>wt(e,t)))),e),setTransactionChanges:e=>Nt((()=>{ae(e[0],((e,t)=>G(e)?ss(t):ae(e,((e,s)=>G(e)?ns(t,s):ae(e,((e,n)=>ke(ds,t,s,n,e))))))),ae(e[1],((e,t)=>Ee(ds,t,e)))})),setTablesJson:Zt,setValuesJson:e=>{try{ft(P(e))}catch{}return ds},setJson:e=>{try{const[t,s]=P(e);lt(t),ft(s)}catch{Zt(e)}return ds},setTablesSchema:_t,setValuesSchema:es,setSchema:(e,t)=>Nt((()=>{_t(e),es(t)})),delTables:ts,delTable:ss,delRow:ns,delCell:(e,t,s,n)=>Nt(((e,t,s)=>H(we($,e),(o=>H(we(o,t),(a=>le(a,s)?Tt(e,o,t,a,s,n):0))))),e,t,s),delValues:os,delValue:e=>Nt((e=>le(q,e)?pt(e):0),e),delTablesSchema:as,delValuesSchema:rs,delSchema:()=>Nt((()=>{as(),rs()})),transaction:is,startTransaction:ls,finishTransaction:cs,forEachTable:e=>he($,((t,s)=>e(s,(e=>he(t,((t,s)=>e(s,(e=>ve(t,e))))))))),forEachRow:(e,t)=>he(we($,C(e)),((e,s)=>t(s,(t=>ve(e,t))))),forEachCell:(e,t,s)=>ve(we(we($,C(e)),C(t)),s),forEachValue:e=>ve(q,e),addSortedRowIdsListener:(e,t,s,n,o,a,r)=>{let i=$t(e,t,s,n,o);return Oe((()=>{const r=$t(e,t,s,n,o);m(r,i)||(i=r,a(ds,e,t,s,n,o,i))}),ee[r?1:0],[e,t],[Wt])},addWillFinishTransactionListener:e=>Oe(e,Ne[0]),addDidFinishTransactionListener:e=>Oe(e,Ne[1]),callListener:e=>(Be(e),ds),delListener:e=>(We(e),ds),getListenerStats:()=>({}),createStore:_e};return ae({[f]:[0,X],[L]:[0,Y],[g]:[1,Z,[Wt]],[v]:[1,_,[Wt]],[w]:[2,se,[Wt,Bt]],[I]:[2,ie,[Wt,Bt]],[S]:[3,de,[Wt,Bt,qt],e=>Ge(Gt(...e))],InvalidCell:[3,Ve],[p]:[0,Je],[y]:[0,Ae],[T]:[1,Fe,[Kt],e=>Ge(Ut(e[0]))],InvalidValue:[1,De]},(([e,t,s,n],o)=>{ds[u+o+c]=(...o)=>Oe(o[e],t[o[e+1]?1:0],e>0?Q(o,0,e):void 0,s,n)})),te(ds)};e.createCheckpoints=Ne,e.createCustomPersister=(e,t,s,n,o)=>{let a,r,i=0,l=!1;const c=async e=>{2!=i&&(i=1,await e(),i=0)},d={load:async(s,n)=>(await c((async()=>{let o;try{o=await t()}catch{}e.setContent(o??[s,n])})),d),startAutoLoad:async(s,o)=>(d.stopAutoLoad(),await d.load(s,o),l=!0,r=n((async(s,n)=>{await c((async()=>{if(n)e.setTransactionChanges(n());else try{e.setContent(s?.()??await t())}catch{}}))})),d),stopAutoLoad:()=>(l&&(o(r),r=void 0,l=!1),d),save:async t=>(1!=i&&(i=2,await s(e.getContent,t),i=0),d),startAutoSave:async()=>(await d.stopAutoSave().save(),a=e.addDidFinishTransactionListener(((e,t)=>d.save(t))),d),stopAutoSave:()=>(H(a,e.delListener),d),getStore:()=>e,destroy:()=>d.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return te(d)},e.createIndexes=Oe,e.createMetrics=Be,e.createQueries=$e,e.createRelationships=qe,e.createStore=_e,e.defaultSorter=je},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={});
