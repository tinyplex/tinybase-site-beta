var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",n=t(s),o=t(!0),a=t(0),r=t(t),i="type",l="default",c="Listener",d="Result",u="add",h="Ids",g="Table",f=g+"s",L=g+h,w="Row",S=w+h,v="Sorted"+w+h,R="Cell",T=R+h,I="Value",p=I+"s",y=I+h,C=e=>s+e,b=(e,t)=>e.includes(t),V=(e,t)=>e.every(t),m=(e,t)=>J(e)===J(t)&&V(e,((e,s)=>t[s]===e)),k=(e,t)=>V(e,((s,n)=>0==n||t(e[n-1],s)<=0)),E=(e,t)=>e.sort(t),M=(e,t)=>e.forEach(t),x=(e,t)=>e.map(t),D=e=>F(e,((e,t)=>e+t),0),J=e=>e.length,A=e=>0==J(e),F=(e,t,s)=>e.reduce(t,s),Q=(e,t,s)=>e.slice(t,s),z=(e,...t)=>e.push(...t),N=e=>e.pop(),j=e=>e.shift(),O=e=>JSON.stringify(e,((e,t)=>q(t,Map)?F([...t],((e,[t,s])=>(e[t]=s,e)),{}):t)),P=JSON.parse,B=Math.max,W=Math.min,$=isFinite,q=(e,t)=>e instanceof t,G=e=>null==e,H=(e,t,s)=>G(e)?s?.():t(e),K=e=>e==n||e==o,U=e=>t(e)==r,X=e=>Array.isArray(e),Y=()=>{},Z=Object,_=Z.keys,ee=Z.isFrozen,te=Z.freeze,se=e=>q(e,Z)&&e.constructor==Z,ne=(e,t)=>!G(((e,t)=>H(e,(e=>e[t])))(e,t)),oe=(e,t)=>delete e[t],ae=(e,t)=>x(Z.entries(e),(([e,s])=>t(s,e))),re=e=>se(e)&&A(_(e)),ie=e=>e.size,le=(e,t)=>e?.has(t)??!1,ce=e=>G(e)||0==ie(e),de=e=>[...e?.values()??[]],ue=e=>e.clear(),he=(e,t)=>e?.forEach(t),ge=(e,t)=>e?.delete(t),fe=e=>new Map(e),Le=e=>[...e?.keys()??[]],we=(e,t)=>e?.get(t),Se=(e,t)=>he(e,((e,s)=>t(s,e))),ve=(e,t,s)=>G(s)?(ge(e,t),e):e?.set(t,s),Re=(e,t,s)=>(le(e,t)||ve(e,t,s()),we(e,t)),Te=(e,t,s)=>{const n={};return he(e,((e,o)=>{const a=t?t(e,o):e;!s?.(a,e)&&(n[o]=a)})),n},Ie=(e,t,s)=>Te(e,(e=>Te(e,t,s)),re),pe=(e,t,s)=>Te(e,(e=>Ie(e,t,s)),re),ye=(e,t)=>{const s=fe();return he(e,((e,n)=>s.set(n,t?.(e)??e))),s},Ce=e=>ye(e,ye),be=e=>ye(e,Ce),Ve=(e,t,s,n,o=0)=>H((s?Re:we)(e,t[o],o>J(t)-2?s:fe),(a=>{if(o>J(t)-2)return n?.(a)&&ve(e,t[o]),a;const r=Ve(a,t,s,n,o+1);return ce(a)&&ve(e,t[o]),r})),me=e=>{const s=t(e);return K(s)||s==a&&$(e)?s:void 0},ke=(e,t,s,n,o)=>G(o)?e.delCell(t,s,n,!0):e.setCell(t,s,n,o),Ee=(e,t,s)=>G(s)?e.delValue(t):e.setValue(t,s),Me=e=>new Set(X(e)||G(e)?e:[e]),xe=(e,t)=>e?.add(t),De=(e,t,s)=>{const n=e.hasRow,o=fe(),a=fe(),r=fe(),i=fe(),l=fe(),c=(t,s,...n)=>{const o=Re(l,t,Me);return M(n,(t=>xe(o,t)&&s&&e.callListener(t))),n},d=(t,...s)=>H(we(l,t),(n=>{M(A(s)?de(n):s,(t=>{e.delListener(t),ge(n,t)})),ce(n)&&ve(l,t)})),u=(e,s)=>{ve(o,e,s),le(a,e)||(ve(a,e,t()),ve(r,e,fe()),ve(i,e,fe()))},h=e=>{ve(o,e),ve(a,e),ve(r,e),ve(i,e),d(e)};return[()=>e,()=>Le(o),e=>Se(a,e),e=>le(a,e),e=>we(o,e),e=>we(a,e),(e,t)=>ve(a,e,t),u,(t,o,a,l,h)=>{u(t,o);const g=fe(),f=fe(),L=we(r,t),w=we(i,t),S=t=>{const a=s=>e.getCell(o,t,s),r=we(L,t),i=n(o,t)?s(l(a,t)):void 0;if(r===i||X(r)&&X(i)&&m(r,i)||ve(g,t,[r,i]),!G(h)){const e=we(w,t),s=n(o,t)?h(a,t):void 0;e!=s&&ve(f,t,s)}},v=e=>{a((()=>{he(g,(([,e],t)=>ve(L,t,e))),he(f,((e,t)=>ve(w,t,e)))}),g,f,L,w,e),ue(g),ue(f)};Se(L,S),e.hasTable(o)&&M(e.getRowIds(o),(e=>{le(L,e)||S(e)})),v(!0),d(t),c(t,0,e.addRowListener(o,null,((e,t,s)=>S(s))),e.addTableListener(o,(()=>v())))},h,()=>Se(l,h),c,d]},Je=(e,o)=>t(e)==n?t=>t(e):e??(()=>o??s),Ae=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},Fe=/^\d+$/,Qe=()=>{const e=[];let t=0;return[n=>(n?j(e):null)??s+t++,t=>{Fe.test(t)&&J(e)<1e3&&z(e,t)}]},ze=e=>{let t;const[n,o]=Qe(),a=fe();return[(o,r,i,l=[],c=(()=>[]))=>{t??=e();const d=n(1);return ve(a,d,[o,r,i,l,c]),xe(Ve(r,i??[s],Me),d),d},(e,n,...o)=>M(((e,t=[s])=>{const n=[],o=(e,s)=>s==J(t)?z(n,e):null===t[s]?he(e,(e=>o(e,s+1))):M([t[s],null],(t=>o(we(e,t),s+1)));return o(e,0),n})(e,n),(e=>he(e,(e=>we(a,e)[0](t,...n??[],...o))))),e=>H(we(a,e),(([,t,n])=>(Ve(t,n??[s],void 0,(t=>(ge(t,e),ce(t)?1:0))),ve(a,e),o(e),n))),e=>H(we(a,e),(([e,,s=[],n,o])=>{const a=(...r)=>{const i=J(r);i==J(s)?e(t,...r,...o(r)):G(s[i])?M(n[i]?.(...r)??[],(e=>a(...r,e))):a(...r,s[i])};a()}))]},Ne=Ae((e=>{let t,n,o,a=100,r=fe(),i=fe(),l=1;const c=fe(),d=fe(),[u,h,g]=ze((()=>O)),f=fe(),L=fe(),w=[],S=[],v=(t,s)=>{l=0,e.transaction((()=>{const[n,o]=we(f,s);he(n,((s,n)=>he(s,((s,o)=>he(s,((s,a)=>ke(e,n,o,a,s[t]))))))),he(o,((s,n)=>Ee(e,n,s[t])))})),l=1},R=e=>{ve(f,e),ve(L,e),h(d,[e])},T=(e,t)=>M(((e,t)=>e.splice(0,t))(e,t??J(e)),R),I=()=>T(w,J(w)-a),p=()=>H(t,(()=>{z(w,t),I(),T(S),t=void 0,o=1})),y=()=>{t=N(w),o=1},C=e.addCellListener(null,null,null,((e,t,s,n,o,a)=>{if(l){p();const e=Re(r,t,fe),i=Re(e,s,fe),l=Re(i,n,(()=>[a,void 0]));l[1]=o,l[0]===o&&ce(ve(i,n))&&ce(ve(e,s))&&ce(ve(r,t))&&y(),x()}})),V=e.addValueListener(null,((e,t,s,n)=>{if(l){p();const e=Re(i,t,(()=>[n,void 0]));e[1]=s,e[0]===s&&ce(ve(i,t))&&y(),x()}})),m=(e="")=>(G(t)&&(t=s+n++,ve(f,t,[r,i]),F(t,e),r=fe(),i=fe(),o=1),t),k=()=>{A(w)||(((e,...t)=>{e.unshift(...t)})(S,m()),v(0,t),t=N(w),o=1)},E=()=>{A(S)||(z(w,t),t=j(S),v(1,t),o=1)},x=()=>{o&&(h(c),o=0)},D=e=>{const t=m(e);return x(),t},F=(e,t)=>(Q(e)&&we(L,e)!==t&&(ve(L,e,t),h(d,[e])),O),Q=e=>le(f,e),O={setSize:e=>(a=e,I(),O),addCheckpoint:D,setCheckpoint:F,getStore:()=>e,getCheckpointIds:()=>[[...w],t,[...S]],forEachCheckpoint:e=>Se(L,e),hasCheckpoint:Q,getCheckpoint:e=>we(L,e),goBackward:()=>(k(),x(),O),goForward:()=>(E(),x(),O),goTo:e=>{const s=b(w,e)?k:b(S,e)?E:null;for(;!G(s)&&e!=t;)s();return x(),O},addCheckpointIdsListener:e=>u(e,c),addCheckpointListener:(e,t)=>u(t,d,[e]),delListener:e=>(g(e),O),clear:()=>(T(w),T(S),G(t)||R(t),t=void 0,n=0,D(),O),destroy:()=>{e.delListener(C),e.delListener(V)},getListenerStats:()=>({})};return te(O.clear())})),je=(e,t)=>e<t?-1:1,Oe=Ae((e=>{const t=fe(),n=fe(),[o,a,r,i,l,c,d,,u,h,g]=De(e,fe,(e=>G(e)?s:X(e)?x(e,C):C(e))),[f,L,w]=ze((()=>v)),S=(t,s,n)=>{const o=l(t);he(n,((t,n)=>s(n,(s=>he(t,(t=>s(t,(s=>e.forEachCell(o,t,s)))))))))},v={setIndexDefinition:(e,s,o,a,r,i=je)=>{const l=G(r)?void 0:([e],[t])=>r(e,t);return u(e,s,((s,o,r,u,h,g)=>{let f=0;const w=Me(),S=Me(),v=c(e);if(he(o,(([e,t],s)=>{const n=Me(e),o=Me(t);he(n,(e=>ge(o,e)?ge(n,e):0)),he(n,(e=>{xe(w,e),H(we(v,e),(t=>{ge(t,s),ce(t)&&(ve(v,e),f=1)}))})),he(o,(e=>{xe(w,e),le(v,e)||(ve(v,e,Me()),f=1),xe(we(v,e),s),G(a)||xe(S,e)}))})),s(),ce(h)||(g?Se(v,(e=>xe(S,e))):Se(r,(e=>H(we(u,e),(e=>xe(S,e))))),he(S,(e=>{const t=(t,s)=>i(we(h,t),we(h,s),e),s=[...we(v,e)];k(s,t)||(ve(v,e,Me(E(s,t))),xe(w,e))}))),(f||g)&&!G(l)){const t=[...v];k(t,l)||(d(e,fe(E(t,l))),f=1)}f&&L(t,[e]),he(w,(t=>L(n,[e,t])))}),Je(o),H(a,Je)),v},delIndexDefinition:e=>(h(e),v),getStore:o,getIndexIds:a,forEachIndex:e=>r(((t,s)=>e(t,(e=>S(t,e,s))))),forEachSlice:(e,t)=>S(e,t,c(e)),hasIndex:i,hasSlice:(e,t)=>le(c(e),t),getTableId:l,getSliceIds:e=>Le(c(e)),getSliceRowIds:(e,t)=>de(we(c(e),t)),addSliceIdsListener:(e,s)=>f(s,t,[e]),addSliceRowIdsListener:(e,t,s)=>f(s,n,[e,t]),delListener:e=>(w(e),v),destroy:g,getListenerStats:()=>({})};return te(v)})),Pe=fe([["avg",[(e,t)=>D(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>B(...e),(e,t)=>B(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:B(t,e)]],["min",[e=>W(...e),(e,t)=>W(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:W(t,e)]],["sum",[e=>D(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),Be=(e,t,s,n,o,a=!1)=>{if(ce(s))return;const[r,i,l,c]=o;return a||=G(e),he(n,(([s,n])=>{a||(e=G(s)?i?.(e,n,t++):G(n)?l?.(e,s,t--):c?.(e,n,s,t),a||=G(e))})),a?r(de(s),ie(s)):e},We=Ae((e=>{const t=fe(),[n,o,a,r,i,l,c,,d,u,h]=De(e,Y,(e=>isNaN(e)||G(e)||!0===e||!1===e||e===s?void 0:1*e)),[g,f,L]=ze((()=>w)),w={setMetricDefinition:(e,s,n,o,a,r,i)=>{const u=U(n)?[n,a,r,i]:we(Pe,n)??we(Pe,"sum");return d(e,s,((s,n,o,a,r,i)=>{const d=l(e),h=ie(a);i||=G(d),s();let g=Be(d,h,a,n,u,i);$(g)||(g=void 0),g!=d&&(c(e,g),f(t,[e],g,d))}),Je(o,1)),w},delMetricDefinition:e=>(u(e),w),getStore:n,getMetricIds:o,forEachMetric:a,hasMetric:r,getTableId:i,getMetric:l,addMetricListener:(e,s)=>g(s,t,[e]),delListener:e=>(L(e),w),destroy:h,getListenerStats:()=>({})};return te(w)})),$e=Ae((e=>{const t=e.createStore,[n,o,a,r,i,,,l,,h,f,L,I]=De(e,(()=>!0),Y),p=t(),y=t(),C=fe(),b=(e,t,...s)=>M(s,(s=>xe(Re(Re(C,t,fe),e,Me),s))),m=e=>{H(we(C,e),(e=>{Se(e,((e,t)=>he(t,(t=>e.delListener(t))))),ue(e)})),M([y,p],(t=>t.delTable(e)))},k=(e,t,s)=>b(t,e,t.addStartTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),E={setQueryDefinition:(t,n,o)=>{l(t,n),m(t);const a=[],r=[[null,[n,null,null,[],fe()]]],i=[],c=[],d=[];o({select:(e,t)=>{const n=U(e)?[J(a)+s,e]:[G(t)?e:t,s=>s(e,t)];return z(a,n),{as:e=>n[0]=e}},join:(e,t,s)=>{const n=G(s)||U(t)?null:t,o=G(n)?t:s,a=[e,[e,n,U(o)?o:e=>e(o),[],fe()]];return z(r,a),{as:e=>a[0]=e}},where:(e,t,s)=>z(i,U(e)?e:G(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,o)=>{const a=[e,[e,U(t)?[t,s,n,o]:we(Pe,t)??[(e,t)=>t]]];return z(c,a),{as:e=>a[0]=e}},having:(e,t)=>z(d,U(e)?e:s=>s(e)===t)});const u=fe(a);if(ce(u))return E;const h=fe(r);Se(h,((e,[,t])=>H(we(h,t),(({3:t})=>G(e)?0:z(t,e)))));const g=fe(c);let f=p;if(ce(g)&&A(d))f=y;else{k(t,f,y);const e=fe();Se(g,((t,[s,n])=>xe(Re(e,s,Me),[t,n])));const s=Me();Se(u,(t=>le(e,t)?0:xe(s,t)));const n=fe(),o=(s,n,o,a)=>H(s,(([r,i,l,c])=>{Se(n,((t,[s])=>{const n=Re(r,t,fe),i=we(n,o),l=a?void 0:s;if(i!==l){const s=Me([[i,l]]),a=ie(n);ve(n,o,l),he(we(e,t),(([e,t])=>{const o=Be(c[e],a,n,s,t);c[e]=G(me(o))?null:o}))}})),ce(i)||!V(d,(e=>e((e=>c[e]))))?y.delRow(t,l):G(l)?s[2]=y.addRow(t,c):y.setRow(t,l,c)}));b(f,t,f.addRowListener(t,null,((a,r,i,l)=>{const c=[],d=[],u=fe(),h=f.hasRow(t,i);let g=!h;he(s,(e=>{const[s,n,o]=l(t,i,e);z(c,n),z(d,o),g||=s})),Se(e,(e=>{const[s,,n]=l(t,i,e);(g||s)&&ve(u,e,[n])})),g&&o(Ve(n,c,void 0,(([,e])=>(ge(e,i),ce(e)))),u,i,1),h&&o(Ve(n,d,(()=>{const e={};return he(s,(s=>e[s]=f.getCell(t,i,s))),[fe(),Me(),void 0,e]}),(([,e])=>{xe(e,i)})),u,i)})))}k(t,e,f);const w=(s,o,a,r)=>{const l=t=>e.getCell(o,a,t);M(r,(n=>{const[o,,a,r,i]=we(h,n),c=a?.(l,s),[d,u]=we(i,s)??[];c!=d&&(G(u)||I(t,u),ve(i,s,G(c)?null:[c,...L(t,1,e.addRowListener(o,c,(()=>w(s,o,c,r))))]))})),(s=>{const o=(t,o)=>e.getCell(...G(o)?[n,s,t]:t===n?[n,s,o]:[we(h,t)?.[0],we(we(h,t)?.[4],s)?.[0],o]);f.transaction((()=>V(i,(e=>e(o)))?Se(u,((e,n)=>ke(f,t,s,e,n(o,s)))):f.delRow(t,s)))})(s)},{3:S}=we(h,null);return f.transaction((()=>L(t,1,e.addRowListener(n,null,((s,o,a)=>{e.hasRow(n,a)?w(a,n,a,S):(f.delRow(t,a),he(h,(({4:e})=>H(we(e,a),(([,s])=>{I(t,s),ve(e,a)})))))}))))),E},delQueryDefinition:e=>(m(e),h(e),E),getStore:n,getQueryIds:o,forEachQuery:a,hasQuery:r,getTableId:i,delListener:e=>(y.delListener(e),E),destroy:f,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=y.getListenerStats();return n}};return ae({[g]:[1,1],[S]:[0,1],[v]:[0,5],[w]:[1,2],[T]:[0,2],[R]:[1,3]},(([e,t],s)=>{M(e?["get","has","forEach"]:["get"],(e=>E[e+d+s]=(...t)=>y[e+s](...t))),E[u+d+s+c]=(...e)=>y[u+s+c](...Q(e,0,t),((s,...n)=>e[t](E,...n)))})),te(E)})),qe=Ae((e=>{const t=fe(),n=fe(),o=fe(),a=fe(),[r,i,l,c,d,u,,,h,g,f]=De(e,(()=>[fe(),fe(),fe(),fe()]),(e=>G(e)?void 0:e+s)),[L,w,S]=ze((()=>I)),v=(e,t,s)=>H(u(e),(([n,,o])=>{if(!le(o,t)){const a=Me();if(d(e)!=T(e))xe(a,t);else{let e=t;for(;!G(e)&&!le(a,e);)xe(a,e),e=we(n,e)}if(s)return a;ve(o,t,a)}return we(o,t)})),R=(e,t)=>H(u(e),(([,,e])=>ve(e,t))),T=e=>we(t,e),I={setRelationshipDefinition:(e,s,r,i)=>(ve(t,e,r),h(e,s,((t,s)=>{const r=Me(),i=Me(),l=Me(),[c,d]=u(e);he(s,(([t,s],n)=>{G(t)||(xe(i,t),H(we(d,t),(e=>{ge(e,n),ce(e)&&ve(d,t)}))),G(s)||(xe(i,s),le(d,s)||ve(d,s,Me()),xe(we(d,s),n)),xe(r,n),ve(c,n,s),Se(we(a,e),(t=>{le(v(e,t),n)&&xe(l,t)}))})),t(),he(r,(t=>w(n,[e,t]))),he(i,(t=>w(o,[e,t]))),he(l,(t=>{R(e,t),w(a,[e,t])}))}),Je(i)),I),delRelationshipDefinition:e=>(ve(t,e),g(e),I),getStore:r,getRelationshipIds:i,forEachRelationship:t=>l((s=>t(s,(t=>e.forEachRow(d(s),t))))),hasRelationship:c,getLocalTableId:d,getRemoteTableId:T,getRemoteRowId:(e,t)=>we(u(e)?.[0],t),getLocalRowIds:(e,t)=>de(we(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>G(u(e))?[t]:de(v(e,t,!0)),addRemoteRowIdListener:(e,t,s)=>L(s,n,[e,t]),addLocalRowIdsListener:(e,t,s)=>L(s,o,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(v(e,t),L(s,a,[e,t])),delListener:e=>(R(...S(e)),I),destroy:f,getListenerStats:()=>({})};return te(I)})),Ge=e=>[e,e],He=()=>[fe(),fe()],Ke=e=>[...e],Ue=([e,t])=>e===t,Xe=(e,t,s,n=ve)=>(ae(t,((t,n)=>s(e,n,t))),Se(e,(s=>ne(t,s)?0:n(e,s))),e),Ye=(e,t,s)=>G(e)||!se(e)||re(e)||ee(e)?(s?.(),!1):(ae(e,((s,n)=>{t(s,n)||oe(e,n)})),!re(e)),Ze=(e,t,s)=>ve(e,t,we(e,t)==-s?void 0:s),_e=()=>{let e,t,s=!1,n=!1,o=0;const r=fe(),d=fe(),h=fe(),v=fe(),V=fe(),k=fe(),D=fe(),J=fe(),A=fe(),F=fe(),N=fe(),j=fe(),B=Me(),W=fe(),$=fe(),q=fe(),X=He(),Y=He(),Z=He(),_=He(),ee=He(),se=He(),ie=He(),de=He(),Ve=He(),De=He(),Je=He(),Ae=He(),Fe=He(),Ne=fe(),Oe=He(),[Pe,Be,We,$e]=ze((()=>us)),qe=e=>{if(!Ye(e,((e,t)=>b([i,l],t))))return!1;const t=e[i];return!(!K(t)&&t!=a||(me(e[l])!=t&&oe(e,l),0))},et=(t,s)=>(!e||le(A,s)||Mt(s))&&Ye(t,((e,t)=>tt(s,t,e)),(()=>Mt(s))),tt=(e,t,s,n)=>Ye(n?s:at(s,e,t),((n,o)=>H(st(e,t,o,n),(e=>(s[o]=e,!0)),(()=>!1))),(()=>Mt(e,t))),st=(t,s,n,o)=>e?H(we(we(A,t),n),(e=>me(o)!=e[i]?Mt(t,s,n,o,e[l]):o),(()=>Mt(t,s,n,o))):G(me(o))?Mt(t,s,n,o):o,nt=(e,t)=>Ye(t?e:rt(e),((t,s)=>H(ot(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>xt())),ot=(e,s)=>t?H(we(N,e),(t=>me(s)!=t[i]?xt(e,s,t[l]):s),(()=>xt(e,s))):G(me(s))?xt(e,s):s,at=(e,t,s)=>(H(we(F,t),(([n,o])=>{he(n,((t,s)=>{ne(e,s)||(e[s]=t)})),he(o,(n=>{ne(e,n)||Mt(t,s,n)}))})),e),rt=e=>(t&&(he(j,((t,s)=>{ne(e,s)||(e[s]=t)})),he(B,(t=>{ne(e,t)||xt(t)}))),e),it=e=>Xe(A,e,((e,t,s)=>{const n=fe(),o=Me();Xe(Re(A,t,fe),s,((e,t,s)=>{ve(e,t,s),H(s[l],(e=>ve(n,t,e)),(()=>xe(o,t)))})),ve(F,t,[n,o])}),((e,t)=>{ve(A,t),ve(F,t)})),lt=e=>Xe(N,e,((e,t,s)=>{ve(N,t,s),H(s[l],(e=>ve(j,t,e)),(()=>xe(B,t)))}),((e,t)=>{ve(N,t),ve(j,t),ge(B,t)})),ct=e=>re(e)?ss():Yt(e),dt=e=>Xe($,e,((e,t,s)=>ut(t,s)),((e,t)=>Tt(t))),ut=(e,t)=>Xe(Re($,e,(()=>(Ct(e,1),fe()))),t,((t,s,n)=>ht(e,t,s,n)),((t,s)=>It(e,t,s))),ht=(e,t,s,n,o)=>Xe(Re(t,s,(()=>(bt(e,s,1),fe()))),n,((t,n,o)=>gt(e,s,t,n,o)),((n,a)=>pt(e,t,s,n,a,o))),gt=(e,t,s,n,o)=>{le(s,n)||Vt(e,t,n,1);const a=we(s,n);o!==a&&(mt(e,t,n,a,o),ve(s,n,o))},ft=(e,t,s,n,o)=>H(we(t,s),(t=>gt(e,s,t,n,o)),(()=>ht(e,t,s,at({[n]:o},e,s)))),Lt=e=>re(e)?as():Zt(e),wt=e=>Xe(q,e,((e,t,s)=>St(t,s)),((e,t)=>yt(t))),St=(e,t)=>{le(q,e)||kt(e,1);const s=we(q,e);t!==s&&(Et(e,s,t),ve(q,e,t))},vt=(e,t)=>{const[s]=Re(W,e,Qe),n=s(t);return le(we($,e),n)?vt(e,t):n},Rt=e=>we($,e)??ut(e,{}),Tt=e=>ut(e,{}),It=(e,t,s)=>{const[,n]=Re(W,e,Qe);n(s),ht(e,t,s,{},!0)},pt=(e,t,s,n,o,a)=>{const r=we(we(F,e)?.[0],o);if(!G(r)&&!a)return gt(e,s,n,o,r);const i=t=>{mt(e,s,t,we(n,t)),Vt(e,s,t,-1),ve(n,t)};G(r)?i(o):Se(n,i),ce(n)&&(bt(e,s,-1),ce(ve(t,s))&&(Ct(e,-1),ve($,e),ve(W,e)))},yt=e=>{const t=we(j,e);if(!G(t))return St(e,t);Et(e,we(q,e)),kt(e,-1),ve(q,e)},Ct=(e,t)=>Ze(r,e,t),bt=(e,t,s)=>Ze(Re(d,e,fe),t,s),Vt=(e,t,s,n)=>Ze(Re(Re(h,e,fe),t,fe),s,n),mt=(e,t,s,n,o)=>Re(Re(Re(v,e,fe),t,fe),s,(()=>[n,0]))[1]=o,kt=(e,t)=>Ze(V,e,t),Et=(e,t,s)=>Re(k,e,(()=>[t,0]))[1]=s,Mt=(e,t,s,n,o)=>(z(Re(Re(Re(D,e,fe),t,fe),s,(()=>[])),n),o),xt=(e,t,s)=>(z(Re(J,e,(()=>[])),t),s),Dt=(e,t,s)=>H(we(we(we(v,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...Ge(Ht(e,t,s))])),Jt=e=>H(we(k,e),(([e,t])=>[!0,e,t]),(()=>[!1,...Ge(Xt(e))])),At=e=>ce(D)||ce(Ve[e])?0:he(e?be(D):D,((t,s)=>he(t,((t,n)=>he(t,((t,o)=>Be(Ve[e],[s,n,o],t))))))),Ft=e=>ce(J)||ce(De[e])?0:he(e?ye(J):J,((t,s)=>Be(De[e],[s],t))),Qt=(e,t,s)=>{if(!ce(t))return Be(e,s),1},zt=e=>{const t=ce(ee[e]),s=ce(ie[e])&&ce(_[e])&&t&&ce(Y[e]),n=ce(de[e])&&ce(se[e])&&ce(Z[e])&&ce(X[e]);if(!s||!n){const o=e?[ye(r),Ce(d),be(h),be(v)]:[r,d,h,v];if(!s){he(o[2],((t,s)=>he(t,((t,n)=>Qt(ie[e],t,[s,n])))));const s=Me();he(o[1],((n,o)=>{Qt(_[e],n,[o])&&!t&&(Be(ee[e],[o,null]),xe(s,o))})),t||he(o[3],((t,n)=>{if(!le(s,n)){const s=Me();he(t,(e=>he(e,(([t,n],o)=>n!==t?xe(s,o):ge(e,o))))),he(s,(t=>Be(ee[e],[n,t])))}})),Qt(Y[e],o[0])}if(!n){let t;he(o[3],((s,n)=>{let o;he(s,((s,a)=>{let r;he(s,(([s,i],l)=>{i!==s&&(Be(de[e],[n,a,l],i,s,Dt),t=o=r=1)})),r&&Be(se[e],[n,a],Dt)})),o&&Be(Z[e],[n],Dt)})),t&&Be(X[e],void 0,Dt)}}},Nt=e=>{const t=ce(Ae[e]),s=ce(Fe[e])&&ce(Je[e]);if(!t||!s){const n=e?[ye(V),ye(k)]:[V,k];if(t||Qt(Ae[e],n[0]),!s){let t;he(n[1],(([s,n],o)=>{n!==s&&(Be(Fe[e],[o],n,s,Jt),t=1)})),t&&Be(Je[e],void 0,Jt)}}},jt=(e,...t)=>(ls((()=>e(...x(t,C)))),us),Ot=()=>[Te(v,((e,t)=>-1===we(r,t)?null:Te(e,((e,s)=>-1===we(we(d,t),s)?null:Te(e,(([,e])=>e??null),((e,t)=>Ue(t)))),re)),re),Te(k,(([,e])=>e??null),((e,t)=>Ue(t)))],Pt=()=>({cellsTouched:s,valuesTouched:n,changedCells:pe(v,Ke,Ue),invalidCells:pe(D),changedValues:Te(k,Ke,Ue),invalidValues:Te(J),changedTableIds:Te(r),changedRowIds:Ie(d),changedCellIds:pe(h),changedValueIds:Te(V)}),Bt=()=>pe($),Wt=()=>Le($),$t=e=>Le(we($,C(e))),qt=(e,t,s,n=0,o)=>{return x(Q(E((a=we($,C(e)),r=(e,s)=>[G(t)?s:we(e,C(t)),s],x([...a?.entries()??[]],(([e,t])=>r(t,e)))),(([e],[t])=>je(e,t)*(s?-1:1))),n,G(o)?o:n+o),(([,e])=>e));var a,r},Gt=(e,t)=>Le(we(we($,C(e)),C(t))),Ht=(e,t,s)=>we(we(we($,C(e)),C(t)),C(s)),Kt=()=>Te(q),Ut=()=>Le(q),Xt=e=>we(q,C(e)),Yt=e=>jt((()=>(e=>Ye(e,et,Mt))(e)?dt(e):0)),Zt=e=>jt((()=>nt(e)?wt(e):0)),_t=e=>{try{ct(P(e))}catch{}return us},es=t=>jt((()=>{if((e=Ye(t,(e=>Ye(e,qe))))&&(it(t),!ce($))){const e=Bt();ss(),Yt(e)}})),ts=e=>jt((()=>{if(t=(e=>Ye(e,qe))(e)){const s=Kt();is(),as(),t=!0,lt(e),Zt(s)}})),ss=()=>jt((()=>dt({}))),ns=e=>jt((e=>le($,e)?Tt(e):0),e),os=(e,t)=>jt(((e,t)=>H(we($,e),(s=>le(s,t)?It(e,s,t):0))),e,t),as=()=>jt((()=>wt({}))),rs=()=>jt((()=>{it({}),e=!1})),is=()=>jt((()=>{lt({}),t=!1})),ls=(e,t)=>{if(-1!=o){cs();const s=e();return ds(t),s}},cs=()=>(-1!=o&&o++,1==o&&Be(Ne,void 0,Ot,Pt),us),ds=e=>(o>0&&(o--,0==o&&(s=!ce(v),n=!ce(k),o=1,At(1),s&&zt(1),Ft(1),n&&Nt(1),e?.(Ot,Pt)&&(he(v,((e,t)=>he(e,((e,s)=>he(e,(([e],n)=>ke(us,t,s,n,e))))))),he(k,(([e],t)=>Ee(us,t,e))),s=n=!1),Be(Oe[0],void 0,Ot,Pt),o=-1,At(0),s&&zt(0),Ft(0),n&&Nt(0),Be(Oe[1],void 0,Ot,Pt),o=0,s=n=!1,M([r,d,h,v,D,V,k,J],ue))),us),us={getContent:()=>[Bt(),Kt()],getTables:Bt,getTableIds:Wt,getTable:e=>Ie(we($,C(e))),getRowIds:$t,getSortedRowIds:qt,getRow:(e,t)=>Te(we(we($,C(e)),C(t))),getCellIds:Gt,getCell:Ht,getValues:Kt,getValueIds:Ut,getValue:Xt,hasTables:()=>!ce($),hasTable:e=>le($,C(e)),hasRow:(e,t)=>le(we($,C(e)),C(t)),hasCell:(e,t,s)=>le(we(we($,C(e)),C(t)),C(s)),hasValues:()=>!ce(q),hasValue:e=>le(q,C(e)),getTablesJson:()=>O($),getValuesJson:()=>O(q),getJson:()=>O([$,q]),getTablesSchemaJson:()=>O(A),getValuesSchemaJson:()=>O(N),getSchemaJson:()=>O([A,N]),setContent:([e,t])=>jt((()=>{Yt(e),Zt(t)})),setTables:Yt,setTable:(e,t)=>jt((e=>et(t,e)?ut(e,t):0),e),setRow:(e,t,s)=>jt(((e,t)=>tt(e,t,s)?ht(e,Rt(e),t,s):0),e,t),addRow:(e,t,s=!0)=>ls((()=>{let n;return tt(e,n,t)&&(e=C(e),ht(e,Rt(e),n=vt(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>jt(((e,t)=>{if(tt(e,t,s,1)){const n=Rt(e);ae(s,((s,o)=>ft(e,n,t,o,s)))}}),e,t),setCell:(e,t,s,n)=>jt(((e,t,s)=>H(st(e,t,s,U(n)?n(Ht(e,t,s)):n),(n=>ft(e,Rt(e),t,s,n)))),e,t,s),setValues:Zt,setPartialValues:e=>jt((()=>nt(e,1)?ae(e,((e,t)=>St(t,e))):0)),setValue:(e,t)=>jt((e=>H(ot(e,U(t)?t(Xt(e)):t),(t=>St(e,t)))),e),setTransactionChanges:e=>jt((()=>{ae(e[0],((e,t)=>G(e)?ns(t):ae(e,((e,s)=>G(e)?os(t,s):ae(e,((e,n)=>ke(us,t,s,n,e))))))),ae(e[1],((e,t)=>Ee(us,t,e)))})),setTablesJson:_t,setValuesJson:e=>{try{Lt(P(e))}catch{}return us},setJson:e=>{try{const[t,s]=P(e);ct(t),Lt(s)}catch{_t(e)}return us},setTablesSchema:es,setValuesSchema:ts,setSchema:(e,t)=>jt((()=>{es(e),ts(t)})),delTables:ss,delTable:ns,delRow:os,delCell:(e,t,s,n)=>jt(((e,t,s)=>H(we($,e),(o=>H(we(o,t),(a=>le(a,s)?pt(e,o,t,a,s,n):0))))),e,t,s),delValues:as,delValue:e=>jt((e=>le(q,e)?yt(e):0),e),delTablesSchema:rs,delValuesSchema:is,delSchema:()=>jt((()=>{rs(),is()})),transaction:ls,startTransaction:cs,finishTransaction:ds,forEachTable:e=>he($,((t,s)=>e(s,(e=>he(t,((t,s)=>e(s,(e=>Se(t,e))))))))),forEachRow:(e,t)=>he(we($,C(e)),((e,s)=>t(s,(t=>Se(e,t))))),forEachCell:(e,t,s)=>Se(we(we($,C(e)),C(t)),s),forEachValue:e=>Se(q,e),addSortedRowIdsListener:(e,t,s,n,o,a,r)=>{let i=qt(e,t,s,n,o);return Pe((()=>{const r=qt(e,t,s,n,o);m(r,i)||(i=r,a(us,e,t,s,n,o,i))}),ee[r?1:0],[e,t],[Wt])},addStartTransactionListener:e=>Pe(e,Ne),addWillFinishTransactionListener:e=>Pe(e,Oe[0]),addDidFinishTransactionListener:e=>Pe(e,Oe[1]),callListener:e=>($e(e),us),delListener:e=>(We(e),us),getListenerStats:()=>({}),createStore:_e};return ae({[f]:[0,X],[L]:[0,Y],[g]:[1,Z,[Wt]],[S]:[1,_,[Wt]],[w]:[2,se,[Wt,$t]],[T]:[2,ie,[Wt,$t]],[R]:[3,de,[Wt,$t,Gt],e=>Ge(Ht(...e))],InvalidCell:[3,Ve],[p]:[0,Je],[y]:[0,Ae],[I]:[1,Fe,[Ut],e=>Ge(Xt(e[0]))],InvalidValue:[1,De]},(([e,t,s,n],o)=>{us[u+o+c]=(...o)=>Pe(o[e],t[o[e+1]?1:0],e>0?Q(o,0,e):void 0,s,n)})),te(us)};e.createCheckpoints=Ne,e.createCustomPersister=(e,t,s,n,o)=>{let a,r,i=0,l=!1;const c=async e=>{2!=i&&(i=1,await e(),i=0)},d={load:async(s={},n={})=>(await c((async()=>{let o;try{o=await t()}catch{}e.setContent(o??[s,n])})),d),startAutoLoad:async(s={},o={})=>(d.stopAutoLoad(),await d.load(s,o),l=!0,r=n((async(s,n)=>{await c((async()=>{if(n)e.setTransactionChanges(n());else try{e.setContent(s?.()??await t())}catch{}}))})),d),stopAutoLoad:()=>(l&&(o(r),r=void 0,l=!1),d),save:async t=>(1!=i&&(i=2,await s(e.getContent,t),i=0),d),startAutoSave:async()=>(await d.stopAutoSave().save(),a=e.addDidFinishTransactionListener(((e,t)=>d.save(t))),d),stopAutoSave:()=>(H(a,e.delListener),d),getStore:()=>e,destroy:()=>d.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return te(d)},e.createIndexes=Oe,e.createMetrics=We,e.createQueries=$e,e.createRelationships=qe,e.createStore=_e,e.defaultSorter=je},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={});
