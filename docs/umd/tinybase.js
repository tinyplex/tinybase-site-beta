var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",n=t(s),a=t(!0),o=t(0),r=t(t),l="type",i="default",c="Listener",d="Result",u="add",h="Ids",g="Table",f=g+"s",w=g+h,L="Row",S=L+"Count",T=L+h,v="Sorted"+L+h,R="Cell",y=R+h,I="Value",C=I+"s",p=I+h,b=e=>s+e,V=Math.max,m=Math.min,E=isFinite,k=(e,t)=>e instanceof t,M=e=>null==e,x=(e,t,s)=>M(e)?s?.():t(e),D=e=>e==n||e==a,J=e=>t(e)==r,A=e=>Array.isArray(e),F=()=>{},Q=(e,t)=>e.includes(t),z=(e,t)=>e.every(t),N=(e,t)=>$(e)===$(t)&&z(e,((e,s)=>t[s]===e)),j=(e,t)=>z(e,((s,n)=>0==n||t(e[n-1],s)<=0)),O=(e,t)=>e.sort(t),P=(e,t)=>e.forEach(t),B=(e,t)=>e.map(t),W=e=>G(e,((e,t)=>e+t),0),$=e=>e.length,q=e=>0==$(e),G=(e,t,s)=>e.reduce(t,s),H=(e,t,s)=>e.slice(t,s),K=(e,...t)=>e.push(...t),U=e=>e.pop(),X=e=>e.shift(),Y=Object,Z=Y.keys,_=Y.isFrozen,ee=Y.freeze,te=e=>k(e,Y)&&e.constructor==Y,se=(e,t)=>!M(((e,t)=>x(e,(e=>e[t])))(e,t)),ne=(e,t)=>(delete e[t],e),ae=(e,t)=>B(Y.entries(e),(([e,s])=>t(s,e))),oe=e=>te(e)&&0==(e=>$(Z(e)))(e),re=e=>e?.size??0,le=(e,t)=>e?.has(t)??!1,ie=e=>M(e)||0==re(e),ce=e=>[...e?.values()??[]],de=e=>e.clear(),ue=(e,t)=>e?.forEach(t),he=(e,t)=>e?.delete(t),ge=e=>new Map(e),fe=e=>[...e?.keys()??[]],we=(e,t)=>e?.get(t),Le=(e,t)=>ue(e,((e,s)=>t(s,e))),Se=(e,t,s)=>M(s)?(he(e,t),e):e?.set(t,s),Te=(e,t,s)=>(le(e,t)||Se(e,t,s()),we(e,t)),ve=(e,t,s,n=Se)=>(ae(t,((t,n)=>s(e,n,t))),Le(e,(s=>se(t,s)?0:n(e,s))),e),Re=(e,t,s)=>{const n={};return ue(e,((e,a)=>{const o=t?t(e,a):e;!s?.(o,e)&&(n[a]=o)})),n},ye=(e,t,s)=>Re(e,(e=>Re(e,t,s)),oe),Ie=(e,t,s)=>Re(e,(e=>ye(e,t,s)),oe),Ce=(e,t)=>{const s=ge();return ue(e,((e,n)=>s.set(n,t?.(e)??e))),s},pe=e=>Ce(e,Ce),be=e=>Ce(e,pe),Ve=(e,t,s,n,a=0)=>x((s?Te:we)(e,t[a],a>$(t)-2?s:ge),(o=>{if(a>$(t)-2)return n?.(o)&&Se(e,t[a]),o;const r=Ve(o,t,s,n,a+1);return ie(o)&&Se(e,t[a]),r})),me=e=>{const s=t(e);return D(s)||s==o&&E(e)?s:void 0},Ee=(e,t,s,n,a)=>M(a)?e.delCell(t,s,n,!0):e.setCell(t,s,n,a),ke=(e,t,s)=>M(s)?e.delValue(t):e.setValue(t,s),Me=e=>new Set(A(e)||M(e)?e:[e]),xe=(e,t)=>e?.add(t),De=(e,t,s)=>{const n=e.hasRow,a=ge(),o=ge(),r=ge(),l=ge(),i=ge(),c=(t,s,...n)=>{const a=Te(i,t,Me);return P(n,(t=>xe(a,t)&&s&&e.callListener(t))),n},d=(t,...s)=>x(we(i,t),(n=>{P(q(s)?ce(n):s,(t=>{e.delListener(t),he(n,t)})),ie(n)&&Se(i,t)})),u=(e,s)=>{Se(a,e,s),le(o,e)||(Se(o,e,t()),Se(r,e,ge()),Se(l,e,ge()))},h=e=>{Se(a,e),Se(o,e),Se(r,e),Se(l,e),d(e)};return[()=>e,()=>fe(a),e=>Le(o,e),e=>le(o,e),e=>we(a,e),e=>we(o,e),(e,t)=>Se(o,e,t),u,(t,a,o,i,h)=>{u(t,a);const g=ge(),f=ge(),w=we(r,t),L=we(l,t),S=t=>{const o=s=>e.getCell(a,t,s),r=we(w,t),l=n(a,t)?s(i(o,t)):void 0;if(r===l||A(r)&&A(l)&&N(r,l)||Se(g,t,[r,l]),!M(h)){const e=we(L,t),s=n(a,t)?h(o,t):void 0;e!=s&&Se(f,t,s)}},T=e=>{o((()=>{ue(g,(([,e],t)=>Se(w,t,e))),ue(f,((e,t)=>Se(L,t,e)))}),g,f,w,L,e),de(g),de(f)};Le(w,S),e.hasTable(a)&&P(e.getRowIds(a),(e=>{le(w,e)||S(e)})),T(!0),d(t),c(t,0,e.addRowListener(a,null,((e,t,s)=>S(s))),e.addTableListener(a,(()=>T())))},h,()=>Le(i,h),c,d]},Je=(e,a)=>t(e)==n?t=>t(e):e??(()=>a??s),Ae=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},Fe=/^\d+$/,Qe=()=>{const e=[];let t=0;return[n=>(n?X(e):null)??s+t++,t=>{Fe.test(t)&&$(e)<1e3&&K(e,t)}]},ze=e=>{let t;const[n,a]=Qe(),o=ge();return[(a,r,l,i=[],c=(()=>[]))=>{t??=e();const d=n(1);return Se(o,d,[a,r,l,i,c]),xe(Ve(r,l??[s],Me),d),d},(e,n,...a)=>P(((e,t=[s])=>{const n=[],a=(e,s)=>s==$(t)?K(n,e):null===t[s]?ue(e,(e=>a(e,s+1))):P([t[s],null],(t=>a(we(e,t),s+1)));return a(e,0),n})(e,n),(e=>ue(e,(e=>we(o,e)[0](t,...n??[],...a))))),e=>x(we(o,e),(([,t,n])=>(Ve(t,n??[s],void 0,(t=>(he(t,e),ie(t)?1:0))),Se(o,e),a(e),n))),e=>x(we(o,e),(([e,,s=[],n,a])=>{const o=(...r)=>{const l=$(r);l==$(s)?e(t,...r,...a(r)):M(s[l])?P(n[l]?.(...r)??[],(e=>o(...r,e))):o(...r,s[l])};o()}))]},Ne=Ae((e=>{let t,n,a,o=100,r=ge(),l=ge(),i=1;const c=ge(),d=ge(),[u,h,g]=ze((()=>F)),f=ge(),w=ge(),L=[],S=[],T=(t,s)=>{i=0,e.transaction((()=>{const[n,a]=we(f,s);ue(n,((s,n)=>ue(s,((s,a)=>ue(s,((s,o)=>Ee(e,n,a,o,s[t]))))))),ue(a,((s,n)=>ke(e,n,s[t])))})),i=1},v=e=>{Se(f,e),Se(w,e),h(d,[e])},R=(e,t)=>P(((e,t)=>e.splice(0,t))(e,t??$(e)),v),y=()=>R(L,$(L)-o),I=()=>x(t,(()=>{K(L,t),y(),R(S),t=void 0,a=1})),C=()=>{t=U(L),a=1},p=e.addCellListener(null,null,null,((e,t,s,n,a,o)=>{if(i){I();const e=Te(r,t,ge),l=Te(e,s,ge),i=Te(l,n,(()=>[o,void 0]));i[1]=a,i[0]===a&&ie(Se(l,n))&&ie(Se(e,s))&&ie(Se(r,t))&&C(),k()}})),b=e.addValueListener(null,((e,t,s,n)=>{if(i){I();const e=Te(l,t,(()=>[n,void 0]));e[1]=s,e[0]===s&&ie(Se(l,t))&&C(),k()}})),V=(e="")=>(M(t)&&(t=s+n++,Se(f,t,[r,l]),J(t,e),r=ge(),l=ge(),a=1),t),m=()=>{q(L)||(((e,...t)=>{e.unshift(...t)})(S,V()),T(0,t),t=U(L),a=1)},E=()=>{q(S)||(K(L,t),t=X(S),T(1,t),a=1)},k=()=>{a&&(h(c),a=0)},D=e=>{const t=V(e);return k(),t},J=(e,t)=>(A(e)&&we(w,e)!==t&&(Se(w,e,t),h(d,[e])),F),A=e=>le(f,e),F={setSize:e=>(o=e,y(),F),addCheckpoint:D,setCheckpoint:J,getStore:()=>e,getCheckpointIds:()=>[[...L],t,[...S]],forEachCheckpoint:e=>Le(w,e),hasCheckpoint:A,getCheckpoint:e=>we(w,e),goBackward:()=>(m(),k(),F),goForward:()=>(E(),k(),F),goTo:e=>{const s=Q(L,e)?m:Q(S,e)?E:null;for(;!M(s)&&e!=t;)s();return k(),F},addCheckpointIdsListener:e=>u(e,c),addCheckpointListener:(e,t)=>u(t,d,[e]),delListener:e=>(g(e),F),clear:()=>(R(L),R(S),M(t)||v(t),t=void 0,n=0,D(),F),destroy:()=>{e.delListener(p),e.delListener(b)},getListenerStats:()=>({})};return ee(F.clear())})),je=(e,t)=>(e??0)<(t??0)?-1:1,Oe=Ae((e=>{const t=ge(),n=ge(),[a,o,r,l,i,c,d,,u,h,g]=De(e,ge,(e=>M(e)?s:A(e)?B(e,b):b(e))),[f,w,L]=ze((()=>T)),S=(t,s,n)=>{const a=i(t);ue(n,((t,n)=>s(n,(s=>ue(t,(t=>s(t,(s=>e.forEachCell(a,t,s)))))))))},T={setIndexDefinition:(e,s,a,o,r,l=je)=>{const i=M(r)?void 0:([e],[t])=>r(e,t);return u(e,s,((s,a,r,u,h,g)=>{let f=0;const L=Me(),S=Me(),T=c(e);if(ue(a,(([e,t],s)=>{const n=Me(e),a=Me(t);ue(n,(e=>he(a,e)?he(n,e):0)),ue(n,(e=>{xe(L,e),x(we(T,e),(t=>{he(t,s),ie(t)&&(Se(T,e),f=1)}))})),ue(a,(e=>{xe(L,e),le(T,e)||(Se(T,e,Me()),f=1),xe(we(T,e),s),M(o)||xe(S,e)}))})),s(),ie(h)||(g?Le(T,(e=>xe(S,e))):Le(r,(e=>x(we(u,e),(e=>xe(S,e))))),ue(S,(e=>{const t=(t,s)=>l(we(h,t),we(h,s),e),s=[...we(T,e)];j(s,t)||(Se(T,e,Me(O(s,t))),xe(L,e))}))),(f||g)&&!M(i)){const t=[...T];j(t,i)||(d(e,ge(O(t,i))),f=1)}f&&w(t,[e]),ue(L,(t=>w(n,[e,t])))}),Je(a),x(o,Je)),T},delIndexDefinition:e=>(h(e),T),getStore:a,getIndexIds:o,forEachIndex:e=>r(((t,s)=>e(t,(e=>S(t,e,s))))),forEachSlice:(e,t)=>S(e,t,c(e)),hasIndex:l,hasSlice:(e,t)=>le(c(e),t),getTableId:i,getSliceIds:e=>fe(c(e)),getSliceRowIds:(e,t)=>ce(we(c(e),t)),addSliceIdsListener:(e,s)=>f(s,t,[e]),addSliceRowIdsListener:(e,t,s)=>f(s,n,[e,t]),delListener:e=>(L(e),T),destroy:g,getListenerStats:()=>({})};return ee(T)})),Pe=ge([["avg",[(e,t)=>W(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>V(...e),(e,t)=>V(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:V(t,e)]],["min",[e=>m(...e),(e,t)=>m(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:m(t,e)]],["sum",[e=>W(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),Be=(e,t,s,n,a,o=!1)=>{if(ie(s))return;const[r,l,i,c]=a;return o||=M(e),ue(n,(([s,n])=>{o||(e=M(s)?l?.(e,n,t++):M(n)?i?.(e,s,t--):c?.(e,n,s,t),o||=M(e))})),o?r(ce(s),re(s)):e},We=Ae((e=>{const t=ge(),[n,a,o,r,l,i,c,,d,u,h]=De(e,F,(e=>isNaN(e)||M(e)||!0===e||!1===e||e===s?void 0:1*e)),[g,f,w]=ze((()=>L)),L={setMetricDefinition:(e,s,n,a,o,r,l)=>{const u=J(n)?[n,o,r,l]:we(Pe,n)??we(Pe,"sum");return d(e,s,((s,n,a,o,r,l)=>{const d=i(e),h=re(o);l||=M(d),s();let g=Be(d,h,o,n,u,l);E(g)||(g=void 0),g!=d&&(c(e,g),f(t,[e],g,d))}),Je(a,1)),L},delMetricDefinition:e=>(u(e),L),getStore:n,getMetricIds:a,forEachMetric:o,hasMetric:r,getTableId:l,getMetric:i,addMetricListener:(e,s)=>g(s,t,[e]),delListener:e=>(w(e),L),destroy:h,getListenerStats:()=>({})};return ee(L)})),$e=Ae((e=>{const t=e.createStore,[n,a,o,r,l,,,i,,h,f,w,I]=De(e,(()=>!0),F),C=t(),p=t(),b=ge(),V=(e,t,...s)=>P(s,(s=>xe(Te(Te(b,t,ge),e,Me),s))),m=e=>{x(we(b,e),(e=>{Le(e,((e,t)=>ue(t,(t=>e.delListener(t))))),de(e)})),P([p,C],(t=>t.delTable(e)))},E=(e,t,s)=>V(t,e,t.addStartTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),k={setQueryDefinition:(t,n,a)=>{i(t,n),m(t);const o=[],r=[[null,[n,null,null,[],ge()]]],l=[],c=[],d=[];a({select:(e,t)=>{const n=J(e)?[$(o)+s,e]:[M(t)?e:t,s=>s(e,t)];return K(o,n),{as:e=>n[0]=e}},join:(e,t,s)=>{const n=M(s)||J(t)?null:t,a=M(n)?t:s,o=[e,[e,n,J(a)?a:e=>e(a),[],ge()]];return K(r,o),{as:e=>o[0]=e}},where:(e,t,s)=>K(l,J(e)?e:M(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,a)=>{const o=[e,[e,J(t)?[t,s,n,a]:we(Pe,t)??[(e,t)=>t]]];return K(c,o),{as:e=>o[0]=e}},having:(e,t)=>K(d,J(e)?e:s=>s(e)===t)});const u=ge(o);if(ie(u))return k;const h=ge(r);Le(h,((e,[,t])=>x(we(h,t),(({3:t})=>M(e)?0:K(t,e)))));const g=ge(c);let f=C;if(ie(g)&&q(d))f=p;else{E(t,f,p);const e=ge();Le(g,((t,[s,n])=>xe(Te(e,s,Me),[t,n])));const s=Me();Le(u,(t=>le(e,t)?0:xe(s,t)));const n=ge(),a=(s,n,a,o)=>x(s,(([r,l,i,c])=>{Le(n,((t,[s])=>{const n=Te(r,t,ge),l=we(n,a),i=o?void 0:s;if(l!==i){const s=Me([[l,i]]),o=re(n);Se(n,a,i),ue(we(e,t),(([e,t])=>{const a=Be(c[e],o,n,s,t);c[e]=M(me(a))?null:a}))}})),ie(l)||!z(d,(e=>e((e=>c[e]))))?p.delRow(t,i):M(i)?s[2]=p.addRow(t,c):p.setRow(t,i,c)}));V(f,t,f.addRowListener(t,null,((o,r,l,i)=>{const c=[],d=[],u=ge(),h=f.hasRow(t,l);let g=!h;ue(s,(e=>{const[s,n,a]=i(t,l,e);K(c,n),K(d,a),g||=s})),Le(e,(e=>{const[s,,n]=i(t,l,e);(g||s)&&Se(u,e,[n])})),g&&a(Ve(n,c,void 0,(([,e])=>(he(e,l),ie(e)))),u,l,1),h&&a(Ve(n,d,(()=>{const e={};return ue(s,(s=>e[s]=f.getCell(t,l,s))),[ge(),Me(),void 0,e]}),(([,e])=>{xe(e,l)})),u,l)})))}E(t,e,f);const L=(s,a,o,r)=>{const i=t=>e.getCell(a,o,t);P(r,(n=>{const[a,,o,r,l]=we(h,n),c=o?.(i,s),[d,u]=we(l,s)??[];c!=d&&(M(u)||I(t,u),Se(l,s,M(c)?null:[c,...w(t,1,e.addRowListener(a,c,(()=>L(s,a,c,r))))]))})),(s=>{const a=(t,a)=>e.getCell(...M(a)?[n,s,t]:t===n?[n,s,a]:[we(h,t)?.[0],we(we(h,t)?.[4],s)?.[0],a]);f.transaction((()=>z(l,(e=>e(a)))?Le(u,((e,n)=>Ee(f,t,s,e,n(a,s)))):f.delRow(t,s)))})(s)},{3:S}=we(h,null);return f.transaction((()=>w(t,1,e.addRowListener(n,null,((s,a,o)=>{e.hasRow(n,o)?L(o,n,o,S):(f.delRow(t,o),ue(h,(({4:e})=>x(we(e,o),(([,s])=>{I(t,s),Se(e,o)})))))}))))),k},delQueryDefinition:e=>(m(e),h(e),k),getStore:n,getQueryIds:a,forEachQuery:o,hasQuery:r,getTableId:l,delListener:e=>(p.delListener(e),k),destroy:f,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=p.getListenerStats();return n}};return ae({[g]:[1,1],[g+y]:[0,1],[S]:[0,1],[T]:[0,1],[v]:[0,5],[L]:[1,2],[y]:[0,2],[R]:[1,3]},(([e,t],s)=>{P(e?["get","has","forEach"]:["get"],(e=>k[e+d+s]=(...t)=>p[e+s](...t))),k[u+d+s+c]=(...e)=>p[u+s+c](...H(e,0,t),((s,...n)=>e[t](k,...n)))})),ee(k)})),qe=Ae((e=>{const t=ge(),n=ge(),a=ge(),o=ge(),[r,l,i,c,d,u,,,h,g,f]=De(e,(()=>[ge(),ge(),ge(),ge()]),(e=>M(e)?void 0:e+s)),[w,L,S]=ze((()=>y)),T=(e,t,s)=>x(u(e),(([n,,a])=>{if(!le(a,t)){const o=Me();if(d(e)!=R(e))xe(o,t);else{let e=t;for(;!M(e)&&!le(o,e);)xe(o,e),e=we(n,e)}if(s)return o;Se(a,t,o)}return we(a,t)})),v=(e,t)=>x(u(e),(([,,e])=>Se(e,t))),R=e=>we(t,e),y={setRelationshipDefinition:(e,s,r,l)=>(Se(t,e,r),h(e,s,((t,s)=>{const r=Me(),l=Me(),i=Me(),[c,d]=u(e);ue(s,(([t,s],n)=>{M(t)||(xe(l,t),x(we(d,t),(e=>{he(e,n),ie(e)&&Se(d,t)}))),M(s)||(xe(l,s),le(d,s)||Se(d,s,Me()),xe(we(d,s),n)),xe(r,n),Se(c,n,s),Le(we(o,e),(t=>{le(T(e,t),n)&&xe(i,t)}))})),t(),ue(r,(t=>L(n,[e,t]))),ue(l,(t=>L(a,[e,t]))),ue(i,(t=>{v(e,t),L(o,[e,t])}))}),Je(l)),y),delRelationshipDefinition:e=>(Se(t,e),g(e),y),getStore:r,getRelationshipIds:l,forEachRelationship:t=>i((s=>t(s,(t=>e.forEachRow(d(s),t))))),hasRelationship:c,getLocalTableId:d,getRemoteTableId:R,getRemoteRowId:(e,t)=>we(u(e)?.[0],t),getLocalRowIds:(e,t)=>ce(we(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>M(u(e))?[t]:ce(T(e,t,!0)),addRemoteRowIdListener:(e,t,s)=>w(s,n,[e,t]),addLocalRowIdsListener:(e,t,s)=>w(s,a,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(T(e,t),w(s,o,[e,t])),delListener:e=>(v(...S(e)),y),destroy:f,getListenerStats:()=>({})};return ee(y)})),Ge=e=>[e,e],He=()=>[ge(),ge()],Ke=e=>[...e],Ue=([e,t])=>e===t,Xe=e=>JSON.stringify(e,((e,t)=>k(t,Map)?Y.fromEntries([...t]):t)),Ye=JSON.parse,Ze=(e,t,s)=>M(e)||!te(e)||oe(e)||_(e)?(s?.(),!1):(ae(e,((s,n)=>{t(s,n)||ne(e,n)})),!oe(e)),_e=(e,t,s)=>Se(e,t,we(e,t)==-s?void 0:s),et=()=>{let e,t,s=!1,n=!1,a=0;const r=ge(),d=ge(),h=ge(),v=ge(),V=ge(),m=ge(),E=ge(),k=ge(),A=ge(),F=ge(),z=ge(),j=ge(),W=ge(),$=ge(),q=Me(),G=ge(),U=ge(),X=ge(),Y=ge(),Z=He(),_=He(),te=He(),ce=He(),Ve=He(),De=He(),Je=He(),Ae=He(),Fe=He(),Ne=He(),Oe=He(),Pe=He(),Be=He(),We=He(),$e=He(),qe=ge(),tt=He(),[st,nt,at,ot]=ze((()=>vs)),rt=e=>{if(!Ze(e,((e,t)=>Q([l,i],t))))return!1;const t=e[l];return!(!D(t)&&t!=o||(me(e[i])!=t&&ne(e,i),0))},lt=(t,s)=>(!e||le(z,s)||zt(s))&&Ze(t,((e,t)=>it(s,t,e)),(()=>zt(s))),it=(e,t,s,n)=>Ze(n?s:ht(s,e,t),((n,a)=>x(ct(e,t,a,n),(e=>(s[a]=e,!0)),(()=>!1))),(()=>zt(e,t))),ct=(t,s,n,a)=>e?x(we(we(z,t),n),(e=>me(a)!=e[l]?zt(t,s,n,a,e[i]):a),(()=>zt(t,s,n,a))):M(me(a))?zt(t,s,n,a):a,dt=(e,t)=>Ze(t?e:gt(e),((t,s)=>x(ut(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>Nt())),ut=(e,s)=>t?x(we(W,e),(t=>me(s)!=t[l]?Nt(e,s,t[i]):s),(()=>Nt(e,s))):M(me(s))?Nt(e,s):s,ht=(e,t,s)=>(x(we(j,t),(([n,a])=>{ue(n,((t,s)=>{se(e,s)||(e[s]=t)})),ue(a,(n=>{se(e,n)||zt(t,s,n)}))})),e),gt=e=>(t&&(ue($,((t,s)=>{se(e,s)||(e[s]=t)})),ue(q,(t=>{se(e,t)||Nt(t)}))),e),ft=e=>ve(z,e,((e,t,s)=>{const n=ge(),a=Me();ve(Te(z,t,ge),s,((e,t,s)=>{Se(e,t,s),x(s[i],(e=>Se(n,t,e)),(()=>xe(a,t)))})),Se(j,t,[n,a])}),((e,t)=>{Se(z,t),Se(j,t)})),wt=e=>ve(W,e,((e,t,s)=>{Se(W,t,s),x(s[i],(e=>Se($,t,e)),(()=>xe(q,t)))}),((e,t)=>{Se(W,t),Se($,t),he(q,t)})),Lt=e=>oe(e)?ds():os(e),St=e=>ve(X,e,((e,t,s)=>Tt(t,s)),((e,t)=>mt(t))),Tt=(e,t)=>ve(Te(X,e,(()=>(xt(e,1),Se(G,e,Qe()),Se(U,e,ge()),ge()))),t,((t,s,n)=>vt(e,t,s,n)),((t,s)=>Et(e,t,s))),vt=(e,t,s,n,a)=>ve(Te(t,s,(()=>(Dt(e,s,1),ge()))),n,((t,n,a)=>Rt(e,s,t,n,a)),((n,o)=>kt(e,t,s,n,o,a))),Rt=(e,t,s,n,a)=>{le(s,n)||Jt(e,t,n,1);const o=we(s,n);a!==o&&(At(e,t,n,o,a),Se(s,n,a))},yt=(e,t,s,n,a)=>x(we(t,s),(t=>Rt(e,s,t,n,a)),(()=>vt(e,t,s,ht({[n]:a},e,s)))),It=e=>oe(e)?gs():rs(e),Ct=e=>ve(Y,e,((e,t,s)=>pt(t,s)),((e,t)=>Mt(t))),pt=(e,t)=>{le(Y,e)||Ft(e,1);const s=we(Y,e);t!==s&&(Qt(e,s,t),Se(Y,e,t))},bt=(e,t)=>{const[s]=we(G,e),n=s(t);return le(we(X,e),n)?bt(e,t):n},Vt=e=>we(X,e)??Tt(e,{}),mt=e=>Tt(e,{}),Et=(e,t,s)=>{const[,n]=we(G,e);n(s),vt(e,t,s,{},!0)},kt=(e,t,s,n,a,o)=>{const r=we(we(j,e)?.[0],a);if(!M(r)&&!o)return Rt(e,s,n,a,r);const l=t=>{At(e,s,t,we(n,t)),Jt(e,s,t,-1),Se(n,t)};M(r)?l(a):Le(n,l),ie(n)&&(Dt(e,s,-1),ie(Se(t,s))&&(xt(e,-1),Se(X,e),Se(G,e),Se(U,e)))},Mt=e=>{const t=we($,e);if(!M(t))return pt(e,t);Qt(e,we(Y,e)),Ft(e,-1),Se(Y,e)},xt=(e,t)=>_e(r,e,t),Dt=(e,t,s)=>_e(Te(v,e,ge),t,s)&&Se(h,e,Te(h,e,(()=>0))+s),Jt=(e,t,s,n)=>{const a=we(U,e),o=we(a,s)??0;(0==o&&1==n||1==o&&-1==n)&&_e(Te(d,e,ge),s,n),Se(a,s,o!=-n?o+n:null),_e(Te(Te(V,e,ge),t,ge),s,n)},At=(e,t,s,n,a)=>Te(Te(Te(m,e,ge),t,ge),s,(()=>[n,0]))[1]=a,Ft=(e,t)=>_e(E,e,t),Qt=(e,t,s)=>Te(k,e,(()=>[t,0]))[1]=s,zt=(e,t,s,n,a)=>(K(Te(Te(Te(A,e,ge),t,ge),s,(()=>[])),n),a),Nt=(e,t,s)=>(K(Te(F,e,(()=>[])),t),s),jt=(e,t,s)=>x(we(we(we(m,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...Ge(ts(e,t,s))])),Ot=e=>x(we(k,e),(([e,t])=>[!0,e,t]),(()=>[!1,...Ge(as(e))])),Pt=e=>ie(A)||ie(Oe[e])?0:ue(e?be(A):A,((t,s)=>ue(t,((t,n)=>ue(t,((t,a)=>nt(Oe[e],[s,n,a],t))))))),Bt=e=>ie(F)||ie(Pe[e])?0:ue(e?Ce(F):F,((t,s)=>nt(Pe[e],[s],t))),Wt=(e,t,s)=>{if(!ie(t))return nt(e,s,(()=>Re(t))),1},$t=e=>{const t=ie(Je[e]),s=ie(Fe[e])&&ie(ce[e])&&ie(Ve[e])&&ie(De[e])&&t&&ie(_[e]),n=ie(Ne[e])&&ie(Ae[e])&&ie(te[e])&&ie(Z[e]);if(!s||!n){const a=e?[Ce(r),pe(d),Ce(h),pe(v),be(V),be(m)]:[r,d,h,v,V,m];if(!s){Wt(_[e],a[0]),ue(a[1],((t,s)=>Wt(ce[e],t,[s]))),ue(a[2],((t,s)=>{0!=t&&nt(Ve[e],[s],Yt(s))}));const s=Me();ue(a[3],((n,a)=>{Wt(De[e],n,[a])&&!t&&(nt(Je[e],[a,null]),xe(s,a))})),t||ue(a[5],((t,n)=>{if(!le(s,n)){const s=Me();ue(t,(e=>ue(e,(([t,n],a)=>n!==t?xe(s,a):he(e,a))))),ue(s,(t=>nt(Je[e],[n,t])))}})),ue(a[4],((t,s)=>ue(t,((t,n)=>Wt(Fe[e],t,[s,n])))))}if(!n){let t;ue(a[5],((s,n)=>{let a;ue(s,((s,o)=>{let r;ue(s,(([s,l],i)=>{l!==s&&(nt(Ne[e],[n,o,i],l,s,jt),t=a=r=1)})),r&&nt(Ae[e],[n,o],jt)})),a&&nt(te[e],[n],jt)})),t&&nt(Z[e],void 0,jt)}}},qt=e=>{const t=ie(We[e]),s=ie($e[e])&&ie(Be[e]);if(!t||!s){const n=e?[Ce(E),Ce(k)]:[E,k];if(t||Wt(We[e],n[0]),!s){let t;ue(n[1],(([s,n],a)=>{n!==s&&(nt($e[e],[a],n,s,Ot),t=1)})),t&&nt(Be[e],void 0,Ot)}}},Gt=(e,...t)=>(Ls((()=>e(...B(t,b)))),vs),Ht=()=>[Re(m,((e,t)=>-1===we(r,t)?null:Re(e,((e,s)=>-1===we(we(v,t),s)?null:Re(e,(([,e])=>e??null),((e,t)=>Ue(t)))),oe)),oe),Re(k,(([,e])=>e??null),((e,t)=>Ue(t)))],Kt=()=>({cellsTouched:s,valuesTouched:n,changedCells:Ie(m,Ke,Ue),invalidCells:Ie(A),changedValues:Re(k,Ke,Ue),invalidValues:Re(F),changedTableIds:Re(r),changedRowIds:ye(v),changedCellIds:Ie(V),changedValueIds:Re(E)}),Ut=()=>Ie(X),Xt=()=>fe(X),Yt=e=>re(we(X,b(e))),Zt=e=>fe(we(X,b(e))),_t=(e,t,s,n=0,a)=>{return B(H(O((o=we(X,b(e)),r=(e,s)=>[M(t)?s:we(e,b(t)),s],B([...o?.entries()??[]],(([e,t])=>r(t,e)))),(([e],[t])=>je(e,t)*(s?-1:1))),n,M(a)?a:n+a),(([,e])=>e));var o,r},es=(e,t)=>fe(we(we(X,b(e)),b(t))),ts=(e,t,s)=>we(we(we(X,b(e)),b(t)),b(s)),ss=()=>Re(Y),ns=()=>fe(Y),as=e=>we(Y,b(e)),os=e=>Gt((()=>(e=>Ze(e,lt,zt))(e)?St(e):0)),rs=e=>Gt((()=>dt(e)?Ct(e):0)),ls=e=>{try{Lt(Ye(e))}catch{}return vs},is=t=>Gt((()=>{if((e=Ze(t,(e=>Ze(e,rt))))&&(ft(t),!ie(X))){const e=Ut();ds(),os(e)}})),cs=e=>Gt((()=>{if(t=(e=>Ze(e,rt))(e)){const s=ss();ws(),gs(),t=!0,wt(e),rs(s)}})),ds=()=>Gt((()=>St({}))),us=e=>Gt((e=>le(X,e)?mt(e):0),e),hs=(e,t)=>Gt(((e,t)=>x(we(X,e),(s=>le(s,t)?Et(e,s,t):0))),e,t),gs=()=>Gt((()=>Ct({}))),fs=()=>Gt((()=>{ft({}),e=!1})),ws=()=>Gt((()=>{wt({}),t=!1})),Ls=(e,t)=>{if(-1!=a){Ss();const s=e();return Ts(t),s}},Ss=()=>(-1!=a&&a++,1==a&&nt(qe,void 0,Ht,Kt),vs),Ts=e=>(a>0&&(a--,0==a&&(s=!ie(m),n=!ie(k),a=1,Pt(1),s&&$t(1),Bt(1),n&&qt(1),e?.(Ht,Kt)&&(ue(m,((e,t)=>ue(e,((e,s)=>ue(e,(([e],n)=>Ee(vs,t,s,n,e))))))),ue(k,(([e],t)=>ke(vs,t,e))),s=n=!1),nt(tt[0],void 0,Ht,Kt),a=-1,Pt(0),s&&$t(0),Bt(0),n&&qt(0),nt(tt[1],void 0,Ht,Kt),a=0,s=n=!1,P([r,d,h,v,V,m,A,E,k,F],de))),vs),vs={getContent:()=>[Ut(),ss()],getTables:Ut,getTableIds:Xt,getTable:e=>ye(we(X,b(e))),getTableCellIds:e=>fe(we(U,b(e))),getRowCount:Yt,getRowIds:Zt,getSortedRowIds:_t,getRow:(e,t)=>Re(we(we(X,b(e)),b(t))),getCellIds:es,getCell:ts,getValues:ss,getValueIds:ns,getValue:as,hasTables:()=>!ie(X),hasTable:e=>le(X,b(e)),hasTableCell:(e,t)=>le(we(U,b(e)),b(t)),hasRow:(e,t)=>le(we(X,b(e)),b(t)),hasCell:(e,t,s)=>le(we(we(X,b(e)),b(t)),b(s)),hasValues:()=>!ie(Y),hasValue:e=>le(Y,b(e)),getTablesJson:()=>Xe(X),getValuesJson:()=>Xe(Y),getJson:()=>Xe([X,Y]),getTablesSchemaJson:()=>Xe(z),getValuesSchemaJson:()=>Xe(W),getSchemaJson:()=>Xe([z,W]),setContent:([e,t])=>Gt((()=>{(oe(e)?ds:os)(e),(oe(t)?gs:rs)(t)})),setTables:os,setTable:(e,t)=>Gt((e=>lt(t,e)?Tt(e,t):0),e),setRow:(e,t,s)=>Gt(((e,t)=>it(e,t,s)?vt(e,Vt(e),t,s):0),e,t),addRow:(e,t,s=!0)=>Ls((()=>{let n;return it(e,n,t)&&(e=b(e),vt(e,Vt(e),n=bt(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>Gt(((e,t)=>{if(it(e,t,s,1)){const n=Vt(e);ae(s,((s,a)=>yt(e,n,t,a,s)))}}),e,t),setCell:(e,t,s,n)=>Gt(((e,t,s)=>x(ct(e,t,s,J(n)?n(ts(e,t,s)):n),(n=>yt(e,Vt(e),t,s,n)))),e,t,s),setValues:rs,setPartialValues:e=>Gt((()=>dt(e,1)?ae(e,((e,t)=>pt(t,e))):0)),setValue:(e,t)=>Gt((e=>x(ut(e,J(t)?t(as(e)):t),(t=>pt(e,t)))),e),setTransactionChanges:e=>Gt((()=>{ae(e[0],((e,t)=>M(e)?us(t):ae(e,((e,s)=>M(e)?hs(t,s):ae(e,((e,n)=>Ee(vs,t,s,n,e))))))),ae(e[1],((e,t)=>ke(vs,t,e)))})),setTablesJson:ls,setValuesJson:e=>{try{It(Ye(e))}catch{}return vs},setJson:e=>{try{const[t,s]=Ye(e);Lt(t),It(s)}catch{ls(e)}return vs},setTablesSchema:is,setValuesSchema:cs,setSchema:(e,t)=>Gt((()=>{is(e),cs(t)})),delTables:ds,delTable:us,delRow:hs,delCell:(e,t,s,n)=>Gt(((e,t,s)=>x(we(X,e),(a=>x(we(a,t),(o=>le(o,s)?kt(e,a,t,o,s,n):0))))),e,t,s),delValues:gs,delValue:e=>Gt((e=>le(Y,e)?Mt(e):0),e),delTablesSchema:fs,delValuesSchema:ws,delSchema:()=>Gt((()=>{fs(),ws()})),transaction:Ls,startTransaction:Ss,finishTransaction:Ts,forEachTable:e=>ue(X,((t,s)=>e(s,(e=>ue(t,((t,s)=>e(s,(e=>Le(t,e))))))))),forEachTableCell:(e,t)=>Le(we(U,b(e)),t),forEachRow:(e,t)=>ue(we(X,b(e)),((e,s)=>t(s,(t=>Le(e,t))))),forEachCell:(e,t,s)=>Le(we(we(X,b(e)),b(t)),s),forEachValue:e=>Le(Y,e),addSortedRowIdsListener:(e,t,s,n,a,o,r)=>{let l=_t(e,t,s,n,a);return st((()=>{const r=_t(e,t,s,n,a);N(r,l)||(l=r,o(vs,e,t,s,n,a,l))}),Je[r?1:0],[e,t],[Xt])},addStartTransactionListener:e=>st(e,qe),addWillFinishTransactionListener:e=>st(e,tt[0]),addDidFinishTransactionListener:e=>st(e,tt[1]),callListener:e=>(ot(e),vs),delListener:e=>(at(e),vs),getListenerStats:()=>({}),createStore:et};return ae({[f]:[0,Z],[w]:[0,_],[g]:[1,te,[Xt]],[g+y]:[1,ce,[Xt]],[S]:[1,Ve,[Xt]],[T]:[1,De,[Xt]],[L]:[2,Ae,[Xt,Zt]],[y]:[2,Fe,[Xt,Zt]],[R]:[3,Ne,[Xt,Zt,es],e=>Ge(ts(...e))],InvalidCell:[3,Oe],[C]:[0,Be],[p]:[0,We],[I]:[1,$e,[ns],e=>Ge(as(e[0]))],InvalidValue:[1,Pe]},(([e,t,s,n],a)=>{vs[u+a+c]=(...a)=>st(a[e],t[a[e+1]?1:0],e>0?H(a,0,e):void 0,s,n)})),ee(vs)};e.createCheckpoints=Ne,e.createCustomPersister=(e,t,s,n,a)=>{let o,r,l,i=0,c=0,d=0;const u=[],h=async e=>(2!=i&&(i=1,await g.schedule((async()=>{await e(),i=0}))),g),g={load:async(s,n)=>await h((async()=>{try{e.setContent(await t())}catch{e.setContent([s,n])}})),startAutoLoad:async(s={},a={})=>(g.stopAutoLoad(),await g.load(s,a),d=1,l=n((async(s,n)=>await h((async()=>{if(n)e.setTransactionChanges(n());else try{e.setContent(s?.()??await t())}catch{}})))),g),stopAutoLoad:()=>(d&&(a(l),l=void 0,d=0),g),save:async t=>(1!=i&&(i=2,await g.schedule((async()=>{try{await s(e.getContent,t)}catch{}i=0}))),g),startAutoSave:async()=>(await g.stopAutoSave().save(),o=e.addDidFinishTransactionListener(((e,t)=>{const[s,n]=t();oe(s)&&oe(n)||g.save((()=>[s,n]))})),g),stopAutoSave:()=>(x(o,e.delListener),g),schedule:async(...e)=>(K(u,...e),await(async()=>{if(!c){for(c=1;!M(r=X(u));)try{await r()}catch{}c=0}})(),g),getStore:()=>e,destroy:()=>g.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return ee(g)},e.createIndexes=Oe,e.createMetrics=We,e.createQueries=$e,e.createRelationships=qe,e.createStore=et,e.defaultSorter=je},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={});
