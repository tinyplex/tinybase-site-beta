var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",n=t(s),o=t(!0),a=t(0),r=t(t),l="type",i="default",c="Listener",d="Result",u="add",h="Ids",g="Table",f=g+"s",L=g+h,w="Row",S=w+h,T="Sorted"+w+h,v="Cell",R=v+h,I="Value",p=I+"s",C=I+h,y=e=>s+e,b=(e,t)=>e.includes(t),V=(e,t)=>e.every(t),m=(e,t)=>J(e)===J(t)&&V(e,((e,s)=>t[s]===e)),E=(e,t)=>V(e,((s,n)=>0==n||t(e[n-1],s)<=0)),k=(e,t)=>e.sort(t),M=(e,t)=>e.forEach(t),x=(e,t)=>e.map(t),D=e=>F(e,((e,t)=>e+t),0),J=e=>e.length,A=e=>0==J(e),F=(e,t,s)=>e.reduce(t,s),Q=(e,t,s)=>e.slice(t,s),z=(e,...t)=>e.push(...t),N=e=>e.pop(),j=e=>e.shift(),O=e=>JSON.stringify(e,((e,t)=>q(t,Map)?F([...t],((e,[t,s])=>(e[t]=s,e)),{}):t)),P=JSON.parse,B=Math.max,W=Math.min,$=isFinite,q=(e,t)=>e instanceof t,G=e=>null==e,H=(e,t,s)=>G(e)?s?.():t(e),K=e=>e==n||e==o,U=e=>t(e)==r,X=e=>Array.isArray(e),Y=()=>{},Z=Object,_=Z.keys,ee=Z.isFrozen,te=Z.freeze,se=e=>q(e,Z)&&e.constructor==Z,ne=(e,t)=>!G(((e,t)=>H(e,(e=>e[t])))(e,t)),oe=(e,t)=>delete e[t],ae=(e,t)=>x(Z.entries(e),(([e,s])=>t(s,e))),re=e=>se(e)&&A(_(e)),le=e=>e.size,ie=(e,t)=>e?.has(t)??!1,ce=e=>G(e)||0==le(e),de=e=>[...e?.values()??[]],ue=e=>e.clear(),he=(e,t)=>e?.forEach(t),ge=(e,t)=>e?.delete(t),fe=e=>new Map(e),Le=e=>[...e?.keys()??[]],we=(e,t)=>e?.get(t),Se=(e,t)=>he(e,((e,s)=>t(s,e))),Te=(e,t,s)=>G(s)?(ge(e,t),e):e?.set(t,s),ve=(e,t,s)=>(ie(e,t)||Te(e,t,s()),we(e,t)),Re=(e,t,s)=>{const n={};return he(e,((e,o)=>{const a=t?t(e,o):e;!s?.(a,e)&&(n[o]=a)})),n},Ie=(e,t,s)=>Re(e,(e=>Re(e,t,s)),re),pe=(e,t,s)=>Re(e,(e=>Ie(e,t,s)),re),Ce=(e,t)=>{const s=fe();return he(e,((e,n)=>s.set(n,t?.(e)??e))),s},ye=e=>Ce(e,Ce),be=e=>Ce(e,ye),Ve=(e,t,s,n,o=0)=>H((s?ve:we)(e,t[o],o>J(t)-2?s:fe),(a=>{if(o>J(t)-2)return n?.(a)&&Te(e,t[o]),a;const r=Ve(a,t,s,n,o+1);return ce(a)&&Te(e,t[o]),r})),me=e=>{const s=t(e);return K(s)||s==a&&$(e)?s:void 0},Ee=(e,t,s,n,o)=>G(o)?e.delCell(t,s,n,!0):e.setCell(t,s,n,o),ke=(e,t,s)=>G(s)?e.delValue(t):e.setValue(t,s),Me=e=>new Set(X(e)||G(e)?e:[e]),xe=(e,t)=>e?.add(t),De=(e,t,s)=>{const n=e.hasRow,o=fe(),a=fe(),r=fe(),l=fe(),i=fe(),c=(t,s,...n)=>{const o=ve(i,t,Me);return M(n,(t=>xe(o,t)&&s&&e.callListener(t))),n},d=(t,...s)=>H(we(i,t),(n=>{M(A(s)?de(n):s,(t=>{e.delListener(t),ge(n,t)})),ce(n)&&Te(i,t)})),u=(e,s)=>{Te(o,e,s),ie(a,e)||(Te(a,e,t()),Te(r,e,fe()),Te(l,e,fe()))},h=e=>{Te(o,e),Te(a,e),Te(r,e),Te(l,e),d(e)};return[()=>e,()=>Le(o),e=>Se(a,e),e=>ie(a,e),e=>we(o,e),e=>we(a,e),(e,t)=>Te(a,e,t),u,(t,o,a,i,h)=>{u(t,o);const g=fe(),f=fe(),L=we(r,t),w=we(l,t),S=t=>{const a=s=>e.getCell(o,t,s),r=we(L,t),l=n(o,t)?s(i(a,t)):void 0;if(r===l||X(r)&&X(l)&&m(r,l)||Te(g,t,[r,l]),!G(h)){const e=we(w,t),s=n(o,t)?h(a,t):void 0;e!=s&&Te(f,t,s)}},T=e=>{a((()=>{he(g,(([,e],t)=>Te(L,t,e))),he(f,((e,t)=>Te(w,t,e)))}),g,f,L,w,e),ue(g),ue(f)};Se(L,S),e.hasTable(o)&&M(e.getRowIds(o),(e=>{ie(L,e)||S(e)})),T(!0),d(t),c(t,0,e.addRowListener(o,null,((e,t,s)=>S(s))),e.addTableListener(o,(()=>T())))},h,()=>Se(i,h),c,d]},Je=(e,o)=>t(e)==n?t=>t(e):e??(()=>o??s),Ae=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},Fe=/^\d+$/,Qe=()=>{const e=[];let t=0;return[n=>(n?j(e):null)??s+t++,t=>{Fe.test(t)&&J(e)<1e3&&z(e,t)}]},ze=e=>{let t;const[n,o]=Qe(),a=fe();return[(o,r,l,i=[],c=(()=>[]))=>{t??=e();const d=n(1);return Te(a,d,[o,r,l,i,c]),xe(Ve(r,l??[s],Me),d),d},(e,n,...o)=>M(((e,t=[s])=>{const n=[],o=(e,s)=>s==J(t)?z(n,e):null===t[s]?he(e,(e=>o(e,s+1))):M([t[s],null],(t=>o(we(e,t),s+1)));return o(e,0),n})(e,n),(e=>he(e,(e=>we(a,e)[0](t,...n??[],...o))))),e=>H(we(a,e),(([,t,n])=>(Ve(t,n??[s],void 0,(t=>(ge(t,e),ce(t)?1:0))),Te(a,e),o(e),n))),e=>H(we(a,e),(([e,,s=[],n,o])=>{const a=(...r)=>{const l=J(r);l==J(s)?e(t,...r,...o(r)):G(s[l])?M(n[l]?.(...r)??[],(e=>a(...r,e))):a(...r,s[l])};a()}))]},Ne=Ae((e=>{let t,n,o,a=100,r=fe(),l=fe(),i=1;const c=fe(),d=fe(),[u,h,g]=ze((()=>O)),f=fe(),L=fe(),w=[],S=[],T=(t,s)=>{i=0,e.transaction((()=>{const[n,o]=we(f,s);he(n,((s,n)=>he(s,((s,o)=>he(s,((s,a)=>Ee(e,n,o,a,s[t]))))))),he(o,((s,n)=>ke(e,n,s[t])))})),i=1},v=e=>{Te(f,e),Te(L,e),h(d,[e])},R=(e,t)=>M(((e,t)=>e.splice(0,t))(e,t??J(e)),v),I=()=>R(w,J(w)-a),p=()=>H(t,(()=>{z(w,t),I(),R(S),t=void 0,o=1})),C=()=>{t=N(w),o=1},y=e.addCellListener(null,null,null,((e,t,s,n,o,a)=>{if(i){p();const e=ve(r,t,fe),l=ve(e,s,fe),i=ve(l,n,(()=>[a,void 0]));i[1]=o,i[0]===o&&ce(Te(l,n))&&ce(Te(e,s))&&ce(Te(r,t))&&C(),x()}})),V=e.addValueListener(null,((e,t,s,n)=>{if(i){p();const e=ve(l,t,(()=>[n,void 0]));e[1]=s,e[0]===s&&ce(Te(l,t))&&C(),x()}})),m=(e="")=>(G(t)&&(t=s+n++,Te(f,t,[r,l]),F(t,e),r=fe(),l=fe(),o=1),t),E=()=>{A(w)||(((e,...t)=>{e.unshift(...t)})(S,m()),T(0,t),t=N(w),o=1)},k=()=>{A(S)||(z(w,t),t=j(S),T(1,t),o=1)},x=()=>{o&&(h(c),o=0)},D=e=>{const t=m(e);return x(),t},F=(e,t)=>(Q(e)&&we(L,e)!==t&&(Te(L,e,t),h(d,[e])),O),Q=e=>ie(f,e),O={setSize:e=>(a=e,I(),O),addCheckpoint:D,setCheckpoint:F,getStore:()=>e,getCheckpointIds:()=>[[...w],t,[...S]],forEachCheckpoint:e=>Se(L,e),hasCheckpoint:Q,getCheckpoint:e=>we(L,e),goBackward:()=>(E(),x(),O),goForward:()=>(k(),x(),O),goTo:e=>{const s=b(w,e)?E:b(S,e)?k:null;for(;!G(s)&&e!=t;)s();return x(),O},addCheckpointIdsListener:e=>u(e,c),addCheckpointListener:(e,t)=>u(t,d,[e]),delListener:e=>(g(e),O),clear:()=>(R(w),R(S),G(t)||v(t),t=void 0,n=0,D(),O),destroy:()=>{e.delListener(y),e.delListener(V)},getListenerStats:()=>({})};return te(O.clear())})),je=(e,t)=>e<t?-1:1,Oe=Ae((e=>{const t=fe(),n=fe(),[o,a,r,l,i,c,d,,u,h,g]=De(e,fe,(e=>G(e)?s:X(e)?x(e,y):y(e))),[f,L,w]=ze((()=>T)),S=(t,s,n)=>{const o=i(t);he(n,((t,n)=>s(n,(s=>he(t,(t=>s(t,(s=>e.forEachCell(o,t,s)))))))))},T={setIndexDefinition:(e,s,o,a,r,l=je)=>{const i=G(r)?void 0:([e],[t])=>r(e,t);return u(e,s,((s,o,r,u,h,g)=>{let f=0;const w=Me(),S=Me(),T=c(e);if(he(o,(([e,t],s)=>{const n=Me(e),o=Me(t);he(n,(e=>ge(o,e)?ge(n,e):0)),he(n,(e=>{xe(w,e),H(we(T,e),(t=>{ge(t,s),ce(t)&&(Te(T,e),f=1)}))})),he(o,(e=>{xe(w,e),ie(T,e)||(Te(T,e,Me()),f=1),xe(we(T,e),s),G(a)||xe(S,e)}))})),s(),ce(h)||(g?Se(T,(e=>xe(S,e))):Se(r,(e=>H(we(u,e),(e=>xe(S,e))))),he(S,(e=>{const t=(t,s)=>l(we(h,t),we(h,s),e),s=[...we(T,e)];E(s,t)||(Te(T,e,Me(k(s,t))),xe(w,e))}))),(f||g)&&!G(i)){const t=[...T];E(t,i)||(d(e,fe(k(t,i))),f=1)}f&&L(t,[e]),he(w,(t=>L(n,[e,t])))}),Je(o),H(a,Je)),T},delIndexDefinition:e=>(h(e),T),getStore:o,getIndexIds:a,forEachIndex:e=>r(((t,s)=>e(t,(e=>S(t,e,s))))),forEachSlice:(e,t)=>S(e,t,c(e)),hasIndex:l,hasSlice:(e,t)=>ie(c(e),t),getTableId:i,getSliceIds:e=>Le(c(e)),getSliceRowIds:(e,t)=>de(we(c(e),t)),addSliceIdsListener:(e,s)=>f(s,t,[e]),addSliceRowIdsListener:(e,t,s)=>f(s,n,[e,t]),delListener:e=>(w(e),T),destroy:g,getListenerStats:()=>({})};return te(T)})),Pe=fe([["avg",[(e,t)=>D(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>B(...e),(e,t)=>B(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:B(t,e)]],["min",[e=>W(...e),(e,t)=>W(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:W(t,e)]],["sum",[e=>D(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),Be=(e,t,s,n,o,a=!1)=>{if(ce(s))return;const[r,l,i,c]=o;return a||=G(e),he(n,(([s,n])=>{a||(e=G(s)?l?.(e,n,t++):G(n)?i?.(e,s,t--):c?.(e,n,s,t),a||=G(e))})),a?r(de(s),le(s)):e},We=Ae((e=>{const t=fe(),[n,o,a,r,l,i,c,,d,u,h]=De(e,Y,(e=>isNaN(e)||G(e)||!0===e||!1===e||e===s?void 0:1*e)),[g,f,L]=ze((()=>w)),w={setMetricDefinition:(e,s,n,o,a,r,l)=>{const u=U(n)?[n,a,r,l]:we(Pe,n)??we(Pe,"sum");return d(e,s,((s,n,o,a,r,l)=>{const d=i(e),h=le(a);l||=G(d),s();let g=Be(d,h,a,n,u,l);$(g)||(g=void 0),g!=d&&(c(e,g),f(t,[e],g,d))}),Je(o,1)),w},delMetricDefinition:e=>(u(e),w),getStore:n,getMetricIds:o,forEachMetric:a,hasMetric:r,getTableId:l,getMetric:i,addMetricListener:(e,s)=>g(s,t,[e]),delListener:e=>(L(e),w),destroy:h,getListenerStats:()=>({})};return te(w)})),$e=Ae((e=>{const t=e.createStore,[n,o,a,r,l,,,i,,h,f,L,I]=De(e,(()=>!0),Y),p=t(),C=t(),y=fe(),b=(e,t,...s)=>M(s,(s=>xe(ve(ve(y,t,fe),e,Me),s))),m=e=>{H(we(y,e),(e=>{Se(e,((e,t)=>he(t,(t=>e.delListener(t))))),ue(e)})),M([C,p],(t=>t.delTable(e)))},E=(e,t,s)=>b(t,e,t.addStartTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),k={setQueryDefinition:(t,n,o)=>{i(t,n),m(t);const a=[],r=[[null,[n,null,null,[],fe()]]],l=[],c=[],d=[];o({select:(e,t)=>{const n=U(e)?[J(a)+s,e]:[G(t)?e:t,s=>s(e,t)];return z(a,n),{as:e=>n[0]=e}},join:(e,t,s)=>{const n=G(s)||U(t)?null:t,o=G(n)?t:s,a=[e,[e,n,U(o)?o:e=>e(o),[],fe()]];return z(r,a),{as:e=>a[0]=e}},where:(e,t,s)=>z(l,U(e)?e:G(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,o)=>{const a=[e,[e,U(t)?[t,s,n,o]:we(Pe,t)??[(e,t)=>t]]];return z(c,a),{as:e=>a[0]=e}},having:(e,t)=>z(d,U(e)?e:s=>s(e)===t)});const u=fe(a);if(ce(u))return k;const h=fe(r);Se(h,((e,[,t])=>H(we(h,t),(({3:t})=>G(e)?0:z(t,e)))));const g=fe(c);let f=p;if(ce(g)&&A(d))f=C;else{E(t,f,C);const e=fe();Se(g,((t,[s,n])=>xe(ve(e,s,Me),[t,n])));const s=Me();Se(u,(t=>ie(e,t)?0:xe(s,t)));const n=fe(),o=(s,n,o,a)=>H(s,(([r,l,i,c])=>{Se(n,((t,[s])=>{const n=ve(r,t,fe),l=we(n,o),i=a?void 0:s;if(l!==i){const s=Me([[l,i]]),a=le(n);Te(n,o,i),he(we(e,t),(([e,t])=>{const o=Be(c[e],a,n,s,t);c[e]=G(me(o))?null:o}))}})),ce(l)||!V(d,(e=>e((e=>c[e]))))?C.delRow(t,i):G(i)?s[2]=C.addRow(t,c):C.setRow(t,i,c)}));b(f,t,f.addRowListener(t,null,((a,r,l,i)=>{const c=[],d=[],u=fe(),h=f.hasRow(t,l);let g=!h;he(s,(e=>{const[s,n,o]=i(t,l,e);z(c,n),z(d,o),g||=s})),Se(e,(e=>{const[s,,n]=i(t,l,e);(g||s)&&Te(u,e,[n])})),g&&o(Ve(n,c,void 0,(([,e])=>(ge(e,l),ce(e)))),u,l,1),h&&o(Ve(n,d,(()=>{const e={};return he(s,(s=>e[s]=f.getCell(t,l,s))),[fe(),Me(),void 0,e]}),(([,e])=>{xe(e,l)})),u,l)})))}E(t,e,f);const w=(s,o,a,r)=>{const i=t=>e.getCell(o,a,t);M(r,(n=>{const[o,,a,r,l]=we(h,n),c=a?.(i,s),[d,u]=we(l,s)??[];c!=d&&(G(u)||I(t,u),Te(l,s,G(c)?null:[c,...L(t,1,e.addRowListener(o,c,(()=>w(s,o,c,r))))]))})),(s=>{const o=(t,o)=>e.getCell(...G(o)?[n,s,t]:t===n?[n,s,o]:[we(h,t)?.[0],we(we(h,t)?.[4],s)?.[0],o]);f.transaction((()=>V(l,(e=>e(o)))?Se(u,((e,n)=>Ee(f,t,s,e,n(o,s)))):f.delRow(t,s)))})(s)},{3:S}=we(h,null);return f.transaction((()=>L(t,1,e.addRowListener(n,null,((s,o,a)=>{e.hasRow(n,a)?w(a,n,a,S):(f.delRow(t,a),he(h,(({4:e})=>H(we(e,a),(([,s])=>{I(t,s),Te(e,a)})))))}))))),k},delQueryDefinition:e=>(m(e),h(e),k),getStore:n,getQueryIds:o,forEachQuery:a,hasQuery:r,getTableId:l,delListener:e=>(C.delListener(e),k),destroy:f,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=C.getListenerStats();return n}};return ae({[g]:[1,1],[S]:[0,1],[T]:[0,5],[w]:[1,2],[R]:[0,2],[v]:[1,3]},(([e,t],s)=>{M(e?["get","has","forEach"]:["get"],(e=>k[e+d+s]=(...t)=>C[e+s](...t))),k[u+d+s+c]=(...e)=>C[u+s+c](...Q(e,0,t),((s,...n)=>e[t](k,...n)))})),te(k)})),qe=Ae((e=>{const t=fe(),n=fe(),o=fe(),a=fe(),[r,l,i,c,d,u,,,h,g,f]=De(e,(()=>[fe(),fe(),fe(),fe()]),(e=>G(e)?void 0:e+s)),[L,w,S]=ze((()=>I)),T=(e,t,s)=>H(u(e),(([n,,o])=>{if(!ie(o,t)){const a=Me();if(d(e)!=R(e))xe(a,t);else{let e=t;for(;!G(e)&&!ie(a,e);)xe(a,e),e=we(n,e)}if(s)return a;Te(o,t,a)}return we(o,t)})),v=(e,t)=>H(u(e),(([,,e])=>Te(e,t))),R=e=>we(t,e),I={setRelationshipDefinition:(e,s,r,l)=>(Te(t,e,r),h(e,s,((t,s)=>{const r=Me(),l=Me(),i=Me(),[c,d]=u(e);he(s,(([t,s],n)=>{G(t)||(xe(l,t),H(we(d,t),(e=>{ge(e,n),ce(e)&&Te(d,t)}))),G(s)||(xe(l,s),ie(d,s)||Te(d,s,Me()),xe(we(d,s),n)),xe(r,n),Te(c,n,s),Se(we(a,e),(t=>{ie(T(e,t),n)&&xe(i,t)}))})),t(),he(r,(t=>w(n,[e,t]))),he(l,(t=>w(o,[e,t]))),he(i,(t=>{v(e,t),w(a,[e,t])}))}),Je(l)),I),delRelationshipDefinition:e=>(Te(t,e),g(e),I),getStore:r,getRelationshipIds:l,forEachRelationship:t=>i((s=>t(s,(t=>e.forEachRow(d(s),t))))),hasRelationship:c,getLocalTableId:d,getRemoteTableId:R,getRemoteRowId:(e,t)=>we(u(e)?.[0],t),getLocalRowIds:(e,t)=>de(we(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>G(u(e))?[t]:de(T(e,t,!0)),addRemoteRowIdListener:(e,t,s)=>L(s,n,[e,t]),addLocalRowIdsListener:(e,t,s)=>L(s,o,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(T(e,t),L(s,a,[e,t])),delListener:e=>(v(...S(e)),I),destroy:f,getListenerStats:()=>({})};return te(I)})),Ge=e=>[e,e],He=()=>[fe(),fe()],Ke=e=>[...e],Ue=([e,t])=>e===t,Xe=(e,t,s,n=Te)=>(ae(t,((t,n)=>s(e,n,t))),Se(e,(s=>ne(t,s)?0:n(e,s))),e),Ye=(e,t,s)=>G(e)||!se(e)||re(e)||ee(e)?(s?.(),!1):(ae(e,((s,n)=>{t(s,n)||oe(e,n)})),!re(e)),Ze=(e,t,s)=>Te(e,t,we(e,t)==-s?void 0:s),_e=()=>{let e,t,s=!1,n=!1,o=0;const r=fe(),d=fe(),h=fe(),T=fe(),V=fe(),E=fe(),D=fe(),J=fe(),A=fe(),F=fe(),N=fe(),j=fe(),B=fe(),W=Me(),$=fe(),q=fe(),X=fe(),Y=fe(),Z=He(),_=He(),ee=He(),se=He(),le=He(),de=He(),Ve=He(),De=He(),Je=He(),Ae=He(),Fe=He(),Ne=He(),Oe=He(),Pe=He(),Be=fe(),We=He(),[$e,qe,et,tt]=ze((()=>fs)),st=e=>{if(!Ye(e,((e,t)=>b([l,i],t))))return!1;const t=e[l];return!(!K(t)&&t!=a||(me(e[i])!=t&&oe(e,i),0))},nt=(t,s)=>(!e||ie(F,s)||Jt(s))&&Ye(t,((e,t)=>ot(s,t,e)),(()=>Jt(s))),ot=(e,t,s,n)=>Ye(n?s:it(s,e,t),((n,o)=>H(at(e,t,o,n),(e=>(s[o]=e,!0)),(()=>!1))),(()=>Jt(e,t))),at=(t,s,n,o)=>e?H(we(we(F,t),n),(e=>me(o)!=e[l]?Jt(t,s,n,o,e[i]):o),(()=>Jt(t,s,n,o))):G(me(o))?Jt(t,s,n,o):o,rt=(e,t)=>Ye(t?e:ct(e),((t,s)=>H(lt(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>At())),lt=(e,s)=>t?H(we(j,e),(t=>me(s)!=t[l]?At(e,s,t[i]):s),(()=>At(e,s))):G(me(s))?At(e,s):s,it=(e,t,s)=>(H(we(N,t),(([n,o])=>{he(n,((t,s)=>{ne(e,s)||(e[s]=t)})),he(o,(n=>{ne(e,n)||Jt(t,s,n)}))})),e),ct=e=>(t&&(he(B,((t,s)=>{ne(e,s)||(e[s]=t)})),he(W,(t=>{ne(e,t)||At(t)}))),e),dt=e=>Xe(F,e,((e,t,s)=>{const n=fe(),o=Me();Xe(ve(F,t,fe),s,((e,t,s)=>{Te(e,t,s),H(s[i],(e=>Te(n,t,e)),(()=>xe(o,t)))})),Te(N,t,[n,o])}),((e,t)=>{Te(F,t),Te(N,t)})),ut=e=>Xe(j,e,((e,t,s)=>{Te(j,t,s),H(s[i],(e=>Te(B,t,e)),(()=>xe(W,t)))}),((e,t)=>{Te(j,t),Te(B,t),ge(W,t)})),ht=e=>re(e)?as():es(e),gt=e=>Xe(X,e,((e,t,s)=>ft(t,s)),((e,t)=>Ct(t))),ft=(e,t)=>Xe(ve(X,e,(()=>(mt(e,1),Te($,e,Qe()),Te(q,e,fe()),fe()))),t,((t,s,n)=>Lt(e,t,s,n)),((t,s)=>yt(e,t,s))),Lt=(e,t,s,n,o)=>Xe(ve(t,s,(()=>(Et(e,s,1),fe()))),n,((t,n,o)=>wt(e,s,t,n,o)),((n,a)=>bt(e,t,s,n,a,o))),wt=(e,t,s,n,o)=>{ie(s,n)||kt(e,t,n,1);const a=we(s,n);o!==a&&(Mt(e,t,n,a,o),Te(s,n,o))},St=(e,t,s,n,o)=>H(we(t,s),(t=>wt(e,s,t,n,o)),(()=>Lt(e,t,s,it({[n]:o},e,s)))),Tt=e=>re(e)?is():ts(e),vt=e=>Xe(Y,e,((e,t,s)=>Rt(t,s)),((e,t)=>Vt(t))),Rt=(e,t)=>{ie(Y,e)||xt(e,1);const s=we(Y,e);t!==s&&(Dt(e,s,t),Te(Y,e,t))},It=(e,t)=>{const[s]=we($,e),n=s(t);return ie(we(X,e),n)?It(e,t):n},pt=e=>we(X,e)??ft(e,{}),Ct=e=>ft(e,{}),yt=(e,t,s)=>{const[,n]=we($,e);n(s),Lt(e,t,s,{},!0)},bt=(e,t,s,n,o,a)=>{const r=we(we(N,e)?.[0],o);if(!G(r)&&!a)return wt(e,s,n,o,r);const l=t=>{Mt(e,s,t,we(n,t)),kt(e,s,t,-1),Te(n,t)};G(r)?l(o):Se(n,l),ce(n)&&(Et(e,s,-1),ce(Te(t,s))&&(mt(e,-1),Te(X,e),Te($,e),Te(q,e)))},Vt=e=>{const t=we(B,e);if(!G(t))return Rt(e,t);Dt(e,we(Y,e)),xt(e,-1),Te(Y,e)},mt=(e,t)=>Ze(r,e,t),Et=(e,t,s)=>Ze(ve(h,e,fe),t,s),kt=(e,t,s,n)=>{const o=we(q,e),a=we(o,s)??0;(0==a&&1==n||1==a&&-1==n)&&Ze(ve(d,e,fe),s,n),Te(o,s,a!=-n?a+n:null),Ze(ve(ve(T,e,fe),t,fe),s,n)},Mt=(e,t,s,n,o)=>ve(ve(ve(V,e,fe),t,fe),s,(()=>[n,0]))[1]=o,xt=(e,t)=>Ze(E,e,t),Dt=(e,t,s)=>ve(D,e,(()=>[t,0]))[1]=s,Jt=(e,t,s,n,o)=>(z(ve(ve(ve(J,e,fe),t,fe),s,(()=>[])),n),o),At=(e,t,s)=>(z(ve(A,e,(()=>[])),t),s),Ft=(e,t,s)=>H(we(we(we(V,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...Ge(Xt(e,t,s))])),Qt=e=>H(we(D,e),(([e,t])=>[!0,e,t]),(()=>[!1,...Ge(_t(e))])),zt=e=>ce(J)||ce(Ae[e])?0:he(e?be(J):J,((t,s)=>he(t,((t,n)=>he(t,((t,o)=>qe(Ae[e],[s,n,o],t))))))),Nt=e=>ce(A)||ce(Fe[e])?0:he(e?Ce(A):A,((t,s)=>qe(Fe[e],[s],t))),jt=(e,t,s)=>{if(!ce(t))return qe(e,s,(()=>Re(t))),1},Ot=e=>{const t=ce(de[e]),s=ce(De[e])&&ce(se[e])&&ce(le[e])&&t&&ce(_[e]),n=ce(Je[e])&&ce(Ve[e])&&ce(ee[e])&&ce(Z[e]);if(!s||!n){const o=e?[Ce(r),ye(d),ye(h),be(T),be(V)]:[r,d,h,T,V];if(!s){he(o[1],((t,s)=>jt(se[e],t,[s]))),he(o[3],((t,s)=>he(t,((t,n)=>jt(De[e],t,[s,n])))));const s=Me();he(o[2],((n,o)=>{jt(le[e],n,[o])&&!t&&(qe(de[e],[o,null]),xe(s,o))})),t||he(o[4],((t,n)=>{if(!ie(s,n)){const s=Me();he(t,(e=>he(e,(([t,n],o)=>n!==t?xe(s,o):ge(e,o))))),he(s,(t=>qe(de[e],[n,t])))}})),jt(_[e],o[0])}if(!n){let t;he(o[4],((s,n)=>{let o;he(s,((s,a)=>{let r;he(s,(([s,l],i)=>{l!==s&&(qe(Je[e],[n,a,i],l,s,Ft),t=o=r=1)})),r&&qe(Ve[e],[n,a],Ft)})),o&&qe(ee[e],[n],Ft)})),t&&qe(Z[e],void 0,Ft)}}},Pt=e=>{const t=ce(Oe[e]),s=ce(Pe[e])&&ce(Ne[e]);if(!t||!s){const n=e?[Ce(E),Ce(D)]:[E,D];if(t||jt(Oe[e],n[0]),!s){let t;he(n[1],(([s,n],o)=>{n!==s&&(qe(Pe[e],[o],n,s,Qt),t=1)})),t&&qe(Ne[e],void 0,Qt)}}},Bt=(e,...t)=>(us((()=>e(...x(t,y)))),fs),Wt=()=>[Re(V,((e,t)=>-1===we(r,t)?null:Re(e,((e,s)=>-1===we(we(h,t),s)?null:Re(e,(([,e])=>e??null),((e,t)=>Ue(t)))),re)),re),Re(D,(([,e])=>e??null),((e,t)=>Ue(t)))],$t=()=>({cellsTouched:s,valuesTouched:n,changedCells:pe(V,Ke,Ue),invalidCells:pe(J),changedValues:Re(D,Ke,Ue),invalidValues:Re(A),changedTableIds:Re(r),changedRowIds:Ie(h),changedCellIds:pe(T),changedValueIds:Re(E)}),qt=()=>pe(X),Gt=()=>Le(X),Ht=e=>Le(we(X,y(e))),Kt=(e,t,s,n=0,o)=>{return x(Q(k((a=we(X,y(e)),r=(e,s)=>[G(t)?s:we(e,y(t)),s],x([...a?.entries()??[]],(([e,t])=>r(t,e)))),(([e],[t])=>je(e,t)*(s?-1:1))),n,G(o)?o:n+o),(([,e])=>e));var a,r},Ut=(e,t)=>Le(we(we(X,y(e)),y(t))),Xt=(e,t,s)=>we(we(we(X,y(e)),y(t)),y(s)),Yt=()=>Re(Y),Zt=()=>Le(Y),_t=e=>we(Y,y(e)),es=e=>Bt((()=>(e=>Ye(e,nt,Jt))(e)?gt(e):0)),ts=e=>Bt((()=>rt(e)?vt(e):0)),ss=e=>{try{ht(P(e))}catch{}return fs},ns=t=>Bt((()=>{if((e=Ye(t,(e=>Ye(e,st))))&&(dt(t),!ce(X))){const e=qt();as(),es(e)}})),os=e=>Bt((()=>{if(t=(e=>Ye(e,st))(e)){const s=Yt();ds(),is(),t=!0,ut(e),ts(s)}})),as=()=>Bt((()=>gt({}))),rs=e=>Bt((e=>ie(X,e)?Ct(e):0),e),ls=(e,t)=>Bt(((e,t)=>H(we(X,e),(s=>ie(s,t)?yt(e,s,t):0))),e,t),is=()=>Bt((()=>vt({}))),cs=()=>Bt((()=>{dt({}),e=!1})),ds=()=>Bt((()=>{ut({}),t=!1})),us=(e,t)=>{if(-1!=o){hs();const s=e();return gs(t),s}},hs=()=>(-1!=o&&o++,1==o&&qe(Be,void 0,Wt,$t),fs),gs=e=>(o>0&&(o--,0==o&&(s=!ce(V),n=!ce(D),o=1,zt(1),s&&Ot(1),Nt(1),n&&Pt(1),e?.(Wt,$t)&&(he(V,((e,t)=>he(e,((e,s)=>he(e,(([e],n)=>Ee(fs,t,s,n,e))))))),he(D,(([e],t)=>ke(fs,t,e))),s=n=!1),qe(We[0],void 0,Wt,$t),o=-1,zt(0),s&&Ot(0),Nt(0),n&&Pt(0),qe(We[1],void 0,Wt,$t),o=0,s=n=!1,M([r,d,h,T,V,J,E,D,A],ue))),fs),fs={getContent:()=>[qt(),Yt()],getTables:qt,getTableIds:Gt,getTable:e=>Ie(we(X,y(e))),getTableCellIds:e=>Le(we(q,y(e))),getRowIds:Ht,getSortedRowIds:Kt,getRow:(e,t)=>Re(we(we(X,y(e)),y(t))),getCellIds:Ut,getCell:Xt,getValues:Yt,getValueIds:Zt,getValue:_t,hasTables:()=>!ce(X),hasTable:e=>ie(X,y(e)),hasTableCell:(e,t)=>ie(we(q,y(e)),y(t)),hasRow:(e,t)=>ie(we(X,y(e)),y(t)),hasCell:(e,t,s)=>ie(we(we(X,y(e)),y(t)),y(s)),hasValues:()=>!ce(Y),hasValue:e=>ie(Y,y(e)),getTablesJson:()=>O(X),getValuesJson:()=>O(Y),getJson:()=>O([X,Y]),getTablesSchemaJson:()=>O(F),getValuesSchemaJson:()=>O(j),getSchemaJson:()=>O([F,j]),setContent:([e,t])=>Bt((()=>{es(e),ts(t)})),setTables:es,setTable:(e,t)=>Bt((e=>nt(t,e)?ft(e,t):0),e),setRow:(e,t,s)=>Bt(((e,t)=>ot(e,t,s)?Lt(e,pt(e),t,s):0),e,t),addRow:(e,t,s=!0)=>us((()=>{let n;return ot(e,n,t)&&(e=y(e),Lt(e,pt(e),n=It(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>Bt(((e,t)=>{if(ot(e,t,s,1)){const n=pt(e);ae(s,((s,o)=>St(e,n,t,o,s)))}}),e,t),setCell:(e,t,s,n)=>Bt(((e,t,s)=>H(at(e,t,s,U(n)?n(Xt(e,t,s)):n),(n=>St(e,pt(e),t,s,n)))),e,t,s),setValues:ts,setPartialValues:e=>Bt((()=>rt(e,1)?ae(e,((e,t)=>Rt(t,e))):0)),setValue:(e,t)=>Bt((e=>H(lt(e,U(t)?t(_t(e)):t),(t=>Rt(e,t)))),e),setTransactionChanges:e=>Bt((()=>{ae(e[0],((e,t)=>G(e)?rs(t):ae(e,((e,s)=>G(e)?ls(t,s):ae(e,((e,n)=>Ee(fs,t,s,n,e))))))),ae(e[1],((e,t)=>ke(fs,t,e)))})),setTablesJson:ss,setValuesJson:e=>{try{Tt(P(e))}catch{}return fs},setJson:e=>{try{const[t,s]=P(e);ht(t),Tt(s)}catch{ss(e)}return fs},setTablesSchema:ns,setValuesSchema:os,setSchema:(e,t)=>Bt((()=>{ns(e),os(t)})),delTables:as,delTable:rs,delRow:ls,delCell:(e,t,s,n)=>Bt(((e,t,s)=>H(we(X,e),(o=>H(we(o,t),(a=>ie(a,s)?bt(e,o,t,a,s,n):0))))),e,t,s),delValues:is,delValue:e=>Bt((e=>ie(Y,e)?Vt(e):0),e),delTablesSchema:cs,delValuesSchema:ds,delSchema:()=>Bt((()=>{cs(),ds()})),transaction:us,startTransaction:hs,finishTransaction:gs,forEachTable:e=>he(X,((t,s)=>e(s,(e=>he(t,((t,s)=>e(s,(e=>Se(t,e))))))))),forEachTableCell:(e,t)=>Se(we(q,y(e)),t),forEachRow:(e,t)=>he(we(X,y(e)),((e,s)=>t(s,(t=>Se(e,t))))),forEachCell:(e,t,s)=>Se(we(we(X,y(e)),y(t)),s),forEachValue:e=>Se(Y,e),addSortedRowIdsListener:(e,t,s,n,o,a,r)=>{let l=Kt(e,t,s,n,o);return $e((()=>{const r=Kt(e,t,s,n,o);m(r,l)||(l=r,a(fs,e,t,s,n,o,l))}),de[r?1:0],[e,t],[Gt])},addStartTransactionListener:e=>$e(e,Be),addWillFinishTransactionListener:e=>$e(e,We[0]),addDidFinishTransactionListener:e=>$e(e,We[1]),callListener:e=>(tt(e),fs),delListener:e=>(et(e),fs),getListenerStats:()=>({}),createStore:_e};return ae({[f]:[0,Z],[L]:[0,_],[g]:[1,ee,[Gt]],[g+R]:[1,se,[Gt]],[S]:[1,le,[Gt]],[w]:[2,Ve,[Gt,Ht]],[R]:[2,De,[Gt,Ht]],[v]:[3,Je,[Gt,Ht,Ut],e=>Ge(Xt(...e))],InvalidCell:[3,Ae],[p]:[0,Ne],[C]:[0,Oe],[I]:[1,Pe,[Zt],e=>Ge(_t(e[0]))],InvalidValue:[1,Fe]},(([e,t,s,n],o)=>{fs[u+o+c]=(...o)=>$e(o[e],t[o[e+1]?1:0],e>0?Q(o,0,e):void 0,s,n)})),te(fs)};e.createCheckpoints=Ne,e.createCustomPersister=(e,t,s,n,o)=>{let a,r,l=0,i=!1;const c=async e=>{2!=l&&(l=1,await e(),l=0)},d={load:async(s={},n={})=>(await c((async()=>{let o;try{o=await t()}catch{}e.setContent(o??[s,n])})),d),startAutoLoad:async(s={},o={})=>(d.stopAutoLoad(),await d.load(s,o),i=!0,r=n((async(s,n)=>{await c((async()=>{if(n)e.setTransactionChanges(n());else try{e.setContent(s?.()??await t())}catch{}}))})),d),stopAutoLoad:()=>(i&&(o(r),r=void 0,i=!1),d),save:async t=>(1!=l&&(l=2,await s(e.getContent,t),l=0),d),startAutoSave:async()=>(await d.stopAutoSave().save(),a=e.addDidFinishTransactionListener(((e,t)=>d.save(t))),d),stopAutoSave:()=>(H(a,e.delListener),d),getStore:()=>e,destroy:()=>d.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return te(d)},e.createIndexes=Oe,e.createMetrics=We,e.createQueries=$e,e.createRelationships=qe,e.createStore=_e,e.defaultSorter=je},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={});
