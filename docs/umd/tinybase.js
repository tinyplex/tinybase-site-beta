var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",n=t(s),o=t(!0),r=t(0),a=t(t),i="default",l="Listener",d="Result",c="add",u="Table",f="RowIds",h="Cell",g="CellIds",L=e=>s+e,w=(e,t)=>e.includes(t),R=(e,t)=>e.every(t),S=(e,t)=>b(e)===b(t)&&R(e,((e,s)=>t[s]===e)),p=(e,t)=>R(e,((s,n)=>0==n||t(e[n-1],s)<=0)),v=(e,t)=>e.sort(t),I=(e,t)=>e.forEach(t),T=(e,t)=>e.map(t),y=e=>V(e,((e,t)=>e+t),0),b=e=>e.length,C=e=>0==b(e),V=(e,t,s)=>e.reduce(t,s),m=(e,t,s)=>e.slice(t,s),k=(e,...t)=>e.push(...t),E=e=>e.pop(),M=e=>e.shift(),J=e=>JSON.stringify(e,((e,t)=>Q(t,Map)?V([...t],((e,[t,s])=>(e[t]=s,e)),{}):t)),x=JSON.parse,D=Math.max,A=Math.min,F=isFinite,Q=(e,t)=>e instanceof t,z=e=>null==e,N=(e,t,s)=>z(e)?s?.():t(e),j=e=>e==n||e==o,O=e=>t(e)==a,P=e=>Array.isArray(e),W=()=>{},B=e=>e.size,$=(e,t)=>e?.has(t)??!1,q=e=>z(e)||0==B(e),G=e=>[...e?.values()??[]],H=e=>e.clear(),K=(e,t)=>e?.forEach(t),U=(e,t)=>e?.delete(t),X=e=>new Map(e),Y=e=>[...e?.keys()??[]],Z=(e,t)=>e?.get(t),_=(e,t)=>K(e,((e,s)=>t(s,e))),ee=(e,t,s)=>z(s)?(U(e,t),e):e?.set(t,s),te=(e,t,s)=>($(e,t)||ee(e,t,s()),Z(e,t)),se=(e,t,s)=>{const n={},o=t??(e=>e);return K(e,((e,t)=>N(o(e),(e=>s?.(e)?0:n[t]=e)))),n},ne=(e,t)=>{const s=X(),n=t??(e=>e);return K(e,((e,t)=>s.set(t,n(e)))),s},oe=e=>ne(e,ne),re=(e,t,s,n,o=0)=>N((s?te:Z)(e,t[o],o>b(t)-2?s:X),(r=>{if(o>b(t)-2)return n?.(r)&&ee(e,t[o]),r;const a=re(r,t,s,n,o+1);return q(r)&&ee(e,t[o]),a})),ae=e=>{const s=t(e);return j(s)||s==r&&F(e)?s:void 0},ie=(e,t,s,n,o)=>z(o)?e.delCell(t,s,n,!0):e.setCell(t,s,n,o),le=(e,t,s)=>z(s)?e.delValue(t):e.setValue(t,s),de=e=>new Set(P(e)||z(e)?e:[e]),ce=(e,t)=>e?.add(t),ue=(e,t,s)=>{const n=e.hasRow,o=X(),r=X(),a=X(),i=X(),l=X(),d=(t,s,...n)=>{const o=te(l,t,de);return I(n,(t=>ce(o,t)&&s&&e.callListener(t))),n},c=(t,...s)=>N(Z(l,t),(n=>{I(C(s)?G(n):s,(t=>{e.delListener(t),U(n,t)})),q(n)&&ee(l,t)})),u=(e,s)=>{ee(o,e,s),$(r,e)||(ee(r,e,t()),ee(a,e,X()),ee(i,e,X()))},f=e=>{ee(o,e),ee(r,e),ee(a,e),ee(i,e),c(e)};return[()=>e,()=>Y(o),e=>_(r,e),e=>$(r,e),e=>Z(o,e),e=>Z(r,e),(e,t)=>ee(r,e,t),u,(t,o,r,l,f)=>{u(t,o);const h=X(),g=X(),L=Z(a,t),w=Z(i,t),R=t=>{const r=s=>e.getCell(o,t,s),a=Z(L,t),i=n(o,t)?s(l(r,t)):void 0;if(a===i||P(a)&&P(i)&&S(a,i)||ee(h,t,[a,i]),!z(f)){const e=Z(w,t),s=n(o,t)?f(r,t):void 0;e!=s&&ee(g,t,s)}},p=e=>{r((()=>{K(h,(([,e],t)=>ee(L,t,e))),K(g,((e,t)=>ee(w,t,e)))}),h,g,L,w,e),H(h),H(g)};_(L,R),e.hasTable(o)&&I(e.getRowIds(o),(e=>{$(L,e)||R(e)})),p(!0),c(t),d(t,0,e.addRowListener(o,null,((e,t,s)=>R(s))),e.addTableListener(o,(()=>p())))},f,()=>_(l,f),d,c]},fe=(e,o)=>t(e)==n?t=>t(e):e??(()=>o??s),he=e=>{const t=new WeakMap;return s=>(t.has(s)||t.set(s,e(s)),t.get(s))},ge=/^\d+$/,Le=()=>{const e=[];let t=0;return[n=>(n?M(e):null)??s+t++,t=>{ge.test(t)&&b(e)<1e3&&k(e,t)}]},we=e=>{let t;const[n,o]=Le(),r=X();return[(o,a,i,l=[],d=(()=>[]))=>{t??=e();const c=n(1);return ee(r,c,[o,a,i,l,d]),ce(re(a,i??[s],de),c),c},(e,n,...o)=>I(((e,t=[s])=>{const n=[],o=(e,s)=>s==b(t)?k(n,e):null===t[s]?K(e,(e=>o(e,s+1))):I([t[s],null],(t=>o(Z(e,t),s+1)));return o(e,0),n})(e,n),(e=>K(e,(e=>Z(r,e)[0](t,...n??[],...o))))),e=>N(Z(r,e),(([,t,n])=>(re(t,n??[s],void 0,(t=>(U(t,e),q(t)?1:0))),ee(r,e),o(e),n))),e=>N(Z(r,e),(([e,,s=[],n,o])=>{const r=(...a)=>{const i=b(a);i==b(s)?e(t,...a,...o(a)):z(s[i])?I(n[i]?.(...a)??[],(e=>r(...a,e))):r(...a,s[i])};r()}))]},Re=Object,Se=Re.keys,pe=Re.isFrozen,ve=Re.freeze,Ie=e=>Q(e,Re)&&e.constructor==Re,Te=(e,t)=>!z(((e,t)=>N(e,(e=>e[t])))(e,t)),ye=(e,t)=>delete e[t],be=(e,t)=>T(Re.entries(e),(([e,s])=>t(s,e))),Ce=e=>Ie(e)&&C(Se(e)),Ve=he((e=>{let t,n,o,r=100,a=X(),i=X(),l=1;const d=X(),c=X(),[u,f,h]=we((()=>W)),g=X(),L=X(),R=[],S=[],p=(t,s)=>{l=0,e.transaction((()=>{const[n,o]=Z(g,s);K(n,((s,n)=>K(s,((s,o)=>K(s,((s,r)=>ie(e,n,o,r,s[t]))))))),K(o,((s,n)=>le(e,n,s[t])))})),l=1},v=e=>{ee(g,e),ee(L,e),f(c,[e])},T=(e,t)=>I(((e,t)=>e.splice(0,t))(e,t??b(e)),v),y=()=>T(R,b(R)-r),V=()=>N(t,(()=>{k(R,t),y(),T(S),t=void 0,o=1})),m=()=>{t=E(R),o=1},J=e.addCellListener(null,null,null,((e,t,s,n,o,r)=>{if(l){V();const e=te(a,t,X),i=te(e,s,X),l=te(i,n,(()=>[r,void 0]));l[1]=o,l[0]===o&&q(ee(i,n))&&q(ee(e,s))&&q(ee(a,t))&&m(),Q()}})),x=e.addValueListener(null,((e,t,s,n)=>{if(l){V();const e=te(i,t,(()=>[n,void 0]));e[1]=s,e[0]===s&&q(ee(i,t))&&m(),Q()}})),D=(e="")=>(z(t)&&(t=s+n++,ee(g,t,[a,i]),O(t,e),a=X(),i=X(),o=1),t),A=()=>{C(R)||(((e,...t)=>{e.unshift(...t)})(S,D()),p(0,t),t=E(R),o=1)},F=()=>{C(S)||(k(R,t),t=M(S),p(1,t),o=1)},Q=()=>{o&&(f(d),o=0)},j=e=>{const t=D(e);return Q(),t},O=(e,t)=>(P(e)&&Z(L,e)!==t&&(ee(L,e,t),f(c,[e])),W),P=e=>$(g,e),W={setSize:e=>(r=e,y(),W),addCheckpoint:j,setCheckpoint:O,getStore:()=>e,getCheckpointIds:()=>[[...R],t,[...S]],forEachCheckpoint:e=>_(L,e),hasCheckpoint:P,getCheckpoint:e=>Z(L,e),goBackward:()=>(A(),Q(),W),goForward:()=>(F(),Q(),W),goTo:e=>{const s=w(R,e)?A:w(S,e)?F:null;for(;!z(s)&&e!=t;)s();return Q(),W},addCheckpointIdsListener:e=>u(e,d),addCheckpointListener:(e,t)=>u(t,c,[e]),delListener:e=>(h(e),W),clear:()=>(T(R),T(S),z(t)||v(t),t=void 0,n=0,j(),W),destroy:()=>{e.delListener(J),e.delListener(x)},getListenerStats:()=>({})};return ve(W.clear())})),me=(e,t)=>e<t?-1:1,ke=he((e=>{const t=X(),n=X(),[o,r,a,i,l,d,c,,u,f,h]=ue(e,X,(e=>z(e)?s:P(e)?T(e,L):L(e))),[g,w,R]=we((()=>I)),S=(t,s,n)=>{const o=l(t);K(n,((t,n)=>s(n,(s=>K(t,(t=>s(t,(s=>e.forEachCell(o,t,s)))))))))},I={setIndexDefinition:(e,s,o,r,a,i=me)=>{const l=z(a)?void 0:([e],[t])=>a(e,t);return u(e,s,((s,o,a,u,f,h)=>{let g=0;const L=de(),R=de(),S=d(e);if(K(o,(([e,t],s)=>{const n=de(e),o=de(t);K(n,(e=>U(o,e)?U(n,e):0)),K(n,(e=>{ce(L,e),N(Z(S,e),(t=>{U(t,s),q(t)&&(ee(S,e),g=1)}))})),K(o,(e=>{ce(L,e),$(S,e)||(ee(S,e,de()),g=1),ce(Z(S,e),s),z(r)||ce(R,e)}))})),s(),q(f)||(h?_(S,(e=>ce(R,e))):_(a,(e=>N(Z(u,e),(e=>ce(R,e))))),K(R,(e=>{const t=(t,s)=>i(Z(f,t),Z(f,s),e),s=[...Z(S,e)];p(s,t)||(ee(S,e,de(v(s,t))),ce(L,e))}))),(g||h)&&!z(l)){const t=[...S];p(t,l)||(c(e,X(v(t,l))),g=1)}g&&w(t,[e]),K(L,(t=>w(n,[e,t])))}),fe(o),N(r,fe)),I},delIndexDefinition:e=>(f(e),I),getStore:o,getIndexIds:r,forEachIndex:e=>a(((t,s)=>e(t,(e=>S(t,e,s))))),forEachSlice:(e,t)=>S(e,t,d(e)),hasIndex:i,hasSlice:(e,t)=>$(d(e),t),getTableId:l,getSliceIds:e=>Y(d(e)),getSliceRowIds:(e,t)=>G(Z(d(e),t)),addSliceIdsListener:(e,s)=>g(s,t,[e]),addSliceRowIdsListener:(e,t,s)=>g(s,n,[e,t]),delListener:e=>(R(e),I),destroy:h,getListenerStats:()=>({})};return ve(I)})),Ee=X([["avg",[(e,t)=>y(e)/t,(e,t,s)=>e+(t-e)/(s+1),(e,t,s)=>e+(e-t)/(s-1),(e,t,s,n)=>e+(t-s)/n]],["max",[e=>D(...e),(e,t)=>D(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:D(t,e)]],["min",[e=>A(...e),(e,t)=>A(t,e),(e,t)=>t==e?void 0:e,(e,t,s)=>s==e?void 0:A(t,e)]],["sum",[e=>y(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,s)=>e-s+t]]]),Me=(e,t,s,n,o,r=!1)=>{if(q(s))return;const[a,i,l,d]=o;return r||=z(e),K(n,(([s,n])=>{r||(e=z(s)?i?.(e,n,t++):z(n)?l?.(e,s,t--):d?.(e,n,s,t),r||=z(e))})),r?a(G(s),B(s)):e},Je=he((e=>{const t=X(),[n,o,r,a,i,l,d,,c,u,f]=ue(e,W,(e=>isNaN(e)||z(e)||!0===e||!1===e||e===s?void 0:1*e)),[h,g,L]=we((()=>w)),w={setMetricDefinition:(e,s,n,o,r,a,i)=>{const u=O(n)?[n,r,a,i]:Z(Ee,n)??Z(Ee,"sum");return c(e,s,((s,n,o,r,a,i)=>{const c=l(e),f=B(r);i||=z(c),s();let h=Me(c,f,r,n,u,i);F(h)||(h=void 0),h!=c&&(d(e,h),g(t,[e],h,c))}),fe(o,1)),w},delMetricDefinition:e=>(u(e),w),getStore:n,getMetricIds:o,forEachMetric:r,hasMetric:a,getTableId:i,getMetric:l,addMetricListener:(e,s)=>h(s,t,[e]),delListener:e=>(L(e),w),destroy:f,getListenerStats:()=>({})};return ve(w)})),xe=he((e=>{const t=e.createStore,[n,o,r,a,i,,,L,,w,S,p,v]=ue(e,(()=>!0),W),T=t(),y=t(),V=X(),E=(e,t,...s)=>I(s,(s=>ce(te(te(V,t,X),e,de),s))),M=e=>{N(Z(V,e),(e=>{_(e,((e,t)=>K(t,(t=>e.delListener(t))))),H(e)})),I([y,T],(t=>t.delTable(e)))},J=(e,t,s)=>E(t,e,t.addWillFinishTransactionListener(s.startTransaction),t.addDidFinishTransactionListener((()=>s.finishTransaction()))),x={setQueryDefinition:(t,n,o)=>{L(t,n),M(t);const r=[],a=[[null,[n,null,null,[],X()]]],i=[],l=[],d=[];o({select:(e,t)=>{const n=O(e)?[b(r)+s,e]:[z(t)?e:t,s=>s(e,t)];return k(r,n),{as:e=>n[0]=e}},join:(e,t,s)=>{const n=z(s)||O(t)?null:t,o=z(n)?t:s,r=[e,[e,n,O(o)?o:e=>e(o),[],X()]];return k(a,r),{as:e=>r[0]=e}},where:(e,t,s)=>k(i,O(e)?e:z(s)?s=>s(e)===t:n=>n(e,t)===s),group:(e,t,s,n,o)=>{const r=[e,[e,O(t)?[t,s,n,o]:Z(Ee,t)??[(e,t)=>t]]];return k(l,r),{as:e=>r[0]=e}},having:(e,t)=>k(d,O(e)?e:s=>s(e)===t)});const c=X(r);if(q(c))return x;const u=X(a);_(u,((e,[,t])=>N(Z(u,t),(({3:t})=>z(e)?0:k(t,e)))));const f=X(l);let h=T;if(q(f)&&C(d))h=y;else{J(t,h,y);const e=X();_(f,((t,[s,n])=>ce(te(e,s,de),[t,n])));const s=de();_(c,(t=>$(e,t)?0:ce(s,t)));const n=X(),o=(s,n,o,r)=>N(s,(([a,i,l,c])=>{_(n,((t,[s])=>{const n=te(a,t,X),i=Z(n,o),l=r?void 0:s;if(i!==l){const s=de([[i,l]]),r=B(n);ee(n,o,l),K(Z(e,t),(([e,t])=>{const o=Me(c[e],r,n,s,t);c[e]=z(ae(o))?null:o}))}})),q(i)||!R(d,(e=>e((e=>c[e]))))?y.delRow(t,l):z(l)?s[2]=y.addRow(t,c):y.setRow(t,l,c)}));E(h,t,h.addRowListener(t,null,((r,a,i,l)=>{const d=[],c=[],u=X(),f=h.hasRow(t,i);let g=!f;K(s,(e=>{const[s,n,o]=l(t,i,e);k(d,n),k(c,o),g||=s})),_(e,(e=>{const[s,,n]=l(t,i,e);(g||s)&&ee(u,e,[n])})),g&&o(re(n,d,void 0,(([,e])=>(U(e,i),q(e)))),u,i,1),f&&o(re(n,c,(()=>{const e={};return K(s,(s=>e[s]=h.getCell(t,i,s))),[X(),de(),void 0,e]}),(([,e])=>{ce(e,i)})),u,i)})))}J(t,e,h);const g=(s,o,r,a)=>{const l=t=>e.getCell(o,r,t);I(a,(n=>{const[o,,r,a,i]=Z(u,n),d=r?.(l,s),[c,f]=Z(i,s)??[];d!=c&&(z(f)||v(t,f),ee(i,s,z(d)?null:[d,...p(t,1,e.addRowListener(o,d,(()=>g(s,o,d,a))))]))})),(s=>{const o=(t,o)=>e.getCell(...z(o)?[n,s,t]:t===n?[n,s,o]:[Z(u,t)?.[0],Z(Z(u,t)?.[4],s)?.[0],o]);h.transaction((()=>R(i,(e=>e(o)))?_(c,((e,n)=>ie(h,t,s,e,n(o,s)))):h.delRow(t,s)))})(s)},{3:w}=Z(u,null);return h.transaction((()=>p(t,1,e.addRowListener(n,null,((s,o,r)=>{e.hasRow(n,r)?g(r,n,r,w):(h.delRow(t,r),K(u,(({4:e})=>N(Z(e,r),(([,s])=>{v(t,s),ee(e,r)})))))}))))),x},delQueryDefinition:e=>(M(e),w(e),x),getStore:n,getQueryIds:o,forEachQuery:r,hasQuery:a,getTableId:i,delListener:e=>(y.delListener(e),x),destroy:S,getListenerStats:()=>{const{tables:e,tableIds:t,transaction:s,...n}=y.getListenerStats();return n}};return be({[u]:[1,1],[f]:[0,1],SortedRowIds:[0,5],Row:[1,2],[g]:[0,2],[h]:[1,3]},(([e,t],s)=>{I(e?["get","has","forEach"]:["get"],(e=>x[e+d+s]=(...t)=>y[e+s](...t))),x[c+d+s+l]=(...e)=>y[c+s+l](...m(e,0,t),((s,...n)=>e[t](x,...n)))})),ve(x)})),De=he((e=>{const t=X(),n=X(),o=X(),r=X(),[a,i,l,d,c,u,,,f,h,g]=ue(e,(()=>[X(),X(),X(),X()]),(e=>z(e)?void 0:e+s)),[L,w,R]=we((()=>I)),S=(e,t,s)=>N(u(e),(([n,,o])=>{if(!$(o,t)){const r=de();if(c(e)!=v(e))ce(r,t);else{let e=t;for(;!z(e)&&!$(r,e);)ce(r,e),e=Z(n,e)}if(s)return r;ee(o,t,r)}return Z(o,t)})),p=(e,t)=>N(u(e),(([,,e])=>ee(e,t))),v=e=>Z(t,e),I={setRelationshipDefinition:(e,s,a,i)=>(ee(t,e,a),f(e,s,((t,s)=>{const a=de(),i=de(),l=de(),[d,c]=u(e);K(s,(([t,s],n)=>{z(t)||(ce(i,t),N(Z(c,t),(e=>{U(e,n),q(e)&&ee(c,t)}))),z(s)||(ce(i,s),$(c,s)||ee(c,s,de()),ce(Z(c,s),n)),ce(a,n),ee(d,n,s),_(Z(r,e),(t=>{$(S(e,t),n)&&ce(l,t)}))})),t(),K(a,(t=>w(n,[e,t]))),K(i,(t=>w(o,[e,t]))),K(l,(t=>{p(e,t),w(r,[e,t])}))}),fe(i)),I),delRelationshipDefinition:e=>(ee(t,e),h(e),I),getStore:a,getRelationshipIds:i,forEachRelationship:t=>l((s=>t(s,(t=>e.forEachRow(c(s),t))))),hasRelationship:d,getLocalTableId:c,getRemoteTableId:v,getRemoteRowId:(e,t)=>Z(u(e)?.[0],t),getLocalRowIds:(e,t)=>G(Z(u(e)?.[1],t)),getLinkedRowIds:(e,t)=>z(u(e))?[t]:G(S(e,t,!0)),addRemoteRowIdListener:(e,t,s)=>L(s,n,[e,t]),addLocalRowIdsListener:(e,t,s)=>L(s,o,[e,t]),addLinkedRowIdsListener:(e,t,s)=>(S(e,t),L(s,r,[e,t])),delListener:e=>(p(...R(e)),I),destroy:g,getListenerStats:()=>({})};return ve(I)})),Ae=e=>[e,e],Fe=()=>[X(),X()],Qe=(e,t,s,n=ee)=>{const o=(r=e=>!Te(t,e),Y(e).filter(r));var r;return I(Se(t),(n=>s(e,n,t[n]))),I(o,(t=>n(e,t))),e},ze=(e,t,s)=>z(e)||!Ie(e)||Ce(e)||pe(e)?(s?.(),!1):(be(e,((s,n)=>{t(s,n)||ye(e,n)})),!Ce(e)),Ne=(e,t,s)=>ee(e,t,Z(e,t)==-s?void 0:s),je=()=>{let e,t,s,n,o=0;const a=X(),d=X(),R=X(),p=X(),y=X(),b=X(),C=X(),V=X(),E=X(),M=X(),D=X(),A=X(),F=de(),Q=X(),P=X(),W=X(),B=Fe(),G=Fe(),re=Fe(),ue=Fe(),fe=Fe(),he=Fe(),ge=Fe(),Re=Fe(),Se=Fe(),pe=Fe(),Ie=Fe(),Ve=Fe(),ke=Fe(),Ee=Fe(),[Me,Je,xe,De]=we((()=>Kt)),Oe=e=>{if(!ze(e,((e,t)=>w(["type",i],t))))return!1;const t=e.type;return!(!j(t)&&t!=r||(ae(e.default)!=t&&ye(e,i),0))},Pe=(t,s)=>(!e||$(E,s)||Rt(s))&&ze(t,((e,t)=>We(s,t,e)),(()=>Rt(s))),We=(e,t,s,n)=>ze(n?s:Ge(s,e,t),((n,o)=>N(Be(e,t,o,n),(e=>(s[o]=e,!0)),(()=>!1))),(()=>Rt(e,t))),Be=(t,s,n,o)=>e?N(Z(Z(E,t),n),(e=>ae(o)!=e.type?Rt(t,s,n,o,e.default):o),(()=>Rt(t,s,n,o))):z(ae(o))?Rt(t,s,n,o):o,$e=(e,t)=>ze(t?e:He(e),((t,s)=>N(qe(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>St())),qe=(e,s)=>t?N(Z(D,e),(t=>ae(s)!=t.type?St(e,s,t.default):s),(()=>St(e,s))):z(ae(s))?St(e,s):s,Ge=(e,t,s)=>(N(Z(M,t),(([n,o])=>{K(n,((t,s)=>{Te(e,s)||(e[s]=t)})),K(o,(n=>{Te(e,n)||Rt(t,s,n)}))})),e),He=e=>(t&&(K(A,((t,s)=>{Te(e,s)||(e[s]=t)})),K(F,(t=>{Te(e,t)||St(t)}))),e),Ke=e=>Qe(E,e,((e,t,s)=>{const n=X(),o=de();Qe(te(E,t,X),s,((e,t,s)=>{ee(e,t,s),N(s.default,(e=>ee(n,t,e)),(()=>ce(o,t)))})),ee(M,t,[n,o])}),((e,t)=>{ee(E,t),ee(M,t)})),Ue=e=>Qe(D,e,((e,t,s)=>{ee(D,t,s),N(s.default,(e=>ee(A,t,e)),(()=>ce(F,t)))}),((e,t)=>{ee(D,t),ee(A,t),U(F,t)})),Xe=e=>Ce(e)?Pt():Qt(e),Ye=e=>Qe(P,e,((e,t,s)=>Ze(t,s)),((e,t)=>it(t))),Ze=(e,t)=>Qe(te(P,e,(()=>(ut(e,1),X()))),t,((t,s,n)=>_e(e,t,s,n)),((t,s)=>lt(e,t,s))),_e=(e,t,s,n,o)=>Qe(te(t,s,(()=>(ft(e,s,1),X()))),n,((t,n,o)=>et(e,s,t,n,o)),((n,r)=>dt(e,t,s,n,r,o))),et=(e,t,s,n,o)=>{$(s,n)||ht(e,t,n,1);const r=Z(s,n);o!==r&&(gt(e,t,n,r,o),ee(s,n,o))},tt=(e,t,s,n,o)=>N(Z(t,s),(t=>et(e,s,t,n,o)),(()=>_e(e,t,s,Ge({[n]:o},e,s)))),st=e=>Ce(e)?Wt():zt(e),nt=e=>Qe(W,e,((e,t,s)=>ot(t,s)),((e,t)=>ct(t))),ot=(e,t)=>{$(W,e)||Lt(e,1);const s=Z(W,e);t!==s&&(wt(e,s,t),ee(W,e,t))},rt=(e,t)=>{const[s]=te(Q,e,Le),n=s(t);return $(Z(P,e),n)?rt(e,t):n},at=e=>Z(P,e)??Ze(e,{}),it=e=>Ze(e,{}),lt=(e,t,s)=>{const[,n]=te(Q,e,Le);n(s),_e(e,t,s,{},!0)},dt=(e,t,s,n,o,r)=>{const a=Z(Z(M,e)?.[0],o);if(!z(a)&&!r)return et(e,s,n,o,a);const i=t=>{gt(e,s,t,Z(n,t)),ht(e,s,t,-1),ee(n,t)};z(a)?i(o):_(n,i),q(n)&&(ft(e,s,-1),q(ee(t,s))&&(ut(e,-1),ee(P,e),ee(Q,e)))},ct=e=>{const t=Z(A,e);if(!z(t))return ot(e,t);wt(e,Z(W,e)),Lt(e,-1),ee(W,e)},ut=(e,t)=>Ne(a,e,t),ft=(e,t,s)=>Ne(te(d,e,X),t,s),ht=(e,t,s,n)=>Ne(te(te(R,e,X),t,X),s,n),gt=(e,t,s,n,o)=>te(te(te(p,e,X),t,X),s,(()=>[n,0]))[1]=o,Lt=(e,t)=>Ne(y,e,t),wt=(e,t,s)=>te(b,e,(()=>[t,0]))[1]=s,Rt=(e,t,s,n,o)=>(k(te(te(te(C,e,X),t,X),s,(()=>[])),n),o),St=(e,t,s)=>(k(te(V,e,(()=>[])),t),s),pt=(e,t,s)=>N(Z(Z(Z(p,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...Ae(xt(e,t,s))])),vt=e=>N(Z(b,e),(([e,t])=>[!0,e,t]),(()=>[!1,...Ae(Ft(e))])),It=e=>q(C)||q(Se[e])?0:K(e?ne(C,oe):C,((t,s)=>K(t,((t,n)=>K(t,((t,o)=>Je(Se[e],[s,n,o],t))))))),Tt=e=>q(V)||q(pe[e])?0:K(e?ne(V):V,((t,s)=>Je(pe[e],[s],t))),yt=(e,t,s)=>{if(!q(t))return Je(e,s),1},bt=e=>{const t=q(fe[e]),s=q(ge[e])&&q(ue[e])&&t&&q(G[e]),n=q(Re[e])&&q(he[e])&&q(re[e])&&q(B[e]);if(!s||!n){const o=e?[ne(a),oe(d),ne(R,oe),ne(p,oe)]:[a,d,R,p];if(!s){K(o[2],((t,s)=>K(t,((t,n)=>yt(ge[e],t,[s,n])))));const s=de();K(o[1],((n,o)=>{yt(ue[e],n,[o])&&!t&&(Je(fe[e],[o,null]),ce(s,o))})),t||K(o[3],((t,n)=>{if(!$(s,n)){const s=de();K(t,(e=>K(e,(([t,n],o)=>n!==t?ce(s,o):U(e,o))))),K(s,(t=>Je(fe[e],[n,t])))}})),yt(G[e],o[0])}if(!n){let t;K(o[3],((s,n)=>{let o;K(s,((s,r)=>{let a;K(s,(([s,i],l)=>{i!==s&&(Je(Re[e],[n,r,l],i,s,pt),t=o=a=1)})),a&&Je(he[e],[n,r],pt)})),o&&Je(re[e],[n],pt)})),t&&Je(B[e],void 0,pt)}}},Ct=e=>{const t=q(Ve[e]),s=q(ke[e])&&q(Ie[e]);if(!t||!s){const n=e?[ne(y),ne(b)]:[y,b];if(t||yt(Ve[e],n[0]),!s){let t;K(n[1],(([s,n],o)=>{n!==s&&(Je(ke[e],[o],n,s,vt),t=1)})),t&&Je(Ie[e],void 0,vt)}}},Vt=(e,...t)=>(qt((()=>e(...T(t,L)))),Kt),mt=()=>se(P,(e=>se(e,se))),kt=()=>Y(P),Et=e=>Y(Z(P,L(e))),Mt=(e,t,s,n=0,o)=>{return T(m(v((r=Z(P,L(e)),a=(e,s)=>[z(t)?s:Z(e,L(t)),s],T([...r?.entries()??[]],(([e,t])=>a(t,e)))),(([e],[t])=>me(e,t)*(s?-1:1))),n,z(o)?o:n+o),(([,e])=>e));var r,a},Jt=(e,t)=>Y(Z(Z(P,L(e)),L(t))),xt=(e,t,s)=>Z(Z(Z(P,L(e)),L(t)),L(s)),Dt=()=>se(W),At=()=>Y(W),Ft=e=>Z(W,L(e)),Qt=e=>Vt((()=>(e=>ze(e,Pe,Rt))(e)?Ye(e):0)),zt=e=>Vt((()=>$e(e)?nt(e):0)),Nt=e=>{try{Xe(x(e))}catch{}return Kt},jt=t=>Vt((()=>{if((e=ze(t,(e=>ze(e,Oe))))&&(Ke(t),!q(P))){const e=mt();Pt(),Qt(e)}})),Ot=e=>Vt((()=>{if(t=(e=>ze(e,Oe))(e)){const s=Dt();$t(),Wt(),t=!0,Ue(e),zt(s)}})),Pt=()=>Vt((()=>Ye({}))),Wt=()=>Vt((()=>nt({}))),Bt=()=>Vt((()=>{Ke({}),e=!1})),$t=()=>Vt((()=>{Ue({}),t=!1})),qt=(e,t)=>{if(-1==o)return;Gt();const s=e();return Ht(t),s},Gt=()=>(o++,Kt),Ht=e=>{if(o>0&&(o--,0==o)){s=!q(p),n=!q(b),o=1,It(1),s&&bt(1),Tt(1),n&&Ct(1),o=-1;let t=!e&&q(Ee[0])&&q(Ee[1])?[{},{},{},{}]:[se(p,(e=>se(e,(e=>se(e,(e=>[...e]),(([e,t])=>e===t))),Ce)),Ce),se(C,(e=>se(e,se))),se(b,(e=>[...e]),(([e,t])=>e===t)),se(V)];e?.(...t)&&(o=1,K(p,((e,t)=>K(e,((e,s)=>K(e,(([e],n)=>ie(Kt,t,s,n,e))))))),K(b,(([e],t)=>le(Kt,t,e))),o=-1,s=n=!1,t=[{},{},{},{}]),Je(Ee[0],void 0,s,n,...t),It(0),s&&bt(0),Tt(0),n&&Ct(0),Je(Ee[1],void 0,s,n,...t),o=0,I([a,d,R,p,C,y,b,V],H)}return Kt},Kt={getContent:()=>[mt(),Dt()],getTables:mt,getTableIds:kt,getTable:e=>se(Z(P,L(e)),se),getRowIds:Et,getSortedRowIds:Mt,getRow:(e,t)=>se(Z(Z(P,L(e)),L(t))),getCellIds:Jt,getCell:xt,getValues:Dt,getValueIds:At,getValue:Ft,hasTables:()=>!q(P),hasTable:e=>$(P,L(e)),hasRow:(e,t)=>$(Z(P,L(e)),L(t)),hasCell:(e,t,s)=>$(Z(Z(P,L(e)),L(t)),L(s)),hasValues:()=>!q(W),hasValue:e=>$(W,L(e)),getTablesJson:()=>J(P),getValuesJson:()=>J(W),getJson:()=>J([P,W]),getTablesSchemaJson:()=>J(E),getValuesSchemaJson:()=>J(D),getSchemaJson:()=>J([E,D]),setContent:([e,t])=>Vt((()=>{Qt(e),zt(t)})),setTables:Qt,setTable:(e,t)=>Vt((e=>Pe(t,e)?Ze(e,t):0),e),setRow:(e,t,s)=>Vt(((e,t)=>We(e,t,s)?_e(e,at(e),t,s):0),e,t),addRow:(e,t,s=!0)=>qt((()=>{let n;return We(e,n,t)&&(e=L(e),_e(e,at(e),n=rt(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>Vt(((e,t)=>{if(We(e,t,s,1)){const n=at(e);be(s,((s,o)=>tt(e,n,t,o,s)))}}),e,t),setCell:(e,t,s,n)=>Vt(((e,t,s)=>N(Be(e,t,s,O(n)?n(xt(e,t,s)):n),(n=>tt(e,at(e),t,s,n)))),e,t,s),setValues:zt,setPartialValues:e=>Vt((()=>$e(e,1)?be(e,((e,t)=>ot(t,e))):0)),setValue:(e,t)=>Vt((e=>N(qe(e,O(t)?t(Ft(e)):t),(t=>ot(e,t)))),e),setTablesJson:Nt,setValuesJson:e=>{try{st(x(e))}catch{}return Kt},setJson:e=>{try{const[t,s]=x(e);Xe(t),st(s)}catch{Nt(e)}return Kt},setTablesSchema:jt,setValuesSchema:Ot,setSchema:(e,t)=>Vt((()=>{jt(e),Ot(t)})),delTables:Pt,delTable:e=>Vt((e=>$(P,e)?it(e):0),e),delRow:(e,t)=>Vt(((e,t)=>N(Z(P,e),(s=>$(s,t)?lt(e,s,t):0))),e,t),delCell:(e,t,s,n)=>Vt(((e,t,s)=>N(Z(P,e),(o=>N(Z(o,t),(r=>$(r,s)?dt(e,o,t,r,s,n):0))))),e,t,s),delValues:Wt,delValue:e=>Vt((e=>$(W,e)?ct(e):0),e),delTablesSchema:Bt,delValuesSchema:$t,delSchema:()=>Vt((()=>{Bt(),$t()})),transaction:qt,startTransaction:Gt,finishTransaction:Ht,forEachTable:e=>K(P,((t,s)=>e(s,(e=>K(t,((t,s)=>e(s,(e=>_(t,e))))))))),forEachRow:(e,t)=>K(Z(P,L(e)),((e,s)=>t(s,(t=>_(e,t))))),forEachCell:(e,t,s)=>_(Z(Z(P,L(e)),L(t)),s),forEachValue:e=>_(W,e),addSortedRowIdsListener:(e,t,s,n,o,r,a)=>{let i=Mt(e,t,s,n,o);return Me((()=>{const a=Mt(e,t,s,n,o);S(a,i)||(i=a,r(Kt,e,t,s,n,o,i))}),fe[a?1:0],[e,t],[kt])},addWillFinishTransactionListener:e=>Me(e,Ee[0]),addDidFinishTransactionListener:e=>Me(e,Ee[1]),callListener:e=>(De(e),Kt),delListener:e=>(xe(e),Kt),getListenerStats:()=>({}),createStore:je};return be({Tables:[0,B],TableIds:[0,G],[u]:[1,re,[kt]],[f]:[1,ue,[kt]],Row:[2,he,[kt,Et]],[g]:[2,ge,[kt,Et]],[h]:[3,Re,[kt,Et,Jt],e=>Ae(xt(...e))],InvalidCell:[3,Se],Values:[0,Ie],ValueIds:[0,Ve],Value:[1,ke,[At],e=>Ae(Ft(e[0]))],InvalidValue:[1,pe]},(([e,t,s,n],o)=>{Kt[c+o+l]=(...o)=>Me(o[e],t[o[e+1]?1:0],e>0?m(o,0,e):void 0,s,n)})),ve(Kt)};e.createCheckpoints=Ve,e.createCustomPersister=(e,t,n,o,r)=>{let a,i,l=0,d=!1;const c={load:async(n,o)=>{if(2!=l){l=1;const r=await t();z(r)||r==s?e.setContent([n,o]):e.setJson(r),l=0}return c},startAutoLoad:async(t,s)=>(c.stopAutoLoad(),await c.load(t,s),d=!0,i=o((async t=>{z(t)?await c.load():2!=l&&(l=1,e.setContent(t),l=0)})),c),stopAutoLoad:()=>(d&&(r(i),i=void 0,d=!1),c),save:async()=>(1!=l&&(l=2,await n(e.getContent),l=0),c),startAutoSave:async()=>(await c.stopAutoSave().save(),a=e.addDidFinishTransactionListener(c.save),c),stopAutoSave:()=>(N(a,e.delListener),c),getStore:()=>e,destroy:()=>c.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return ve(c)},e.createIndexes=ke,e.createMetrics=Je,e.createQueries=xe,e.createRelationships=De,e.createStore=je,e.defaultSorter=me},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBase={});
