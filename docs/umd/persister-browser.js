var t,e;t=this,e=function(t){"use strict";const e=(t,e)=>t instanceof e,a=t=>null==t,s=Object,n=s.keys,o=s.freeze,r=t=>(t=>e(t,s)&&t.constructor==s)(t)&&0==(t=>n(t).length)(t),i=JSON.parse,c="storage",d=globalThis.window,y=(t,n,y)=>((t,u,l,f,h)=>{let p,v,w,g=0,S=0,A=0;const L=[],m=async t=>(2!=g&&(g=1,await T.schedule((async()=>{await t(),g=0}))),T),T={load:async(e,a)=>await m((async()=>{try{t.setContent(await u())}catch{t.setContent([e,a])}})),startAutoLoad:async(e={},a={})=>(T.stopAutoLoad(),await T.load(e,a),A=1,w=(t=>{const e=e=>{e.storageArea===y&&e.key===n&&t((()=>i(e.newValue)))};return d.addEventListener(c,e),e})((async(e,a)=>await m((async()=>{if(a)t.setTransactionChanges(a());else try{t.setContent(e?.()??await u())}catch{}})))),T),stopAutoLoad:()=>{return A&&(t=w,d.removeEventListener(c,t),w=void 0,A=0),T;var t},save:async a=>(1!=g&&(g=2,await T.schedule((async()=>{try{await(async t=>{return y.setItem(n,(a=t(),JSON.stringify(a,((t,a)=>e(a,Map)?s.fromEntries([...a]):a))));var a})(t.getContent)}catch{}g=0}))),T),startAutoSave:async()=>(await T.stopAutoSave().save(),p=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();r(a)&&r(s)||T.save((()=>[a,s]))})),T),stopAutoSave:()=>{var e,s;return e=p,s=t.delListener,a(e)||s(e),T},schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(L,...t),await(async()=>{if(!S){for(S=1;!a((t=L,v=t.shift()));)try{await v()}catch{}S=0}var t})(),T),getStore:()=>t,destroy:()=>T.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return o(T)})(t,(async()=>i(y.getItem(n))));t.createLocalPersister=(t,e)=>y(t,e,localStorage),t.createSessionPersister=(t,e)=>y(t,e,sessionStorage)},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterBrowser={});
