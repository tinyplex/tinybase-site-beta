var t,e;t=this,e=function(t){"use strict";const e=t=>null==t,a=(t,a,s)=>e(t)?s?.():a(t),s=Object,n=t=>s.getPrototypeOf(t),o=s.keys,r=s.freeze,i=t=>(t=>!e(t)&&a(n(t),(t=>t==s.prototype||e(n(t))),(()=>!0)))(t)&&0==(t=>o(t).length)(t),c=JSON.parse,y=t=>new Map(t),d=(t,e)=>t?.get(e),u=(t,a,s)=>{return e(s)?(n=t,o=a,n?.delete(o),t):t?.set(a,s);var n,o},l=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||u(t,e,a()),d(t,e)},f=y(),p=y(),g="storage",w=globalThis.window,h=(t,n,o,y)=>((t,s,n,o,c,y,[g,w]=[],h=[])=>{let v,S,A,L=0,m=0;l(f,h,(()=>0)),l(p,h,(()=>[]));const T=async t=>(2!=L&&(L=1,await b.schedule((async()=>{await t(),L=0}))),b),b={load:async(e,a)=>await T((async()=>{try{t.setContent(await s())}catch{t.setContent([e,a])}})),startAutoLoad:async(e={},a={})=>(b.stopAutoLoad(),await b.load(e,a),m=1,A=o((async(e,a)=>{if(a){const e=a();await T((async()=>t.setTransactionChanges(e)))}else await T((async()=>{try{t.setContent(e?.()??await s())}catch(t){y?.(t)}}))})),b),stopAutoLoad:()=>(m&&(c(A),A=void 0,m=0),b),save:async e=>(1!=L&&(L=2,await b.schedule((async()=>{try{await n(t.getContent,e)}catch(t){y?.(t)}L=0}))),b),startAutoSave:async()=>(await b.stopAutoSave().save(),v=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();i(a)&&i(s)||b.save((()=>[a,s]))})),b),stopAutoSave:()=>(a(v,t.delListener),v=void 0,b),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(d(p,h),...t),await(async()=>{if(!d(f,h)){for(u(f,h,1);!e((t=d(p,h),S=t.shift()));)try{await S()}catch(t){y?.(t)}u(f,h,0)}var t})(),b),getStore:()=>t,destroy:()=>b.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return g&&(b[g]=()=>w),r(b)})(t,(async()=>c(o.getItem(n))),(async t=>{return o.setItem(n,(e=t(),JSON.stringify(e,((t,e)=>e instanceof Map?s.fromEntries([...e]):e))));var e}),(t=>{const e=e=>{e.storageArea===o&&e.key===n&&t((()=>c(e.newValue)))};return w.addEventListener(g,e),e}),(t=>w.removeEventListener(g,t)),y,["getStorageName",n]);t.createLocalPersister=(t,e,a)=>h(t,e,localStorage,a),t.createSessionPersister=(t,e,a)=>h(t,e,sessionStorage,a)},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterBrowser={});
