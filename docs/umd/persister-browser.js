var t,e;t=this,e=function(t){"use strict";const e=JSON.parse,a=t=>null==t,s=Object.freeze,n="storage",o=globalThis.window,r=(t,r,i)=>((t,c,d,u,y)=>{let l,f,v,p=0,w=0,h=0;const g=[],S=async t=>{2!=p&&(p=1,await t(),p=0)},A={load:async(e,a)=>(await S((async()=>{try{t.setContent(await c())}catch{t.setContent([e,a])}})),A),startAutoLoad:async(a={},s={})=>(A.stopAutoLoad(),await A.load(a,s),h=1,v=(t=>{const a=a=>{a.storageArea===i&&a.key===r&&t((()=>e(a.newValue)))};return o.addEventListener(n,a),a})((async(e,a)=>{await S((async()=>{if(a)t.setTransactionChanges(a());else try{t.setContent(e?.()??await c())}catch{}}))})),A),stopAutoLoad:()=>{return h&&(t=v,o.removeEventListener(n,t),v=void 0,h=0),A;var t},save:async e=>(await A.schedule((async()=>{if(1!=p){p=2;try{await(async t=>{return i.setItem(r,(e=t(),JSON.stringify(e,((t,e)=>{return e instanceof Map?(a=(t,[e,a])=>(t[e]=a,t),s={},[...e].reduce(a,s)):e;var a,s}))));var e})(t.getContent)}catch{}p=0}})),A),startAutoSave:async()=>(await A.stopAutoSave().save(),l=t.addDidFinishTransactionListener(((t,e)=>{const a=e();A.save((()=>a))})),A),stopAutoSave:()=>{var e,s;return e=l,s=t.delListener,a(e)||s(e),A},schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(g,...t),await(async()=>{if(!w){for(w=1;!a((t=g,f=t.shift()));)try{await f()}catch{}w=0}var t})(),A),getStore:()=>t,destroy:()=>A.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return s(A)})(t,(async()=>e(i.getItem(r))));t.createLocalPersister=(t,e)=>r(t,e,localStorage),t.createSessionPersister=(t,e)=>r(t,e,sessionStorage)},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterBrowser={});
