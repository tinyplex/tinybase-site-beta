var t,e;t=this,e=function(t){"use strict";const e=(t,e)=>t instanceof e,a=t=>null==t,s=Object,n=s.keys,o=s.freeze,r=t=>(t=>e(t,s)&&t.constructor==s)(t)&&0==(t=>n(t).length)(t),i=JSON.parse,c=t=>new Map(t),d=(t,e)=>t?.get(e),y=(t,e,s)=>{return a(s)?(n=t,o=e,n?.delete(o),t):t?.set(e,s);var n,o},u=(t,e,a)=>{var s,n;return s=t,n=e,s?.has(n)||y(t,e,a()),d(t,e)},l=c(),f=c(),w="storage",h=globalThis.window,p=(t,n,c,p)=>((t,e,s,n,i,c,w=[])=>{let h,p,v,g=0,S=0;u(l,w,(()=>0)),u(f,w,(()=>[]));const A=async t=>(2!=g&&(g=1,await L.schedule((async()=>{await t(),g=0}))),L),L={load:async(a,s)=>await A((async()=>{try{t.setContent(await e())}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},s={})=>(L.stopAutoLoad(),await L.load(a,s),S=1,v=n((async(a,s)=>{if(s){const e=s();await A((async()=>t.setTransactionChanges(e)))}else await A((async()=>{try{t.setContent(a?.()??await e())}catch(t){c?.(t)}}))})),L),stopAutoLoad:()=>(S&&(i(v),v=void 0,S=0),L),save:async e=>(1!=g&&(g=2,await L.schedule((async()=>{try{await s(t.getContent,e)}catch(t){c?.(t)}g=0}))),L),startAutoSave:async()=>(await L.stopAutoSave().save(),h=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();r(a)&&r(s)||L.save((()=>[a,s]))})),L),stopAutoSave:()=>{var e,s;return e=h,s=t.delListener,a(e)||s(e),L},schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(d(f,w),...t),await(async()=>{if(!d(l,w)){for(y(l,w,1);!a((t=d(f,w),p=t.shift()));)try{await p()}catch(t){c?.(t)}y(l,w,0)}var t})(),L),getStore:()=>t,destroy:()=>L.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return o(L)})(t,(async()=>i(c.getItem(n))),(async t=>{return c.setItem(n,(a=t(),JSON.stringify(a,((t,a)=>e(a,Map)?s.fromEntries([...a]):a))));var a}),(t=>{const e=e=>{e.storageArea===c&&e.key===n&&t((()=>i(e.newValue)))};return h.addEventListener(w,e),e}),(t=>h.removeEventListener(w,t)),p);t.createLocalPersister=(t,e,a)=>p(t,e,localStorage,a),t.createSessionPersister=(t,e,a)=>p(t,e,sessionStorage,a)},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterBrowser={});
