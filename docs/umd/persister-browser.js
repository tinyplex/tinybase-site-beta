var t,e;t=this,e=function(t){"use strict";const e=JSON.parse,a=(t,e)=>t instanceof e,s=t=>null==t,n=Object,o=n.keys,r=n.freeze,i=t=>(t=>a(t,n)&&t.constructor==n)(t)&&0==(t=>o(t).length)(t),c="storage",d=globalThis.window,u=(t,n,o)=>((t,u,y,l,f)=>{let v,h,p,w=0,g=0,S=0;const A=[],L=async t=>(2!=w&&(w=1,await T.schedule((async()=>{await t(),w=0}))),T),T={load:async(e,a)=>await L((async()=>{try{t.setContent(await u())}catch{t.setContent([e,a])}})),startAutoLoad:async(a={},s={})=>(T.stopAutoLoad(),await T.load(a,s),S=1,p=(t=>{const a=a=>{a.storageArea===o&&a.key===n&&t((()=>e(a.newValue)))};return d.addEventListener(c,a),a})((async(e,a)=>await L((async()=>{if(a)t.setTransactionChanges(a());else try{t.setContent(e?.()??await u())}catch{}})))),T),stopAutoLoad:()=>{return S&&(t=p,d.removeEventListener(c,t),p=void 0,S=0),T;var t},save:async e=>(1!=w&&(w=2,await T.schedule((async()=>{try{await(async t=>{return o.setItem(n,(e=t(),JSON.stringify(e,((t,e)=>{return a(e,Map)?(s=(t,[e,a])=>(t[e]=a,t),n={},[...e].reduce(s,n)):e;var s,n}))));var e})(t.getContent)}catch{}w=0}))),T),startAutoSave:async()=>(await T.stopAutoSave().save(),v=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();i(a)&&i(s)||T.save((()=>[a,s]))})),T),stopAutoSave:()=>{var e,a;return e=v,a=t.delListener,s(e)||a(e),T},schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(A,...t),await(async()=>{if(!g){for(g=1;!s((t=A,h=t.shift()));)try{await h()}catch{}g=0}var t})(),T),getStore:()=>t,destroy:()=>T.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return r(T)})(t,(async()=>e(o.getItem(n))));t.createLocalPersister=(t,e)=>u(t,e,localStorage),t.createSessionPersister=(t,e)=>u(t,e,sessionStorage)},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterBrowser={});
