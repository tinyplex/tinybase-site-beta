var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a=t(""),s=e=>null==e,n=(e,t,a)=>s(e)?a?.():t(e),o=Object,r=e=>o.getPrototypeOf(e),i=o.keys,c=o.freeze,y=e=>(e=>!s(e)&&n(r(e),(e=>e==o.prototype||s(r(e))),(()=>!0)))(e)&&0==(e=>i(e).length)(e),l=JSON.parse,d=e=>new Map(e),u=(e,t)=>e?.get(t),p=(e,t,a)=>{return s(a)?(n=e,o=t,n?.delete(o),e):e?.set(t,a);var n,o},g=(e,t,a)=>{var s,n;return s=e,n=t,s?.has(n)||p(e,t,a()),u(e,t)},f=d(),h=d(),w="storage",v=globalThis.window,S=(e,r,i,d)=>((e,o,r,i,l,d,w,[v,S]=[],A=[])=>{let L,C,b,m=0,T=0;g(f,A,(()=>0)),g(h,A,(()=>[]));const M=(w?e.getMergeableContent:null)??e.getContent,O=e.getTransactionChanges,P=async e=>(2!=m&&(m=1,await x.schedule((async()=>{await e(),m=0}))),x),x={load:async(s,n)=>await P((async()=>{try{const s=await o();(w&&(e=>t(e)==a)(s[0])?e.applyMergeableChanges:e.setContent)(s)}catch{e.setContent([s,n])}})),startAutoLoad:async(t={},a={})=>(x.stopAutoLoad(),await x.load(t,a),T=1,b=i((async(t,a)=>{if(a){const t=a();await P((async()=>e.applyChanges(t)))}else await P((async()=>{try{e.setContent(t?.()??await o())}catch(e){d?.(e)}}))})),x),stopAutoLoad:()=>(T&&(l(b),b=void 0,T=0),x),save:async e=>(1!=m&&(m=2,await x.schedule((async()=>{try{await r(M,e)}catch(e){d?.(e)}m=0}))),x),startAutoSave:async()=>(await x.stopAutoSave().save(),L=e.addDidFinishTransactionListener((()=>{const[e,t]=O();y(e)&&y(t)||x.save((()=>[e,t]))})),x),stopAutoSave:()=>(n(L,e.delListener),L=void 0,x),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(u(h,A),...e),await(async()=>{if(!u(f,A)){for(p(f,A,1);!s((e=u(h,A),C=e.shift()));)try{await C()}catch(e){d?.(e)}p(f,A,0)}var e})(),x),getStore:()=>e,destroy:()=>x.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return v&&(x[v]=()=>S),c(x)})(e,(async()=>l(i.getItem(r))),(async e=>{return i.setItem(r,(t=e(),JSON.stringify(t,((e,t)=>t instanceof Map?o.fromEntries([...t]):t))));var t}),(e=>{const t=t=>{t.storageArea===i&&t.key===r&&e((()=>l(t.newValue)))};return v.addEventListener(w,t),t}),(e=>v.removeEventListener(w,e)),d,!1,["getStorageName",r]);e.createLocalPersister=(e,t,a)=>S(e,t,localStorage,a),e.createSessionPersister=(e,t,a)=>S(e,t,sessionStorage,a)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterBrowser={});
