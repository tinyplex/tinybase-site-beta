var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a=t(""),n=e=>null==e,s=(e,t,a)=>n(e)?a?.():t(e),o=Object,r=e=>o.getPrototypeOf(e),i=o.entries,c=o.keys,d=o.freeze,u=(e,t)=>s(e,(e=>e[t])),y=(e,t)=>t in e,g=(e,t)=>(delete e[t],e),l=(e,t)=>((e,t)=>e.map(t))(i(e),(([e,a])=>t(a,e))),p=e=>c(e).length,h=e=>(e=>!n(e)&&s(r(e),(e=>e==o.prototype||n(r(e))),(()=>!0)))(e)&&0==p(e),f=e=>new Map(e),v=(e,t)=>e?.get(t),w=(e,t,a)=>{return n(a)?(s=e,o=t,s?.delete(o),e):e?.set(t,a);var s,o},A=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)?n?.(v(e,t)):w(e,t,a()),v(e,t)},C=f(),b=f(),L=(e,t)=>[e[t].t,e[t].v],S=(e,t,a,s)=>{const o=n(t)?e:((e,t,a)=>(y(e,t)||(e[t]={}),e[t]))(e,t);let r;return l(a,((e,t)=>{s(o,t,e)&&(r=1)})),l(o,((e,t)=>{y(a,t)||(g(o,t),r=1)})),!n(t)&&h(o)&&g(e,t),r};e.createAutomergePersister=(e,o,r="tinybase",i)=>(o.change((e=>e[r]={})),((e,o,r,i,c,u,y,g={},l=[])=>{let p,f,L,S=0;A(C,l,(()=>0)),A(b,l,(()=>[]));const[m,M,T,x,D]=((e,t)=>!e||n(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!h(e)||!h(t),t.setContent]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!h(e)||!h(t),t.setDefaultContent])(y,e),P=async e=>(2!=S&&(S=1,await O.schedule((async()=>{await e(),S=0}))),O),j=n=>{var s;(m&&(s=n?.[0],t(s)==a)?1===n?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===n?.[2]?e.applyChanges:e.setContent)(n)},O={load:async e=>await P((async()=>{try{j(await o())}catch(t){u?.(t),e&&D(e)}})),startAutoLoad:async e=>(await O.stopAutoLoad().load(e),f=i((async(e,t)=>{const a=t?.();await P((async()=>{try{j(a??e?.()??await o())}catch(e){u?.(e)}}))})),O),stopAutoLoad:()=>(f&&(c(f),f=void 0),O),isAutoLoading:()=>!n(f),save:async e=>(1!=S&&(S=2,await O.schedule((async()=>{try{await r(M,e)}catch(e){u?.(e)}S=0}))),O),startAutoSave:async()=>(await O.stopAutoSave().save(),L=e.addDidFinishTransactionListener((()=>{const e=T();x(e)&&O.save((()=>e))})),O),stopAutoSave:()=>(s(L,e.delListener),L=void 0,O),isAutoSaving:()=>!n(L),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(v(b,l),...e),await(async()=>{if(!v(C,l)){for(w(C,l,1);!n((e=v(b,l),p=e.shift()));)try{await p()}catch(e){u?.(e)}w(C,l,0)}var e})(),O),getStore:()=>e,destroy:()=>O.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...g};return d(O)})(e,(async()=>{const e=await o.doc();return 2==p(e[r])?L(e,r):void 0}),(async(e,t)=>o.change((a=>((e,t,a,o)=>{((e,t)=>{h(e[t])&&(e[t]={t:{},v:{}})})(e,t);const[r,i]=L(e,t),c=()=>{d=1};let d=1;if(s(o?.(),(([e,t])=>{d=0,l(e,((e,t)=>d?0:n(e)?g(r,t):s(r[t],(t=>l(e,((e,a)=>d?0:n(e)?g(t,a):s(u(t,a),(t=>l(e,((e,a)=>n(e)?g(t,a):t[a]=e))),c)))),c))),l(t,((e,t)=>d?0:n(e)?g(i,t):i[t]=e))})),d){const[e,t]=a();S(r,void 0,e,((e,t,a)=>S(r,t,a,((e,t,a)=>S(e,t,a,((e,t,a)=>{if(u(e,t)!==a)return e[t]=a,1})))))),S(i,void 0,t,((e,t,a)=>{u(i,t)!==a&&(i[t]=a)}))}})(a,r,e,t)))),(e=>{const t=({doc:t})=>e((()=>L(t,r)));return o.on("change",t),t}),(e=>{o.removeListener("change",e)}),i,!1,{getDocHandle:()=>o}))},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterAutomerge={});
