var e,t;e=this,t=function(e){"use strict";const t=e=>null==e,a=(e,a,n)=>t(e)?n?.():a(e),n=Object,s=e=>n.getPrototypeOf(e),o=n.entries,r=n.keys,i=n.freeze,c=(e,t)=>a(e,(e=>e[t])),d=(e,t)=>t in e,y=(e,t)=>(delete e[t],e),u=(e,t)=>((e,t)=>e.map(t))(o(e),(([e,a])=>t(a,e))),g=e=>r(e).length,l=e=>(e=>!t(e)&&a(s(e),(e=>e==n.prototype||t(s(e))),(()=>!0)))(e)&&0==g(e),h=e=>new Map(e),p=(e,t)=>e?.get(t),v=(e,a,n)=>{return t(n)?(s=e,o=a,s?.delete(o),e):e?.set(a,n);var s,o},f=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)?n?.(p(e,t)):v(e,t,a()),p(e,t)},w=h(),A=h(),C=(e,t)=>[e[t].t,e[t].v],b=(e,a,n,s)=>{const o=t(a)?e:((e,t,a)=>(d(e,t)||(e[t]={}),e[t]))(e,a);let r;return u(n,((e,t)=>{s(o,t,e)&&(r=1)})),u(o,((e,t)=>{d(n,t)||(y(o,t),r=1)})),!t(a)&&l(o)&&y(e,a),r};e.createAutomergePersister=(e,n,s="tinybase",o)=>(n.change((e=>e[s]={})),((e,n,s,o,r,c,d,y={},u=[])=>{let g,h,C,b=0;f(w,u,(()=>0)),f(A,u,(()=>[]));const[L,S,m,M,T]=((e,a)=>!e||t(a.getMergeableContent)?[0,a.getContent,a.getTransactionChanges,([e,t])=>!l(e)||!l(t),a.setContent]:[1,a.getMergeableContent,a.getTransactionMergeableChanges,([[e],[t]])=>!l(e)||!l(t),a.setDefaultContent])(d,e),x=async e=>(2!=b&&(b=1,await P.schedule((async()=>{await e(),b=0}))),P),D=t=>{var a;(L&&(a=t?.[0],Array.isArray(a))?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},P={load:async e=>await x((async()=>{try{D(await n())}catch(t){c?.(t),e&&T(e)}})),startAutoLoad:async e=>(await P.stopAutoLoad().load(e),h=o((async(e,t)=>{const a=t?.();await x((async()=>{try{D(a??e?.()??await n())}catch(e){c?.(e)}}))})),P),stopAutoLoad:()=>(h&&(r(h),h=void 0),P),isAutoLoading:()=>!t(h),save:async e=>(1!=b&&(b=2,await P.schedule((async()=>{try{await s(S,e)}catch(e){c?.(e)}b=0}))),P),startAutoSave:async()=>(await P.stopAutoSave().save(),C=e.addDidFinishTransactionListener((()=>{const e=m();M(e)&&P.save((()=>e))})),P),stopAutoSave:()=>(a(C,e.delListener),C=void 0,P),isAutoSaving:()=>!t(C),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(p(A,u),...e),await(async()=>{if(!p(w,u)){for(v(w,u,1);!t((e=p(A,u),g=e.shift()));)try{await g()}catch(e){c?.(e)}v(w,u,0)}var e})(),P),getStore:()=>e,destroy:()=>P.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...y};return i(P)})(e,(async()=>{const e=await n.doc();return 2==g(e[s])?C(e,s):void 0}),(async(e,o)=>n.change((n=>((e,n,s,o)=>{((e,t)=>{l(e[t])&&(e[t]={t:{},v:{}})})(e,n);const[r,i]=C(e,n),d=()=>{g=1};let g=1;if(a(o?.(),(([e,n])=>{g=0,u(e,((e,n)=>g?0:t(e)?y(r,n):a(r[n],(n=>u(e,((e,s)=>g?0:t(e)?y(n,s):a(c(n,s),(a=>u(e,((e,n)=>t(e)?y(a,n):a[n]=e))),d)))),d))),u(n,((e,a)=>g?0:t(e)?y(i,a):i[a]=e))})),g){const[e,t]=s();b(r,void 0,e,((e,t,a)=>b(r,t,a,((e,t,a)=>b(e,t,a,((e,t,a)=>{if(c(e,t)!==a)return e[t]=a,1})))))),b(i,void 0,t,((e,t,a)=>{c(i,t)!==a&&(i[t]=a)}))}})(n,s,e,o)))),(e=>{const t=({doc:t})=>e((()=>C(t,s)));return n.on("change",t),t}),(e=>{n.removeListener("change",e)}),o,!1,{getDocHandle:()=>n}))},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterAutomerge={});
