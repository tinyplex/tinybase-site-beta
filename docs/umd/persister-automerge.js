var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a=t(""),n=e=>null==e,s=(e,t,a)=>n(e)?a?.():t(e),o=Object,r=e=>o.getPrototypeOf(e),i=o.entries,c=o.keys,d=o.freeze,y=(e,t)=>s(e,(e=>e[t])),g=(e,t)=>t in e,u=(e,t)=>(delete e[t],e),l=(e,t)=>((e,t)=>e.map(t))(i(e),(([e,a])=>t(a,e))),p=e=>c(e).length,h=e=>(e=>!n(e)&&s(r(e),(e=>e==o.prototype||n(r(e))),(()=>!0)))(e)&&0==p(e),v=e=>new Map(e),f=(e,t)=>e?.get(t),w=(e,t,a)=>{return n(a)?(s=e,o=t,s?.delete(o),e):e?.set(t,a);var s,o},A=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)?n?.(f(e,t)):w(e,t,a()),f(e,t)},b=v(),C=v(),L=(e,t)=>[e[t].t,e[t].v],S=(e,t,a,s)=>{const o=n(t)?e:((e,t,a)=>(g(e,t)||(e[t]={}),e[t]))(e,t);let r;return l(a,((e,t)=>{s(o,t,e)&&(r=1)})),l(o,((e,t)=>{g(a,t)||(u(o,t),r=1)})),!n(t)&&h(o)&&u(e,t),r};e.createAutomergePersister=(e,o,r="tinybase",i)=>(o.change((e=>e[r]={})),((e,o,r,i,c,y,g,u={},l=[])=>{let p,v,L,S=0;A(b,l,(()=>0)),A(C,l,(()=>[]));const[m,M,T,x]=((e,t)=>!e||n(t.getMergeableContent)?[0,t.getContent,t.getTransactionChanges,([e,t])=>!h(e)||!h(t)]:[1,t.getMergeableContent,t.getTransactionMergeableChanges,([,[[,e],[,t]]])=>!h(e)||!h(t)])(g,e),P=async e=>(2!=S&&(S=1,await D.schedule((async()=>{await e(),S=0}))),D),j=n=>{var s;(m&&(s=n?.[0],t(s)==a)?1===n?.[1][2]?e.applyMergeableChanges:e.setMergeableContent:1===n?.[2]?e.applyChanges:e.setContent)(n)},D={load:async(t,a)=>await P((async()=>{try{j(await o())}catch(n){y?.(n),e.setContent([t,a])}})),startAutoLoad:async(e={},t={})=>(await D.stopAutoLoad().load(e,t),v=i((async(e,t)=>{const a=t?.();await P((async()=>{try{j(a??e?.()??await o())}catch(e){y?.(e)}}))})),D),stopAutoLoad:()=>(v&&(c(v),v=void 0),D),isAutoLoading:()=>!n(v),save:async e=>(1!=S&&(S=2,await D.schedule((async()=>{try{await r(M,e)}catch(e){y?.(e)}S=0}))),D),startAutoSave:async()=>(await D.stopAutoSave().save(),L=e.addDidFinishTransactionListener((()=>{const e=T();x(e)&&D.save((()=>e))})),D),stopAutoSave:()=>(s(L,e.delListener),L=void 0,D),isAutoSaving:()=>!n(L),schedule:async(...e)=>(((e,...t)=>{e.push(...t)})(f(C,l),...e),await(async()=>{if(!f(b,l)){for(w(b,l,1);!n((e=f(C,l),p=e.shift()));)try{await p()}catch(e){y?.(e)}w(b,l,0)}var e})(),D),getStore:()=>e,destroy:()=>D.stopAutoLoad().stopAutoSave(),getStats:()=>({}),...u};return d(D)})(e,(async()=>{const e=await o.doc();return 2==p(e[r])?L(e,r):void 0}),(async(e,t)=>o.change((a=>((e,t,a,o)=>{((e,t)=>{h(e[t])&&(e[t]={t:{},v:{}})})(e,t);const[r,i]=L(e,t),c=()=>{d=1};let d=1;if(s(o?.(),(([e,t])=>{d=0,l(e,((e,t)=>d?0:n(e)?u(r,t):s(r[t],(t=>l(e,((e,a)=>d?0:n(e)?u(t,a):s(y(t,a),(t=>l(e,((e,a)=>n(e)?u(t,a):t[a]=e))),c)))),c))),l(t,((e,t)=>d?0:n(e)?u(i,t):i[t]=e))})),d){const[e,t]=a();S(r,void 0,e,((e,t,a)=>S(r,t,a,((e,t,a)=>S(e,t,a,((e,t,a)=>{if(y(e,t)!==a)return e[t]=a,1})))))),S(i,void 0,t,((e,t,a)=>{y(i,t)!==a&&(i[t]=a)}))}})(a,r,e,t)))),(e=>{const t=({doc:t})=>e((()=>L(t,r)));return o.on("change",t),t}),(e=>{o.removeListener("change",e)}),i,!1,{getDocHandle:()=>o}))},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterAutomerge={});
