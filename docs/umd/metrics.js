var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="",r=t(n),s=t(t),i=(e,t)=>e.forEach(t),o=e=>c(e,((e,t)=>e+t),0),a=e=>e.length,c=(e,t,n)=>e.reduce(t,n),d=(e,...t)=>e.push(...t),l=Math.max,u=Math.min,f=isFinite,h=e=>null==e,v=(e,t,n)=>h(e)?n?.():t(e),g=e=>Array.isArray(e),M=()=>{},p=Object.freeze,y=e=>e.size,m=(e,t)=>e?.has(t)??!1,b=e=>h(e)||0==y(e),L=e=>[...e?.values()??[]],w=e=>e.clear(),T=(e,t)=>e?.forEach(t),x=(e,t)=>e?.delete(t),E=e=>new Map(e),I=(e,t)=>e?.get(t),R=(e,t)=>T(e,((e,n)=>t(n,e))),S=(e,t,n)=>h(n)?(x(e,t),e):e?.set(t,n),j=(e,t,n)=>(m(e,t)||S(e,t,n()),I(e,t)),k=(e,t,n,r,s=0)=>v((n?j:I)(e,t[s],s>a(t)-2?n:E),(i=>{if(s>a(t)-2)return r?.(i)&&S(e,t[s]),i;const o=k(i,t,n,r,s+1);return b(i)&&S(e,t[s]),o})),z=E([["avg",[(e,t)=>o(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,r)=>e+(t-n)/r]],["max",[e=>l(...e),(e,t)=>l(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:l(t,e)]],["min",[e=>u(...e),(e,t)=>u(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:u(t,e)]],["sum",[e=>o(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]),A=e=>new Set(g(e)||h(e)?e:[e]),D=(e,t)=>e?.add(t),N=/^\d+$/,B=(e=>{const o=new WeakMap;return e=>(o.has(e)||o.set(e,(e=>{const o=E(),[c,l,u,B,C,F,O,,W,$,q]=((e,t,r)=>{const s=e.hasRow,o=E(),c=E(),d=E(),l=E(),u=E(),f=(t,n,...r)=>{const s=j(u,t,A);return i(r,(t=>D(s,t)&&n&&e.callListener(t))),r},M=(t,...n)=>v(I(u,t),(r=>{i(0==a(n)?L(r):n,(t=>{e.delListener(t),x(r,t)})),b(r)&&S(u,t)})),p=(e,n)=>{S(o,e,n),m(c,e)||(S(c,e,t()),S(d,e,E()),S(l,e,E()))},y=e=>{S(o,e),S(c,e),S(d,e),S(l,e),M(e)};return[()=>e,()=>{return e=o,[...e?.keys()??[]];var e},e=>R(c,e),e=>m(c,e),e=>I(o,e),e=>I(c,e),(e,t)=>S(c,e,t),p,(t,r,o,c,u)=>{p(t,r);const v=E(),y=E(),b=I(d,t),L=I(l,t),x=t=>{const i=n=>e.getCell(r,t,n),o=I(b,t),d=s(r,t)?(l=c(i,t),isNaN(l)||h(l)||!0===l||!1===l||l===n?void 0:1*l):void 0;var l,f,M,p;if(o===d||g(o)&&g(d)&&(M=d,a(f=o)===a(M)&&(p=(e,t)=>M[t]===e,f.every(p)))||S(v,t,[o,d]),!h(u)){const e=I(L,t),n=s(r,t)?u(i,t):void 0;e!=n&&S(y,t,n)}},j=e=>{o((()=>{T(v,(([,e],t)=>S(b,t,e))),T(y,((e,t)=>S(L,t,e)))}),v,y,b,L,e),w(v),w(y)};R(b,x),e.hasTable(r)&&i(e.getRowIds(r),(e=>{m(b,e)||x(e)})),j(!0),M(t),f(t,0,e.addRowListener(r,null,((e,t,n)=>x(n))),e.addTableListener(r,(()=>j())))},y,()=>R(u,y),f,M]})(e,M),[G,H,J]=(e=>{let t;const[r,s]=(()=>{const e=[];let t=0;return[r=>(r?e.shift():null)??n+t++,t=>{N.test(t)&&a(e)<1e3&&d(e,t)}]})(),o=E();return[(e,s,i,a=[],c=(()=>[]))=>{t??=K;const d=r(1);return S(o,d,[e,s,i,a,c]),D(k(s,i??[n],A),d),d},(e,r,...s)=>i(((e,t=[n])=>{const r=[],s=(e,n)=>n==a(t)?d(r,e):null===t[n]?T(e,(e=>s(e,n+1))):i([t[n],null],(t=>s(I(e,t),n+1)));return s(e,0),r})(e,r),(e=>T(e,(e=>I(o,e)[0](t,...r??[],...s))))),e=>v(I(o,e),(([,t,r])=>(k(t,r??[n],void 0,(t=>(x(t,e),b(t)?1:0))),S(o,e),s(e),r))),e=>v(I(o,e),(([e,,n=[],r,s])=>{const o=(...c)=>{const d=a(c);d==a(n)?e(t,...c,...s(c)):h(n[d])?i(r[d]?.(...c)??[],(e=>o(...c,e))):o(...c,n[d])};o()}))]})(),K={setMetricDefinition:(e,n,i,a,c,d,l)=>{const u=t(i)==s?[i,c,d,l]:I(z,i)??I(z,"sum");return W(e,n,((t,n,r,s,i,a)=>{const c=F(e),d=y(s);a||=h(c),t();let l=((e,t,n,r,s,i=!1)=>{if(b(n))return;const[o,a,c,d]=s;return i||=h(e),T(r,(([n,r])=>{i||(e=h(n)?a?.(e,r,t++):h(r)?c?.(e,n,t--):d?.(e,r,n,t),i||=h(e))})),i?o(L(n),y(n)):e})(c,d,s,n,u,a);f(l)||(l=void 0),l!=c&&(O(e,l),H(o,[e],l,c))}),(1,t(v=a)==r?e=>e(v):v??(()=>1))),K;var v},delMetricDefinition:e=>($(e),K),getStore:c,getMetricIds:l,forEachMetric:u,hasMetric:B,getTableId:C,getMetric:F,addMetricListener:(e,t)=>G(t,o,[e]),delListener:e=>(J(e),K),destroy:q,getListenerStats:()=>({})};return p(K)})(e)),o.get(e))})();e.createMetrics=B},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseMetrics={});
