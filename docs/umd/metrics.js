var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,r="",n=t(r),s=t(t),i=Math.max,o=Math.min,a=isFinite,c=e=>null==e,d=(e,t,r)=>c(e)?r?.():t(e),l=e=>Array.isArray(e),u=e=>e.length,f=()=>{},h=(e,t)=>e.forEach(t),v=e=>M(e,((e,t)=>e+t),0),M=(e,t,r)=>e.reduce(t,r),g=(e,...t)=>e.push(...t),p=Object.freeze,y=e=>e?.size??0,m=(e,t)=>e?.has(t)??!1,L=e=>c(e)||0==y(e),b=e=>[...e?.values()??[]],w=e=>e.clear(),T=(e,t)=>e?.forEach(t),x=(e,t)=>e?.delete(t),I=e=>new Map(e),E=(e,t)=>e?.get(t),R=(e,t)=>T(e,((e,r)=>t(r,e))),S=(e,t,r)=>c(r)?(x(e,t),e):e?.set(t,r),j=(e,t,r)=>(m(e,t)||S(e,t,r()),E(e,t)),k=(e,t,r,n,s=0)=>d((r?j:E)(e,t[s],s>u(t)-2?r:I),(i=>{if(s>u(t)-2)return n?.(i)&&S(e,t[s]),i;const o=k(i,t,r,n,s+1);return L(i)&&S(e,t[s]),o})),z=I([["avg",[(e,t)=>v(e)/t,(e,t,r)=>e+(t-e)/(r+1),(e,t,r)=>e+(e-t)/(r-1),(e,t,r,n)=>e+(t-r)/n]],["max",[e=>i(...e),(e,t)=>i(t,e),(e,t)=>t==e?void 0:e,(e,t,r)=>r==e?void 0:i(t,e)]],["min",[e=>o(...e),(e,t)=>o(t,e),(e,t)=>t==e?void 0:e,(e,t,r)=>r==e?void 0:o(t,e)]],["sum",[e=>v(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,r)=>e-r+t]]]),A=e=>new Set(l(e)||c(e)?e:[e]),D=(e,t)=>e?.add(t),N=/^\d+$/,B=((e,i)=>{const o=new WeakMap;return e=>{o.has(e)||o.set(e,(e=>{const i=I(),[o,v,M]=(e=>{let t;const[n,s]=(()=>{const e=[];let t=0;return[n=>(n?e.shift():null)??r+t++,t=>{N.test(t)&&u(e)<1e3&&g(e,t)}]})(),i=I();return[(e,s,o,a=[],c=(()=>[]))=>{t??=P;const d=n(1);return S(i,d,[e,s,o,a,c]),D(k(s,o??[r],A),d),d},(e,n,...s)=>h(((e,t=[r])=>{const n=[],s=(e,r)=>r==u(t)?g(n,e):null===t[r]?T(e,(e=>s(e,r+1))):h([t[r],null],(t=>s(E(e,t),r+1)));return s(e,0),n})(e,n),(e=>T(e,(e=>E(i,e)[0](t,...n??[],...s))))),e=>d(E(i,e),(([,t,n])=>(k(t,n??[r],void 0,(t=>(x(t,e),L(t)?1:0))),S(i,e),s(e),n))),e=>d(E(i,e),(([e,,r=[],n,s])=>{const i=(...o)=>{const a=u(o);a==u(r)?e(t,...o,...s(o)):c(r[a])?h(n[a]?.(...o)??[],(e=>i(...o,e))):i(...o,r[a])};i()}))]})(),[B,C,F,O,W,$,q,,G,H,J,K]=((e,t,n,s,i)=>{const o=e.hasRow,a=I(),f=I(),v=I(),M=I(),g=I(),p=I(),y=(t,r,...n)=>{const s=j(p,t,A);return h(n,(t=>D(s,t)&&r&&e.callListener(t))),n},k=(t,...r)=>d(E(p,t),(n=>{h(0==u(r)?b(n):r,(t=>{e.delListener(t),x(n,t)})),L(n)&&S(p,t)})),z=(e,r)=>{S(a,e,r),m(f,e)||(S(f,e,t()),S(M,e,I()),S(g,e,I()),i(v))},N=e=>{S(a,e),S(f,e),S(M,e),S(g,e),k(e),i(v)};return[()=>e,()=>{return e=a,[...e?.keys()??[]];var e},e=>R(f,e),e=>m(f,e),e=>E(a,e),e=>E(f,e),(e,t)=>S(f,e,t),z,(t,n,s,i,a)=>{z(t,n);const d=I(),f=I(),v=E(M,t),p=E(g,t),L=t=>{const s=r=>e.getCell(n,t,r),h=E(v,t),M=o(n,t)?(g=i(s,t),isNaN(g)||c(g)||!0===g||!1===g||g===r?void 0:1*g):void 0;var g,y,m,L;if(h===M||l(h)&&l(M)&&(m=M,u(y=h)===u(m)&&(L=(e,t)=>m[t]===e,y.every(L)))||S(d,t,[h,M]),!c(a)){const e=E(p,t),r=o(n,t)?a(s,t):void 0;e!=r&&S(f,t,r)}},b=e=>{s((()=>{T(d,(([,e],t)=>S(v,t,e))),T(f,((e,t)=>S(p,t,e)))}),d,f,v,p,e),w(d),w(f)};R(v,L),e.hasTable(n)&&h(e.getRowIds(n),(e=>{m(v,e)||L(e)})),b(!0),k(t),y(t,0,e.addRowListener(n,null,((e,t,r)=>L(r))),e.addTableListener(n,(()=>b())))},N,e=>s(e,v),()=>R(p,N),y,k]})(e,f,0,o,v),P={setMetricDefinition:(e,r,o,d,l,u,f)=>{const h=t(o)==s?[o,l,u,f]:E(z,o)??E(z,"sum");return G(e,r,((t,r,n,s,o,d)=>{const l=$(e),u=y(s);d||=c(l),t();let f=((e,t,r,n,s,i=!1)=>{if(L(r))return;const[o,a,d,l]=s;return i||=c(e),T(n,(([r,n])=>{i||(e=c(r)?a?.(e,n,t++):c(n)?d?.(e,r,t--):l?.(e,n,r,t),i||=c(e))})),i?o(b(r),y(r)):e})(l,u,s,r,h,d);a(f)||(f=void 0),f!=l&&(q(e,f),v(i,[e],f,l))}),(1,t(M=d)==n?e=>e(M):M??(()=>1))),P;var M},delMetricDefinition:e=>(H(e),P),getStore:B,getMetricIds:C,forEachMetric:F,hasMetric:O,getTableId:W,getMetric:$,addMetricIdsListener:J,addMetricListener:(e,t)=>o(t,i,[e]),delListener:e=>(M(e),P),destroy:K,getListenerStats:()=>({})};return p(P)})(e));return o.get(e)}})();e.createMetrics=B},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseMetrics={});
