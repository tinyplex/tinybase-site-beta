var t,e;t=this,e=function(t){"use strict";const e=t=>null==t,a=Object,s=a.keys,n=a.freeze,o=t=>(t=>t instanceof a&&t.constructor==a)(t)&&0==(t=>s(t).length)(t);t.createCustomPersister=(t,a,s,i,c)=>{let r,d,u,y=0,f=0,l=0;const h=[],p=async t=>(2!=y&&(y=1,await w.schedule((async()=>{await t(),y=0}))),w),w={load:async(e,s)=>await p((async()=>{try{t.setContent(await a())}catch{t.setContent([e,s])}})),startAutoLoad:async(e={},s={})=>(w.stopAutoLoad(),await w.load(e,s),l=1,u=i((async(e,s)=>await p((async()=>{if(s)t.setTransactionChanges(s());else try{t.setContent(e?.()??await a())}catch{}})))),w),stopAutoLoad:()=>(l&&(c(u),u=void 0,l=0),w),save:async e=>(1!=y&&(y=2,await w.schedule((async()=>{try{await s(t.getContent,e)}catch{}y=0}))),w),startAutoSave:async()=>(await w.stopAutoSave().save(),r=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();o(a)&&o(s)||w.save((()=>[a,s]))})),w),stopAutoSave:()=>{var a,s;return a=r,s=t.delListener,e(a)||s(a),w},schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(h,...t),await(async()=>{if(!f){for(f=1;!e((t=h,d=t.shift()));)try{await d()}catch{}f=0}var t})(),w),getStore:()=>t,destroy:()=>w.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return n(w)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisters={});
