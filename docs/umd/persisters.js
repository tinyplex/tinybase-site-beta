var t,e;t=this,e=function(t){"use strict";const e=t=>null==t,a=(t,a,s)=>e(t)?s?.():a(t),s=Object,o=t=>s.getPrototypeOf(t),n=s.keys,i=s.freeze,c=t=>(t=>!e(t)&&a(o(t),(t=>t==s.prototype||e(o(t))),(()=>!0)))(t)&&0==(t=>n(t).length)(t),r=t=>new Map(t),d=(t,e)=>t?.get(e),y=(t,a,s)=>{return e(s)?(o=t,n=a,o?.delete(n),t):t?.set(a,s);var o,n},u=(t,e,a)=>{var s,o;return s=t,o=e,s?.has(o)||y(t,e,a()),d(t,e)},f=r(),l=r();t.createCustomPersister=(t,s,o,n,r,p,[h,w]=[],v=[])=>{let g,A,C,L=0,S=0;u(f,v,(()=>0)),u(l,v,(()=>[]));const T=async t=>(2!=L&&(L=1,await b.schedule((async()=>{await t(),L=0}))),b),b={load:async(e,a)=>await T((async()=>{try{t.setContent(await s())}catch{t.setContent([e,a])}})),startAutoLoad:async(e={},a={})=>(b.stopAutoLoad(),await b.load(e,a),S=1,C=n((async(e,a)=>{if(a){const e=a();await T((async()=>t.setTransactionChanges(e)))}else await T((async()=>{try{t.setContent(e?.()??await s())}catch(t){p?.(t)}}))})),b),stopAutoLoad:()=>(S&&(r(C),C=void 0,S=0),b),save:async e=>(1!=L&&(L=2,await b.schedule((async()=>{try{await o(t.getContent,e)}catch(t){p?.(t)}L=0}))),b),startAutoSave:async()=>(await b.stopAutoSave().save(),g=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();c(a)&&c(s)||b.save((()=>[a,s]))})),b),stopAutoSave:()=>(a(g,t.delListener),g=void 0,b),schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(d(l,v),...t),await(async()=>{if(!d(f,v)){for(y(f,v,1);!e((t=d(l,v),A=t.shift()));)try{await A()}catch(t){p?.(t)}y(f,v,0)}var t})(),b),getStore:()=>t,destroy:()=>b.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return h&&(b[h]=()=>w),i(b)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisters={});
