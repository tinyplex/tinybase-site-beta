var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,s=e(""),a="t",r=Promise,i=t=>null==t,n=(t,e,s)=>t.slice(e,s),o=(t,e)=>t.map(e),c=(t,...e)=>t.push(...e),l=Object,y=(t=[])=>l.fromEntries(t),f=(t,e)=>o(l.entries(t),(([t,s])=>e(s,t))),p=(t,e,s)=>(((t,e)=>!i(((t,e)=>{return a=t=>t[e],i(s=t)?void 0:a(s);var s,a})(t,e)))(t,e)||(t[e]=s()),t[e]),u=t=>JSON.stringify(t,((t,e)=>e instanceof Map?l.fromEntries([...e]):e)),d=JSON.parse,h=(t,e)=>[t[0],e?d(n(t,1)):n(t,1)],w=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,s)=>e(s,t))),g="hasStore",v=y(o(["Origin","Methods","Headers"],(t=>["Access-Control-Allow-"+t,"*"]))),m=async t=>await t.get(g),b=async(t,e)=>{const s=[t.put(g,1)],n=[];f(e[0],((e,r)=>i(e)?((t,...e)=>t.unshift(...e))(n,P(a,r)):f(e,((e,o)=>i(e)?c(n,P(a,r,o)):f(e,((e,i)=>S(s,t,P(a,r,o,i),e))))))),f(e[1],((e,a)=>S(s,t,"v"+a,e))),0!=n.length&&w(await t.list(),(e=>n.every((a=>!e.startsWith(a)||S(s,t,e)&&!1)))),await(async t=>r.all(t))(s)},P=(t,...e)=>t+n(u(e),1,-1),S=(t,e,s,a)=>c(t,i(a)?e.delete(s):e.put(s,a)),T=(t,e=null)=>new Response(e,{status:t,headers:v});t.TinyBasePartyKitServer=class{constructor(t){this.party=t}async onRequest(t){const e=this.party.storage;if(t.url.endsWith("/store")){const s=await m(e),r=await t.text();return"PUT"==t.method?s?T(205):(await b(this.party.storage,d(r)),T(201)):T(200,s?u(await(async t=>{const e={},s={};return w(await t.list(),((t,r)=>{const[i,n]=h(t);if(i==a){const[t,s,a]=d("["+n+"]");p(p(e,t,y),s,y)[a]=r}else"v"==i&&(s[n]=r)})),[e,s]})(e)):"")}return T(404)}async onMessage(t,a){const r=this.party.storage,[i,n]=h(t,1);"s"==i&&await m(r)&&(await b(r,n),this.party.broadcast(((t,a)=>"s"+(e(a)==s?a:u(a)))(0,n),[a.id]))}}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPartyKitServer={});
