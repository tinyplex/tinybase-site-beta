var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="",s=t(n),o=(e,t)=>e.forEach(t),r=e=>e.length,i=(e,...t)=>e.push(...t),a=e=>null==e,l=(e,t,n)=>a(e)?n?.():t(e),d=e=>Array.isArray(e),c=Object.freeze,f=(e,t)=>e?.has(t)??!1,u=e=>a(e)||0==(e=>e.size)(e),h=e=>[...e?.values()??[]],R=e=>e.clear(),p=(e,t)=>e?.forEach(t),g=(e,t)=>e?.delete(t),L=e=>new Map(e),w=(e,t)=>e?.get(t),y=(e,t)=>p(e,((e,n)=>t(n,e))),v=(e,t,n)=>a(n)?(g(e,t),e):e?.set(t,n),I=(e,t,n)=>(f(e,t)||v(e,t,n()),w(e,t)),b=(e,t,n,s,o=0)=>l((n?I:w)(e,t[o],o>r(t)-2?n:L),(i=>{if(o>r(t)-2)return s?.(i)&&v(e,t[o]),i;const a=b(i,t,n,s,o+1);return u(i)&&v(e,t[o]),a})),T=e=>new Set(d(e)||a(e)?e:[e]),m=(e,t)=>e?.add(t),k=/^\d+$/,E=(e=>{const E=new WeakMap;return e=>(E.has(e)||E.set(e,(e=>{const E=L(),x=L(),S=L(),j=L(),[z,A,D,M,B,C,,,O,W,$]=((e,t,s)=>{const i=e.hasRow,c=L(),b=L(),k=L(),E=L(),x=L(),S=(t,n,...s)=>{const r=I(x,t,T);return o(s,(t=>m(r,t)&&n&&e.callListener(t))),s},j=(t,...n)=>l(w(x,t),(s=>{o(0==r(n)?h(s):n,(t=>{e.delListener(t),g(s,t)})),u(s)&&v(x,t)})),z=(e,t)=>{v(c,e,t),f(b,e)||(v(b,e,[L(),L(),L(),L()]),v(k,e,L()),v(E,e,L()))},A=e=>{v(c,e),v(b,e),v(k,e),v(E,e),j(e)};return[()=>e,()=>{return e=c,[...e?.keys()??[]];var e},e=>y(b,e),e=>f(b,e),e=>w(c,e),e=>w(b,e),(e,t)=>v(b,e,t),z,(t,s,l,c,u)=>{z(t,s);const h=L(),g=L(),I=w(k,t),b=w(E,t),T=t=>{const o=n=>e.getCell(s,t,n),l=w(I,t),f=i(s,t)?(R=c(o,t),a(R)?void 0:R+n):void 0;var R,p,L,y;if(l===f||d(l)&&d(f)&&(L=f,r(p=l)===r(L)&&(y=(e,t)=>L[t]===e,p.every(y)))||v(h,t,[l,f]),!a(u)){const e=w(b,t),n=i(s,t)?u(o,t):void 0;e!=n&&v(g,t,n)}},m=e=>{l((()=>{p(h,(([,e],t)=>v(I,t,e))),p(g,((e,t)=>v(b,t,e)))}),h,g,I,b,e),R(h),R(g)};y(I,T),e.hasTable(s)&&o(e.getRowIds(s),(e=>{f(I,e)||T(e)})),m(!0),j(t),S(t,0,e.addRowListener(s,null,((e,t,n)=>T(n))),e.addTableListener(s,(()=>m())))},A,()=>y(x,A),S,j]})(e),[q,F,G]=(e=>{let t;const[s,d]=(()=>{const e=[];let t=0;return[s=>(s?e.shift():null)??n+t++,t=>{k.test(t)&&r(e)<1e3&&i(e,t)}]})(),c=L();return[(e,o,r,i=[],a=(()=>[]))=>{t??=N;const l=s(1);return v(c,l,[e,o,r,i,a]),m(b(o,r??[n],T),l),l},(e,s,...a)=>o(((e,t=[n])=>{const s=[],a=(e,n)=>n==r(t)?i(s,e):null===t[n]?p(e,(e=>a(e,n+1))):o([t[n],null],(t=>a(w(e,t),n+1)));return a(e,0),s})(e,s),(e=>p(e,(e=>w(c,e)[0](t,...s??[],...a))))),e=>l(w(c,e),(([,t,s])=>(b(t,s??[n],void 0,(t=>(g(t,e),u(t)?1:0))),v(c,e),d(e),s))),e=>l(w(c,e),(([e,,n=[],s,i])=>{const l=(...d)=>{const c=r(d);c==r(n)?e(t,...d,...i(d)):a(n[c])?o(s[c]?.(...d)??[],(e=>l(...d,e))):l(...d,n[c])};l()}))]})(),H=(e,t,n)=>l(C(e),(([s,,o])=>{if(!f(o,t)){const r=T();if(B(e)!=K(e))m(r,t);else{let e=t;for(;!a(e)&&!f(r,e);)m(r,e),e=w(s,e)}if(n)return r;v(o,t,r)}return w(o,t)})),J=(e,t)=>l(C(e),(([,,e])=>v(e,t))),K=e=>w(E,e),N={setRelationshipDefinition:(e,o,r,i)=>{return v(E,e,r),O(e,o,((t,n)=>{const s=T(),o=T(),r=T(),[i,d]=C(e);p(n,(([t,n],c)=>{a(t)||(m(o,t),l(w(d,t),(e=>{g(e,c),u(e)&&v(d,t)}))),a(n)||(m(o,n),f(d,n)||v(d,n,T()),m(w(d,n),c)),m(s,c),v(i,c,n),y(w(j,e),(t=>{f(H(e,t),c)&&m(r,t)}))})),t(),p(s,(t=>F(x,[e,t]))),p(o,(t=>F(S,[e,t]))),p(r,(t=>{J(e,t),F(j,[e,t])}))}),t(d=i)==s?e=>e(d):d??(()=>n)),N;var d},delRelationshipDefinition:e=>(v(E,e),W(e),N),getStore:z,getRelationshipIds:A,forEachRelationship:t=>D((n=>t(n,(t=>e.forEachRow(B(n),t))))),hasRelationship:M,getLocalTableId:B,getRemoteTableId:K,getRemoteRowId:(e,t)=>w(C(e)?.[0],t),getLocalRowIds:(e,t)=>h(w(C(e)?.[1],t)),getLinkedRowIds:(e,t)=>a(C(e))?[t]:h(H(e,t,!0)),addRemoteRowIdListener:(e,t,n)=>q(n,x,[e,t]),addLocalRowIdsListener:(e,t,n)=>q(n,S,[e,t]),addLinkedRowIdsListener:(e,t,n)=>(H(e,t),q(n,j,[e,t])),delListener:e=>(J(...G(e)),N),destroy:$,getListenerStats:()=>({})};return c(N)})(e)),E.get(e))})();e.createRelationships=E},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseRelationships={});
