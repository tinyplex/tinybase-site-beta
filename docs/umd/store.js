var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",l=t(s),n=t(!0),a=t(0),o=t(t),r="type",c="default",i="Ids",d="Table",u=d+"s",h=d+i,f="Row"+i,g="Cell",T=g+i,b="Value",V=b+"s",C=b+i,S=e=>s+e,v=isFinite,y=(e,t)=>e instanceof t,w=e=>null==e,p=(e,t,s)=>w(e)?s?.():t(e),I=e=>e==l||e==n,m=e=>t(e)==o,R=(e,t)=>e.forEach(t),J=(e,t)=>e.map(t),E=e=>e.length,L=(e,t,s)=>e.slice(t,s),F=(e,...t)=>e.push(...t),x=Object,z=x.keys,O=x.isFrozen,j=x.freeze,k=e=>y(e,x)&&e.constructor==x,A=(e,t)=>!w(((e,t)=>p(e,(e=>e[t])))(e,t)),M=(e,t)=>(delete e[t],e),N=(e,t)=>J(x.entries(e),(([e,s])=>t(s,e))),P=e=>k(e)&&0==(e=>E(z(e)))(e),B=(e,t)=>e?.has(t)??!1,D=e=>w(e)||0==(e=>e.size)(e),W=e=>e.clear(),$=(e,t)=>e?.forEach(t),q=(e,t)=>e?.delete(t),G=e=>new Map(e),H=e=>[...e?.keys()??[]],K=(e,t)=>e?.get(t),Q=(e,t)=>$(e,((e,s)=>t(s,e))),U=(e,t,s)=>w(s)?(q(e,t),e):e?.set(t,s),X=(e,t,s)=>(B(e,t)||U(e,t,s()),K(e,t)),Y=(e,t,s,l=U)=>(N(t,((t,l)=>s(e,l,t))),Q(e,(s=>A(t,s)?0:l(e,s))),e),Z=(e,t,s)=>{const l={};return $(e,((e,n)=>{const a=t?t(e,n):e;!s?.(a,e)&&(l[n]=a)})),l},_=(e,t,s)=>Z(e,(e=>Z(e,t,s)),P),ee=(e,t,s)=>Z(e,(e=>_(e,t,s)),P),te=(e,t)=>{const s=G();return $(e,((e,l)=>s.set(l,t?.(e)??e))),s},se=e=>te(e,te),le=e=>te(e,se),ne=(e,t,s,l,n=0)=>p((s?X:K)(e,t[n],n>E(t)-2?s:G),(a=>{if(n>E(t)-2)return l?.(a)&&U(e,t[n]),a;const o=ne(a,t,s,l,n+1);return D(a)&&U(e,t[n]),o})),ae=e=>new Set(Array.isArray(e)||w(e)?e:[e]),oe=(e,t)=>e?.add(t),re=/^\d+$/,ce=()=>{const e=[];let t=0;return[l=>(l?e.shift():null)??s+t++,t=>{re.test(t)&&E(e)<1e3&&F(e,t)}]},ie=e=>[e,e],de=()=>[G(),G()],ue=e=>[...e],he=([e,t])=>e===t,fe=e=>{const s=t(e);return I(s)||s==a&&v(e)?s:void 0},ge=(e,t,s,l,n)=>w(n)?e.delCell(t,s,l,!0):e.setCell(t,s,l,n),Te=(e,t,s)=>w(s)?e.delValue(t):e.setValue(t,s),be=e=>JSON.stringify(e,((e,t)=>y(t,Map)?x.fromEntries([...t]):t)),Ve=JSON.parse,Ce=(e,t,s)=>w(e)||!k(e)||P(e)||O(e)?(s?.(),!1):(N(e,((s,l)=>{t(s,l)||M(e,l)})),!P(e)),Se=(e,t,s)=>U(e,t,K(e,t)==-s?void 0:s),ve=()=>{let e,t,l=!1,n=!1,o=0;const i=G(),v=G(),y=G(),x=G(),z=G(),O=G(),k=G(),re=G(),ye=G(),we=G(),pe=G(),Ie=G(),me=G(),Re=ae(),Je=G(),Ee=G(),Le=G(),Fe=G(),xe=de(),ze=de(),Oe=de(),je=de(),ke=de(),Ae=de(),Me=de(),Ne=de(),Pe=de(),Be=de(),De=de(),We=de(),$e=de(),qe=de(),Ge=G(),He=de(),[Ke,Qe,Ue,Xe]=(e=>{let t;const[l,n]=ce(),a=G();return[(e,n,o,r=[],c=(()=>[]))=>{t??=is;const i=l(1);return U(a,i,[e,n,o,r,c]),oe(ne(n,o??[s],ae),i),i},(e,l,...n)=>R(((e,t=[s])=>{const l=[],n=(e,s)=>s==E(t)?F(l,e):null===t[s]?$(e,(e=>n(e,s+1))):R([t[s],null],(t=>n(K(e,t),s+1)));return n(e,0),l})(e,l),(e=>$(e,(e=>K(a,e)[0](t,...l??[],...n))))),e=>p(K(a,e),(([,t,l])=>(ne(t,l??[s],void 0,(t=>(q(t,e),D(t)?1:0))),U(a,e),n(e),l))),e=>p(K(a,e),(([e,,s=[],l,n])=>{const a=(...o)=>{const r=E(o);r==E(s)?e(t,...o,...n(o)):w(s[r])?R(l[r]?.(...o)??[],(e=>a(...o,e))):a(...o,s[r])};a()}))]})(),Ye=e=>{if(!Ce(e,((e,t)=>[r,c].includes(t))))return!1;const t=e[r];return!(!I(t)&&t!=a||(fe(e[c])!=t&&M(e,c),0))},Ze=(t,s)=>(!e||B(we,s)||Et(s))&&Ce(t,((e,t)=>_e(s,t,e)),(()=>Et(s))),_e=(e,t,s,l)=>Ce(l?s:lt(s,e,t),((l,n)=>p(et(e,t,n,l),(e=>(s[n]=e,!0)),(()=>!1))),(()=>Et(e,t))),et=(t,s,l,n)=>e?p(K(K(we,t),l),(e=>fe(n)!=e[r]?Et(t,s,l,n,e[c]):n),(()=>Et(t,s,l,n))):w(fe(n))?Et(t,s,l,n):n,tt=(e,t)=>Ce(t?e:nt(e),((t,s)=>p(st(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>Lt())),st=(e,s)=>t?p(K(Ie,e),(t=>fe(s)!=t[r]?Lt(e,s,t[c]):s),(()=>Lt(e,s))):w(fe(s))?Lt(e,s):s,lt=(e,t,s)=>(p(K(pe,t),(([l,n])=>{$(l,((t,s)=>{A(e,s)||(e[s]=t)})),$(n,(l=>{A(e,l)||Et(t,s,l)}))})),e),nt=e=>(t&&($(me,((t,s)=>{A(e,s)||(e[s]=t)})),$(Re,(t=>{A(e,t)||Lt(t)}))),e),at=e=>Y(we,e,((e,t,s)=>{const l=G(),n=ae();Y(X(we,t,G),s,((e,t,s)=>{U(e,t,s),p(s[c],(e=>U(l,t,e)),(()=>oe(n,t)))})),U(pe,t,[l,n])}),((e,t)=>{U(we,t),U(pe,t)})),ot=e=>Y(Ie,e,((e,t,s)=>{U(Ie,t,s),p(s[c],(e=>U(me,t,e)),(()=>oe(Re,t)))}),((e,t)=>{U(Ie,t),U(me,t),q(Re,t)})),rt=e=>P(e)?es():Ut(e),ct=e=>Y(Le,e,((e,t,s)=>it(t,s)),((e,t)=>Ct(t))),it=(e,t)=>Y(X(Le,e,(()=>(wt(e,1),U(Je,e,ce()),U(Ee,e,G()),G()))),t,((t,s,l)=>dt(e,t,s,l)),((t,s)=>St(e,t,s))),dt=(e,t,s,l,n)=>Y(X(t,s,(()=>(pt(e,s,1),G()))),l,((t,l,n)=>ut(e,s,t,l,n)),((l,a)=>vt(e,t,s,l,a,n))),ut=(e,t,s,l,n)=>{B(s,l)||It(e,t,l,1);const a=K(s,l);n!==a&&(mt(e,t,l,a,n),U(s,l,n))},ht=(e,t,s,l,n)=>p(K(t,s),(t=>ut(e,s,t,l,n)),(()=>dt(e,t,s,lt({[l]:n},e,s)))),ft=e=>P(e)?ls():Xt(e),gt=e=>Y(Fe,e,((e,t,s)=>Tt(t,s)),((e,t)=>yt(t))),Tt=(e,t)=>{B(Fe,e)||Rt(e,1);const s=K(Fe,e);t!==s&&(Jt(e,s,t),U(Fe,e,t))},bt=(e,t)=>{const[s]=K(Je,e),l=s(t);return B(K(Le,e),l)?bt(e,t):l},Vt=e=>K(Le,e)??it(e,{}),Ct=e=>it(e,{}),St=(e,t,s)=>{const[,l]=K(Je,e);l(s),dt(e,t,s,{},!0)},vt=(e,t,s,l,n,a)=>{const o=K(K(pe,e)?.[0],n);if(!w(o)&&!a)return ut(e,s,l,n,o);const r=t=>{mt(e,s,t,K(l,t)),It(e,s,t,-1),U(l,t)};w(o)?r(n):Q(l,r),D(l)&&(pt(e,s,-1),D(U(t,s))&&(wt(e,-1),U(Le,e),U(Je,e),U(Ee,e)))},yt=e=>{const t=K(me,e);if(!w(t))return Tt(e,t);Jt(e,K(Fe,e)),Rt(e,-1),U(Fe,e)},wt=(e,t)=>Se(i,e,t),pt=(e,t,s)=>Se(X(y,e,G),t,s),It=(e,t,s,l)=>{const n=K(Ee,e),a=K(n,s)??0;(0==a&&1==l||1==a&&-1==l)&&Se(X(v,e,G),s,l),U(n,s,a!=-l?a+l:null),Se(X(X(x,e,G),t,G),s,l)},mt=(e,t,s,l,n)=>X(X(X(z,e,G),t,G),s,(()=>[l,0]))[1]=n,Rt=(e,t)=>Se(O,e,t),Jt=(e,t,s)=>X(k,e,(()=>[t,0]))[1]=s,Et=(e,t,s,l,n)=>(F(X(X(X(re,e,G),t,G),s,(()=>[])),l),n),Lt=(e,t,s)=>(F(X(ye,e,(()=>[])),t),s),Ft=(e,t,s)=>p(K(K(K(z,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...ie(Gt(e,t,s))])),xt=e=>p(K(k,e),(([e,t])=>[!0,e,t]),(()=>[!1,...ie(Qt(e))])),zt=e=>D(re)||D(Be[e])?0:$(e?le(re):re,((t,s)=>$(t,((t,l)=>$(t,((t,n)=>Qe(Be[e],[s,l,n],t))))))),Ot=e=>D(ye)||D(De[e])?0:$(e?te(ye):ye,((t,s)=>Qe(De[e],[s],t))),jt=(e,t,s)=>{if(!D(t))return Qe(e,s,(()=>Z(t))),1},kt=e=>{const t=D(Ae[e]),s=D(Ne[e])&&D(je[e])&&D(ke[e])&&t&&D(ze[e]),l=D(Pe[e])&&D(Me[e])&&D(Oe[e])&&D(xe[e]);if(!s||!l){const n=e?[te(i),se(v),se(y),le(x),le(z)]:[i,v,y,x,z];if(!s){jt(ze[e],n[0]),$(n[1],((t,s)=>jt(je[e],t,[s])));const s=ae();$(n[2],((l,n)=>{jt(ke[e],l,[n])&&!t&&(Qe(Ae[e],[n,null]),oe(s,n))})),t||$(n[4],((t,l)=>{if(!B(s,l)){const s=ae();$(t,(e=>$(e,(([t,l],n)=>l!==t?oe(s,n):q(e,n))))),$(s,(t=>Qe(Ae[e],[l,t])))}})),$(n[3],((t,s)=>$(t,((t,l)=>jt(Ne[e],t,[s,l])))))}if(!l){let t;$(n[4],((s,l)=>{let n;$(s,((s,a)=>{let o;$(s,(([s,r],c)=>{r!==s&&(Qe(Pe[e],[l,a,c],r,s,Ft),t=n=o=1)})),o&&Qe(Me[e],[l,a],Ft)})),n&&Qe(Oe[e],[l],Ft)})),t&&Qe(xe[e],void 0,Ft)}}},At=e=>{const t=D($e[e]),s=D(qe[e])&&D(We[e]);if(!t||!s){const l=e?[te(O),te(k)]:[O,k];if(t||jt($e[e],l[0]),!s){let t;$(l[1],(([s,l],n)=>{l!==s&&(Qe(qe[e],[n],l,s,xt),t=1)})),t&&Qe(We[e],void 0,xt)}}},Mt=(e,...t)=>(os((()=>e(...J(t,S)))),is),Nt=()=>[Z(z,((e,t)=>-1===K(i,t)?null:Z(e,((e,s)=>-1===K(K(y,t),s)?null:Z(e,(([,e])=>e??null),((e,t)=>he(t)))),P)),P),Z(k,(([,e])=>e??null),((e,t)=>he(t)))],Pt=()=>({cellsTouched:l,valuesTouched:n,changedCells:ee(z,ue,he),invalidCells:ee(re),changedValues:Z(k,ue,he),invalidValues:Z(ye),changedTableIds:Z(i),changedRowIds:_(y),changedCellIds:ee(x),changedValueIds:Z(O)}),Bt=()=>ee(Le),Dt=()=>H(Le),Wt=e=>H(K(Le,S(e))),$t=(e,t,s,l=0,n)=>{return J(L((o=K(Le,S(e)),r=(e,s)=>[w(t)?s:K(e,S(t)),s],a=([e],[t])=>(e<t?-1:1)*(s?-1:1),J([...o?.entries()??[]],(([e,t])=>r(t,e))).sort(a)),l,w(n)?n:l+n),(([,e])=>e));var a,o,r},qt=(e,t)=>H(K(K(Le,S(e)),S(t))),Gt=(e,t,s)=>K(K(K(Le,S(e)),S(t)),S(s)),Ht=()=>Z(Fe),Kt=()=>H(Fe),Qt=e=>K(Fe,S(e)),Ut=e=>Mt((()=>(e=>Ce(e,Ze,Et))(e)?ct(e):0)),Xt=e=>Mt((()=>tt(e)?gt(e):0)),Yt=e=>{try{rt(Ve(e))}catch{}return is},Zt=t=>Mt((()=>{if((e=Ce(t,(e=>Ce(e,Ye))))&&(at(t),!D(Le))){const e=Bt();es(),Ut(e)}})),_t=e=>Mt((()=>{if(t=(e=>Ce(e,Ye))(e)){const s=Ht();as(),ls(),t=!0,ot(e),Xt(s)}})),es=()=>Mt((()=>ct({}))),ts=e=>Mt((e=>B(Le,e)?Ct(e):0),e),ss=(e,t)=>Mt(((e,t)=>p(K(Le,e),(s=>B(s,t)?St(e,s,t):0))),e,t),ls=()=>Mt((()=>gt({}))),ns=()=>Mt((()=>{at({}),e=!1})),as=()=>Mt((()=>{ot({}),t=!1})),os=(e,t)=>{if(-1!=o){rs();const s=e();return cs(t),s}},rs=()=>(-1!=o&&o++,1==o&&Qe(Ge,void 0,Nt,Pt),is),cs=e=>(o>0&&(o--,0==o&&(l=!D(z),n=!D(k),o=1,zt(1),l&&kt(1),Ot(1),n&&At(1),e?.(Nt,Pt)&&($(z,((e,t)=>$(e,((e,s)=>$(e,(([e],l)=>ge(is,t,s,l,e))))))),$(k,(([e],t)=>Te(is,t,e))),l=n=!1),Qe(He[0],void 0,Nt,Pt),o=-1,zt(0),l&&kt(0),Ot(0),n&&At(0),Qe(He[1],void 0,Nt,Pt),o=0,l=n=!1,R([i,v,y,x,z,re,O,k,ye],W))),is),is={getContent:()=>[Bt(),Ht()],getTables:Bt,getTableIds:Dt,getTable:e=>_(K(Le,S(e))),getTableCellIds:e=>H(K(Ee,S(e))),getRowIds:Wt,getSortedRowIds:$t,getRow:(e,t)=>Z(K(K(Le,S(e)),S(t))),getCellIds:qt,getCell:Gt,getValues:Ht,getValueIds:Kt,getValue:Qt,hasTables:()=>!D(Le),hasTable:e=>B(Le,S(e)),hasTableCell:(e,t)=>B(K(Ee,S(e)),S(t)),hasRow:(e,t)=>B(K(Le,S(e)),S(t)),hasCell:(e,t,s)=>B(K(K(Le,S(e)),S(t)),S(s)),hasValues:()=>!D(Fe),hasValue:e=>B(Fe,S(e)),getTablesJson:()=>be(Le),getValuesJson:()=>be(Fe),getJson:()=>be([Le,Fe]),getTablesSchemaJson:()=>be(we),getValuesSchemaJson:()=>be(Ie),getSchemaJson:()=>be([we,Ie]),setContent:([e,t])=>Mt((()=>{(P(e)?es:Ut)(e),(P(t)?ls:Xt)(t)})),setTables:Ut,setTable:(e,t)=>Mt((e=>Ze(t,e)?it(e,t):0),e),setRow:(e,t,s)=>Mt(((e,t)=>_e(e,t,s)?dt(e,Vt(e),t,s):0),e,t),addRow:(e,t,s=!0)=>os((()=>{let l;return _e(e,l,t)&&(e=S(e),dt(e,Vt(e),l=bt(e,s?1:0),t)),l})),setPartialRow:(e,t,s)=>Mt(((e,t)=>{if(_e(e,t,s,1)){const l=Vt(e);N(s,((s,n)=>ht(e,l,t,n,s)))}}),e,t),setCell:(e,t,s,l)=>Mt(((e,t,s)=>p(et(e,t,s,m(l)?l(Gt(e,t,s)):l),(l=>ht(e,Vt(e),t,s,l)))),e,t,s),setValues:Xt,setPartialValues:e=>Mt((()=>tt(e,1)?N(e,((e,t)=>Tt(t,e))):0)),setValue:(e,t)=>Mt((e=>p(st(e,m(t)?t(Qt(e)):t),(t=>Tt(e,t)))),e),setTransactionChanges:e=>Mt((()=>{N(e[0],((e,t)=>w(e)?ts(t):N(e,((e,s)=>w(e)?ss(t,s):N(e,((e,l)=>ge(is,t,s,l,e))))))),N(e[1],((e,t)=>Te(is,t,e)))})),setTablesJson:Yt,setValuesJson:e=>{try{ft(Ve(e))}catch{}return is},setJson:e=>{try{const[t,s]=Ve(e);rt(t),ft(s)}catch{Yt(e)}return is},setTablesSchema:Zt,setValuesSchema:_t,setSchema:(e,t)=>Mt((()=>{Zt(e),_t(t)})),delTables:es,delTable:ts,delRow:ss,delCell:(e,t,s,l)=>Mt(((e,t,s)=>p(K(Le,e),(n=>p(K(n,t),(a=>B(a,s)?vt(e,n,t,a,s,l):0))))),e,t,s),delValues:ls,delValue:e=>Mt((e=>B(Fe,e)?yt(e):0),e),delTablesSchema:ns,delValuesSchema:as,delSchema:()=>Mt((()=>{ns(),as()})),transaction:os,startTransaction:rs,finishTransaction:cs,forEachTable:e=>$(Le,((t,s)=>e(s,(e=>$(t,((t,s)=>e(s,(e=>Q(t,e))))))))),forEachTableCell:(e,t)=>Q(K(Ee,S(e)),t),forEachRow:(e,t)=>$(K(Le,S(e)),((e,s)=>t(s,(t=>Q(e,t))))),forEachCell:(e,t,s)=>Q(K(K(Le,S(e)),S(t)),s),forEachValue:e=>Q(Fe,e),addSortedRowIdsListener:(e,t,s,l,n,a,o)=>{let r=$t(e,t,s,l,n);return Ke((()=>{const o=$t(e,t,s,l,n);var c,i,d;i=r,E(c=o)===E(i)&&(d=(e,t)=>i[t]===e,c.every(d))||(r=o,a(is,e,t,s,l,n,r))}),Ae[o?1:0],[e,t],[Dt])},addStartTransactionListener:e=>Ke(e,Ge),addWillFinishTransactionListener:e=>Ke(e,He[0]),addDidFinishTransactionListener:e=>Ke(e,He[1]),callListener:e=>(Xe(e),is),delListener:e=>(Ue(e),is),getListenerStats:()=>({}),createStore:ve};return N({[u]:[0,xe],[h]:[0,ze],[d]:[1,Oe,[Dt]],[d+T]:[1,je,[Dt]],[f]:[1,ke,[Dt]],Row:[2,Me,[Dt,Wt]],[T]:[2,Ne,[Dt,Wt]],[g]:[3,Pe,[Dt,Wt,qt],e=>ie(Gt(...e))],InvalidCell:[3,Be],[V]:[0,We],[C]:[0,$e],[b]:[1,qe,[Kt],e=>ie(Qt(e[0]))],InvalidValue:[1,De]},(([e,t,s,l],n)=>{is["add"+n+"Listener"]=(...n)=>Ke(n[e],t[n[e+1]?1:0],e>0?L(n,0,e):void 0,s,l)})),j(is)};e.createStore=ve},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseStore={});
