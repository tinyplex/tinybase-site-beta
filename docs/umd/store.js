var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,s="",n=t(s),l=t(!0),a=t(0),r=t(t),o="type",c="default",i="Ids",d="Table",u=d+"s",h=d+i,f="Row"+i,g="Cell",T=g+i,b="Value",V=b+"s",v=b+i,C=e=>s+e,S=(e,t)=>e.forEach(t),y=(e,t)=>e.map(t),w=e=>e.length,p=(e,t,s)=>e.slice(t,s),I=(e,...t)=>e.push(...t),R=e=>JSON.stringify(e,((e,t)=>{return L(t,Map)?(s=(e,[t,s])=>(e[t]=s,e),n={},[...t].reduce(s,n)):t;var s,n})),m=JSON.parse,J=isFinite,L=(e,t)=>e instanceof t,E=e=>null==e,F=(e,t,s)=>E(e)?s?.():t(e),x=e=>e==n||e==l,z=e=>t(e)==r,O=Object,j=O.keys,k=O.isFrozen,A=O.freeze,M=e=>L(e,O)&&e.constructor==O,N=(e,t)=>!E(((e,t)=>F(e,(e=>e[t])))(e,t)),P=(e,t)=>delete e[t],B=(e,t)=>y(O.entries(e),(([e,s])=>t(s,e))),D=e=>{return M(e)&&(t=j(e),0==w(t));var t},W=(e,t)=>e?.has(t)??!1,$=e=>E(e)||0==(e=>e.size)(e),q=e=>e.clear(),G=(e,t)=>e?.forEach(t),H=(e,t)=>e?.delete(t),K=e=>new Map(e),Q=e=>[...e?.keys()??[]],U=(e,t)=>e?.get(t),X=(e,t)=>G(e,((e,s)=>t(s,e))),Y=(e,t,s)=>E(s)?(H(e,t),e):e?.set(t,s),Z=(e,t,s)=>(W(e,t)||Y(e,t,s()),U(e,t)),_=(e,t,s)=>{const n={};return G(e,((e,l)=>{const a=t?t(e,l):e;!s?.(a,e)&&(n[l]=a)})),n},ee=(e,t,s)=>_(e,(e=>_(e,t,s)),D),te=(e,t,s)=>_(e,(e=>ee(e,t,s)),D),se=(e,t)=>{const s=K();return G(e,((e,n)=>s.set(n,t?.(e)??e))),s},ne=e=>se(e,se),le=e=>se(e,ne),ae=(e,t,s,n,l=0)=>F((s?Z:U)(e,t[l],l>w(t)-2?s:K),(a=>{if(l>w(t)-2)return n?.(a)&&Y(e,t[l]),a;const r=ae(a,t,s,n,l+1);return $(a)&&Y(e,t[l]),r})),re=e=>new Set(Array.isArray(e)||E(e)?e:[e]),oe=(e,t)=>e?.add(t),ce=/^\d+$/,ie=()=>{const e=[];let t=0;return[n=>(n?e.shift():null)??s+t++,t=>{ce.test(t)&&w(e)<1e3&&I(e,t)}]},de=e=>[e,e],ue=()=>[K(),K()],he=e=>[...e],fe=([e,t])=>e===t,ge=e=>{const s=t(e);return x(s)||s==a&&J(e)?s:void 0},Te=(e,t,s,n,l)=>E(l)?e.delCell(t,s,n,!0):e.setCell(t,s,n,l),be=(e,t,s)=>E(s)?e.delValue(t):e.setValue(t,s),Ve=(e,t,s,n=Y)=>(B(t,((t,n)=>s(e,n,t))),X(e,(s=>N(t,s)?0:n(e,s))),e),ve=(e,t,s)=>E(e)||!M(e)||D(e)||k(e)?(s?.(),!1):(B(e,((s,n)=>{t(s,n)||P(e,n)})),!D(e)),Ce=(e,t,s)=>Y(e,t,U(e,t)==-s?void 0:s),Se=()=>{let e,t,n=!1,l=!1,r=0;const i=K(),J=K(),L=K(),O=K(),j=K(),k=K(),M=K(),ce=K(),ye=K(),we=K(),pe=K(),Ie=K(),Re=K(),me=re(),Je=K(),Le=K(),Ee=K(),Fe=K(),xe=ue(),ze=ue(),Oe=ue(),je=ue(),ke=ue(),Ae=ue(),Me=ue(),Ne=ue(),Pe=ue(),Be=ue(),De=ue(),We=ue(),$e=ue(),qe=ue(),Ge=K(),He=ue(),[Ke,Qe,Ue,Xe]=(e=>{let t;const[n,l]=ie(),a=K();return[(e,l,r,o=[],c=(()=>[]))=>{t??=is;const i=n(1);return Y(a,i,[e,l,r,o,c]),oe(ae(l,r??[s],re),i),i},(e,n,...l)=>S(((e,t=[s])=>{const n=[],l=(e,s)=>s==w(t)?I(n,e):null===t[s]?G(e,(e=>l(e,s+1))):S([t[s],null],(t=>l(U(e,t),s+1)));return l(e,0),n})(e,n),(e=>G(e,(e=>U(a,e)[0](t,...n??[],...l))))),e=>F(U(a,e),(([,t,n])=>(ae(t,n??[s],void 0,(t=>(H(t,e),$(t)?1:0))),Y(a,e),l(e),n))),e=>F(U(a,e),(([e,,s=[],n,l])=>{const a=(...r)=>{const o=w(r);o==w(s)?e(t,...r,...l(r)):E(s[o])?S(n[o]?.(...r)??[],(e=>a(...r,e))):a(...r,s[o])};a()}))]})(),Ye=e=>{if(!ve(e,((e,t)=>[o,c].includes(t))))return!1;const t=e[o];return!(!x(t)&&t!=a||(ge(e[c])!=t&&P(e,c),0))},Ze=(t,s)=>(!e||W(we,s)||Lt(s))&&ve(t,((e,t)=>_e(s,t,e)),(()=>Lt(s))),_e=(e,t,s,n)=>ve(n?s:nt(s,e,t),((n,l)=>F(et(e,t,l,n),(e=>(s[l]=e,!0)),(()=>!1))),(()=>Lt(e,t))),et=(t,s,n,l)=>e?F(U(U(we,t),n),(e=>ge(l)!=e[o]?Lt(t,s,n,l,e[c]):l),(()=>Lt(t,s,n,l))):E(ge(l))?Lt(t,s,n,l):l,tt=(e,t)=>ve(t?e:lt(e),((t,s)=>F(st(s,t),(t=>(e[s]=t,!0)),(()=>!1))),(()=>Et())),st=(e,s)=>t?F(U(Ie,e),(t=>ge(s)!=t[o]?Et(e,s,t[c]):s),(()=>Et(e,s))):E(ge(s))?Et(e,s):s,nt=(e,t,s)=>(F(U(pe,t),(([n,l])=>{G(n,((t,s)=>{N(e,s)||(e[s]=t)})),G(l,(n=>{N(e,n)||Lt(t,s,n)}))})),e),lt=e=>(t&&(G(Re,((t,s)=>{N(e,s)||(e[s]=t)})),G(me,(t=>{N(e,t)||Et(t)}))),e),at=e=>Ve(we,e,((e,t,s)=>{const n=K(),l=re();Ve(Z(we,t,K),s,((e,t,s)=>{Y(e,t,s),F(s[c],(e=>Y(n,t,e)),(()=>oe(l,t)))})),Y(pe,t,[n,l])}),((e,t)=>{Y(we,t),Y(pe,t)})),rt=e=>Ve(Ie,e,((e,t,s)=>{Y(Ie,t,s),F(s[c],(e=>Y(Re,t,e)),(()=>oe(me,t)))}),((e,t)=>{Y(Ie,t),Y(Re,t),H(me,t)})),ot=e=>D(e)?es():Ut(e),ct=e=>Ve(Ee,e,((e,t,s)=>it(t,s)),((e,t)=>vt(t))),it=(e,t)=>Ve(Z(Ee,e,(()=>(wt(e,1),Y(Je,e,ie()),Y(Le,e,K()),K()))),t,((t,s,n)=>dt(e,t,s,n)),((t,s)=>Ct(e,t,s))),dt=(e,t,s,n,l)=>Ve(Z(t,s,(()=>(pt(e,s,1),K()))),n,((t,n,l)=>ut(e,s,t,n,l)),((n,a)=>St(e,t,s,n,a,l))),ut=(e,t,s,n,l)=>{W(s,n)||It(e,t,n,1);const a=U(s,n);l!==a&&(Rt(e,t,n,a,l),Y(s,n,l))},ht=(e,t,s,n,l)=>F(U(t,s),(t=>ut(e,s,t,n,l)),(()=>dt(e,t,s,nt({[n]:l},e,s)))),ft=e=>D(e)?ns():Xt(e),gt=e=>Ve(Fe,e,((e,t,s)=>Tt(t,s)),((e,t)=>yt(t))),Tt=(e,t)=>{W(Fe,e)||mt(e,1);const s=U(Fe,e);t!==s&&(Jt(e,s,t),Y(Fe,e,t))},bt=(e,t)=>{const[s]=U(Je,e),n=s(t);return W(U(Ee,e),n)?bt(e,t):n},Vt=e=>U(Ee,e)??it(e,{}),vt=e=>it(e,{}),Ct=(e,t,s)=>{const[,n]=U(Je,e);n(s),dt(e,t,s,{},!0)},St=(e,t,s,n,l,a)=>{const r=U(U(pe,e)?.[0],l);if(!E(r)&&!a)return ut(e,s,n,l,r);const o=t=>{Rt(e,s,t,U(n,t)),It(e,s,t,-1),Y(n,t)};E(r)?o(l):X(n,o),$(n)&&(pt(e,s,-1),$(Y(t,s))&&(wt(e,-1),Y(Ee,e),Y(Je,e),Y(Le,e)))},yt=e=>{const t=U(Re,e);if(!E(t))return Tt(e,t);Jt(e,U(Fe,e)),mt(e,-1),Y(Fe,e)},wt=(e,t)=>Ce(i,e,t),pt=(e,t,s)=>Ce(Z(L,e,K),t,s),It=(e,t,s,n)=>{const l=U(Le,e),a=U(l,s)??0;(0==a&&1==n||1==a&&-1==n)&&Ce(Z(J,e,K),s,n),Y(l,s,a!=-n?a+n:null),Ce(Z(Z(O,e,K),t,K),s,n)},Rt=(e,t,s,n,l)=>Z(Z(Z(j,e,K),t,K),s,(()=>[n,0]))[1]=l,mt=(e,t)=>Ce(k,e,t),Jt=(e,t,s)=>Z(M,e,(()=>[t,0]))[1]=s,Lt=(e,t,s,n,l)=>(I(Z(Z(Z(ce,e,K),t,K),s,(()=>[])),n),l),Et=(e,t,s)=>(I(Z(ye,e,(()=>[])),t),s),Ft=(e,t,s)=>F(U(U(U(j,e),t),s),(([e,t])=>[!0,e,t]),(()=>[!1,...de(Gt(e,t,s))])),xt=e=>F(U(M,e),(([e,t])=>[!0,e,t]),(()=>[!1,...de(Qt(e))])),zt=e=>$(ce)||$(Be[e])?0:G(e?le(ce):ce,((t,s)=>G(t,((t,n)=>G(t,((t,l)=>Qe(Be[e],[s,n,l],t))))))),Ot=e=>$(ye)||$(De[e])?0:G(e?se(ye):ye,((t,s)=>Qe(De[e],[s],t))),jt=(e,t,s)=>{if(!$(t))return Qe(e,s,(()=>_(t))),1},kt=e=>{const t=$(Ae[e]),s=$(Ne[e])&&$(je[e])&&$(ke[e])&&t&&$(ze[e]),n=$(Pe[e])&&$(Me[e])&&$(Oe[e])&&$(xe[e]);if(!s||!n){const l=e?[se(i),ne(J),ne(L),le(O),le(j)]:[i,J,L,O,j];if(!s){G(l[1],((t,s)=>jt(je[e],t,[s]))),G(l[3],((t,s)=>G(t,((t,n)=>jt(Ne[e],t,[s,n])))));const s=re();G(l[2],((n,l)=>{jt(ke[e],n,[l])&&!t&&(Qe(Ae[e],[l,null]),oe(s,l))})),t||G(l[4],((t,n)=>{if(!W(s,n)){const s=re();G(t,(e=>G(e,(([t,n],l)=>n!==t?oe(s,l):H(e,l))))),G(s,(t=>Qe(Ae[e],[n,t])))}})),jt(ze[e],l[0])}if(!n){let t;G(l[4],((s,n)=>{let l;G(s,((s,a)=>{let r;G(s,(([s,o],c)=>{o!==s&&(Qe(Pe[e],[n,a,c],o,s,Ft),t=l=r=1)})),r&&Qe(Me[e],[n,a],Ft)})),l&&Qe(Oe[e],[n],Ft)})),t&&Qe(xe[e],void 0,Ft)}}},At=e=>{const t=$($e[e]),s=$(qe[e])&&$(We[e]);if(!t||!s){const n=e?[se(k),se(M)]:[k,M];if(t||jt($e[e],n[0]),!s){let t;G(n[1],(([s,n],l)=>{n!==s&&(Qe(qe[e],[l],n,s,xt),t=1)})),t&&Qe(We[e],void 0,xt)}}},Mt=(e,...t)=>(rs((()=>e(...y(t,C)))),is),Nt=()=>[_(j,((e,t)=>-1===U(i,t)?null:_(e,((e,s)=>-1===U(U(L,t),s)?null:_(e,(([,e])=>e??null),((e,t)=>fe(t)))),D)),D),_(M,(([,e])=>e??null),((e,t)=>fe(t)))],Pt=()=>({cellsTouched:n,valuesTouched:l,changedCells:te(j,he,fe),invalidCells:te(ce),changedValues:_(M,he,fe),invalidValues:_(ye),changedTableIds:_(i),changedRowIds:ee(L),changedCellIds:te(O),changedValueIds:_(k)}),Bt=()=>te(Ee),Dt=()=>Q(Ee),Wt=e=>Q(U(Ee,C(e))),$t=(e,t,s,n=0,l)=>{return y(p((r=U(Ee,C(e)),o=(e,s)=>[E(t)?s:U(e,C(t)),s],a=([e],[t])=>(e<t?-1:1)*(s?-1:1),y([...r?.entries()??[]],(([e,t])=>o(t,e))).sort(a)),n,E(l)?l:n+l),(([,e])=>e));var a,r,o},qt=(e,t)=>Q(U(U(Ee,C(e)),C(t))),Gt=(e,t,s)=>U(U(U(Ee,C(e)),C(t)),C(s)),Ht=()=>_(Fe),Kt=()=>Q(Fe),Qt=e=>U(Fe,C(e)),Ut=e=>Mt((()=>(e=>ve(e,Ze,Lt))(e)?ct(e):0)),Xt=e=>Mt((()=>tt(e)?gt(e):0)),Yt=e=>{try{ot(m(e))}catch{}return is},Zt=t=>Mt((()=>{if((e=ve(t,(e=>ve(e,Ye))))&&(at(t),!$(Ee))){const e=Bt();es(),Ut(e)}})),_t=e=>Mt((()=>{if(t=(e=>ve(e,Ye))(e)){const s=Ht();as(),ns(),t=!0,rt(e),Xt(s)}})),es=()=>Mt((()=>ct({}))),ts=e=>Mt((e=>W(Ee,e)?vt(e):0),e),ss=(e,t)=>Mt(((e,t)=>F(U(Ee,e),(s=>W(s,t)?Ct(e,s,t):0))),e,t),ns=()=>Mt((()=>gt({}))),ls=()=>Mt((()=>{at({}),e=!1})),as=()=>Mt((()=>{rt({}),t=!1})),rs=(e,t)=>{if(-1!=r){os();const s=e();return cs(t),s}},os=()=>(-1!=r&&r++,1==r&&Qe(Ge,void 0,Nt,Pt),is),cs=e=>(r>0&&(r--,0==r&&(n=!$(j),l=!$(M),r=1,zt(1),n&&kt(1),Ot(1),l&&At(1),e?.(Nt,Pt)&&(G(j,((e,t)=>G(e,((e,s)=>G(e,(([e],n)=>Te(is,t,s,n,e))))))),G(M,(([e],t)=>be(is,t,e))),n=l=!1),Qe(He[0],void 0,Nt,Pt),r=-1,zt(0),n&&kt(0),Ot(0),l&&At(0),Qe(He[1],void 0,Nt,Pt),r=0,n=l=!1,S([i,J,L,O,j,ce,k,M,ye],q))),is),is={getContent:()=>[Bt(),Ht()],getTables:Bt,getTableIds:Dt,getTable:e=>ee(U(Ee,C(e))),getTableCellIds:e=>Q(U(Le,C(e))),getRowIds:Wt,getSortedRowIds:$t,getRow:(e,t)=>_(U(U(Ee,C(e)),C(t))),getCellIds:qt,getCell:Gt,getValues:Ht,getValueIds:Kt,getValue:Qt,hasTables:()=>!$(Ee),hasTable:e=>W(Ee,C(e)),hasTableCell:(e,t)=>W(U(Le,C(e)),C(t)),hasRow:(e,t)=>W(U(Ee,C(e)),C(t)),hasCell:(e,t,s)=>W(U(U(Ee,C(e)),C(t)),C(s)),hasValues:()=>!$(Fe),hasValue:e=>W(Fe,C(e)),getTablesJson:()=>R(Ee),getValuesJson:()=>R(Fe),getJson:()=>R([Ee,Fe]),getTablesSchemaJson:()=>R(we),getValuesSchemaJson:()=>R(Ie),getSchemaJson:()=>R([we,Ie]),setContent:([e,t])=>Mt((()=>{Ut(e),Xt(t)})),setTables:Ut,setTable:(e,t)=>Mt((e=>Ze(t,e)?it(e,t):0),e),setRow:(e,t,s)=>Mt(((e,t)=>_e(e,t,s)?dt(e,Vt(e),t,s):0),e,t),addRow:(e,t,s=!0)=>rs((()=>{let n;return _e(e,n,t)&&(e=C(e),dt(e,Vt(e),n=bt(e,s?1:0),t)),n})),setPartialRow:(e,t,s)=>Mt(((e,t)=>{if(_e(e,t,s,1)){const n=Vt(e);B(s,((s,l)=>ht(e,n,t,l,s)))}}),e,t),setCell:(e,t,s,n)=>Mt(((e,t,s)=>F(et(e,t,s,z(n)?n(Gt(e,t,s)):n),(n=>ht(e,Vt(e),t,s,n)))),e,t,s),setValues:Xt,setPartialValues:e=>Mt((()=>tt(e,1)?B(e,((e,t)=>Tt(t,e))):0)),setValue:(e,t)=>Mt((e=>F(st(e,z(t)?t(Qt(e)):t),(t=>Tt(e,t)))),e),setTransactionChanges:e=>Mt((()=>{B(e[0],((e,t)=>E(e)?ts(t):B(e,((e,s)=>E(e)?ss(t,s):B(e,((e,n)=>Te(is,t,s,n,e))))))),B(e[1],((e,t)=>be(is,t,e)))})),setTablesJson:Yt,setValuesJson:e=>{try{ft(m(e))}catch{}return is},setJson:e=>{try{const[t,s]=m(e);ot(t),ft(s)}catch{Yt(e)}return is},setTablesSchema:Zt,setValuesSchema:_t,setSchema:(e,t)=>Mt((()=>{Zt(e),_t(t)})),delTables:es,delTable:ts,delRow:ss,delCell:(e,t,s,n)=>Mt(((e,t,s)=>F(U(Ee,e),(l=>F(U(l,t),(a=>W(a,s)?St(e,l,t,a,s,n):0))))),e,t,s),delValues:ns,delValue:e=>Mt((e=>W(Fe,e)?yt(e):0),e),delTablesSchema:ls,delValuesSchema:as,delSchema:()=>Mt((()=>{ls(),as()})),transaction:rs,startTransaction:os,finishTransaction:cs,forEachTable:e=>G(Ee,((t,s)=>e(s,(e=>G(t,((t,s)=>e(s,(e=>X(t,e))))))))),forEachTableCell:(e,t)=>X(U(Le,C(e)),t),forEachRow:(e,t)=>G(U(Ee,C(e)),((e,s)=>t(s,(t=>X(e,t))))),forEachCell:(e,t,s)=>X(U(U(Ee,C(e)),C(t)),s),forEachValue:e=>X(Fe,e),addSortedRowIdsListener:(e,t,s,n,l,a,r)=>{let o=$t(e,t,s,n,l);return Ke((()=>{const r=$t(e,t,s,n,l);var c,i,d;i=o,w(c=r)===w(i)&&(d=(e,t)=>i[t]===e,c.every(d))||(o=r,a(is,e,t,s,n,l,o))}),Ae[r?1:0],[e,t],[Dt])},addStartTransactionListener:e=>Ke(e,Ge),addWillFinishTransactionListener:e=>Ke(e,He[0]),addDidFinishTransactionListener:e=>Ke(e,He[1]),callListener:e=>(Xe(e),is),delListener:e=>(Ue(e),is),getListenerStats:()=>({}),createStore:Se};return B({[u]:[0,xe],[h]:[0,ze],[d]:[1,Oe,[Dt]],[d+T]:[1,je,[Dt]],[f]:[1,ke,[Dt]],Row:[2,Me,[Dt,Wt]],[T]:[2,Ne,[Dt,Wt]],[g]:[3,Pe,[Dt,Wt,qt],e=>de(Gt(...e))],InvalidCell:[3,Be],[V]:[0,We],[v]:[0,$e],[b]:[1,qe,[Kt],e=>de(Qt(e[0]))],InvalidValue:[1,De]},(([e,t,s,n],l)=>{is["add"+l+"Listener"]=(...l)=>Ke(l[e],t[l[e+1]?1:0],e>0?p(l,0,e):void 0,s,n)})),A(is)};e.createStore=Se},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseStore={});
